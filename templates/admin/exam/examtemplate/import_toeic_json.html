{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}Import TOEIC JSON{% if template %} - {{ template.title }}{% endif %}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto" style="min-height: 100vh; padding: 2rem 1rem;">
  <div class="mb-4">
    <h1 class="text-2xl font-semibold text-slate-900">{% trans "Import TOEIC Questions from JSON" %}</h1>
    {% if template %}
    <p class="mt-1 text-sm text-slate-600">
      Template: <strong>{{ template.title }}</strong>
    </p>
    {% else %}
    <p class="mt-1 text-sm text-blue-600 bg-blue-50 p-2 rounded">
      <strong>ℹ️ Tự động tạo:</strong> Nếu JSON có <code>test_id</code>, hệ thống sẽ tự động tạo ExamTemplate mới hoặc tìm template đã tồn tại.
    </p>
    {% endif %}
    <p class="mt-2 text-sm text-slate-500">
      {% trans "Import TOEIC questions từ file JSON (schema_version 1.0). Hỗ trợ upload file hoặc paste JSON text." %}
    </p>
    <p class="mt-1 text-xs text-amber-600 bg-amber-50 p-2 rounded">
      <strong>⚠️ Lưu ý:</strong> Chỉ hỗ trợ format mới (schema_version 1.0) với cấu trúc sections/passages/questions.
    </p>
  </div>

  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
    <form method="post" enctype="multipart/form-data" novalidate class="space-y-4">
      {% csrf_token %}

      <div>
        <label for="id_json_file" class="block text-sm font-semibold text-slate-800 mb-1">
          {% trans "Upload JSON File" %}
        </label>
        <input type="file" name="json_file" id="id_json_file" accept=".json,application/json"
               class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
        <p class="mt-1 text-xs text-slate-500">{% trans "Hoặc paste JSON text bên dưới" %}</p>
      </div>

      <div class="border-t border-slate-200 pt-4">
        <label for="id_json_text" class="block text-sm font-semibold text-slate-800 mb-1">
          {% trans "Hoặc Paste JSON Text" %}
        </label>
        <textarea name="json_text" id="id_json_text" rows="20"
                  class="w-full font-mono text-xs sm:text-sm rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder='{"schema_version": "1.0", "module": "READING", "sections": [...], "passages": [...], "questions": [...]}'></textarea>
      </div>

      <div class="flex items-center gap-2 pt-2">
        <button type="submit"
                class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">
          {% trans "Import" %}
        </button>
        <a class="inline-flex items-center justify-center px-4 py-2 rounded-xl border border-slate-200 text-sm font-semibold hover:bg-slate-50"
           href="{% if template %}{% url 'admin:exam_examtemplate_change' template.id %}{% else %}{% url 'admin:exam_examtemplate_changelist' %}{% endif %}">
          {% trans "Cancel" %}
        </a>
      </div>
    </form>
  </div>

  <details class="mt-4">
    <summary class="cursor-pointer text-sm font-semibold text-slate-700">{% trans "JSON Format Examples (schema_version 1.0)" %}</summary>
    <div class="mt-2 space-y-6">
      
      {# Reading Example - Full #}
      <div>
        <h3 class="text-base font-semibold text-slate-900 mb-3">{% trans "Reading Module (P5 + P6 + P7)" %}</h3>
        <pre class="whitespace-pre-wrap bg-slate-50 p-4 rounded-2xl border border-slate-200 text-xs overflow-x-auto">{
  "schema_version": "1.0",
  "test_id": "READING_ETS2026_TEST1",
  "module": "READING",
  "timezone": "Asia/Bangkok",
  "sections": [
    {
      "section_id": "P5",
      "type": "incomplete_sentences",
      "instruction": "Choose the best answer to complete the sentence.",
      "question_numbers": [126, 127, 128, 129, 130]
    },
    {
      "section_id": "P6",
      "type": "text_completion",
      "instruction": "Choose the best answer for each blank in the passage.",
      "passage_ids": [
        "READING_ETS2026_TEST1_L6_Q131-134",
        "READING_ETS2026_TEST1_L6_Q135-138"
      ]
    },
    {
      "section_id": "P7",
      "type": "reading_comprehension",
      "instruction": "Read the passage and answer the questions.",
      "passage_ids": [
        "READING_ETS2026_TEST1_L7_Q147-148"
      ]
    }
  ],
  "passages": [
    {
      "passage_id": "READING_ETS2026_TEST1_L6_Q131-134",
      "section_id": "P6",
      "type": "flyer",
      "instruction": "Questions 131-134 refer to the following flyer.",
      "question_numbers": [131, 132, 133, 134],
      "assets": [
        {
          "kind": "image",
          "url": "https://example.com/assets/READING_ETS2026_TEST1_L6_Q131-134.png"
        }
      ],
      "text": "Sample flyer content with blanks (131)-(134) shown in the image asset.",
      "meta": {
        "question_range": [131, 134],
        "source": "ETS2026"
      }
    }
  ],
  "questions": [
    {
      "question_id": "READING_ETS2026_TEST1_Q126",
      "number": 126,
      "section_id": "P5",
      "passage_id": null,
      "question_type": "single_blank_sentence",
      "stem": "With its fixed price ------, Omega Cellular guarantees no phone bill increases for three years.",
      "choices": [
        { "key": "A", "text": "assurance" },
        { "key": "B", "text": "assuredly" },
        { "key": "C", "text": "assuring" },
        { "key": "D", "text": "assures" }
      ],
      "answer_key": "A",
      "explanation": "Placeholder explanation",
      "meta": {}
    },
    {
      "question_id": "READING_ETS2026_TEST1_Q131",
      "number": 131,
      "section_id": "P6",
      "passage_id": "READING_ETS2026_TEST1_L6_Q131-134",
      "question_type": "passage_blank",
      "blank_ref": { "blank_number_in_passage": 131 },
      "stem": "Select the best option to fill blank (131) in the flyer.",
      "choices": [
        { "key": "A", "text": "Staff members have written articles..." },
        { "key": "B", "text": "Installing lights can enhance..." },
        { "key": "C", "text": "Local competitors cannot beat..." },
        { "key": "D", "text": "Riessler Landscaping's goal is to make your vision a reality." }
      ],
      "answer_key": "D",
      "explanation": "Placeholder explanation",
      "meta": {}
    }
  ]
}</pre>
      </div>

      {# Reading Part 5 Only #}
      <div>
        <h3 class="text-base font-semibold text-slate-900 mb-3">{% trans "Reading Part 5 Only (Minimal Example)" %}</h3>
        <pre class="whitespace-pre-wrap bg-slate-50 p-4 rounded-2xl border border-slate-200 text-xs overflow-x-auto">{
  "schema_version": "1.0",
  "module": "READING",
  "sections": [
    {
      "section_id": "P5",
      "type": "incomplete_sentences",
      "instruction": "Choose the best answer to complete the sentence.",
      "question_numbers": [126, 127, 128, 129, 130]
    }
  ],
  "passages": [],
  "questions": [
    {
      "question_id": "Q126",
      "number": 126,
      "section_id": "P5",
      "passage_id": null,
      "question_type": "single_blank_sentence",
      "stem": "The meeting will be held _____ the conference room.",
      "choices": [
        { "key": "A", "text": "at" },
        { "key": "B", "text": "in" },
        { "key": "C", "text": "on" },
        { "key": "D", "text": "by" }
      ],
      "answer_key": "B",
      "explanation": "Giải thích: 'in' dùng cho không gian kín"
    }
  ]
}</pre>
      </div>

      {# Reading Part 6 Example #}
      <div>
        <h3 class="text-base font-semibold text-slate-900 mb-3">{% trans "Reading Part 6 (With Passage)" %}</h3>
        <pre class="whitespace-pre-wrap bg-slate-50 p-4 rounded-2xl border border-slate-200 text-xs overflow-x-auto">{
  "schema_version": "1.0",
  "module": "READING",
  "sections": [
    {
      "section_id": "P6",
      "type": "text_completion",
      "instruction": "Choose the best answer for each blank in the passage.",
      "passage_ids": ["PASSAGE_1"]
    }
  ],
  "passages": [
    {
      "passage_id": "PASSAGE_1",
      "section_id": "P6",
      "type": "email",
      "instruction": "Questions 131-134 refer to the following e-mail.",
      "question_numbers": [131, 132, 133, 134],
      "assets": [
        {
          "kind": "image",
          "url": "https://example.com/passage1.jpg"
        }
      ],
      "text": "Dear Team,\n\nWe would like to inform you...",
      "meta": {
        "question_range": [131, 134]
      }
    }
  ],
  "questions": [
    {
      "question_id": "Q131",
      "number": 131,
      "section_id": "P6",
      "passage_id": "PASSAGE_1",
      "question_type": "passage_blank",
      "blank_ref": { "blank_number_in_passage": 131 },
      "stem": "Select the best option to fill blank (131) in the e-mail.",
      "choices": [
        { "key": "A", "text": "Option A" },
        { "key": "B", "text": "Option B" },
        { "key": "C", "text": "Option C" },
        { "key": "D", "text": "Option D" }
      ],
      "answer_key": "A"
    }
  ]
}</pre>
      </div>

      {# Listening Example #}
      <div>
        <h3 class="text-base font-semibold text-slate-900 mb-3">{% trans "Listening Module (Example - Part 3)" %}</h3>
        <pre class="whitespace-pre-wrap bg-slate-50 p-4 rounded-2xl border border-slate-200 text-xs overflow-x-auto">{
  "schema_version": "1.0",
  "module": "LISTENING",
  "sections": [
    {
      "section_id": "P3",
      "type": "short_conversations",
      "instruction": "Listen to each conversation and answer the questions.",
      "passage_ids": ["CONV_1", "CONV_2"]
    }
  ],
  "passages": [
    {
      "passage_id": "CONV_1",
      "section_id": "P3",
      "type": "conversation",
      "instruction": "Questions 32-34 refer to the following conversation.",
      "question_numbers": [32, 33, 34],
      "assets": [
        {
          "kind": "audio",
          "url": "https://example.com/audio/conv1.mp3"
        }
      ],
      "text": "Man: Good morning. I'd like to...",
      "meta": {
        "question_range": [32, 34]
      }
    }
  ],
  "questions": [
    {
      "question_id": "Q32",
      "number": 32,
      "section_id": "P3",
      "passage_id": "CONV_1",
      "question_type": "conversation_question",
      "stem": "What is the man's main concern?",
      "choices": [
        { "key": "A", "text": "The price" },
        { "key": "B", "text": "The delivery time" },
        { "key": "C", "text": "The product quality" },
        { "key": "D", "text": "The warranty" }
      ],
      "answer_key": "B"
    }
  ]
}</pre>
      </div>

      {# Field Descriptions #}
      <div>
        <h3 class="text-base font-semibold text-slate-900 mb-3">{% trans "Field Descriptions" %}</h3>
        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 text-sm space-y-2">
          <div>
            <strong>schema_version:</strong> <span class="text-slate-600">Bắt buộc. Phải là "1.0"</span>
          </div>
          <div>
            <strong>module:</strong> <span class="text-slate-600">Bắt buộc. "READING" hoặc "LISTENING"</span>
          </div>
          <div>
            <strong>sections:</strong> <span class="text-slate-600">Bắt buộc. Array các section (P5/P6/P7 cho Reading, P1-P4 cho Listening)</span>
          </div>
          <div>
            <strong>passages:</strong> <span class="text-slate-600">Bắt buộc (có thể là array rỗng). Array các passage/conversation</span>
          </div>
          <div>
            <strong>questions:</strong> <span class="text-slate-600">Bắt buộc. Array tất cả các câu hỏi</span>
          </div>
          <div>
            <strong>section_id:</strong> <span class="text-slate-600">P5/P6/P7 (Reading) hoặc P1/P2/P3/P4 (Listening)</span>
          </div>
          <div>
            <strong>passage_id:</strong> <span class="text-slate-600">ID unique của passage/conversation (phải match với passages[].passage_id)</span>
          </div>
          <div>
            <strong>number:</strong> <span class="text-slate-600">Số thứ tự câu hỏi trong đề (126, 127, ...)</span>
          </div>
          <div>
            <strong>stem:</strong> <span class="text-slate-600">Nội dung câu hỏi</span>
          </div>
          <div>
            <strong>choices:</strong> <span class="text-slate-600">Array 4 options với key "A"/"B"/"C"/"D"</span>
          </div>
          <div>
            <strong>answer_key:</strong> <span class="text-slate-600">Bắt buộc. "A", "B", "C", hoặc "D"</span>
          </div>
          <div>
            <strong>assets:</strong> <span class="text-slate-600">Array assets của passage (image cho Reading, audio cho Listening)</span>
          </div>
        </div>
      </div>

    </div>
  </details>
</div>
{% endblock %}
