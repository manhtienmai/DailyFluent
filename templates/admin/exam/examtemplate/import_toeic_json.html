{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}Import TOEIC JSON{% if template %} - {{ template.title }}{% endif %}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
  /* Import JSON Page Styles */
  :root {
    --import-primary: #3b82f6;
    --import-primary-hover: #2563eb;
    --import-success: #10b981;
    --import-warning: #f59e0b;
    --import-danger: #ef4444;
    --import-border: #e2e8f0;
    --import-bg: #f8fafc;
  }

  .import-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1.5rem;
  }

  .import-header {
    margin-bottom: 1.5rem;
  }

  .import-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 0.5rem 0;
  }

  .import-subtitle {
    font-size: 0.875rem;
    color: #64748b;
    margin: 0;
  }

  .import-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }

  @media (max-width: 1024px) {
    .import-layout {
      grid-template-columns: 1fr;
    }
  }

  .import-card {
    background: #fff;
    border: 1px solid var(--import-border);
    border-radius: 1rem;
    overflow: hidden;
  }

  .import-card-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--import-border);
    background: var(--import-bg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .import-card-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .import-card-body {
    padding: 1.25rem;
  }

  /* Schema Selector */
  .schema-selector {
    display: flex;
    gap: 0.5rem;
    background: #fff;
    border-radius: 0.5rem;
    padding: 0.25rem;
    border: 1px solid var(--import-border);
  }

  .schema-btn {
    padding: 0.375rem 0.75rem;
    border: none;
    background: transparent;
    border-radius: 0.375rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: #64748b;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .schema-btn:hover {
    background: #f1f5f9;
    color: #1e293b;
  }

  .schema-btn.active {
    background: var(--import-primary);
    color: #fff;
  }

  /* File Upload */
  .file-upload-zone {
    border: 2px dashed var(--import-border);
    border-radius: 0.75rem;
    padding: 2rem;
    text-align: center;
    background: var(--import-bg);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .file-upload-zone:hover {
    border-color: var(--import-primary);
    background: #eff6ff;
  }

  .file-upload-zone.dragover {
    border-color: var(--import-primary);
    background: #dbeafe;
  }

  .file-upload-icon {
    font-size: 2rem;
    margin-bottom: 0.75rem;
  }

  .file-upload-text {
    font-size: 0.875rem;
    color: #64748b;
    margin: 0;
  }

  .file-upload-text strong {
    color: var(--import-primary);
  }

  .file-name-display {
    margin-top: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: #fff;
    border: 1px solid var(--import-border);
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    color: #1e293b;
    display: none;
  }

  .file-name-display.visible {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  /* JSON Editor */
  .json-editor-container {
    position: relative;
  }

  .json-editor {
    width: 100%;
    min-height: 400px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 0.8125rem;
    line-height: 1.5;
    border: 1px solid var(--import-border);
    border-radius: 0.5rem;
    padding: 1rem;
    background: #1e293b;
    color: #e2e8f0;
    resize: vertical;
  }

  .json-editor::placeholder {
    color: #64748b;
  }

  .json-editor:focus {
    outline: none;
    border-color: var(--import-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  /* JSON Stats */
  .json-stats {
    display: flex;
    gap: 1rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }

  .json-stat {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: #64748b;
    background: var(--import-bg);
    padding: 0.375rem 0.625rem;
    border-radius: 999px;
  }

  .json-stat-value {
    font-weight: 600;
    color: #1e293b;
  }

  /* Preview Panel */
  .preview-panel {
    background: #1e293b;
    border-radius: 0.5rem;
    min-height: 400px;
    max-height: 500px;
    overflow: auto;
  }

  .preview-content {
    padding: 1rem;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 0.75rem;
    line-height: 1.6;
    color: #e2e8f0;
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* Syntax Highlighting */
  .json-key {
    color: #7dd3fc;
  }

  .json-string {
    color: #86efac;
  }

  .json-number {
    color: #fcd34d;
  }

  .json-boolean {
    color: #f472b6;
  }

  .json-null {
    color: #f472b6;
  }

  .json-bracket {
    color: #94a3b8;
  }

  /* Validation Status */
  .validation-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
  }

  .validation-status.valid {
    background: #ecfdf5;
    color: #059669;
    border: 1px solid #a7f3d0;
  }

  .validation-status.invalid {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
  }

  .validation-status.empty {
    background: var(--import-bg);
    color: #64748b;
    border: 1px solid var(--import-border);
  }

  /* Action Buttons */
  .import-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .btn-import {
    flex: 1;
    padding: 0.875rem 1.5rem;
    background: var(--import-primary);
    color: #fff;
    border: none;
    border-radius: 0.75rem;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-import:hover:not(:disabled) {
    background: var(--import-primary-hover);
    transform: translateY(-1px);
  }

  .btn-import:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
  }

  .btn-cancel {
    padding: 0.875rem 1.5rem;
    background: #fff;
    color: #475569;
    border: 1px solid var(--import-border);
    border-radius: 0.75rem;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn-cancel:hover {
    background: #f1f5f9;
    border-color: #94a3b8;
  }

  /* Quick Actions */
  .quick-actions {
    display: flex;
    gap: 0.5rem;
  }

  .quick-btn {
    padding: 0.375rem 0.625rem;
    background: #fff;
    border: 1px solid var(--import-border);
    border-radius: 0.375rem;
    font-size: 0.75rem;
    color: #64748b;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .quick-btn:hover {
    background: var(--import-bg);
    color: #1e293b;
  }

  /* Info Box */
  .info-box {
    padding: 0.875rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    line-height: 1.5;
    margin-bottom: 1rem;
  }

  .info-box.blue {
    background: #eff6ff;
    color: #1d4ed8;
    border: 1px solid #bfdbfe;
  }

  .info-box.amber {
    background: #fffbeb;
    color: #b45309;
    border: 1px solid #fde68a;
  }

  /* Schema Examples Toggle */
  .examples-toggle {
    margin-top: 1.5rem;
  }

  .examples-summary {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #475569;
    cursor: pointer;
    padding: 0.75rem 1rem;
    background: #fff;
    border: 1px solid var(--import-border);
    border-radius: 0.75rem;
    transition: all 0.15s ease;
  }

  .examples-summary:hover {
    background: var(--import-bg);
  }

  .examples-content {
    margin-top: 1rem;
    padding: 1.25rem;
    background: #fff;
    border: 1px solid var(--import-border);
    border-radius: 0.75rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="import-container">
  <!-- Header -->
  <div class="import-header">
    <h1 class="import-title">üöÄ {% trans "Import TOEIC Questions from JSON" %}</h1>
    {% if template %}
    <p class="import-subtitle">
      Template: <strong>{{ template.title }}</strong>
    </p>
    {% else %}
    <p class="import-subtitle">
      T·ª± ƒë·ªông t·∫°o ExamTemplate m·ªõi t·ª´ JSON n·∫øu c√≥ <code>test_id</code>
    </p>
    {% endif %}
  </div>

  <form method="post" enctype="multipart/form-data" id="importForm">
    {% csrf_token %}

    <div class="import-layout">
      <!-- Left Panel: Input -->
      <div>
        <div class="import-card">
          <div class="import-card-header">
            <h3 class="import-card-title">
              üìù JSON Input
            </h3>
            <div class="schema-selector">
              <button type="button" class="schema-btn active" data-schema="1.0">v1.0</button>
              <button type="button" class="schema-btn" data-schema="2.1">v2.1</button>
            </div>
          </div>
          <div class="import-card-body">
            <!-- File Upload -->
            <div class="file-upload-zone" id="dropZone">
              <div class="file-upload-icon">üìÅ</div>
              <p class="file-upload-text">
                <strong>Click ƒë·ªÉ ch·ªçn file</strong> ho·∫∑c k√©o th·∫£ file JSON v√†o ƒë√¢y
              </p>
              <input type="file" name="json_file" id="jsonFile" accept=".json,application/json" style="display: none;">
            </div>
            <div class="file-name-display" id="fileNameDisplay">
              <span id="fileName"></span>
              <button type="button" id="clearFile" style="background: none; border: none; cursor: pointer;">‚úï</button>
            </div>

            <!-- Divider -->
            <div style="display: flex; align-items: center; gap: 1rem; margin: 1.25rem 0;">
              <div style="flex: 1; height: 1px; background: var(--import-border);"></div>
              <span style="font-size: 0.75rem; color: #94a3b8; text-transform: uppercase;">ho·∫∑c paste JSON</span>
              <div style="flex: 1; height: 1px; background: var(--import-border);"></div>
            </div>

            <!-- JSON Editor -->
            <div class="json-editor-container">
              <textarea name="json_text" id="jsonEditor" class="json-editor" placeholder='{
  "schema_version": "1.0",
  "test_id": "TOEIC_TEST_01",
  "module": "READING",
  "sections": [...],
  "passages": [...],
  "questions": [...]
}'></textarea>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem;">
              <div class="quick-actions">
                <button type="button" class="quick-btn" id="formatBtn">‚ú® Format</button>
                <button type="button" class="quick-btn" id="clearBtn">üóëÔ∏è Clear</button>
                <button type="button" class="quick-btn" id="sampleBtn">üìã Sample</button>
              </div>
              <div class="json-stats" id="jsonStats">
                <!-- Populated by JS -->
              </div>
            </div>

            <!-- Validation Status -->
            <div class="validation-status empty" id="validationStatus" style="margin-top: 1rem;">
              <span>‚è≥</span> Nh·∫≠p JSON ƒë·ªÉ validate
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Preview -->
      <div>
        <div class="import-card">
          <div class="import-card-header">
            <h3 class="import-card-title">
              üëÅÔ∏è Preview
            </h3>
            <span style="font-size: 0.75rem; color: #64748b;" id="previewInfo">Syntax Highlighted</span>
          </div>
          <div class="import-card-body" style="padding: 0;">
            <div class="preview-panel" id="previewPanel">
              <div class="preview-content" id="previewContent">
                <span style="color: #64748b;">JSON preview s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Import Info -->
        <div style="margin-top: 1rem;">
          {% if auto_create %}
          <div class="info-box blue">
            <strong>‚ÑπÔ∏è Auto-create mode:</strong> H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o ExamTemplate m·ªõi t·ª´ <code>test_id</code> trong
            JSON.
          </div>
          {% endif %}
          <div class="info-box amber">
            <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> H·ªó tr·ª£ schema 1.0 (stem/choices) v√† 2.1 (stem_segments/blanks).
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="import-actions">
      <button type="submit" class="btn-import" id="importBtn" disabled>
        <span>‚¨ÜÔ∏è</span> Import JSON
      </button>
      <a class="btn-cancel"
        href="{% if template %}{% url 'admin:exam_examtemplate_change' template.id %}{% else %}{% url 'admin:exam_examtemplate_changelist' %}{% endif %}">
        Cancel
      </a>
    </div>
  </form>

  <!-- Schema Examples -->
  <details class="examples-toggle">
    <summary class="examples-summary">
      <span>üìö</span> Xem v√≠ d·ª• JSON format
    </summary>
    <div class="examples-content">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <!-- Schema 1.0 -->
        <div>
          <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">Schema 1.0 (stem/choices)</h4>
          <pre
            style="font-size: 0.7rem; background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; max-height: 300px;">{
  "schema_version": "1.0",
  "module": "READING",
  "sections": [{"section_id": "P5", ...}],
  "questions": [{
    "number": 101,
    "section_id": "P5",
    "stem": "The report was ___ by the manager.",
    "choices": [
      {"key": "A", "text": "reviewed"},
      {"key": "B", "text": "reviewing"}
    ],
    "answer_key": "A"
  }]
}</pre>
        </div>
        <!-- Schema 2.1 -->
        <div>
          <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">Schema 2.1 (stem_segments/blanks)
          </h4>
          <pre
            style="font-size: 0.7rem; background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; max-height: 300px;">{
  "schema_version": "2.1",
  "module": "READING",
  "sections": [{"section_id": "P5", ...}],
  "questions": [{
    "number": 101,
    "section_id": "P5",
    "stem_segments": [
      {"type": "text", "text": "The report was "},
      {"type": "blank", "id": "b101"},
      {"type": "text", "text": " by the manager."}
    ],
    "blanks": [{
      "id": "b101",
      "choices": [{"key": "A", "text": "reviewed"}],
      "answer_key": "A"
    }]
  }]
}</pre>
        </div>
      </div>
    </div>
  </details>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const dropZone = document.getElementById('dropZone');
    const jsonFile = document.getElementById('jsonFile');
    const jsonEditor = document.getElementById('jsonEditor');
    const previewContent = document.getElementById('previewContent');
    const validationStatus = document.getElementById('validationStatus');
    const jsonStats = document.getElementById('jsonStats');
    const importBtn = document.getElementById('importBtn');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const fileName = document.getElementById('fileName');
    const schemaBtns = document.querySelectorAll('.schema-btn');

    // Schema selector
    schemaBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        schemaBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // File upload handling
    dropZone.addEventListener('click', () => jsonFile.click());
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        jsonFile.files = e.dataTransfer.files;
        handleFileSelect(e.dataTransfer.files[0]);
      }
    });

    jsonFile.addEventListener('change', function () {
      if (this.files.length) {
        handleFileSelect(this.files[0]);
      }
    });

    function handleFileSelect(file) {
      fileName.textContent = file.name;
      fileNameDisplay.classList.add('visible');

      const reader = new FileReader();
      reader.onload = function (e) {
        jsonEditor.value = e.target.result;
        validateAndPreview();
      };
      reader.readAsText(file);
    }

    document.getElementById('clearFile').addEventListener('click', function () {
      jsonFile.value = '';
      fileNameDisplay.classList.remove('visible');
    });

    // JSON Editor events
    jsonEditor.addEventListener('input', debounce(validateAndPreview, 300));

    // Quick actions
    document.getElementById('formatBtn').addEventListener('click', function () {
      try {
        const parsed = JSON.parse(jsonEditor.value);
        jsonEditor.value = JSON.stringify(parsed, null, 2);
        validateAndPreview();
      } catch (e) {
        // Ignore format errors
      }
    });

    document.getElementById('clearBtn').addEventListener('click', function () {
      jsonEditor.value = '';
      validateAndPreview();
    });

    document.getElementById('sampleBtn').addEventListener('click', function () {
      const activeSchema = document.querySelector('.schema-btn.active').dataset.schema;
      if (activeSchema === '2.1') {
        jsonEditor.value = JSON.stringify({
          "schema_version": "2.1",
          "test_id": "SAMPLE_TEST",
          "module": "READING",
          "sections": [{ "section_id": "P5", "type": "incomplete_sentences", "question_numbers": [101] }],
          "passages": [],
          "questions": [{
            "question_id": "Q101",
            "number": 101,
            "section_id": "P5",
            "stem_segments": [
              { "type": "text", "text": "The meeting was " },
              { "type": "blank", "id": "b101" },
              { "type": "text", "text": " at noon." }
            ],
            "blanks": [{
              "id": "b101",
              "choices": [
                { "key": "A", "text": "scheduled" },
                { "key": "B", "text": "scheduling" },
                { "key": "C", "text": "schedule" },
                { "key": "D", "text": "schedules" }
              ],
              "answer_key": "A"
            }]
          }]
        }, null, 2);
      } else {
        jsonEditor.value = JSON.stringify({
          "schema_version": "1.0",
          "test_id": "SAMPLE_TEST",
          "module": "READING",
          "sections": [{ "section_id": "P5", "type": "incomplete_sentences", "question_numbers": [101] }],
          "passages": [],
          "questions": [{
            "question_id": "Q101",
            "number": 101,
            "section_id": "P5",
            "stem": "The meeting was _____ at noon.",
            "choices": [
              { "key": "A", "text": "scheduled" },
              { "key": "B", "text": "scheduling" },
              { "key": "C", "text": "schedule" },
              { "key": "D", "text": "schedules" }
            ],
            "answer_key": "A"
          }]
        }, null, 2);
      }
      validateAndPreview();
    });

    function validateAndPreview() {
      const text = jsonEditor.value.trim();

      if (!text) {
        previewContent.innerHTML = '<span style="color: #64748b;">JSON preview s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</span>';
        validationStatus.className = 'validation-status empty';
        validationStatus.innerHTML = '<span>‚è≥</span> Nh·∫≠p JSON ƒë·ªÉ validate';
        jsonStats.innerHTML = '';
        importBtn.disabled = true;
        return;
      }

      try {
        const parsed = JSON.parse(text);

        // Syntax highlight
        previewContent.innerHTML = syntaxHighlight(JSON.stringify(parsed, null, 2));

        // Validation
        const issues = validateToeicJson(parsed);
        if (issues.length === 0) {
          validationStatus.className = 'validation-status valid';
          validationStatus.innerHTML = '<span>‚úÖ</span> JSON h·ª£p l·ªá - S·∫µn s√†ng import';
          importBtn.disabled = false;
        } else {
          validationStatus.className = 'validation-status invalid';
          validationStatus.innerHTML = `<span>‚ùå</span> ${issues[0]}`;
          importBtn.disabled = false; // Still allow import, server will validate
        }

        // Stats
        updateStats(parsed);

      } catch (e) {
        previewContent.innerHTML = `<span style="color: #f87171;">‚ùå JSON Parse Error:\n${escapeHtml(e.message)}</span>`;
        validationStatus.className = 'validation-status invalid';
        validationStatus.innerHTML = `<span>‚ùå</span> JSON kh√¥ng h·ª£p l·ªá: ${e.message}`;
        jsonStats.innerHTML = '';
        importBtn.disabled = true;
      }
    }

    function validateToeicJson(data) {
      const issues = [];
      if (!data.schema_version) issues.push('Thi·∫øu schema_version');
      else if (!['1.0', '2.1'].includes(data.schema_version)) issues.push('schema_version ph·∫£i l√† 1.0 ho·∫∑c 2.1');
      if (!data.module) issues.push('Thi·∫øu module');
      else if (!['READING', 'LISTENING'].includes(data.module.toUpperCase())) issues.push('module ph·∫£i l√† READING ho·∫∑c LISTENING');
      if (!data.sections || !Array.isArray(data.sections)) issues.push('Thi·∫øu sections array');
      if (!data.questions || !Array.isArray(data.questions)) issues.push('Thi·∫øu questions array');
      return issues;
    }

    function updateStats(data) {
      const stats = [];
      if (data.schema_version) stats.push(`<div class="json-stat"><span>Version:</span><span class="json-stat-value">${data.schema_version}</span></div>`);
      if (data.module) stats.push(`<div class="json-stat"><span>Module:</span><span class="json-stat-value">${data.module}</span></div>`);
      if (data.questions) stats.push(`<div class="json-stat"><span>Questions:</span><span class="json-stat-value">${data.questions.length}</span></div>`);
      if (data.passages) stats.push(`<div class="json-stat"><span>Passages:</span><span class="json-stat-value">${data.passages.length}</span></div>`);
      jsonStats.innerHTML = stats.join('');
    }

    function syntaxHighlight(json) {
      json = escapeHtml(json);
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      }).replace(/[\[\]{}]/g, '<span class="json-bracket">$&</span>');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Initial validation
    validateAndPreview();
  });
</script>
{% endblock %}