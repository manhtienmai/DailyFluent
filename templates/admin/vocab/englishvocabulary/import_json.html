{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}Import English Vocabulary JSON{% endblock %}

{% block content %}
<div class="max-w-5xl">
  <div class="mb-4">
    <h1 class="text-2xl font-semibold text-slate-900">{% trans "Import English Vocabulary from JSON" %}</h1>
    <p class="mt-1 text-sm text-slate-600">
      {% trans "Paste JSON array or single object, or upload a .json file. Required fields: en_word, vi_meaning." %}
    </p>
  </div>

  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
    <form method="post" enctype="multipart/form-data" novalidate class="space-y-4">
      {% csrf_token %}

      <div>
        <label for="id_json_file" class="block text-sm font-semibold text-slate-800 mb-1">{% trans "JSON file (optional)" %}</label>
        <input type="file" name="json_file" id="id_json_file" accept="application/json,.json"
               class="block w-full text-sm">
        <p class="mt-1 text-xs text-slate-500">{% trans "If you upload a file, you can leave the textarea empty." %}</p>
      </div>

      <div>
        <label for="id_payload" class="block text-sm font-semibold text-slate-800 mb-1">{% trans "JSON data (paste)" %}</label>
        <textarea name="payload" id="id_payload" rows="14"
                  class="w-full font-mono text-xs sm:text-sm rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >{{ payload|default:"" }}</textarea>
      </div>

      <div class="grid sm:grid-cols-3 gap-3">
        <div class="sm:col-span-1">
          <label for="id_course_id" class="block text-sm font-medium text-slate-700 mb-1">Course</label>
          <select name="course_id" id="id_course_id" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
            <option value="">-- Chọn course (optional) --</option>
            {% for c in courses %}
              <option value="{{ c.id }}" {% if selected_course_id|default:"" == c.id|stringformat:"s" %}selected{% endif %}>{{ c.title }}</option>
            {% endfor %}
          </select>
          <div class="mt-2">
            <label for="id_new_course_title" class="block text-xs font-semibold text-slate-600 mb-1">Hoặc tạo course mới</label>
            <div class="flex items-center gap-2">
              <input type="text" name="new_course_title" id="id_new_course_title" value="{{ new_course_title|default:"" }}"
                     class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm"
                     placeholder="IELTS, TOEIC...">
              <button id="btnCreateCourse" type="button"
                      class="shrink-0 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800">
                Tạo course
              </button>
            </div>
          </div>
        </div>

        <div class="sm:col-span-1">
          <label for="id_section_id" class="block text-sm font-medium text-slate-700 mb-1">Section / Part</label>
          <select name="section_id" id="id_section_id" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
            <option value="">-- Chọn section (optional) --</option>
            {% for s in sections %}
              <option value="{{ s.id }}"
                      data-course="{{ s.course_id }}"
                      {% if selected_section_id|default:"" == s.id|stringformat:"s" %}selected{% endif %}>
                {{ s.course.title }} — {{ s.title }}
              </option>
            {% endfor %}
          </select>
          <div class="mt-2">
            <label for="id_new_section_title" class="block text-xs font-semibold text-slate-600 mb-1">Hoặc tạo section mới</label>
            <div class="flex items-center gap-2">
              <input type="text" name="new_section_title" id="id_new_section_title" value="{{ new_section_title|default:"" }}"
                     class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm"
                     placeholder="Part 1, Unit A...">
              <button id="btnCreateSection" type="button" disabled
                      class="shrink-0 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed">
                Tạo section
              </button>
            </div>
          </div>
        </div>

        <div class="sm:col-span-1">
          <label for="id_lesson_id" class="block text-sm font-medium text-slate-700 mb-1">Lesson</label>
          <select name="lesson_id" id="id_lesson_id" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
            <option value="">-- Chọn lesson (optional) --</option>
            {% for l in lessons %}
              <option value="{{ l.id }}"
                      data-section="{{ l.section_id|default:'' }}"
                      {% if selected_lesson_id|default:"" == l.id|stringformat:"s" %}selected{% endif %}>
                {% if l.section %}{{ l.section.course.title }} — {{ l.section.title }} — {% endif %}{{ l.title }}
              </option>
            {% endfor %}
          </select>
          <div class="mt-2">
            <label for="id_new_lesson_title" class="block text-xs font-semibold text-slate-600 mb-1">Hoặc tạo lesson mới (sẽ nằm trong section đã chọn)</label>
            <div class="flex items-center gap-2">
              <input type="text" name="new_lesson_title" id="id_new_lesson_title" value="{{ new_lesson_title|default:"" }}"
                     class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm"
                     placeholder="Lesson 1, Unit 2...">
              <button id="btnCreateLesson" type="button" disabled
                      class="shrink-0 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed">
                Tạo lesson
              </button>
            </div>
          </div>
        </div>

        <div>
          <label for="id_default_active" class="block text-sm font-medium text-slate-700 mb-1">{% trans "Set active" %}</label>
          <select name="default_active" id="id_default_active" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
            <option value="true" {% if default_active != "false" %}selected{% endif %}>{% trans "True" %}</option>
            <option value="false" {% if default_active == "false" %}selected{% endif %}>{% trans "False" %}</option>
          </select>
        </div>
      </div>

      {# Backwards-compatible hidden defaults (server uses these after resolving dropdown/new create) #}
      <input type="hidden" name="default_course" value="{{ default_course|default:'' }}">
      <input type="hidden" name="default_section" value="{{ default_section|default:'' }}">
      <input type="hidden" name="default_lesson" value="{{ default_lesson|default:'' }}">

      <div class="flex items-center gap-2 pt-2">
        <button type="submit"
                class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">
          {% trans "Import" %}
        </button>
        <a class="inline-flex items-center justify-center px-4 py-2 rounded-xl border border-slate-200 text-sm font-semibold hover:bg-slate-50"
           href="{% url 'admin:vocab_englishvocabulary_changelist' %}">
          {% trans "Cancel" %}
        </a>
      </div>
    </form>
  </div>

  <details class="mt-4">
    <summary class="cursor-pointer text-sm font-semibold text-slate-700">{% trans "Sample JSON Formats" %}</summary>
    <div class="mt-2 space-y-4">
      <div>
        <p class="text-sm font-medium text-slate-800 mb-2">{% trans "Format mới (khuyến nghị):" %}</p>
        <pre class="whitespace-pre-wrap bg-slate-50 p-4 rounded-2xl border border-slate-200 text-xs overflow-x-auto">[
  {
    "word": "accountant",
    "pos": "noun",
    "pos_candidates": [],
    "meaning_vn": "kế toán",
    "definition_en_simple": "an employee who checks and prepares financial records",
    "pronunciation_uk_ipa": "/əˈkaʊntənt/",
    "examples": [
      {
        "order": 1,
        "context": "finance reporting",
        "sentence_marked": "The ⟦accountant⟧ prepared the monthly expense summary for the finance director this afternoon carefully.",
        "sentence_en": "The accountant prepared the monthly expense summary for the finance director this afternoon carefully.",
        "word_count": 14
      },
      {
        "order": 2,
        "context": "budget adjustment",
        "sentence_marked": "The ⟦accountant⟧ updated the quarterly budget because several travel costs were entered under the wrong category.",
        "sentence_en": "The accountant updated the quarterly budget because several travel costs were entered under the wrong category.",
        "word_count": 16
      }
    ],
    "audio_pack_uuid": "ff6d6065-ea42-4141-a999-d353437b00ea"
  }
]</pre>
        <p class="mt-1 text-xs text-slate-500">
          {% trans "Lưu ý: Sau khi import, bạn sẽ được chuyển đến trang phân chia từ vựng vào các lesson." %}
        </p>
      </div>
      
      <div>
        <p class="text-sm font-medium text-slate-800 mb-2">{% trans "Format cũ (vẫn hỗ trợ):" %}</p>
        <pre class="whitespace-pre-wrap bg-slate-50 p-4 rounded-2xl border border-slate-200 text-xs overflow-x-auto">[
  {
    "en_word": "efficient",
    "phonetic": "/ɪˈfɪʃ.ənt/",
    "vi_meaning": "hiệu quả",
    "en_definition": "working well without wasting time or energy",
    "lesson": "Lesson 1",
    "course": "General English",
    "notes": "Often used in work context",
    "examples": [
      { "order": 0, "en": "This is a very efficient way to learn.", "vi": "Đây là một cách học rất hiệu quả." },
      { "order": 1, "en": "We need a more efficient process.", "vi": "Chúng ta cần một quy trình hiệu quả hơn." }
    ]
  }
]</pre>
      </div>
    </div>
  </details>
</div>

<script>
  (function () {
    var courseSel = document.getElementById('id_course_id');
    var sectionSel = document.getElementById('id_section_id');
    var lessonSel = document.getElementById('id_lesson_id');
    var btnCreateCourse = document.getElementById('btnCreateCourse');
    var btnCreateSection = document.getElementById('btnCreateSection');
    var btnCreateLesson = document.getElementById('btnCreateLesson');
    var newCourseInput = document.getElementById('id_new_course_title');
    var newSectionInput = document.getElementById('id_new_section_title');
    var newLessonInput = document.getElementById('id_new_lesson_title');
    if (!courseSel || !sectionSel || !lessonSel) return;

    function getCookie(name) {
      var value = "; " + document.cookie;
      var parts = value.split("; " + name + "=");
      if (parts.length === 2) return parts.pop().split(";").shift();
      return "";
    }

    function filterSections() {
      var courseId = courseSel.value;
      var opts = sectionSel.querySelectorAll('option[data-course]');
      opts.forEach(function (opt) {
        if (!courseId) {
          opt.hidden = false;
          return;
        }
        opt.hidden = (String(opt.getAttribute('data-course') || '') !== String(courseId));
      });

      var selectedOpt = sectionSel.options[sectionSel.selectedIndex];
      if (selectedOpt && selectedOpt.hidden) {
        sectionSel.value = '';
      }

      if (btnCreateSection) {
        btnCreateSection.disabled = !courseId;
      }
    }

    function filterLessons() {
      var sectionId = sectionSel.value;
      var opts = lessonSel.querySelectorAll('option[data-section]');
      opts.forEach(function (opt) {
        if (!sectionId) {
          opt.hidden = false;
          return;
        }
        opt.hidden = (String(opt.getAttribute('data-section') || '') !== String(sectionId));
      });
      var selectedOpt = lessonSel.options[lessonSel.selectedIndex];
      if (selectedOpt && selectedOpt.hidden) {
        lessonSel.value = '';
      }
      if (btnCreateLesson) {
        btnCreateLesson.disabled = !sectionId;
      }
    }

    courseSel.addEventListener('change', function () {
      filterSections();
      filterLessons();
    });
    sectionSel.addEventListener('change', filterLessons);
    filterSections();
    filterLessons();

    function addOption(selectEl, value, label, extraAttrs) {
      var opt = document.createElement('option');
      opt.value = String(value);
      opt.textContent = label;
      if (extraAttrs) {
        Object.keys(extraAttrs).forEach(function (k) {
          opt.setAttribute(k, extraAttrs[k]);
        });
      }
      selectEl.appendChild(opt);
      return opt;
    }

    async function postForm(url, data) {
      var resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams(data).toString()
      });
      var json = await resp.json().catch(function () { return {}; });
      if (!resp.ok) {
        throw new Error(json.error || 'Request failed');
      }
      return json;
    }

    if (btnCreateCourse) {
      btnCreateCourse.addEventListener('click', async function () {
        var title = (newCourseInput && newCourseInput.value || '').trim();
        if (!title) {
          alert('Nhập tên course trước.');
          return;
        }
        btnCreateCourse.disabled = true;
        try {
          var data = await postForm("{% url 'admin:vocab_englishvocabulary_create_course_api' %}", { title: title });
          // If course already exists in dropdown, just select it
          var existing = courseSel.querySelector('option[value="' + data.id + '"]');
          if (!existing) {
            addOption(courseSel, data.id, data.title);
          }
          courseSel.value = String(data.id);
          if (newCourseInput) newCourseInput.value = '';
          filterSections();
          filterLessons();
        } catch (e) {
          alert(e.message || 'Không thể tạo course');
        } finally {
          btnCreateCourse.disabled = false;
        }
      });
    }

    if (btnCreateSection) {
      btnCreateSection.addEventListener('click', async function () {
        var courseId = courseSel.value;
        if (!courseId) {
          alert('Hãy chọn/tạo course trước.');
          return;
        }
        var title = (newSectionInput && newSectionInput.value || '').trim();
        if (!title) {
          alert('Nhập tên section trước.');
          return;
        }
        btnCreateSection.disabled = true;
        try {
          var data = await postForm("{% url 'admin:vocab_englishvocabulary_create_section_api' %}", { title: title, course_id: courseId });
          var label = (data.course_title ? (data.course_title + ' — ') : '') + data.title;
          var existing = sectionSel.querySelector('option[value="' + data.id + '"]');
          if (!existing) {
            addOption(sectionSel, data.id, label, { 'data-course': String(data.course_id || '') });
          }
          sectionSel.value = String(data.id);
          if (newSectionInput) newSectionInput.value = '';
          filterLessons();
        } catch (e) {
          alert(e.message || 'Không thể tạo section');
        } finally {
          btnCreateSection.disabled = false;
          filterSections();
        }
      });
    }

    if (btnCreateLesson) {
      btnCreateLesson.addEventListener('click', async function () {
        var courseId = courseSel.value;
        var sectionId = sectionSel.value;
        if (!courseId || !sectionId) {
          alert('Hãy chọn/tạo course và section trước.');
          return;
        }
        var title = (newLessonInput && newLessonInput.value || '').trim();
        if (!title) {
          alert('Nhập tên lesson trước.');
          return;
        }
        btnCreateLesson.disabled = true;
        try {
          var data = await postForm("{% url 'admin:vocab_englishvocabulary_create_lesson_api' %}", { title: title, course_id: courseId, section_id: sectionId });
          // Add lesson option and select it
          var label = (data.course_title ? (data.course_title + ' — ') : '') + (data.section_title ? (data.section_title + ' — ') : '') + data.title;
          var existing = lessonSel.querySelector('option[value="' + data.id + '"]');
          if (!existing) {
            addOption(lessonSel, data.id, label, { 'data-section': String(data.section_id || '') });
          }
          lessonSel.value = String(data.id);
          if (newLessonInput) newLessonInput.value = '';
          filterLessons();
        } catch (e) {
          alert(e.message || 'Không thể tạo lesson');
        } finally {
          btnCreateLesson.disabled = false;
        }
      });
    }
  })();
</script>
{% endblock %}


