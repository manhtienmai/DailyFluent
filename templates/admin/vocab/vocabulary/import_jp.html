{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
    {{ block.super }}
    <style>
        /* ===== Layout ===== */
        .ij * { box-sizing: border-box; }
        .ij {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* ===== Import Sections ===== */
        .ij-section {
            background: var(--body-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }
        [data-theme="dark"] .ij-section {
            background: #1a1d23;
            border-color: #2d3139;
        }
        .ij-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }
        .ij-section-num {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8125rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .ij-section-title {
            font-size: 0.9375rem;
            font-weight: 700;
            color: var(--body-fg);
        }
        [data-theme="dark"] .ij-section-title {
            color: #e2e8f0;
        }
        .ij-section-desc {
            font-size: 0.75rem;
            color: var(--body-quiet-color);
            margin-left: auto;
        }
        [data-theme="dark"] .ij-section-desc {
            color: #94a3b8;
        }
        
        /* ===== Collection + Set Row ===== */
        .ij-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .ij-field {
            flex: 1;
            min-width: 200px;
        }
        .ij-field label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--body-quiet-color);
            margin-bottom: 4px;
        }
        [data-theme="dark"] .ij-field label {
            color: #cbd5e1;
        }
        .ij-field select,
        .ij-field input {
            width: 100%;
            padding: 8px 10px;
            font-size: 0.8125rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--body-bg);
            color: var(--body-fg);
        }
        [data-theme="dark"] .ij-field select,
        [data-theme="dark"] .ij-field input {
            background: #0f1115;
            border-color: #2d3139;
            color: #e2e8f0;
        }
        .ij-field select:focus,
        .ij-field input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .ij-field .help {
            font-size: 0.6875rem;
            color: var(--body-quiet-color);
            margin-top: 3px;
        }
        [data-theme="dark"] .ij-field .help {
            color: #64748b;
        }
        
        /* ===== Buttons ===== */
        .ij-btn-create {
            padding: 8px 14px;
            font-size: 0.8125rem;
            font-weight: 600;
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }
        .ij-btn-create:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        .ij-btn-source {
            padding: 8px 14px;
            font-size: 0.8125rem;
            font-weight: 600;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
        }
        .ij-btn-source:hover {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
        }
        
        /* ===== Collection Info Box ===== */
        .ij-info {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.8125rem;
            color: #166534;
            display: none;
            align-items: center;
            gap: 8px;
        }
        [data-theme="dark"] .ij-info {
            background: #0c1f17;
            border-color: #1e4430;
            color: #6ee7b7;
        }
        .ij-info.show { display: flex; }
        .ij-info-icon { font-size: 1.125rem; }
        .ij-info strong { font-weight: 700; }
        
        /* ===== New Set Input ===== */
        .ij-new-set {
            display: none;
            gap: 8px;
            align-items: flex-end;
        }
        .ij-new-set.show { display: flex; }
        
        /* ===== Drop Zone ===== */
        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            background: var(--darkened-bg);
        }
        [data-theme="dark"] .drop-zone {
            background: #0f1115;
            border-color: #2d3139;
        }
        .drop-zone:hover { border-color: #6366f1; background: #f5f3ff; }
        [data-theme="dark"] .drop-zone:hover { background: #1e1b2e; }
        .drop-zone.drag-over { border-color: #6366f1; background: #ede9fe; box-shadow: 0 0 0 3px rgba(99,102,241,0.15); }
        [data-theme="dark"] .drop-zone.drag-over { background: #2a2438; }
        .drop-zone.has-file { border-color: #10b981; background: #f0fdf4; border-style: solid; }
        [data-theme="dark"] .drop-zone.has-file { background: #0c1f17; border-color: #1e4430; }
        .drop-zone-icon { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; }
        .drop-zone-text { color: var(--body-quiet-color); font-size: 0.875rem; line-height: 1.5; }
        [data-theme="dark"] .drop-zone-text { color: #94a3b8; }
        .drop-zone-text strong { color: #6366f1; }
        .drop-zone-file { display: none; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem; color: #166534; font-weight: 600; }
        [data-theme="dark"] .drop-zone-file { color: #6ee7b7; }
        .drop-zone.has-file .drop-zone-prompt { display: none; }
        .drop-zone.has-file .drop-zone-file { display: flex; }
        .drop-zone-remove { background: none; border: 1px solid var(--border-color); border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 0.75rem; color: var(--body-quiet-color); margin-left: 0.5rem; }
        [data-theme="dark"] .drop-zone-remove { border-color: #2d3139; color: #64748b; }
        .drop-zone-remove:hover { border-color: #ef4444; color: #ef4444; }
        .drop-zone input[type="file"] { display: none; }
        
        .input-separator {
            text-align: center; color: var(--body-quiet-color); font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 10px;
        }
        [data-theme="dark"] .input-separator { color: #64748b; }
        textarea {
            width: 100%; height: 250px; font-family: monospace; font-size: 0.8125rem;
            padding: 10px; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 8px;
            background: var(--body-bg); color: var(--body-fg);
        }
        [data-theme="dark"] textarea {
            background: #0f1115;
            border-color: #2d3139;
            color: #e2e8f0;
        }
        textarea:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        
        /* ===== Submit ===== */
        .ij-submit {
            padding: 12px 32px;
            font-size: 0.9375rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(99,102,241,0.3);
            transition: all 0.15s;
        }
        .ij-submit:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99,102,241,0.4); }
        
        /* ===== Modal ===== */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 1000; align-items: center; justify-content: center;
        }
        [data-theme="dark"] .modal-overlay { background: rgba(0,0,0,0.75); }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background: var(--body-bg); border-radius: 12px; padding: 24px; width: 100%;
            max-width: 480px; box-shadow: 0 20px 50px rgba(0,0,0,0.25);
        }
        [data-theme="dark"] .modal-box {
            background: #1a1d23;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
        }
        [data-theme="dark"] .modal-header { border-color: #2d3139; }
        .modal-header h3 { margin: 0; font-size: 1rem; color: var(--body-fg); }
        [data-theme="dark"] .modal-header h3 { color: #e2e8f0; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--body-quiet-color); line-height: 1; }
        [data-theme="dark"] .modal-close { color: #64748b; }
        .modal-close:hover { color: #ef4444; }
        .modal-row { margin-bottom: 14px; }
        .modal-row label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--body-quiet-color); margin-bottom: 4px; }
        [data-theme="dark"] .modal-row label { color: #cbd5e1; }
        .modal-row input, .modal-row select { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8125rem; background: var(--body-bg); color: var(--body-fg); }
        [data-theme="dark"] .modal-row input,
        [data-theme="dark"] .modal-row select { background: #0f1115; border-color: #2d3139; color: #e2e8f0; }
        .modal-row input:focus, .modal-row select:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        .modal-row .help { font-size: 0.6875rem; color: var(--body-quiet-color); margin-top: 3px; }
        [data-theme="dark"] .modal-row .help { color: #64748b; }
        .modal-inline { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-color); }
        [data-theme="dark"] .modal-actions { border-color: #2d3139; }
        .modal-btn-cancel { padding: 8px 16px; background: var(--darkened-bg); color: var(--body-fg); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 500; }
        [data-theme="dark"] .modal-btn-cancel { background: #0f1115; color: #cbd5e1; border-color: #2d3139; }
        .modal-btn-cancel:hover { background: var(--border-color); }
        [data-theme="dark"] .modal-btn-cancel:hover { background: #1a1d23; }
        .modal-btn-save { padding: 8px 20px; background: linear-gradient(135deg, #10b981, #059669); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .modal-btn-save:hover { background: linear-gradient(135deg, #059669, #047857); }
    </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label='vocab' %}">Vocab</a>
&rsaquo; <a href="{% url 'admin:vocab_vocabulary_changelist' %}">Vocabulary</a>
&rsaquo; Import Japanese
</div>
{% endblock %}

{% block content %}
<div id="content-main" class="ij">
    <form method="post" id="import-form" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Section 1: Ch·ªçn b·ªô t·ª´ v·ª±ng -->
        <div class="ij-section">
            <div class="ij-section-header">
                <div class="ij-section-num">1</div>
                <div class="ij-section-title">Ch·ªçn b·ªô t·ª´ v·ª±ng</div>
                <div class="ij-section-desc">T·ª´ v·ª±ng import s·∫Ω thu·ªôc b·ªô n√†y</div>
            </div>
            
            <div class="ij-row">
                <div class="ij-field" style="flex: 2;">
                    <label for="collection">B·ªô t·ª´ v·ª±ng (Collection)</label>
                    <select name="collection" id="collection">
                        <option value="">-- Ch·ªçn b·ªô t·ª´ v·ª±ng --</option>
                        {% for col in collections %}
                        <option value="{{ col.id }}" data-name="{{ col.name }}" data-type="{{ col.source_type }}" data-lang="{{ col.language }}">
                            üìö {{ col.name }} {% if col.level %}({{ col.level }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="help">B·ªô = nh√≥m ch·ª©a nhi·ªÅu set. VD: "Mimikara N2" ch·ª©a Set 1, Set 2...</div>
                </div>
                <button type="button" class="ij-btn-create" id="btn-create-collection" style="margin-bottom: 4px;">+ T·∫°o b·ªô m·ªõi</button>
            </div>
            
            <!-- Info box when collection selected -->
            <div class="ij-info" id="collection-info">
                <span class="ij-info-icon">üìö</span>
                <span>ƒê√£ ch·ªçn b·ªô: <strong id="collection-info-name"></strong>. Ch·ªçn set c·ª• th·ªÉ ho·∫∑c t·∫°o set m·ªõi b√™n d∆∞·ªõi.</span>
            </div>
            
            <!-- Auto-group checkbox -->
            <div class="ij-row" id="auto-group-row" style="display: none;">
                <div class="ij-field" style="flex: 2;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.8125rem; font-weight: 600; color: #1e293b; padding: 10px 14px; background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px;">
                        <input type="checkbox" name="auto_group" id="auto_group" checked style="width: 18px; height: 18px; accent-color: #6366f1;">
                        <span>
                            T·ª± ƒë·ªông t·∫°o set theo ch∆∞∆°ng/ch·ªß ƒë·ªÅ
                            <span style="display: block; font-size: 0.6875rem; font-weight: 400; color: #92400e; margin-top: 2px;">
                                M·ªói metadata.lesson kh√°c nhau ‚Üí 1 set ri√™ng. Chapter/section t·ª± detect t·ª´ t√™n file.
                            </span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- Set selector (appears when collection is chosen AND auto-group is off) -->
            <div class="ij-row" id="set-row" style="display: none;">
                <div class="ij-field" style="flex: 2;">
                    <label for="vocab_set">Set t·ª´ v·ª±ng trong b·ªô</label>
                    <select name="vocab_set" id="vocab_set">
                        <option value="">üÜï T·∫°o set m·ªõi t·ª± ƒë·ªông</option>
                    </select>
                    <div class="help">Ch·ªçn set c√≥ s·∫µn ho·∫∑c ƒë·ªÉ "T·∫°o set m·ªõi t·ª± ƒë·ªông" - h·ªá th·ªëng s·∫Ω t·∫°o set m·ªõi khi import</div>
                </div>
            </div>
            
            <!-- New set name (when auto-create, single set mode) -->
            <div class="ij-new-set" id="new-set-row">
                <div class="ij-field" style="flex: 2;">
                    <label for="new_set_title">T√™n set m·ªõi (optional)</label>
                    <input type="text" name="new_set_title" id="new_set_title" placeholder="VD: B√†i 1 - ƒê·ªông t·ª´ c∆° b·∫£n (ƒë·ªÉ tr·ªëng = t·ª± ƒë·ªông t·∫°o)">
                    <div class="help">N·∫øu ƒë·ªÉ tr·ªëng, t√™n set s·∫Ω l√† "T√™n b·ªô - Import ng√†y/th√°ng/nƒÉm"</div>
                </div>
            </div>
        </div>

        <!-- Section 2: C·∫•u h√¨nh -->
        <div class="ij-section">
            <div class="ij-section-header">
                <div class="ij-section-num">2</div>
                <div class="ij-section-title">C·∫•u h√¨nh Import</div>
            </div>
            
            <div class="ij-row">
                <div class="ij-field">
                    <label for="source">Source (ngu·ªìn v√≠ d·ª•)</label>
                    <div style="display: flex; gap: 8px;">
                        <select name="source" id="source" style="flex: 1;">
                            {% for col in collections %}
                            <option value="{{ col.code }}" {% if col.code == "mimikara_n2" %}selected{% endif %}>{{ col.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="help">Ngu·ªìn g·ªëc c·ªßa c√¢u v√≠ d·ª• (s√°ch/t·ª´ ƒëi·ªÉn)</div>
                </div>
                <div class="ij-field" style="max-width: 160px;">
                    <label for="default_pos">Default POS</label>
                    <select name="default_pos" id="default_pos">
                        <option value="noun" selected>noun</option>
                        <option value="verb">verb</option>
                        <option value="adj">adj</option>
                        <option value="adv">adv</option>
                        <option value="expression">expression</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Section 3: D·ªØ li·ªáu -->
        <div class="ij-section">
            <div class="ij-section-header">
                <div class="ij-section-num">3</div>
                <div class="ij-section-title">D·ªØ li·ªáu Import</div>
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 0.75rem; font-weight: 600; color: #475569; margin-bottom: 4px;">JSON Files</label>
                <div class="drop-zone" id="drop-zone">
                    <input type="file" name="json_files" id="file-input" accept=".json,application/json" multiple />
                    <div class="drop-zone-prompt">
                        <div class="drop-zone-icon">üìÑ</div>
                        <div class="drop-zone-text">
                            K√©o th·∫£ file JSON v√†o ƒë√¢y ho·∫∑c <strong>nh·∫•n ƒë·ªÉ ch·ªçn</strong>
                        </div>
                    </div>
                    <div class="drop-zone-file-list" id="file-list"></div>
                </div>
                <div class="input-separator">ho·∫∑c nh·∫≠p tr·ª±c ti·∫øp</div>
            </div>

            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <label style="font-size: 0.75rem; font-weight: 600; color: #475569;">JSON Data (Optional)</label>
                    <button type="button" id="load-sample" style="padding: 4px 10px; font-size: 0.75rem; cursor: pointer; background: #f1f5f9; border: 1px solid #d1d5db; border-radius: 4px; color: #475569;">Load Sample</button>
                </div>
                <textarea name="json_data" id="json_data">{{ json_data }}</textarea>
            </div>
        </div>

        <!-- Submit -->
        <div style="text-align: center; padding: 8px 0;">
            <button type="submit" class="ij-submit">üì• Import Japanese Vocabulary</button>
        </div>
    </form>
</div>

<!-- Modal: T·∫°o b·ªô t·ª´ v·ª±ng m·ªõi -->
<div class="modal-overlay" id="modal-collection">
    <div class="modal-box">
        <div class="modal-header">
            <h3>üìö T·∫°o b·ªô t·ª´ v·ª±ng m·ªõi</h3>
            <button type="button" class="modal-close" onclick="closeModal('modal-collection')">&times;</button>
        </div>
        
        <div class="modal-row">
            <label>T√™n b·ªô t·ª´ v·ª±ng *</label>
            <input type="text" id="mc-name" placeholder="VD: Shinkanzen Master N2, Minna N5...">
        </div>
        
        <div class="modal-row">
            <label>M√£ code *</label>
            <input type="text" id="mc-code" placeholder="T·ª± t·∫°o t·ª´ t√™n">
            <div class="help">Ch·ªâ ch·ªØ th∆∞·ªùng, s·ªë, underscore</div>
        </div>
        
        <div class="modal-inline">
            <div class="modal-row">
                <label>Lo·∫°i</label>
                <select id="mc-type">
                    {% for value, label in source_types %}
                    <option value="{{ value }}" {% if value == 'book' %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-row">
                <label>Ng√¥n ng·ªØ</label>
                <select id="mc-lang">
                    <option value="jp" selected>Japanese</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
        
        <div class="modal-row">
            <label>C·∫•p ƒë·ªô (optional)</label>
            <input type="text" id="mc-level" placeholder="VD: N2, N3, B2...">
        </div>
        
        <div class="modal-actions">
            <button type="button" class="modal-btn-cancel" onclick="closeModal('modal-collection')">H·ªßy</button>
            <button type="button" class="modal-btn-save" id="btn-save-collection">üìö T·∫°o b·ªô</button>
        </div>
    </div>
</div>

<script>
(function() {
    // ===== Helpers =====
    function getCookie(name) {
        const v = "; " + document.cookie;
        const p = v.split("; " + name + "=");
        if (p.length === 2) return p.pop().split(";").shift();
        return "";
    }
    
    window.closeModal = function(id) {
        document.getElementById(id).classList.remove('show');
    };
    
    // ===== All sets data (for filtering by collection) =====
    const allSets = [
        {% for vs in vocab_sets %}
        { id: {{ vs.id }}, title: "{{ vs.title|escapejs }}", collectionId: {{ vs.collection_id|default:"null" }}, wordCount: {{ vs.word_count }} },
        {% endfor %}
    ];
    
    // ===== Collection select logic =====
    const collectionSelect = document.getElementById('collection');
    const vocabSetSelect = document.getElementById('vocab_set');
    const setRow = document.getElementById('set-row');
    const newSetRow = document.getElementById('new-set-row');
    const autoGroupRow = document.getElementById('auto-group-row');
    const autoGroupCheck = document.getElementById('auto_group');
    const collectionInfo = document.getElementById('collection-info');
    const collectionInfoName = document.getElementById('collection-info-name');
    const sourceSelect = document.getElementById('source');
    
    function updateSetVisibility() {
        const colId = collectionSelect.value;
        const isAutoGroup = autoGroupCheck.checked;
        
        if (colId) {
            autoGroupRow.style.display = '';
            
            if (isAutoGroup) {
                // Auto-group mode: hide set selector and new set name
                setRow.style.display = 'none';
                newSetRow.classList.remove('show');
            } else {
                // Manual mode: show set selector
                setRow.style.display = '';
                if (!vocabSetSelect.value) {
                    newSetRow.classList.add('show');
                }
            }
        } else {
            autoGroupRow.style.display = 'none';
            setRow.style.display = 'none';
            newSetRow.classList.remove('show');
        }
    }
    
    collectionSelect.addEventListener('change', () => {
        const colId = collectionSelect.value;
        
        if (colId) {
            // Show info
            const opt = collectionSelect.options[collectionSelect.selectedIndex];
            collectionInfoName.textContent = opt.dataset.name;
            collectionInfo.classList.add('show');
            
            // Filter sets for this collection
            vocabSetSelect.innerHTML = '<option value="">üÜï T·∫°o set m·ªõi t·ª± ƒë·ªông</option>';
            allSets.filter(s => String(s.collectionId) === colId).forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.title} (${s.wordCount} t·ª´)`;
                vocabSetSelect.appendChild(opt);
            });
            
            // Auto-select matching source
            const colCode = opt.dataset.name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
            for (let i = 0; i < sourceSelect.options.length; i++) {
                if (sourceSelect.options[i].value.includes(colCode.substring(0, 8))) {
                    sourceSelect.selectedIndex = i;
                    break;
                }
            }
        } else {
            collectionInfo.classList.remove('show');
        }
        
        updateSetVisibility();
    });
    
    autoGroupCheck.addEventListener('change', updateSetVisibility);
    
    vocabSetSelect.addEventListener('change', () => {
        if (vocabSetSelect.value) {
            // Specific set selected ‚Üí disable auto-group
            autoGroupCheck.checked = false;
            newSetRow.classList.remove('show');
        } else {
            newSetRow.classList.add('show');
        }
        updateSetVisibility();
    });
    
    // ===== Create Collection Modal =====
    document.getElementById('btn-create-collection').addEventListener('click', () => {
        document.getElementById('modal-collection').classList.add('show');
        document.getElementById('mc-name').focus();
    });
    
    document.getElementById('modal-collection').addEventListener('click', (e) => {
        if (e.target.id === 'modal-collection') closeModal('modal-collection');
    });
    
    // Auto-generate code
    document.getElementById('mc-name').addEventListener('input', () => {
        const codeInput = document.getElementById('mc-code');
        if (!codeInput.dataset.manual) {
            codeInput.value = document.getElementById('mc-name').value.trim().toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
        }
    });
    document.getElementById('mc-code').addEventListener('input', () => {
        document.getElementById('mc-code').dataset.manual = 'true';
    });
    
    document.getElementById('btn-save-collection').addEventListener('click', async () => {
        const name = document.getElementById('mc-name').value.trim();
        const code = document.getElementById('mc-code').value.trim();
        
        if (!name) { alert('Nh·∫≠p t√™n b·ªô t·ª´ v·ª±ng'); return; }
        
        const btn = document.getElementById('btn-save-collection');
        btn.disabled = true;
        btn.textContent = 'ƒêang t·∫°o...';
        
        try {
            const fd = new URLSearchParams({
                name: name,
                code: code || name.toLowerCase().replace(/[^a-z0-9]+/g, '_'),
                source_type: document.getElementById('mc-type').value,
                language: document.getElementById('mc-lang').value,
                level: document.getElementById('mc-level').value,
            });
            
            const resp = await fetch("{% url 'admin:vocab_vocabsource_create_api' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCookie('csrftoken') },
                body: fd.toString()
            });
            const data = await resp.json();
            
            if (data.error) {
                alert('L·ªói: ' + data.error);
            } else {
                // Add to collection select
                const opt = document.createElement('option');
                opt.value = data.id;
                opt.textContent = 'üìö ' + data.name;
                opt.dataset.name = data.name;
                opt.selected = true;
                collectionSelect.appendChild(opt);
                
                // Also add to source select
                const srcOpt = document.createElement('option');
                srcOpt.value = data.code;
                srcOpt.textContent = data.name;
                sourceSelect.appendChild(srcOpt);
                
                // Trigger change
                collectionSelect.dispatchEvent(new Event('change'));
                
                closeModal('modal-collection');
                document.getElementById('mc-name').value = '';
                document.getElementById('mc-code').value = '';
                document.getElementById('mc-level').value = '';
                delete document.getElementById('mc-code').dataset.manual;
            }
        } catch (e) {
            alert('L·ªói: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'üìö T·∫°o b·ªô';
        }
    });
    
    // ===== Drop Zone =====
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileListEl = document.getElementById('file-list');
    let accumulatedFiles = new DataTransfer();

    dropZone.addEventListener('click', (e) => { if (!e.target.closest('.drop-zone-remove')) fileInput.click(); });
    fileInput.addEventListener('change', () => addFiles(fileInput.files));
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); if (e.dataTransfer.files.length) addFiles(e.dataTransfer.files); });

    function addFiles(files) {
        const existing = new Set();
        for (const f of accumulatedFiles.files) existing.add(f.name + '|' + f.size);
        Array.from(files).forEach(f => { const k = f.name + '|' + f.size; if (!existing.has(k)) { accumulatedFiles.items.add(f); existing.add(k); } });
        fileInput.files = accumulatedFiles.files;
        renderFileList();
    }

    function removeFile(idx) {
        const dt = new DataTransfer();
        const files = accumulatedFiles.files;
        for (let i = 0; i < files.length; i++) if (i !== idx) dt.items.add(files[i]);
        accumulatedFiles = dt;
        fileInput.files = accumulatedFiles.files;
        renderFileList();
    }

    function clearAll() { accumulatedFiles = new DataTransfer(); fileInput.files = accumulatedFiles.files; renderFileList(); }

    function renderFileList() {
        fileListEl.innerHTML = '';
        const files = accumulatedFiles.files;
        if (files.length > 0) {
            dropZone.classList.add('has-file');
            Array.from(files).forEach((f, i) => {
                const d = document.createElement('div');
                d.className = 'drop-zone-file'; d.style.display = 'flex';
                const sz = f.size < 1024 ? f.size + ' B' : f.size < 1048576 ? (f.size/1024).toFixed(1) + ' KB' : (f.size/1048576).toFixed(1) + ' MB';
                d.innerHTML = `<span>üìÑ ${f.name} (${sz})</span><button type="button" class="drop-zone-remove" data-index="${i}" title="Remove">&times;</button>`;
                fileListEl.appendChild(d);
            });
            const cb = document.createElement('div');
            cb.style.cssText = 'text-align:center; margin-top:8px;';
            cb.innerHTML = `<button type="button" id="clear-all-files" style="padding:4px 12px; font-size:0.75rem; cursor:pointer; background:#ef4444; color:#fff; border:none; border-radius:4px;">X√≥a t·∫•t c·∫£ (${files.length})</button>`;
            fileListEl.appendChild(cb);
        } else {
            dropZone.classList.remove('has-file');
        }
    }

    fileListEl.addEventListener('click', (e) => {
        const rb = e.target.closest('.drop-zone-remove');
        if (rb) { e.stopPropagation(); removeFile(parseInt(rb.dataset.index)); return; }
        if (e.target.closest('#clear-all-files')) { e.stopPropagation(); clearAll(); }
    });

    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop', (e) => {
        e.preventDefault();
        const jf = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.json'));
        if (jf.length) { const dt = new DataTransfer(); jf.forEach(f => dt.items.add(f)); addFiles(dt.files); }
    });

    // ===== Load sample =====
    document.getElementById('load-sample').addEventListener('click', () => {
        document.getElementById('json_data').value = JSON.stringify([{
            word_info: { kanji: "ÁµåÈ®ì", reading: "„Åë„ÅÑ„Åë„Çì" },
            meanings: { vietnamese: "kinh nghi·ªám, tr·∫£i nghi·ªám", han_viet: "KINH NGHI·ªÜM" },
            metadata: { lesson: "B√†i 1" },
            part_of_speech: "noun",
            examples: [{ type: "sentence", jp_text: "Êµ∑Â§ñ„ÅßÂÉç„ÅÑ„ÅüÁµåÈ®ì„Åå„ÅÇ„Çã„ÄÇ", vn_text: "T√¥i c√≥ kinh nghi·ªám l√†m vi·ªác ·ªü n∆∞·ªõc ngo√†i." }]
        }], null, 4);
        clearAll();
    });
})();
</script>
{% endblock %}
