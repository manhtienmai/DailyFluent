{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
    {{ block.super }}
    <style>
        textarea {
            width: 100%;
            height: 400px;
            font-family: monospace;
            padding: 10px;
            box-sizing: border-box;
        }
        .submit-row {
            margin-top: 20px;
        }
        .form-row {
            margin-bottom: 15px;
        }
        .form-row label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-row select {
            padding: 6px 10px;
            min-width: 200px;
        }
        .inline-fields {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .result-box {
            background: #dff0d8;
            border: 1px solid #d0e9c6;
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .result-box.error {
            background: #f2dede;
            border-color: #ebccd1;
        }

        /* ===== Drop Zone ===== */
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            background: #fafbfc;
            position: relative;
        }
        .drop-zone:hover {
            border-color: #79aec8;
            background: #f0f7fb;
        }
        .drop-zone.drag-over {
            border-color: #417690;
            background: #e4f0f7;
            box-shadow: 0 0 0 3px rgba(65, 118, 144, 0.15);
        }
        .drop-zone.has-file {
            border-color: #4caf50;
            background: #f1f8e9;
            border-style: solid;
        }
        .drop-zone-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }
        .drop-zone-text {
            color: #666;
            font-size: 0.9375rem;
            line-height: 1.5;
        }
        .drop-zone-text strong {
            color: #417690;
        }
        .drop-zone-file {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9375rem;
            color: #2e7d32;
            font-weight: 600;
        }
        .drop-zone.has-file .drop-zone-prompt { display: none; }
        .drop-zone.has-file .drop-zone-file { display: flex; }
        .drop-zone-remove {
            background: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            color: #999;
            margin-left: 0.5rem;
        }
        .drop-zone-remove:hover {
            border-color: #e53935;
            color: #e53935;
        }
        .drop-zone input[type="file"] {
            display: none;
        }
        .input-separator {
            text-align: center;
            color: #999;
            font-size: 0.8125rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
        }
    </style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label='vocab' %}">Vocab</a>
&rsaquo; <a href="{% url 'admin:vocab_vocabulary_changelist' %}">Vocabulary</a>
&rsaquo; Import Japanese
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <h2>Import Japanese Vocabulary (Mimikara Format)</h2>
        <p>Drag &amp; drop a JSON file or paste JSON data below. Each item should have <code>word_info</code> (kanji, reading), <code>meanings</code> (vietnamese), and <code>examples</code>.</p>

        <form method="post" id="import-form" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="inline-fields">
                <div class="form-row">
                    <label for="vocab_set">Vocabulary Set (optional):</label>
                    <select name="vocab_set" id="vocab_set">
                        <option value="">-- None --</option>
                        {% for vs in vocab_sets %}
                        <option value="{{ vs.id }}">{{ vs.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-row">
                    <label for="source">Source:</label>
                    <select name="source" id="source">
                        {% for value, label in sources %}
                        <option value="{{ value }}" {% if value == "mimikara_n2" %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-row">
                    <label for="default_pos">Default POS:</label>
                    <select name="default_pos" id="default_pos">
                        <option value="noun" selected>noun</option>
                        <option value="verb">verb</option>
                        <option value="adj">adj</option>
                        <option value="adv">adv</option>
                        <option value="expression">expression</option>
                    </select>
                </div>
            </div>

            <!-- Drop Zone -->
            <div class="form-row">
                <label>JSON Files:</label>
                <div class="drop-zone" id="drop-zone">
                    <input type="file" name="json_files" id="file-input" accept=".json,application/json" multiple />
                    <div class="drop-zone-prompt">
                        <div class="drop-zone-icon">&#128196;</div>
                        <div class="drop-zone-text">
                            K√©o th·∫£ nhi·ªÅu file JSON v√†o ƒë√¢y ho·∫∑c <strong>nh·∫•n ƒë·ªÉ ch·ªçn files</strong>
                        </div>
                    </div>
                    <div class="drop-zone-file-list" id="file-list"></div>
                </div>
                <div class="input-separator">ho·∫∑c nh·∫≠p tr·ª±c ti·∫øp</div>
            </div>

            <div class="form-row">
                <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <label for="json_data">JSON Data (Optional):</label>
                    <button type="button" id="load-sample" class="button" style="padding: 5px 10px; cursor: pointer;">Load Sample</button>
                </div>
                <textarea name="json_data" id="json_data">{{ json_data }}</textarea>
                <div class="help" style="margin-top: 5px; color: #666;">
                    JSON array of items with <code>word_info.kanji</code>, <code>meanings.vietnamese</code>, <code>examples[]</code>.
                </div>
            </div>

            <div class="submit-row">
                <input type="submit" value="Import Japanese Vocabulary" class="default" />
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileListEl = document.getElementById('file-list');
    const textarea = document.getElementById('json_data');

    // Accumulator: keep track of all files across multiple selections/drops
    let accumulatedFiles = new DataTransfer();

    // Click to select file
    dropZone.addEventListener('click', function(e) {
        if (e.target.closest('.drop-zone-remove')) return;
        fileInput.click();
    });

    // File selected via input ‚Äî append to accumulated list
    fileInput.addEventListener('change', function() {
        addFiles(fileInput.files);
    });

    // Drag events
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            addFiles(files);
        }
    });

    /**
     * Append new files to the accumulator (skip duplicates by name+size).
     */
    function addFiles(files) {
        const existingNames = new Set();
        for (const f of accumulatedFiles.files) {
            existingNames.add(f.name + '|' + f.size);
        }

        Array.from(files).forEach(f => {
            const key = f.name + '|' + f.size;
            if (!existingNames.has(key)) {
                accumulatedFiles.items.add(f);
                existingNames.add(key);
            }
        });

        // Sync the hidden file input with the accumulated list
        fileInput.files = accumulatedFiles.files;
        renderFileList();
    }

    /**
     * Remove a single file by index and re-render.
     */
    function removeFile(index) {
        const newDT = new DataTransfer();
        const files = accumulatedFiles.files;
        for (let i = 0; i < files.length; i++) {
            if (i !== index) newDT.items.add(files[i]);
        }
        accumulatedFiles = newDT;
        fileInput.files = accumulatedFiles.files;
        renderFileList();
    }

    /**
     * Clear all files.
     */
    function clearAllFiles() {
        accumulatedFiles = new DataTransfer();
        fileInput.files = accumulatedFiles.files;
        renderFileList();
    }

    /**
     * Render the file list UI from accumulatedFiles.
     */
    function renderFileList() {
        fileListEl.innerHTML = '';
        const files = accumulatedFiles.files;

        if (files.length > 0) {
            dropZone.classList.add('has-file');

            Array.from(files).forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'drop-zone-file';
                item.style.display = 'flex';
                item.innerHTML = `
                    <span>üìÑ ${file.name} (${formatSize(file.size)})</span>
                    <button type="button" class="drop-zone-remove" data-index="${index}" title="Remove">&times;</button>
                `;
                fileListEl.appendChild(item);
            });

            // Add "Clear all" button
            const clearBtn = document.createElement('div');
            clearBtn.style.cssText = 'text-align:center; margin-top:8px;';
            clearBtn.innerHTML = `<button type="button" class="button" id="clear-all-files"
                style="padding:4px 12px; font-size:0.8125rem; cursor:pointer; background:#e53935; color:#fff; border:none; border-radius:4px;">
                X√≥a t·∫•t c·∫£ files (${files.length})
            </button>`;
            fileListEl.appendChild(clearBtn);
        } else {
            dropZone.classList.remove('has-file');
        }
    }

    // Delegate click for individual remove buttons & clear-all
    fileListEl.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.drop-zone-remove');
        if (removeBtn) {
            e.stopPropagation();
            const idx = parseInt(removeBtn.dataset.index, 10);
            removeFile(idx);
            return;
        }
        if (e.target.closest('#clear-all-files')) {
            e.stopPropagation();
            clearAllFiles();
        }
    });

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Also support dropping JSON files anywhere on the page
    document.addEventListener('dragover', function(e) { e.preventDefault(); });
    document.addEventListener('drop', function(e) {
        e.preventDefault();
        const files = e.dataTransfer.files;
        const jsonFiles = Array.from(files).filter(f => f.name.endsWith('.json') || f.type === 'application/json');
        if (jsonFiles.length > 0) {
            const dt = new DataTransfer();
            jsonFiles.forEach(f => dt.items.add(f));
            addFiles(dt.files);
        }
    });

    // Load sample button
    document.getElementById('load-sample').addEventListener('click', function() {
        const sample = [
            {
                "word_info": {
                    "kanji": "ÁµåÈ®ì",
                    "reading": "„Åë„ÅÑ„Åë„Çì",
                    "html_display": "<ruby>ÁµåÈ®ì<rt>„Åë„ÅÑ„Åë„Çì</rt></ruby>"
                },
                "meanings": {
                    "vietnamese": "kinh nghi·ªám, tr·∫£i nghi·ªám",
                    "han_viet": "KINH NGHI·ªÜM"
                },
                "metadata": {
                    "lesson": "B√†i 1"
                },
                "part_of_speech": "noun",
                "examples": [
                    {
                        "type": "sentence",
                        "jp_html": "<ruby>Êµ∑Â§ñ<rt>„Åã„ÅÑ„Åå„ÅÑ</rt></ruby>„Åß<ruby>ÂÉç<rt>„ÅØ„Åü„Çâ</rt></ruby>„ÅÑ„Åü<ruby>ÁµåÈ®ì<rt>„Åë„ÅÑ„Åë„Çì</rt></ruby>„Åå„ÅÇ„Çã„ÄÇ",
                        "jp_text": "Êµ∑Â§ñ„ÅßÂÉç„ÅÑ„ÅüÁµåÈ®ì„Åå„ÅÇ„Çã„ÄÇ",
                        "vn_text": "T√¥i c√≥ kinh nghi·ªám l√†m vi·ªác ·ªü n∆∞·ªõc ngo√†i."
                    },
                    {
                        "type": "compound",
                        "label": "T·ª´ gh√©p",
                        "jp_html": "<ruby>ÁµåÈ®ìËÄÖ<rt>„Åë„ÅÑ„Åë„Çì„Åó„ÇÉ</rt></ruby>",
                        "jp_text": "ÁµåÈ®ìËÄÖ",
                        "vn_text": "ng∆∞·ªùi c√≥ kinh nghi·ªám"
                    }
                ]
            }
        ];
        textarea.value = JSON.stringify(sample, null, 4);
        textarea.removeAttribute('readonly');
        clearAllFiles();
    });
})();
</script>
{% endblock %}
