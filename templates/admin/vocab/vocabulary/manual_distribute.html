{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}Manual Vocabulary Distribution{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
  /* Dark Theme Base */
  .vsm * { box-sizing: border-box; }
  
  .vsm {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f172a;
    min-height: calc(100vh - 100px);
    padding: 1rem;
    margin: -20px;
  }
  
  /* Header */
  .vsm-header {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    margin-bottom: 1rem;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.75rem;
  }
  
  .vsm-header h1 {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .vsm-header-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
  }
  
  .vsm-header-stat {
    background: rgba(255,255,255,0.15);
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
  }
  
  .vsm-header-stat strong {
    font-weight: 700;
  }
  
  /* Collection Filter Bar */
  .vsm-filter-bar {
    background: #1e293b;
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    border: 1px solid #334155;
  }
  
  .vsm-filter-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: #94a3b8;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .vsm-filter-select {
    flex: 1;
    max-width: 350px;
    padding: 0.5rem 0.75rem;
    font-size: 0.8125rem;
    border: 1px solid #475569;
    border-radius: 0.5rem;
    background: #0f172a;
    color: #e2e8f0;
    cursor: pointer;
  }
  
  .vsm-filter-select:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
  }
  
  .vsm-filter-select option {
    background: #1e293b;
    color: #e2e8f0;
  }
  
  .vsm-filter-btn {
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 600;
    background: #6366f1;
    color: #fff;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background 0.15s ease;
  }
  
  .vsm-filter-btn:hover {
    background: #4f46e5;
  }
  
  .vsm-filter-btn.clear {
    background: transparent;
    border: 1px solid #475569;
    color: #94a3b8;
  }
  
  .vsm-filter-btn.clear:hover {
    background: #334155;
    color: #e2e8f0;
  }
  
  .vsm-filter-info {
    font-size: 0.75rem;
    color: #64748b;
    margin-left: auto;
  }
  
  .vsm-filter-info strong {
    color: #a5b4fc;
  }
  
  /* Main Layout - 3 columns */
  .vsm-main {
    display: grid;
    grid-template-columns: 280px 1fr 280px;
    gap: 1rem;
    height: calc(100vh - 240px);
    min-height: 500px;
  }
  
  /* Panel Base */
  .vsm-panel {
    background: #1e293b;
    border-radius: 1rem;
    border: 1px solid #334155;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .vsm-panel-header {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid #334155;
    background: #1e293b;
    flex-shrink: 0;
  }
  
  .vsm-panel-title {
    font-size: 0.8125rem;
    font-weight: 700;
    color: #e2e8f0;
    margin: 0 0 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .vsm-panel-count {
    font-size: 0.6875rem;
    font-weight: 600;
    background: #475569;
    color: #e2e8f0;
    padding: 0.125rem 0.5rem;
    border-radius: 1rem;
  }
  
  .vsm-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
  }
  
  /* Custom scrollbar for dark theme */
  .vsm-panel-body::-webkit-scrollbar {
    width: 6px;
  }
  
  .vsm-panel-body::-webkit-scrollbar-track {
    background: #0f172a;
    border-radius: 3px;
  }
  
  .vsm-panel-body::-webkit-scrollbar-thumb {
    background: #475569;
    border-radius: 3px;
  }
  
  .vsm-panel-body::-webkit-scrollbar-thumb:hover {
    background: #64748b;
  }
  
  /* Search Box */
  .vsm-search {
    position: relative;
  }
  
  .vsm-search input {
    width: 100%;
    padding: 0.5rem 0.75rem 0.5rem 2rem;
    font-size: 0.75rem;
    border: 1px solid #475569;
    border-radius: 0.5rem;
    background: #0f172a;
    color: #e2e8f0;
  }
  
  .vsm-search input::placeholder {
    color: #64748b;
  }
  
  .vsm-search input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
  }
  
  .vsm-search-icon {
    position: absolute;
    left: 0.625rem;
    top: 50%;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    color: #64748b;
  }
  
  /* Set Item (Left Panel) */
  .vsm-set-item {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.625rem 0.75rem;
    margin-bottom: 0.25rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.15s ease;
    border: 2px solid transparent;
  }
  
  .vsm-set-item:hover {
    background: #334155;
  }
  
  .vsm-set-item.active {
    background: #3730a3;
    border-color: #6366f1;
  }
  
  .vsm-set-item.drop-target {
    background: #713f12;
    border-color: #fbbf24;
    border-style: dashed;
  }
  
  .vsm-set-icon {
    width: 32px;
    height: 32px;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    color: #fff;
    flex-shrink: 0;
  }
  
  .vsm-set-icon.unassigned {
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
  }
  
  .vsm-set-info {
    flex: 1;
    min-width: 0;
  }
  
  .vsm-set-name {
    font-size: 0.8125rem;
    font-weight: 600;
    color: #e2e8f0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .vsm-set-meta {
    font-size: 0.6875rem;
    color: #64748b;
    margin-top: 0.125rem;
  }
  
  .vsm-set-count {
    font-size: 0.6875rem;
    font-weight: 700;
    background: #475569;
    color: #e2e8f0;
    padding: 0.125rem 0.5rem;
    border-radius: 1rem;
    flex-shrink: 0;
  }
  
  .vsm-set-item.active .vsm-set-count {
    background: #6366f1;
    color: #fff;
  }
  
  /* Add New Set */
  .vsm-add-set {
    display: flex;
    gap: 0.375rem;
    padding: 0.5rem;
    border-top: 1px solid #334155;
    background: #1e293b;
  }
  
  .vsm-add-set input {
    flex: 1;
    padding: 0.5rem 0.625rem;
    font-size: 0.75rem;
    border: 1px solid #475569;
    border-radius: 0.375rem;
    background: #0f172a;
    color: #e2e8f0;
  }
  
  .vsm-add-set input::placeholder {
    color: #64748b;
  }
  
  .vsm-add-set input:focus {
    outline: none;
    border-color: #6366f1;
  }
  
  .vsm-add-set button {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #fff;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.15s ease;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
  }
  
  .vsm-add-set button:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
  }
  
  /* Vocab Item (Center Panel) */
  .vsm-vocab-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.625rem;
    margin-bottom: 0.25rem;
    border-radius: 0.5rem;
    background: #0f172a;
    cursor: grab;
    transition: all 0.15s ease;
    border: 1px solid transparent;
  }
  
  .vsm-vocab-item:hover {
    background: #334155;
    border-color: #475569;
  }
  
  .vsm-vocab-item.selected {
    background: #3730a3;
    border-color: #6366f1;
  }
  
  .vsm-vocab-item.dragging {
    opacity: 0.5;
  }
  
  .vsm-vocab-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: #6366f1;
    flex-shrink: 0;
  }
  
  .vsm-vocab-word {
    font-size: 0.875rem;
    font-weight: 600;
    color: #e2e8f0;
    flex: 1;
    min-width: 0;
  }
  
  .vsm-vocab-extra {
    font-size: 0.6875rem;
    color: #64748b;
    flex: 1;
    min-width: 0;
    text-align: right;
  }
  
  /* Center Panel Toolbar */
  .vsm-toolbar {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
  }
  
  .vsm-toolbar-btn {
    padding: 0.375rem 0.625rem;
    font-size: 0.6875rem;
    font-weight: 600;
    border-radius: 0.375rem;
    border: 1px solid #475569;
    background: transparent;
    color: #94a3b8;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  
  .vsm-toolbar-btn:hover {
    background: #334155;
    border-color: #64748b;
    color: #e2e8f0;
  }
  
  .vsm-toolbar-btn.primary {
    background: #6366f1;
    border-color: #6366f1;
    color: #fff;
  }
  
  .vsm-toolbar-btn.primary:hover:not(:disabled) {
    background: #4f46e5;
  }
  
  .vsm-toolbar-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* Selection Info */
  .vsm-selection-info {
    padding: 0.75rem;
    background: #713f12;
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.75rem;
    color: #fef3c7;
    text-align: center;
    border: 1px solid #a16207;
  }
  
  .vsm-selection-info strong {
    font-weight: 700;
    color: #fbbf24;
  }
  
  /* Target select */
  .vsm-target-select {
    width: 100%;
    padding: 0.5rem 0.625rem;
    font-size: 0.75rem;
    border: 1px solid #475569;
    border-radius: 0.5rem;
    background: #0f172a;
    color: #e2e8f0;
    margin-bottom: 0.5rem;
  }
  
  .vsm-target-select:focus {
    outline: none;
    border-color: #6366f1;
  }
  
  .vsm-target-select option {
    background: #1e293b;
    color: #e2e8f0;
  }
  
  .vsm-move-btn {
    width: 100%;
    padding: 0.75rem;
    font-size: 0.8125rem;
    font-weight: 700;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: #fff;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
  }
  
  .vsm-move-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
  }
  
  .vsm-move-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  /* Quick Create */
  .vsm-quick-create {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #334155;
  }
  
  .vsm-quick-create h4 {
    font-size: 0.6875rem;
    font-weight: 700;
    color: #64748b;
    text-transform: uppercase;
    margin: 0 0 0.5rem;
  }
  
  .vsm-quick-create-row {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    margin-bottom: 0.5rem;
  }
  
  .vsm-quick-create-row label {
    font-size: 0.6875rem;
    font-weight: 600;
    color: #94a3b8;
  }
  
  .vsm-quick-create-row select,
  .vsm-quick-create-row input {
    padding: 0.375rem 0.5rem;
    font-size: 0.75rem;
    border: 1px solid #475569;
    border-radius: 0.375rem;
    background: #0f172a;
    color: #e2e8f0;
  }
  
  .vsm-quick-create-row input::placeholder {
    color: #64748b;
  }
  
  .vsm-quick-create-row select:focus,
  .vsm-quick-create-row input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
  }
  
  .vsm-quick-create-row select option {
    background: #1e293b;
    color: #e2e8f0;
  }
  
  /* Number input spinner styling for dark theme */
  .vsm-quick-create-row input[type="number"]::-webkit-inner-spin-button,
  .vsm-quick-create-row input[type="number"]::-webkit-outer-spin-button {
    opacity: 0.5;
  }
  
  .vsm-create-btn {
    width: 100%;
    padding: 0.625rem;
    font-size: 0.75rem;
    font-weight: 600;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #fff;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.15s ease;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
  }
  
  .vsm-create-btn:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    transform: translateY(-1px);
  }
  
  /* Empty State */
  .vsm-empty {
    text-align: center;
    padding: 2rem 1rem;
    color: #64748b;
  }
  
  .vsm-empty-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }
  
  .vsm-empty p {
    font-size: 0.75rem;
    margin: 0;
  }
  
  /* Toast Notification */
  .vsm-toast {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    padding: 0.75rem 1.25rem;
    background: #334155;
    color: #fff;
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1000;
    opacity: 0;
    transform: translateY(1rem);
    transition: all 0.3s ease;
  }
  
  .vsm-toast.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  .vsm-toast.success {
    background: #10b981;
  }
  
  .vsm-toast.error {
    background: #ef4444;
  }
  
  /* Loading Overlay */
  .vsm-loading {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }
  
  .vsm-loading.show {
    opacity: 1;
    pointer-events: auto;
  }
  
  .vsm-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #475569;
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Back link */
  .vsm-back {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: #64748b;
    text-decoration: none;
    margin-bottom: 0.75rem;
  }
  
  .vsm-back:hover {
    color: #a5b4fc;
  }
  
  /* Responsive */
  @media (max-width: 1024px) {
    .vsm-main {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr auto;
      height: auto;
    }
    
    .vsm-panel-body {
      max-height: 300px;
    }
  }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">Home</a>
  &rsaquo; <a href="{% url 'admin:app_list' app_label='vocab' %}">Vocab</a>
  &rsaquo; <a href="{% url 'admin:vocab_vocabulary_changelist' %}">Vocabulary</a>
  &rsaquo; Manual Distribution
</div>
{% endblock %}

{% block content %}
<div class="vsm">
  <!-- Back Link -->
  <a href="{% url 'admin:vocab_vocabulary_distribute_jp' %}" class="vsm-back">
    ‚Üê Quay l·∫°i Auto-distribute
  </a>
  
  <!-- Header -->
  <div class="vsm-header">
    <h1>üìö Manual Vocabulary Distribution</h1>
    <div class="vsm-header-stats">
      <div class="vsm-header-stat">T·ªïng: <strong id="stat-total">{{ total_vocab }}</strong></div>
      <div class="vsm-header-stat">Ch∆∞a ph√¢n: <strong id="stat-unassigned">{{ unassigned_count }}</strong></div>
    </div>
  </div>
  
  <!-- Collection Filter Bar -->
  <div class="vsm-filter-bar">
    <span class="vsm-filter-label">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
      </svg>
      B·ªô t·ª´ v·ª±ng:
    </span>
    <select id="collection-filter" class="vsm-filter-select">
      <option value="">-- T·∫•t c·∫£ b·ªô t·ª´ v·ª±ng --</option>
      {% for col in collections %}
        <option value="{{ col.id }}" {% if current_collection_id == col.id|stringformat:"s" %}selected{% endif %}>
          {{ col.name }} ({{ col.get_source_type_display }})
        </option>
      {% endfor %}
    </select>
    <button type="button" id="btn-apply-filter" class="vsm-filter-btn">L·ªçc</button>
    {% if current_collection_id %}
    <button type="button" id="btn-clear-filter" class="vsm-filter-btn clear">X√≥a b·ªô l·ªçc</button>
    {% endif %}
    <span class="vsm-filter-info">
      Hi·ªÉn th·ªã <strong>{{ sets|length }}</strong> sets
    </span>
  </div>
  
  <!-- Main 3-Column Layout -->
  <div class="vsm-main">
    <!-- Left Panel: Sets List -->
    <div class="vsm-panel" id="panel-sets">
      <div class="vsm-panel-header">
        <div class="vsm-panel-title">
          Vocabulary Sets
          <span class="vsm-panel-count" id="sets-count">{{ sets|length }}</span>
        </div>
        <div class="vsm-search">
          <svg class="vsm-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" id="search-sets" placeholder="T√¨m set...">
        </div>
      </div>
      
      <div class="vsm-panel-body" id="sets-list">
        <!-- Unassigned special set (only show if not filtering by collection) -->
        {% if not current_collection_id %}
        <div class="vsm-set-item active" data-set-id="unassigned">
          <div class="vsm-set-icon unassigned">‚ö†Ô∏è</div>
          <div class="vsm-set-info">
            <div class="vsm-set-name">Ch∆∞a ph√¢n b·ªï</div>
            <div class="vsm-set-meta">T·ª´ v·ª±ng c·∫ßn assign</div>
          </div>
          <span class="vsm-set-count" id="unassigned-count">{{ unassigned_count }}</span>
        </div>
        {% endif %}
        
        <!-- VocabularySets -->
        {% for set in sets %}
        <div class="vsm-set-item {% if current_collection_id and forloop.first %}active{% endif %}" 
             data-set-id="{{ set.id }}"
             data-set-name="{{ set.title }}"
             data-collection="{{ set.collection_id|default:'' }}"
             data-chapter="{{ set.chapter|default:'' }}">
          <div class="vsm-set-icon">üìñ</div>
          <div class="vsm-set-info">
            <div class="vsm-set-name">{{ set.title }}</div>
            <div class="vsm-set-meta">
              {% if set.chapter %}Ch∆∞∆°ng {{ set.chapter }} ¬∑ {% endif %}{% if set.collection %}{{ set.collection.name }}{% elif set.toeic_level %}TOEIC {{ set.toeic_level }}{% else %}General{% endif %}
            </div>
          </div>
          <span class="vsm-set-count" data-set-id="{{ set.id }}">{{ set.word_count }}</span>
        </div>
        {% endfor %}
      </div>
      
      <!-- Add New Set -->
      <div class="vsm-add-set">
        <input type="text" id="new-set-name" placeholder="T√™n set m·ªõi...">
        <button type="button" id="btn-add-set">+ Th√™m</button>
      </div>
    </div>
    
    <!-- Center Panel: Vocabulary in Selected Set -->
    <div class="vsm-panel" id="panel-vocab" style="position: relative;">
      <div class="vsm-loading" id="vocab-loading">
        <div class="vsm-spinner"></div>
      </div>
      
      <div class="vsm-panel-header">
        <div class="vsm-panel-title">
          <span id="current-set-name">{% if current_collection_id and sets %}{{ sets.0.title }}{% else %}Ch∆∞a ph√¢n b·ªï{% endif %}</span>
          <span class="vsm-panel-count" id="vocab-count">0</span>
        </div>
        <div class="vsm-search">
          <svg class="vsm-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" id="search-vocab" placeholder="T√¨m t·ª´ v·ª±ng...">
        </div>
        <div class="vsm-toolbar">
          <button type="button" class="vsm-toolbar-btn" id="btn-select-all">‚òëÔ∏è Ch·ªçn t·∫•t c·∫£</button>
          <button type="button" class="vsm-toolbar-btn" id="btn-clear-selection">‚òê B·ªè ch·ªçn</button>
        </div>
      </div>
      
      <div class="vsm-panel-body" id="vocab-list">
        <div class="vsm-empty">
          <div class="vsm-empty-icon">üì≠</div>
          <p>Ch·ªçn m·ªôt set ƒë·ªÉ xem t·ª´ v·ª±ng</p>
        </div>
      </div>
    </div>
    
    <!-- Right Panel: Move to Target -->
    <div class="vsm-panel" id="panel-target">
      <div class="vsm-panel-header">
        <div class="vsm-panel-title">Chuy·ªÉn ƒë·∫øn</div>
      </div>
      
      <div class="vsm-panel-body">
        <div class="vsm-selection-info">
          ƒêang ch·ªçn <strong id="selected-count">0</strong> t·ª´ v·ª±ng
        </div>
        
        <label style="font-size: 0.6875rem; font-weight: 600; color: #94a3b8; display: block; margin-bottom: 0.375rem;">Ch·ªçn set ƒë√≠ch:</label>
        <select id="target-set" class="vsm-target-select">
          <option value="">-- Ch·ªçn set --</option>
          <option value="unassigned">‚ö†Ô∏è B·ªè kh·ªèi set (Unassign)</option>
          {% for set in sets %}
            <option value="{{ set.id }}">{{ set.title }}</option>
          {% endfor %}
        </select>
        
        <button type="button" id="btn-move" class="vsm-move-btn" disabled>
          ‚û°Ô∏è Chuy·ªÉn t·ª´ v·ª±ng
        </button>
        
        <!-- Quick Create Set -->
        <div class="vsm-quick-create">
          <h4>‚ö° T·∫°o set m·ªõi</h4>
          
          <div class="vsm-quick-create-row">
            <label>B·ªô t·ª´ v·ª±ng:</label>
            <select id="qc-collection">
              <option value="">-- Kh√¥ng ch·ªçn --</option>
              {% for col in collections %}
                <option value="{{ col.id }}" {% if current_collection_id == col.id|stringformat:"s" %}selected{% endif %}>{{ col.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="vsm-quick-create-row">
            <label>Ch∆∞∆°ng (Chapter):</label>
            <input type="number" id="qc-chapter" placeholder="VD: 1, 2, 3..." min="1">
          </div>
          
          <div class="vsm-quick-create-row">
            <label>TOEIC Level:</label>
            <select id="qc-toeic-level">
              <option value="">-- Kh√¥ng ch·ªçn --</option>
              <option value="600">TOEIC 600</option>
              <option value="730">TOEIC 730</option>
              <option value="860">TOEIC 860</option>
              <option value="990">TOEIC 990</option>
            </select>
          </div>
          
          <div class="vsm-quick-create-row">
            <label>T√™n set:</label>
            <input type="text" id="qc-set-name" placeholder="VD: Unit 1 - Business">
          </div>
          
          <button type="button" id="btn-qc-create" class="vsm-create-btn">
            + T·∫°o & Chuy·ªÉn t·ª´ v√†o
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="vsm-toast"></div>

<script>
(function() {
  // State
  let currentSetId = '{% if current_collection_id and sets %}{{ sets.0.id }}{% else %}unassigned{% endif %}';
  let selectedVocabIds = new Set();
  let vocabCache = {}; // Cache vocab data by set
  
  // Elements
  const setsList = document.getElementById('sets-list');
  const vocabList = document.getElementById('vocab-list');
  const searchSets = document.getElementById('search-sets');
  const searchVocab = document.getElementById('search-vocab');
  const targetSet = document.getElementById('target-set');
  const btnMove = document.getElementById('btn-move');
  const btnSelectAll = document.getElementById('btn-select-all');
  const btnClearSelection = document.getElementById('btn-clear-selection');
  const btnAddSet = document.getElementById('btn-add-set');
  const newSetName = document.getElementById('new-set-name');
  const currentSetNameEl = document.getElementById('current-set-name');
  const selectedCountEl = document.getElementById('selected-count');
  const vocabCountEl = document.getElementById('vocab-count');
  const vocabLoading = document.getElementById('vocab-loading');
  const toast = document.getElementById('toast');
  
  // Filter elements
  const collectionFilter = document.getElementById('collection-filter');
  const btnApplyFilter = document.getElementById('btn-apply-filter');
  const btnClearFilter = document.getElementById('btn-clear-filter');
  
  // Quick Create
  const qcCollection = document.getElementById('qc-collection');
  const qcChapter = document.getElementById('qc-chapter');
  const qcToeicLevel = document.getElementById('qc-toeic-level');
  const qcSetName = document.getElementById('qc-set-name');
  const btnQcCreate = document.getElementById('btn-qc-create');
  
  // Helpers
  function showToast(msg, type = '') {
    toast.textContent = msg;
    toast.className = 'vsm-toast ' + type;
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => toast.classList.remove('show'), 3000);
  }
  
  function showLoading(show) {
    vocabLoading.classList.toggle('show', show);
  }
  
  function updateSelectedCount() {
    selectedCountEl.textContent = selectedVocabIds.size;
    btnMove.disabled = selectedVocabIds.size === 0 || !targetSet.value;
  }
  
  // Collection Filter
  btnApplyFilter.addEventListener('click', () => {
    const collectionId = collectionFilter.value;
    const url = new URL(window.location.href);
    if (collectionId) {
      url.searchParams.set('collection', collectionId);
    } else {
      url.searchParams.delete('collection');
    }
    window.location.href = url.toString();
  });
  
  if (btnClearFilter) {
    btnClearFilter.addEventListener('click', () => {
      const url = new URL(window.location.href);
      url.searchParams.delete('collection');
      window.location.href = url.toString();
    });
  }
  
  // Fetch vocab for a set
  async function fetchVocabForSet(setId) {
    if (vocabCache[setId]) return vocabCache[setId];
    
    showLoading(true);
    try {
      const url = "{% url 'admin:vocab_vocabulary_manual_distribute_api' %}?set_id=" + encodeURIComponent(setId);
      const resp = await fetch(url, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await resp.json();
      vocabCache[setId] = data.vocabs || [];
      return vocabCache[setId];
    } catch (e) {
      showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
      return [];
    } finally {
      showLoading(false);
    }
  }
  
  // Render vocab list
  async function renderVocabList() {
    const vocabs = await fetchVocabForSet(currentSetId);
    const searchTerm = searchVocab.value.toLowerCase();
    
    vocabCountEl.textContent = vocabs.length;
    
    if (vocabs.length === 0) {
      vocabList.innerHTML = `
        <div class="vsm-empty">
          <div class="vsm-empty-icon">üì≠</div>
          <p>${currentSetId === 'unassigned' ? 'Kh√¥ng c√≥ t·ª´ v·ª±ng ch∆∞a ph√¢n b·ªï' : 'Set n√†y ch∆∞a c√≥ t·ª´ v·ª±ng'}</p>
        </div>
      `;
      return;
    }
    
    const filtered = vocabs.filter(v => 
      !searchTerm || v.word.toLowerCase().includes(searchTerm)
    );
    
    vocabList.innerHTML = filtered.map(v => `
      <div class="vsm-vocab-item ${selectedVocabIds.has(String(v.id)) ? 'selected' : ''}" 
           data-vocab-id="${v.id}"
           draggable="true">
        <input type="checkbox" class="vsm-vocab-checkbox" 
               ${selectedVocabIds.has(String(v.id)) ? 'checked' : ''}>
        <span class="vsm-vocab-word">${v.word}</span>
        <span class="vsm-vocab-extra">${v.lesson || ''}</span>
      </div>
    `).join('');
    
    // Add event listeners
    vocabList.querySelectorAll('.vsm-vocab-item').forEach(item => {
      const vocabId = item.dataset.vocabId;
      const checkbox = item.querySelector('.vsm-vocab-checkbox');
      
      item.addEventListener('click', (e) => {
        if (e.target === checkbox) return;
        checkbox.checked = !checkbox.checked;
        toggleVocabSelection(vocabId, checkbox.checked);
      });
      
      checkbox.addEventListener('change', () => {
        toggleVocabSelection(vocabId, checkbox.checked);
      });
      
      // Drag events
      item.addEventListener('dragstart', (e) => {
        if (!selectedVocabIds.has(vocabId)) {
          selectedVocabIds.add(vocabId);
          item.classList.add('selected');
          checkbox.checked = true;
          updateSelectedCount();
        }
        e.dataTransfer.setData('text/plain', Array.from(selectedVocabIds).join(','));
        item.classList.add('dragging');
      });
      
      item.addEventListener('dragend', () => {
        item.classList.remove('dragging');
      });
    });
  }
  
  function toggleVocabSelection(vocabId, selected) {
    if (selected) {
      selectedVocabIds.add(String(vocabId));
    } else {
      selectedVocabIds.delete(String(vocabId));
    }
    
    const item = vocabList.querySelector(`[data-vocab-id="${vocabId}"]`);
    if (item) item.classList.toggle('selected', selected);
    
    updateSelectedCount();
  }
  
  // Select Set
  function selectSet(setId) {
    currentSetId = setId;
    selectedVocabIds.clear();
    
    // Update UI
    setsList.querySelectorAll('.vsm-set-item').forEach(item => {
      item.classList.toggle('active', item.dataset.setId === String(setId));
    });
    
    const activeSet = setsList.querySelector(`[data-set-id="${setId}"]`);
    if (activeSet) {
      currentSetNameEl.textContent = activeSet.querySelector('.vsm-set-name').textContent;
    }
    
    renderVocabList();
    updateSelectedCount();
  }
  
  // Move vocabs to target set
  async function moveVocabs(targetSetId) {
    if (selectedVocabIds.size === 0) return;
    
    showLoading(true);
    
    const vocabIds = Array.from(selectedVocabIds);
    
    try {
      const formData = new URLSearchParams();
      formData.append('vocab_ids', JSON.stringify(vocabIds));
      formData.append('target_set_id', targetSetId);
      formData.append('source_set_id', currentSetId);
      
      const response = await fetch("{% url 'admin:vocab_vocabulary_move_to_set_api' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData.toString()
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Clear cache for affected sets
        delete vocabCache[currentSetId];
        delete vocabCache[targetSetId];
        
        // Update counts in UI
        updateSetCounts();
        
        selectedVocabIds.clear();
        renderVocabList();
        updateSelectedCount();
        
        showToast(`‚úÖ ƒê√£ chuy·ªÉn ${data.moved} t·ª´ v·ª±ng`, 'success');
      } else {
        showToast('‚ùå L·ªói: ' + (data.error || 'Unknown'), 'error');
      }
    } catch (e) {
      showToast('‚ùå L·ªói: ' + e.message, 'error');
    } finally {
      showLoading(false);
    }
  }
  
  // Update set counts via API
  async function updateSetCounts() {
    try {
      const resp = await fetch("{% url 'admin:vocab_vocabulary_set_counts_api' %}", {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await resp.json();
      
      const unassignedCountEl = document.getElementById('unassigned-count');
      const statUnassignedEl = document.getElementById('stat-unassigned');
      
      if (unassignedCountEl) unassignedCountEl.textContent = data.unassigned || 0;
      if (statUnassignedEl) statUnassignedEl.textContent = data.unassigned || 0;
      
      if (data.sets) {
        data.sets.forEach(s => {
          const el = document.querySelector(`.vsm-set-count[data-set-id="${s.id}"]`);
          if (el) el.textContent = s.count;
        });
      }
    } catch (e) {
      console.error('Failed to update counts', e);
    }
  }
  
  // Create new set
  async function createSet(name, toeicLevel, collectionId, chapter) {
    if (!name) return null;
    
    try {
      const formData = new URLSearchParams();
      formData.append('title', name);
      if (toeicLevel) formData.append('toeic_level', toeicLevel);
      if (collectionId) formData.append('collection_id', collectionId);
      if (chapter) formData.append('chapter', chapter);
      
      const response = await fetch("{% url 'admin:vocab_vocabulary_create_set_api' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData.toString()
      });
      
      const data = await response.json();
      
      if (data.id) {
        // Build meta text
        let metaText = '';
        if (data.chapter) metaText += `Ch∆∞∆°ng ${data.chapter} ¬∑ `;
        metaText += data.collection_name || (data.toeic_level ? 'TOEIC ' + data.toeic_level : 'General');
        
        // Add to sets list
        const newSetHtml = `
          <div class="vsm-set-item" data-set-id="${data.id}" data-set-name="${data.title}" data-chapter="${data.chapter || ''}">
            <div class="vsm-set-icon">üìñ</div>
            <div class="vsm-set-info">
              <div class="vsm-set-name">${data.title}</div>
              <div class="vsm-set-meta">${metaText}</div>
            </div>
            <span class="vsm-set-count" data-set-id="${data.id}">0</span>
          </div>
        `;
        
        setsList.insertAdjacentHTML('beforeend', newSetHtml);
        
        // Add to target select
        const newOption = document.createElement('option');
        newOption.value = data.id;
        newOption.textContent = data.title;
        targetSet.appendChild(newOption);
        
        // Add event listener
        const newSetEl = setsList.querySelector(`[data-set-id="${data.id}"]`);
        newSetEl.addEventListener('click', () => selectSet(data.id));
        setupDragDrop(newSetEl);
        
        showToast(`‚úÖ ƒê√£ t·∫°o set: ${data.title}`, 'success');
        return data.id;
      } else {
        showToast('‚ùå L·ªói: ' + (data.error || 'Unknown'), 'error');
        return null;
      }
    } catch (e) {
      showToast('‚ùå L·ªói: ' + e.message, 'error');
      return null;
    }
  }
  
  // Setup drag-drop for set item
  function setupDragDrop(setItem) {
    setItem.addEventListener('dragover', (e) => {
      e.preventDefault();
      setItem.classList.add('drop-target');
    });
    
    setItem.addEventListener('dragleave', () => {
      setItem.classList.remove('drop-target');
    });
    
    setItem.addEventListener('drop', async (e) => {
      e.preventDefault();
      setItem.classList.remove('drop-target');
      
      const targetSetId = setItem.dataset.setId;
      if (targetSetId !== currentSetId && selectedVocabIds.size > 0) {
        await moveVocabs(targetSetId);
      }
    });
  }
  
  // Event Listeners
  setsList.querySelectorAll('.vsm-set-item').forEach(item => {
    item.addEventListener('click', () => selectSet(item.dataset.setId));
    setupDragDrop(item);
  });
  
  searchSets.addEventListener('input', () => {
    const term = searchSets.value.toLowerCase();
    setsList.querySelectorAll('.vsm-set-item').forEach(item => {
      const name = item.querySelector('.vsm-set-name').textContent.toLowerCase();
      item.style.display = !term || name.includes(term) ? '' : 'none';
    });
  });
  
  searchVocab.addEventListener('input', renderVocabList);
  
  targetSet.addEventListener('change', updateSelectedCount);
  
  btnMove.addEventListener('click', () => {
    if (targetSet.value) {
      moveVocabs(targetSet.value);
    }
  });
  
  btnSelectAll.addEventListener('click', () => {
    vocabList.querySelectorAll('.vsm-vocab-item').forEach(item => {
      const vocabId = item.dataset.vocabId;
      selectedVocabIds.add(vocabId);
      item.classList.add('selected');
      item.querySelector('.vsm-vocab-checkbox').checked = true;
    });
    updateSelectedCount();
  });
  
  btnClearSelection.addEventListener('click', () => {
    selectedVocabIds.clear();
    vocabList.querySelectorAll('.vsm-vocab-item').forEach(item => {
      item.classList.remove('selected');
      item.querySelector('.vsm-vocab-checkbox').checked = false;
    });
    updateSelectedCount();
  });
  
  btnAddSet.addEventListener('click', async () => {
    const name = newSetName.value.trim();
    if (!name) {
      showToast('Nh·∫≠p t√™n set', 'error');
      return;
    }
    
    // Use current collection filter as default
    const currentCollection = collectionFilter ? collectionFilter.value : '';
    const setId = await createSet(name, null, currentCollection, null);
    if (setId) {
      newSetName.value = '';
      selectSet(setId);
    }
  });
  
  btnQcCreate.addEventListener('click', async () => {
    const name = qcSetName.value.trim();
    const toeicLevel = qcToeicLevel.value;
    const collectionId = qcCollection.value;
    const chapter = qcChapter.value;
    
    if (!name) {
      showToast('Nh·∫≠p t√™n set', 'error');
      return;
    }
    
    const setId = await createSet(name, toeicLevel, collectionId, chapter);
    if (setId && selectedVocabIds.size > 0) {
      await moveVocabs(setId);
      selectSet(setId);
    }
    
    qcSetName.value = '';
    qcChapter.value = '';
  });
  
  function getCookie(name) {
    const value = "; " + document.cookie;
    const parts = value.split("; " + name + "=");
    if (parts.length === 2) return parts.pop().split(";").shift();
    return "";
  }
  
  // Init
  selectSet(currentSetId);
})();
</script>
{% endblock %}
