{% extends "base.html" %}
{% load static %}

{% block title %}{{ exercise.title }} | Nghe ch√©p ch√≠nh t·∫£{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dictation.css' %}?v=20260105">
<style>
  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fade-in-up 0.5s ease-out forwards;
  }
</style>
{% endblock %}

{% block main_classes %}df-page-container-lg{% endblock %}

{% block content %}
<div class="dictation-card space-y-6">
  <!-- Header & Tabs -->
  <div>
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <a href="{% url 'core:dictation_list' %}" class="text-slate-400 hover:text-slate-600 transition-colors">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </a>
        <h1 class="text-xl font-bold text-slate-900">{{ exercise.title }}</h1>
      </div>

      <!-- Tab Navigation -->
      <div class="flex gap-1 border-b border-slate-200">
        <button onclick="switchTab('dictation')" id="tab-btn-dictation"
          class="tab-btn active">
          Dictation
        </button>
        <button onclick="switchTab('transcript')" id="tab-btn-transcript"
          class="tab-btn">
          Full Transcript
        </button>
      </div>
    </div>
  </div>

  <!-- TAB: DICTATION (Original Game) -->
  <div id="view-dictation" class="tab-pane animate-fade-in-up">

    <!-- Progress (Dictation Mode) -->
    <div class="flex items-center justify-center gap-4 mb-8">
      <span id="progress-text" class="text-sm text-slate-500 font-medium">1 / {{ segments.count }}</span>
      <div class="w-48 bg-slate-200 rounded-full h-1.5">
        <div id="progress-bar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%">
        </div>
      </div>
    </div>

    <!-- Main Exercise Card -->
    <div id="exercise-app" class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
      <!-- Audio Section -->
      <div class="p-8 bg-gradient-to-br from-slate-50/50 to-slate-100/50 border-b border-slate-200">
        <div class="flex flex-col items-center gap-6">
          <!-- Visualizer -->
          <div id="audio-viz" class="audio-visualizer paused">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
          </div>

          <!-- Controls -->
          <div class="flex items-center gap-3">
            <button id="btn-play" type="button"
              class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-all shadow-md hover:shadow-lg">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z" />
              </svg>
              Ph√°t
            </button>
            <button id="btn-replay" type="button"
              class="flex items-center gap-2 px-5 py-2.5 bg-slate-100 text-slate-700 rounded-xl font-semibold hover:bg-slate-200 transition-all shadow-sm hover:shadow-md">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Nghe l·∫°i
            </button>
            <button id="btn-slow" type="button"
              class="flex items-center gap-1 px-4 py-2.5 bg-slate-100 border border-slate-200 text-slate-700 rounded-xl font-medium hover:bg-slate-200 transition-colors">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Ch·∫≠m
            </button>
          </div>

          <!-- Hint -->
          <p id="hint-text" class="text-sm text-slate-500 italic hidden"></p>
        </div>
      </div>

      <!-- Input Section -->
      <div class="p-8">
        <textarea id="user-input"
          class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all resize-none text-lg leading-relaxed"
          rows="2" placeholder="Nh·∫≠p n·ªôi dung b·∫°n nghe ƒë∆∞·ª£c..."></textarea>

        <!-- Actions -->
        <div class="flex justify-center gap-3 mt-6">
          <button id="btn-check" type="button"
            class="px-6 py-2.5 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700 transition-colors shadow-sm">
            Ki·ªÉm tra
          </button>
          <button id="btn-next" type="button"
            class="hidden px-6 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-sm">
            Ti·∫øp theo ‚Üí
          </button>
        </div>
      </div>

      <!-- Feedback Section -->
      <div id="feedback" class="hidden p-8 border-t border-slate-200 bg-slate-50/50">
        <div class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">K·∫øt qu·∫£:</div>
        <div id="feedback-content" class="text-lg leading-relaxed"></div>
      </div>
    </div>

    <!-- Summary Screen -->
    <div id="summary-screen" class="hidden bg-white border border-slate-200 rounded-2xl shadow-sm p-10 text-center">
      <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-slate-900 mb-2">Ho√†n th√†nh! üéâ</h2>
      <p class="text-slate-600 mb-2">B·∫°n ƒë√£ ho√†n th√†nh b√†i t·∫≠p v·ªõi k·∫øt qu·∫£:</p>
      <p id="final-score" class="text-3xl font-bold text-emerald-600 mb-6"></p>
      <div class="flex justify-center gap-3">
        <button onclick="window.location.reload()"
          class="px-5 py-2.5 bg-slate-900 text-white rounded-xl font-semibold hover:bg-slate-800 transition-colors">
          L√†m l·∫°i
        </button>
        <a href="{% url 'core:dictation_list' %}"
          class="px-5 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-semibold hover:bg-slate-50 transition-colors">
          Danh s√°ch b√†i
        </a>
      </div>
    </div>
  </div>

  <!-- TAB: FULL TRANSCRIPT -->
  <div id="view-transcript" class="tab-pane hidden animate-fade-in-up">
    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden flex flex-col md:flex-row"
      style="height: 550px;">

      <!-- Box Left: Player & Current Text -->
      <div class="w-full md:w-5/12 bg-gradient-to-br from-slate-800 to-slate-900 text-white p-8 flex flex-col relative justify-between">

        <!-- Decoration -->
        <div class="absolute top-0 right-0 p-4 opacity-10">
          <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
          </svg>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center text-center space-y-4 px-2 z-10">
          <!-- Icon -->
          <div class="w-14 h-14 rounded-full bg-white/15 flex items-center justify-center text-white/80 mb-4">
            <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
          </div>
          <!-- Active Text -->
          <div id="trans-active-text"
            class="text-lg font-medium leading-relaxed flex items-center justify-center text-white/95 transition-all duration-300 px-4"
            style="min-height: 80px;">
            (B·∫•m play ƒë·ªÉ b·∫Øt ƒë·∫ßu)
          </div>
        </div>

        <!-- Compact Controls -->
        <div class="pt-4 border-t border-white/10 z-10 w-full mt-4">
          <!-- Progress Bar -->
          <div class="w-full bg-white/20 h-1.5 rounded-full cursor-pointer relative group mb-3"
            id="trans-progress-container">
            <div id="trans-progress-bar"
              class="bg-blue-500 h-full rounded-full w-0 pointer-events-none transition-[width] duration-100 ease-linear">
            </div>
            <div class="absolute -top-2 -bottom-2 w-full cursor-pointer"></div>
          </div>

          <div class="flex items-center justify-between">
            <div class="text-xs text-white/80 font-mono w-12 text-left font-medium" id="trans-current-time">00:00</div>

            <div class="flex items-center gap-3">
              <button id="trans-btn-prev" class="text-white/80 hover:text-white transition-all p-2.5 hover:bg-white/15 rounded-lg active:scale-95"><svg
                  class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                </svg></button>

              <button id="trans-btn-play"
                class="w-14 h-14 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg shadow-blue-600/40 transition-transform active:scale-95 hover:scale-105">
                <svg class="w-7 h-7 ml-0.5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z" />
                </svg>
              </button>

              <button id="trans-btn-replay" class="text-white/80 hover:text-white transition-all p-2.5 hover:bg-white/15 rounded-lg active:scale-95" title="Nghe l·∫°i">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              </button>

              <button id="trans-btn-next" class="text-white/80 hover:text-white transition-all p-2.5 hover:bg-white/15 rounded-lg active:scale-95"><svg
                  class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                </svg></button>
            </div>

            <div class="text-xs text-white/80 font-mono w-12 text-right font-medium" id="trans-total-time">00:00</div>
          </div>
        </div>
      </div>

      <!-- Box Right: Transcript List -->
      <div class="w-full md:w-7/12 bg-white flex flex-col border-l border-slate-100">
        <!-- Options Header -->
        <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
          <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Danh s√°ch c√¢u</div>
          <label
            class="flex items-center gap-2 cursor-pointer text-sm text-slate-600 select-none hover:text-slate-900 group">
            <input type="checkbox" id="chk-autoscroll"
              class="rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer" checked>
            <span class="font-medium group-hover:text-blue-600 transition-colors">T·ª± ƒë·ªông cu·ªôn</span>
          </label>
        </div>

        <!-- List -->
        <div id="transcript-list" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2">
          <!-- Items will be injected here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden Audio (Shared) -->
  <audio id="main-audio" preload="auto" crossorigin="anonymous">
    <source src="{{ exercise.audio_file.url }}" type="audio/mpeg">
  </audio>
</div>

<script src="{% static 'js/dictation.js' %}?v=20260105"></script>
<script>
  (function () {
    if (typeof DictationApp === 'undefined') {
      console.error('DictationApp not loaded!');
      return;
    }

    const segments = JSON.parse("{{ segments_json|escapejs }}");
    const audio = document.getElementById('main-audio');

    if (segments.length === 0) {
      document.querySelector('.dictation-card').innerHTML = '<div class="p-10 text-center text-slate-500">Ch∆∞a c√≥ d·ªØ li·ªáu b√†i t·∫≠p. H√£y quay l·∫°i sau.</div>';
      return;
    }

    // Initialize DictationApp
    const app = new DictationApp({
      segments: segments,
      audio: audio,
      dictationElements: {
        viz: document.getElementById('audio-viz'),
        btnPlay: document.getElementById('btn-play'),
        btnReplay: document.getElementById('btn-replay'),
        btnSlow: document.getElementById('btn-slow'),
        btnCheck: document.getElementById('btn-check'),
        btnNext: document.getElementById('btn-next'),
        userInput: document.getElementById('user-input'),
        hintText: document.getElementById('hint-text'),
        feedback: document.getElementById('feedback'),
        feedbackContent: document.getElementById('feedback-content'),
        progressBar: document.getElementById('progress-bar'),
        progressText: document.getElementById('progress-text'),
        exerciseApp: document.getElementById('exercise-app'),
        summaryScreen: document.getElementById('summary-screen'),
        finalScore: document.getElementById('final-score')
      },
      transcriptElements: {
        activeText: document.getElementById('trans-active-text'),
        list: document.getElementById('transcript-list'),
        btnPlay: document.getElementById('trans-btn-play'),
        btnReplay: document.getElementById('trans-btn-replay'),
        btnPrev: document.getElementById('trans-btn-prev'),
        btnNext: document.getElementById('trans-btn-next'),
        progressBar: document.getElementById('trans-progress-bar'),
        progressContainer: document.getElementById('trans-progress-container'),
        currentTime: document.getElementById('trans-current-time'),
        totalTime: document.getElementById('trans-total-time'),
        autoScroll: document.getElementById('chk-autoscroll')
      }
    });

    // Set up tab switching
    window.switchTab = (tabName) => {
      app.switchTab(tabName);
    };
  })();
</script>
{% endblock %}
