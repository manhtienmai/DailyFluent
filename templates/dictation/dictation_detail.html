{% extends "base.html" %}
{% load static %}

{% block title %}{{ exercise.title }} | Nghe ch√©p ch√≠nh t·∫£{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dictation.css' %}?v=20260104">
<style>
  .dictation-card {
    max-width: 700px;
    margin: 0 auto;
  }

  .audio-visualizer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
    height: 40px;
  }

  .audio-visualizer .bar {
    width: 4px;
    background: linear-gradient(to top, #3b82f6, #60a5fa);
    border-radius: 2px;
    animation: pulse 0.8s ease-in-out infinite;
  }

  .audio-visualizer .bar:nth-child(1) {
    height: 20px;
    animation-delay: 0s;
  }

  .audio-visualizer .bar:nth-child(2) {
    height: 30px;
    animation-delay: 0.1s;
  }

  .audio-visualizer .bar:nth-child(3) {
    height: 40px;
    animation-delay: 0.2s;
  }

  .audio-visualizer .bar:nth-child(4) {
    height: 30px;
    animation-delay: 0.3s;
  }

  .audio-visualizer .bar:nth-child(5) {
    height: 20px;
    animation-delay: 0.4s;
  }

  @keyframes pulse {

    0%,
    100% {
      transform: scaleY(0.5);
      opacity: 0.5;
    }

    50% {
      transform: scaleY(1);
      opacity: 1;
    }
  }

  .audio-visualizer.paused .bar {
    animation: none;
    opacity: 0.3;
    transform: scaleY(0.3);
  }
</style>
{% endblock %}

{% block main_classes %}df-page-container-lg{% endblock %}

{% block content %}
<div class="dictation-card space-y-6">
  <!-- Header -->
  <div class="text-center">
    <div class="flex items-center justify-center gap-3 mb-2">
      <a href="{% url 'core:dictation_list' %}" class="text-slate-400 hover:text-slate-600 transition-colors">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </a>
      <h1 class="text-xl font-bold text-slate-900">{{ exercise.title }}</h1>
      <span class="px-2 py-0.5 text-xs font-semibold rounded-full 
        {% if exercise.difficulty == 'beginner' %}bg-green-100 text-green-700
        {% elif exercise.difficulty == 'intermediate' %}bg-blue-100 text-blue-700
        {% else %}bg-purple-100 text-purple-700{% endif %}">
        {{ exercise.get_difficulty_display }}
      </span>
    </div>
    <!-- Progress -->
    <div class="flex items-center justify-center gap-3">
      <span id="progress-text" class="text-sm text-slate-500 font-medium">1 / {{ segments.count }}</span>
      <div class="w-48 bg-slate-200 rounded-full h-1.5">
        <div id="progress-bar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%">
        </div>
      </div>
    </div>
  </div>

  <!-- Main Exercise Card -->
  <div id="exercise-app" class="bg-white border border-slate-200 rounded-2xl shadow-lg overflow-hidden">
    <!-- Audio Section -->
    <div class="p-6 bg-gradient-to-br from-slate-50 to-slate-100 border-b border-slate-200">
      <div class="flex flex-col items-center gap-4">
        <!-- Visualizer -->
        <div id="audio-viz" class="audio-visualizer paused">
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
        </div>

        <!-- Controls -->
        <div class="flex items-center gap-3">
          <button id="btn-play" type="button"
            class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-all shadow-md hover:shadow-lg">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z" />
            </svg>
            Ph√°t
          </button>
          <button id="btn-slow" type="button"
            class="flex items-center gap-1 px-4 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-medium hover:bg-slate-50 transition-colors">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Ch·∫≠m
          </button>
        </div>

        <!-- Hint -->
        <p id="hint-text" class="text-sm text-slate-500 italic hidden"></p>
      </div>
    </div>

    <!-- Input Section -->
    <div class="p-6">
      <textarea id="user-input"
        class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all resize-none text-lg leading-relaxed"
        rows="2" placeholder="Nh·∫≠p n·ªôi dung b·∫°n nghe ƒë∆∞·ª£c..."></textarea>

      <!-- Actions -->
      <div class="flex justify-center gap-3 mt-4">
        <button id="btn-check" type="button"
          class="px-6 py-2.5 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700 transition-colors shadow-sm">
          Ki·ªÉm tra
        </button>
        <button id="btn-next" type="button"
          class="hidden px-6 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-sm">
          Ti·∫øp theo ‚Üí
        </button>
      </div>
    </div>

    <!-- Feedback Section -->
    <div id="feedback" class="hidden p-6 border-t border-slate-100 bg-slate-50">
      <div class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">K·∫øt qu·∫£:</div>
      <div id="feedback-content" class="text-lg leading-relaxed"></div>
    </div>
  </div>

  <!-- Summary Screen -->
  <div id="summary-screen" class="hidden bg-white border border-slate-200 rounded-2xl shadow-lg p-10 text-center">
    <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
    </div>
    <h2 class="text-2xl font-bold text-slate-900 mb-2">Ho√†n th√†nh! üéâ</h2>
    <p class="text-slate-600 mb-2">B·∫°n ƒë√£ ho√†n th√†nh b√†i t·∫≠p v·ªõi k·∫øt qu·∫£:</p>
    <p id="final-score" class="text-3xl font-bold text-emerald-600 mb-6"></p>
    <div class="flex justify-center gap-3">
      <button onclick="window.location.reload()"
        class="px-5 py-2.5 bg-slate-900 text-white rounded-xl font-semibold hover:bg-slate-800 transition-colors">
        L√†m l·∫°i
      </button>
      <a href="{% url 'core:dictation_list' %}"
        class="px-5 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-xl font-semibold hover:bg-slate-50 transition-colors">
        Danh s√°ch b√†i
      </a>
    </div>
  </div>

  <!-- Hidden Audio -->
  <audio id="main-audio" preload="auto">
    <source src="{{ exercise.audio_file.url }}" type="audio/mpeg">
  </audio>
</div>

<script>
  (function () {
    const segments = JSON.parse("{{ segments_json|escapejs }}");
    const audio = document.getElementById('main-audio');
    const viz = document.getElementById('audio-viz');
    const btnPlay = document.getElementById('btn-play');
    const btnSlow = document.getElementById('btn-slow');
    const btnCheck = document.getElementById('btn-check');
    const btnNext = document.getElementById('btn-next');
    const userInput = document.getElementById('user-input');
    const hintText = document.getElementById('hint-text');
    const feedback = document.getElementById('feedback');
    const feedbackContent = document.getElementById('feedback-content');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const exerciseApp = document.getElementById('exercise-app');
    const summaryScreen = document.getElementById('summary-screen');
    const finalScore = document.getElementById('final-score');

    let currentIndex = 0;
    let isSlow = false;
    let isChecked = false;
    let correctCount = 0;
    let checkInterval = null;

    function init() {
      if (segments.length === 0) {
        exerciseApp.innerHTML = '<div class="p-10 text-center text-slate-500">Ch∆∞a c√≥ d·ªØ li·ªáu segments. Vui l√≤ng import JSON t·ª´ Admin.</div>';
        return;
      }
      render();
    }

    function render() {
      if (currentIndex >= segments.length) {
        showSummary();
        return;
      }

      const seg = segments[currentIndex];

      // Reset UI
      isChecked = false;
      userInput.value = '';
      userInput.disabled = false;
      userInput.focus();
      btnCheck.classList.remove('hidden');
      btnNext.classList.add('hidden');
      feedback.classList.add('hidden');

      // Hint
      if (seg.hint) {
        hintText.textContent = 'üí° ' + seg.hint;
        hintText.classList.remove('hidden');
      } else {
        hintText.classList.add('hidden');
      }

      // Progress
      progressText.textContent = `${currentIndex + 1} / ${segments.length}`;
      progressBar.style.width = `${(currentIndex / segments.length) * 100}%`;

      // Auto play
      playCurrentSegment();
    }

    function playCurrentSegment() {
      if (currentIndex >= segments.length) return;
      const seg = segments[currentIndex];

      audio.currentTime = seg.start_time;
      audio.playbackRate = isSlow ? 0.7 : 1.0;
      audio.play();

      viz.classList.remove('paused');

      // Stop at end_time
      if (checkInterval) clearInterval(checkInterval);
      checkInterval = setInterval(() => {
        if (!audio.paused && audio.currentTime >= seg.end_time) {
          audio.pause();
          viz.classList.add('paused');
          clearInterval(checkInterval);
        }
      }, 50);
    }

    function diffString(userText, correctText) {
      const u = userText.trim().split(/\s+/);
      const c = correctText.trim().split(/\s+/);
      let html = '';
      const len = Math.max(u.length, c.length);

      for (let i = 0; i < len; i++) {
        const uw = u[i] || '';
        const cw = c[i] || '';
        if (uw.toLowerCase() === cw.toLowerCase()) {
          html += `<span class="text-emerald-600">${cw}</span> `;
        } else {
          if (uw) html += `<del>${uw}</del> `;
          if (cw) html += `<ins>${cw}</ins> `;
        }
      }
      return html.trim();
    }

    function check() {
      if (isChecked) return;
      isChecked = true;

      const seg = segments[currentIndex];
      const userText = userInput.value.trim();
      const correctText = seg.correct_text.trim();

      const normalize = s => s.toLowerCase().replace(/[.,?!'"]/g, '');
      const isCorrect = normalize(userText) === normalize(correctText);

      if (isCorrect) correctCount++;

      // Show feedback
      feedback.classList.remove('hidden');
      if (isCorrect) {
        feedbackContent.innerHTML = `
        <div class="flex items-center gap-2 text-emerald-600 font-bold">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Ch√≠nh x√°c!
        </div>
        <div class="mt-2 text-slate-800">${correctText}</div>
      `;
      } else {
        feedbackContent.innerHTML = `
        <div class="flex items-center gap-2 text-rose-600 font-bold mb-2">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Ch∆∞a ƒë√∫ng
        </div>
        <div>${diffString(userText, correctText)}</div>
      `;
      }

      userInput.disabled = true;
      btnCheck.classList.add('hidden');
      btnNext.classList.remove('hidden');
      btnNext.focus();
    }

    function next() {
      currentIndex++;
      render();
    }

    function showSummary() {
      exerciseApp.classList.add('hidden');
      summaryScreen.classList.remove('hidden');
      progressBar.style.width = '100%';
      finalScore.textContent = `${correctCount} / ${segments.length} c√¢u ƒë√∫ng`;
    }

    // Event Listeners
    btnPlay.addEventListener('click', playCurrentSegment);

    btnSlow.addEventListener('click', () => {
      isSlow = !isSlow;
      btnSlow.classList.toggle('bg-blue-50', isSlow);
      btnSlow.classList.toggle('border-blue-300', isSlow);
      btnSlow.classList.toggle('text-blue-600', isSlow);
    });

    btnCheck.addEventListener('click', check);
    btnNext.addEventListener('click', next);

    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!isChecked) check();
        else next();
      }
    });

    audio.addEventListener('ended', () => {
      viz.classList.add('paused');
    });

    audio.addEventListener('pause', () => {
      viz.classList.add('paused');
    });

    // Init
    init();
  })();
</script>
{% endblock %}