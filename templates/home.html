{# templates/home.html #}
{% extends "base.html" %}

{% block title %}DailyFluent - Dashboard{% endblock %}

{% block main_classes %}df-page-full{% endblock %}

{% block content %}
<div class="space-y-6 px-4 lg:px-6">

  <!-- HEADER DASHBOARD -->
  <div class="flex items-center justify-between gap-3">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-400">Dashboard</p>
      <h1 class="text-2xl sm:text-3xl font-bold text-slate-900">
        Xin ch√†o{% if user.is_authenticated and user.email %}, {{ user.email }}{% endif %} üëã
      </h1>
    </div>

    {% if user.is_authenticated %}
    <div class="hidden sm:block text-right text-xs text-slate-500">
      <p>ƒê√£ ƒëƒÉng nh·∫≠p</p>
      <p class="font-medium text-slate-700">Ti·∫øp t·ª•c gi·ªØ nh·ªãp m·ªói ng√†y nh√©!</p>
    </div>
    {% endif %}
  </div>

  {% if user.is_authenticated %}
  <!-- CARD STREAK CH√çNH -->
  <section class="bg-white border border-slate-100 rounded-3xl shadow-sm p-5 sm:p-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="h-12 w-12 rounded-2xl bg-orange-100 flex items-center justify-center">
          <span class="text-2xl">üî•</span>
        </div>
        <div>
          <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">
            Chu·ªói ng√†y h·ªçc li√™n t·ª•c
          </p>

          {% if streak and streak.current_streak > 0 %}
          <p class="text-3xl font-bold text-slate-900" id="streak-number" data-streak="{{ streak.current_streak }}">
            {{ streak.current_streak }}
          </p>
          <p class="text-xs text-slate-500 mt-1">
            K·ª∑ l·ª•c d√†i nh·∫•t:
            <span class="font-semibold text-slate-800">{{ streak.longest_streak }} ng√†y</span>
          </p>
          {% else %}
          <p class="text-sm text-slate-700 mt-1">
            B·∫°n ch∆∞a c√≥ streak n√†o. B·∫Øt ƒë·∫ßu ngay h√¥m nay b·∫±ng c√°ch ho√†n th√†nh 1 b√†i h·ªçc ho·∫∑c √¥n t·ª´ v·ª±ng. ‚ú®
          </p>
          {% endif %}
        </div>
      </div>

      <div class="flex flex-col items-start sm:items-end gap-2">
        <p class="text-xs text-slate-500">
          M·ª•c ti√™u g·ª£i √Ω: √≠t nh·∫•t <span class="font-semibold">10‚Äì15 ph√∫t</span> h·ªçc m·ªói ng√†y.
        </p>
        <div class="flex flex-wrap gap-2">
          <a href="{% url 'vocab:list' %}"
            class="inline-flex items-center justify-center px-4 py-2 rounded-full bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700">
            √în t·ª´ v·ª±ng ngay
          </a>
          <a href="{% url 'video:list' %}"
            class="inline-flex items-center justify-center px-4 py-2 rounded-full border border-slate-200 text-xs text-slate-700 hover:bg-slate-50">
            Xem video luy·ªán nghe
          </a>
        </div>
      </div>
    </div>

    {% if streak and streak.current_streak > 0 %}
    <div class="mt-5 grid sm:grid-cols-2 gap-3 text-xs">
      <div class="bg-slate-50 rounded-2xl p-3">
        <p class="text-[11px] text-slate-500 mb-1">Tr·∫°ng th√°i hi·ªán t·∫°i</p>
        <p class="text-sm font-semibold text-slate-800">
          B·∫°n ƒëang gi·ªØ chu·ªói {{ streak.current_streak }} ng√†y li√™n t·ª•c. ƒê·ª´ng ƒë·ªÉ b·ªã ng·∫Øt nh√©!
        </p>
        {% if minutes_today is not None %}
        <p class="text-[11px] text-slate-500 mt-1">
          H√¥m nay b·∫°n ƒë√£ h·ªçc <span class="font-semibold text-slate-800">{{ minutes_today }}</span> ph√∫t flashcard.
        </p>
        {% endif %}
        {% if cards_today is not None %}
        <p class="text-[11px] text-slate-500 mt-1">
          H√¥m nay b·∫°n ƒë√£ √¥n <span class="font-semibold text-slate-800">{{ cards_today }}</span> th·∫ª
          <span class="text-slate-400">(m·ªõi: {{ new_cards_today }}, √¥n: {{ reviews_today }})</span>.
        </p>
        {% endif %}
      </div>
      <div class="bg-slate-50 rounded-2xl p-3">
        <p class="text-[11px] text-slate-500 mb-1">G·ª£i √Ω h√¥m nay</p>
        <p class="text-sm text-slate-800">
          Ho√†n th√†nh 1 video ho·∫∑c 1 b·ªô t·ª´ v·ª±ng l√† ƒë·ªß ƒë·ªÉ gi·ªØ streak. Kh√¥ng c·∫ßn h·ªçc qu√° nhi·ªÅu m·ªôt l√∫c.
        </p>
      </div>
    </div>
    {% endif %}
  </section>

  <!-- Daily goal + Heatmap -->
  <div class="grid md:grid-cols-2 gap-4 mt-4">
    {% include "streak/_daily_goal.html" %}
    {% include "streak/_heatmap.html" %}
  </div>

  <!-- My Courses + Recent Exam Results - 2 columns -->
  <div class="grid md:grid-cols-2 gap-4 mt-4">
    <!-- Kh√≥a h·ªçc c·ªßa t√¥i -->
    <section class="bg-white border border-slate-100 rounded-2xl shadow-sm p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base font-bold text-slate-900 flex items-center gap-2">
          üìö Kh√≥a h·ªçc c·ªßa t√¥i
        </h2>
        <a href="{% url 'core:course_list' %}" class="text-xs text-blue-600 hover:text-blue-700 font-medium">
          Xem t·∫•t c·∫£ ‚Üí
        </a>
      </div>
      {% if enrolled_courses %}
      <div class="space-y-2">
        {% for enrollment in enrolled_courses %}
        <a href="{% url 'core:course_detail' enrollment.course.slug %}"
          class="flex items-center gap-3 p-2.5 rounded-xl bg-slate-50 hover:bg-slate-100 transition-colors">
          <div
            class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
            {{ enrollment.course.title|slice:":2"|upper }}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-slate-900 truncate">{{ enrollment.course.title }}</p>
            <p class="text-xs text-slate-500">
              {% if enrollment.progress %}{{ enrollment.progress }}% ho√†n th√†nh{% else %}Ch∆∞a b·∫Øt ƒë·∫ßu{% endif %}
            </p>
          </div>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-6">
        <p class="text-sm text-slate-500 mb-2">B·∫°n ch∆∞a ƒëƒÉng k√Ω kh√≥a h·ªçc n√†o</p>
        <a href="{% url 'core:course_list' %}" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
          Kh√°m ph√° kh√≥a h·ªçc ‚Üí
        </a>
      </div>
      {% endif %}
    </section>

    <!-- K·∫øt qu·∫£ luy·ªán thi g·∫ßn nh·∫•t -->
    <section class="bg-white border border-slate-100 rounded-2xl shadow-sm p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base font-bold text-slate-900 flex items-center gap-2">
          üìä K·∫øt qu·∫£ luy·ªán thi
        </h2>
        <a href="{% url 'core:profile' %}" class="text-xs text-blue-600 hover:text-blue-700 font-medium">
          Xem t·∫•t c·∫£ ‚Üí
        </a>
      </div>
      {% if recent_exam_results %}
      <div class="space-y-2">
        {% for result in recent_exam_results %}
        <a href="{% url 'exam:exam_result' result.id %}"
          class="flex items-center gap-3 p-2.5 rounded-xl bg-slate-50 hover:bg-slate-100 transition-colors">
          <div class="w-10 h-10 rounded-lg flex items-center justify-center text-sm font-bold flex-shrink-0
              {% if result.score >= 80 %}bg-green-100 text-green-700
              {% elif result.score >= 60 %}bg-yellow-100 text-yellow-700
              {% else %}bg-red-100 text-red-700{% endif %}">
            {{ result.score|floatformat:0 }}%
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-slate-900 truncate">{{ result.template.title }}</p>
            <p class="text-xs text-slate-500">
              {{ result.submitted_at|date:"d/m/Y" }} ‚Ä¢ {{ result.correct_count }}/{{ result.total_questions }} c√¢u ƒë√∫ng
            </p>
          </div>
          <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-6">
        <p class="text-sm text-slate-500 mb-2">B·∫°n ch∆∞a l√†m b√†i thi n√†o</p>
        <a href="{% url 'exam:exam_list' %}" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
          L√†m b√†i thi ngay ‚Üí
        </a>
      </div>
      {% endif %}
    </section>
  </div>

  <!-- Todo List - M·ª•c ti√™u h√†ng ng√†y -->
  <section class="bg-white border border-slate-100 rounded-3xl shadow-sm p-5 sm:p-6 mt-6">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-blue-100 flex items-center justify-center">
          <span class="text-xl">üìù</span>
        </div>
        <div>
          <h2 class="text-lg font-bold text-slate-900">M·ª•c ti√™u</h2>
          <p class="text-xs text-slate-500">Ghi l·∫°i nh·ªØng m·ª•c ti√™u b·∫°n mu·ªën ho√†n th√†nh</p>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 mb-4 border-b border-slate-200">
      <button type="button"
        class="df-todo-tab px-4 py-2 text-sm font-medium transition-colors border-b-2 {% if request.GET.period == 'day' or not request.GET.period %}border-blue-600 text-blue-600{% else %}border-transparent text-slate-500 hover:text-slate-700{% endif %}"
        data-period="day">
        Ng√†y
      </button>
      <button type="button"
        class="df-todo-tab px-4 py-2 text-sm font-medium transition-colors border-b-2 {% if request.GET.period == 'week' %}border-purple-600 text-purple-600{% else %}border-transparent text-slate-500 hover:text-slate-700{% endif %}"
        data-period="week">
        Tu·∫ßn
      </button>
      <button type="button"
        class="df-todo-tab px-4 py-2 text-sm font-medium transition-colors border-b-2 {% if request.GET.period == 'month' %}border-orange-600 text-orange-600{% else %}border-transparent text-slate-500 hover:text-slate-700{% endif %}"
        data-period="month">
        Th√°ng
      </button>
      <button type="button"
        class="df-todo-tab px-4 py-2 text-sm font-medium transition-colors border-b-2 {% if request.GET.period == 'year' %}border-green-600 text-green-600{% else %}border-transparent text-slate-500 hover:text-slate-700{% endif %}"
        data-period="year">
        NƒÉm
      </button>
    </div>

    <!-- Add todo form -->
    <form id="todo-form" class="mb-4">
      <div class="flex gap-2">
        <input type="text" id="todo-input" placeholder="Th√™m m·ª•c ti√™u m·ªõi..."
          class="flex-1 px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
          maxlength="200" required />
        <select id="todo-period-type"
          class="px-3 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white">
          <option value="day">Ng√†y</option>
          <option value="week">Tu·∫ßn</option>
          <option value="month">Th√°ng</option>
          <option value="year">NƒÉm</option>
        </select>
        <button type="submit"
          class="px-5 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold text-sm transition-colors">
          Th√™m
        </button>
      </div>
    </form>

    <!-- Todo list -->
    <div id="todo-list" class="space-y-2">
      {% for todo in todo_items %}
      <div
        class="df-todo-item flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition-colors"
        data-todo-id="{{ todo.id }}">
        <button type="button"
          class="df-todo-checkbox flex-shrink-0 w-6 h-6 rounded-lg border-2 {% if todo.completed %}bg-blue-600 border-blue-600{% else %}border-slate-300{% endif %} flex items-center justify-center transition-all hover:scale-110"
          data-todo-id="{{ todo.id }}"
          title="{% if todo.completed %}ƒê√°nh d·∫•u ch∆∞a ho√†n th√†nh{% else %}ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh{% endif %}">
          {% if todo.completed %}
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
          </svg>
          {% endif %}
        </button>
        <div class="df-todo-title-wrapper flex-1 flex items-center gap-2">
          <span
            class="df-todo-title-display px-3 py-1.5 text-sm {% if todo.completed %}line-through text-slate-400{% else %}text-slate-900{% endif %} cursor-pointer hover:bg-slate-100 rounded-lg transition-colors"
            data-todo-id="{{ todo.id }}">
            {{ todo.title }}
          </span>
          <span
            class="text-xs px-2 py-0.5 rounded {% if todo.period_type == 'day' %}bg-blue-100 text-blue-700{% elif todo.period_type == 'week' %}bg-purple-100 text-purple-700{% elif todo.period_type == 'month' %}bg-orange-100 text-orange-700{% else %}bg-green-100 text-green-700{% endif %}">
            {% if todo.period_type == 'day' %}Ng√†y{% elif todo.period_type == 'week' %}Tu·∫ßn{% elif todo.period_type ==
            'month' %}Th√°ng{% else %}NƒÉm{% endif %}
          </span>
        </div>
        <button type="button"
          class="df-todo-edit flex-shrink-0 w-8 h-8 rounded-lg text-slate-400 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-colors"
          data-todo-id="{{ todo.id }}" title="Ch·ªânh s·ª≠a">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
            </path>
          </svg>
        </button>
        <button type="button"
          class="df-todo-delete flex-shrink-0 w-8 h-8 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 flex items-center justify-center transition-colors"
          data-todo-id="{{ todo.id }}" title="X√≥a">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
            </path>
          </svg>
        </button>
      </div>
      {% empty %}
      <div class="text-center py-8 text-slate-400">
        <p class="text-sm">Ch∆∞a c√≥ m·ª•c ti√™u n√†o. H√£y th√™m m·ª•c ti√™u ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
      </div>
      {% endfor %}
    </div>

    {% if todo_items|length >= 5 %}
    <div class="mt-4 text-center">
      <a href="{% url 'todos:todo_list' %}" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
        Xem t·∫•t c·∫£ m·ª•c ti√™u ‚Üí
      </a>
    </div>
    {% endif %}
  </section>

  <script>
    (function () {
      const todoForm = document.getElementById('todo-form');
      const todoInput = document.getElementById('todo-input');
      const todoPeriodType = document.getElementById('todo-period-type');
      const todoList = document.getElementById('todo-list');
      const currentPeriod = '{{ request.GET.period|default:"day" }}';

      // Set default period type in form based on current tab
      if (todoPeriodType) {
        todoPeriodType.value = currentPeriod;
      }

      // Function to load todos by period
      async function loadTodosByPeriod(period) {
        try {
          const response = await fetch(`{% url "todos:todo_list_api" %}?period=${period}`);
          const data = await response.json();

          if (data.success) {
            // Clear current list
            todoList.innerHTML = '';

            // Update period type in form
            if (todoPeriodType) {
              todoPeriodType.value = period;
            }

            // Update active tab
            document.querySelectorAll('.df-todo-tab').forEach(tab => {
              const tabPeriod = tab.dataset.period;
              if (tabPeriod === period) {
                // Set active styles
                const colors = {
                  'day': 'border-blue-600 text-blue-600',
                  'week': 'border-purple-600 text-purple-600',
                  'month': 'border-orange-600 text-orange-600',
                  'year': 'border-green-600 text-green-600'
                };
                tab.className = `df-todo-tab px-4 py-2 text-sm font-medium transition-colors border-b-2 ${colors[period]}`;
              } else {
                tab.className = 'df-todo-tab px-4 py-2 text-sm font-medium transition-colors border-b-2 border-transparent text-slate-500 hover:text-slate-700';
              }
            });

            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('period', period);
            window.history.pushState({ period: period }, '', url.toString());

            // Render todos
            if (data.todos.length === 0) {
              todoList.innerHTML = '<div class="text-center py-8 text-slate-400"><p class="text-sm">Ch∆∞a c√≥ m·ª•c ti√™u n√†o. H√£y th√™m m·ª•c ti√™u ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p></div>';
            } else {
              data.todos.forEach(todo => {
                const todoHTML = createTodoItemHTML(todo);
                todoList.insertAdjacentHTML('beforeend', todoHTML);
              });

              // Attach event listeners to all todos
              todoList.querySelectorAll('.df-todo-item').forEach(item => {
                attachTodoListeners(item);
              });

              // Sort todos: incomplete first, then completed
              sortTodos();
            }
          }
        } catch (error) {
          console.error('Error loading todos:', error);
        }
      }

      // Tab switching
      document.querySelectorAll('.df-todo-tab').forEach(tab => {
        tab.addEventListener('click', function () {
          const period = this.dataset.period;
          loadTodosByPeriod(period);
        });
      });

      // Helper function to get period badge HTML
      function getPeriodBadge(periodType) {
        const badges = {
          'day': '<span class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700">Ng√†y</span>',
          'week': '<span class="text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-700">Tu·∫ßn</span>',
          'month': '<span class="text-xs px-2 py-0.5 rounded bg-orange-100 text-orange-700">Th√°ng</span>',
          'year': '<span class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-700">NƒÉm</span>'
        };
        return badges[periodType] || badges['day'];
      }

      // Helper function to create todo item HTML
      function createTodoItemHTML(todo) {
        const completed = todo.completed || false;
        const completedClass = completed ? 'line-through text-slate-400' : 'text-slate-900';
        const checkboxClass = completed ? 'bg-blue-600 border-blue-600' : 'border-slate-300';
        const checkmark = completed ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : '';

        return `
          <div class="df-todo-item flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition-colors" data-todo-id="${todo.id}">
            <button
              type="button"
              class="df-todo-checkbox flex-shrink-0 w-6 h-6 rounded-lg border-2 ${checkboxClass} flex items-center justify-center transition-all hover:scale-110"
              data-todo-id="${todo.id}"
              title="${completed ? 'ƒê√°nh d·∫•u ch∆∞a ho√†n th√†nh' : 'ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh'}"
            >
              ${checkmark}
            </button>
            <div class="df-todo-title-wrapper flex-1 flex items-center gap-2">
              <span class="df-todo-title-display px-3 py-1.5 text-sm ${completedClass} cursor-pointer hover:bg-slate-100 rounded-lg transition-colors" data-todo-id="${todo.id}">
                ${todo.title}
              </span>
              ${getPeriodBadge(todo.period_type || 'day')}
            </div>
            <button
              type="button"
              class="df-todo-edit flex-shrink-0 w-8 h-8 rounded-lg text-slate-400 hover:text-blue-600 hover:bg-blue-50 flex items-center justify-center transition-colors"
              data-todo-id="${todo.id}"
              title="Ch·ªânh s·ª≠a"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </button>
            <button
              type="button"
              class="df-todo-delete flex-shrink-0 w-8 h-8 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 flex items-center justify-center transition-colors"
              data-todo-id="${todo.id}"
              title="X√≥a"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        `;
      }

      // Create todo
      todoForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        const title = todoInput.value.trim();
        if (!title) return;

        const submitBtn = todoForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang th√™m...';

        try {
          const response = await fetch('{% url "todos:todo_create" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
              title: title,
              period_type: todoPeriodType.value || currentPeriod
            })
          });

          const data = await response.json();
          if (data.success) {
            todoInput.value = '';
            // Only add if period_type matches current tab
            if (data.todo.period_type === currentPeriod) {
              // Remove empty message if exists
              const emptyMsg = todoList.querySelector('.text-center');
              if (emptyMsg) emptyMsg.remove();

              // Add new todo at the top
              const newTodoHTML = createTodoItemHTML(data.todo);
              todoList.insertAdjacentHTML('afterbegin', newTodoHTML);

              // Attach event listeners to new todo
              attachTodoListeners(todoList.querySelector(`[data-todo-id="${data.todo.id}"]`));

              // Sort todos: incomplete first, then completed
              sortTodos();
            } else {
              // If period doesn't match, switch to correct tab
              loadTodosByPeriod(data.todo.period_type);
            }
          } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫°o m·ª•c ti√™u'));
          }
        } catch (error) {
          console.error('Error:', error);
          alert('C√≥ l·ªói x·∫£y ra khi t·∫°o m·ª•c ti√™u');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });

      // Sort todos: incomplete first, then completed
      function sortTodos() {
        const items = Array.from(todoList.querySelectorAll('.df-todo-item'));
        items.sort((a, b) => {
          const aCompleted = a.querySelector('.df-todo-checkbox').classList.contains('bg-blue-600');
          const bCompleted = b.querySelector('.df-todo-checkbox').classList.contains('bg-blue-600');
          if (aCompleted === bCompleted) return 0;
          return aCompleted ? 1 : -1;
        });
        items.forEach(item => todoList.appendChild(item));
      }

      // Attach event listeners to a todo item
      function attachTodoListeners(todoItem) {
        if (!todoItem) return;

        const todoId = todoItem.dataset.todoId;
        const checkbox = todoItem.querySelector('.df-todo-checkbox');
        const titleDisplay = todoItem.querySelector('.df-todo-title-display');
        const editBtn = todoItem.querySelector('.df-todo-edit');
        const deleteBtn = todoItem.querySelector('.df-todo-delete');

        // Toggle completed
        if (checkbox) {
          checkbox.addEventListener('click', async function () {
            try {
              const response = await fetch(`/todos/${todoId}/toggle/`, {
                method: 'POST',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                }
              });

              const data = await response.json();
              if (data.success) {
                const completed = data.completed;
                if (completed) {
                  checkbox.classList.remove('border-slate-300');
                  checkbox.classList.add('bg-blue-600', 'border-blue-600');
                  checkbox.innerHTML = '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>';
                  titleDisplay.classList.add('line-through', 'text-slate-400');
                  titleDisplay.classList.remove('text-slate-900');
                } else {
                  checkbox.classList.remove('bg-blue-600', 'border-blue-600');
                  checkbox.classList.add('border-slate-300');
                  checkbox.innerHTML = '';
                  titleDisplay.classList.remove('line-through', 'text-slate-400');
                  titleDisplay.classList.add('text-slate-900');
                }
                sortTodos();
              }
            } catch (error) {
              console.error('Error:', error);
              alert('C√≥ l·ªói x·∫£y ra');
            }
          });
        }

        // Edit title
        if (editBtn) {
          editBtn.addEventListener('click', function () {
            const currentTitle = titleDisplay.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'flex-1 px-3 py-1.5 text-sm border border-blue-500 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none';
            input.maxLength = 200;

            const wrapper = titleDisplay.parentElement;
            wrapper.replaceChild(input, titleDisplay);
            input.focus();
            input.select();

            const saveEdit = async () => {
              const newTitle = input.value.trim();
              if (!newTitle) {
                wrapper.replaceChild(titleDisplay, input);
                return;
              }

              try {
                const response = await fetch(`/todos/${todoId}/update/`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                  },
                  body: JSON.stringify({ title: newTitle })
                });

                const data = await response.json();
                if (data.success) {
                  titleDisplay.textContent = newTitle;
                  wrapper.replaceChild(titleDisplay, input);
                } else {
                  alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'));
                  wrapper.replaceChild(titleDisplay, input);
                }
              } catch (error) {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra');
                wrapper.replaceChild(titleDisplay, input);
              }
            };

            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', function (e) {
              if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit();
              } else if (e.key === 'Escape') {
                wrapper.replaceChild(titleDisplay, input);
              }
            });
          });
        }

        // Delete todo
        if (deleteBtn) {
          deleteBtn.addEventListener('click', async function () {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c ti√™u n√†y?')) return;

            try {
              const response = await fetch(`/todos/${todoId}/delete/`, {
                method: 'POST',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                }
              });

              const data = await response.json();
              if (data.success) {
                todoItem.remove();
                // Show empty message if no todos left
                const remainingTodos = todoList.querySelectorAll('.df-todo-item');
                if (remainingTodos.length === 0) {
                  todoList.innerHTML = '<div class="text-center py-8 text-slate-400"><p class="text-sm">Ch∆∞a c√≥ m·ª•c ti√™u n√†o. H√£y th√™m m·ª•c ti√™u ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p></div>';
                }
              }
            } catch (error) {
              console.error('Error:', error);
              alert('C√≥ l·ªói x·∫£y ra');
            }
          });
        }
      }

      // Attach listeners to existing todos
      document.querySelectorAll('.df-todo-item').forEach(item => {
        attachTodoListeners(item);
      });
    })();
  </script>

  {% endif %}

  <!-- ƒê·ªÅ thi m·ªõi nh·∫•t (hi·ªÉn th·ªã cho c·∫£ logged in v√† not logged in) -->
  {% if latest_exams %}
  <section
    class="bg-white border border-slate-100 rounded-3xl shadow-sm p-6 {% if user.is_authenticated %}mt-6{% endif %}">
    <h2 class="text-xl font-bold text-slate-900 mb-6">ƒê·ªÅ thi m·ªõi nh·∫•t</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      {% for exam in latest_exams %}
      <div class="bg-slate-50 rounded-2xl p-4 border border-slate-200 hover:shadow-md transition-shadow">
        <h3 class="text-sm font-semibold text-slate-900 mb-3 line-clamp-2">{{ exam.title }}</h3>

        <div class="space-y-2 text-xs text-slate-600 mb-3">
          <div class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>
              {% if exam.level == "TOEIC" %}
              {% if exam.category == "LISTENING" %}
              40 ph√∫t
              {% elif exam.category == "READING" %}
              60 ph√∫t
              {% elif exam.category == "TOEIC_FULL" %}
              {{ exam.listening_time_limit_minutes|default:45 }} + {{ exam.reading_time_limit_minutes|default:75 }} ph√∫t
              {% else %}
              {{ exam.time_limit_minutes|default:60 }} ph√∫t
              {% endif %}
              {% else %}
              {{ exam.time_limit_minutes|default:60 }} ph√∫t
              {% endif %}
            </span>
          </div>

          <div class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span>{{ exam.attempt_count|default:0|floatformat:0 }}</span>
          </div>

          <div class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            <span>{{ exam.comment_count|default:0|floatformat:0 }}</span>
          </div>

          <div class="text-xs text-slate-500 pt-1">
            {% if exam.level == "TOEIC" %}
            {% if exam.category == "LISTENING" %}
            4 ph·∫ßn thi | {{ exam.total_questions }} c√¢u h·ªèi
            {% elif exam.category == "READING" %}
            3 ph·∫ßn thi | {{ exam.total_questions }} c√¢u h·ªèi
            {% elif exam.category == "TOEIC_FULL" %}
            7 ph·∫ßn thi | {{ exam.total_questions }} c√¢u h·ªèi
            {% else %}
            {{ exam.total_questions }} c√¢u h·ªèi
            {% endif %}
            {% else %}
            {{ exam.total_questions }} c√¢u h·ªèi
            {% endif %}
          </div>
        </div>

        <div class="flex flex-wrap gap-1 mb-3">
          {% if exam.level == "TOEIC" %}
          <span class="text-[10px] px-2 py-0.5 bg-blue-100 text-blue-700 rounded">#IELTS Academic</span>
          {% if exam.category == "LISTENING" %}
          <span class="text-[10px] px-2 py-0.5 bg-blue-100 text-blue-700 rounded">#Listening</span>
          {% elif exam.category == "READING" %}
          <span class="text-[10px] px-2 py-0.5 bg-blue-100 text-blue-700 rounded">#Reading</span>
          {% endif %}
          {% else %}
          <span class="text-[10px] px-2 py-0.5 bg-blue-100 text-blue-700 rounded">#{{ exam.get_level_display }}</span>
          {% if exam.category %}
          <span class="text-[10px] px-2 py-0.5 bg-blue-100 text-blue-700 rounded">#{{ exam.get_category_display
            }}</span>
          {% endif %}
          {% endif %}
        </div>

        <a href="{% url 'exam:exam_detail' exam.slug %}"
          class="block w-full text-center px-3 py-2 bg-blue-600 text-white text-xs font-semibold rounded-lg hover:bg-blue-700 transition-colors">
          Chi ti·∫øt
        </a>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}
</div>

<!-- Why Choose Us Section - Only for non-authenticated users -->
{% if not user.is_authenticated %}
{% include "components/landing/why_choose_us.html" %}
{% endif %}

<!-- Student Stories Section - Only for non-authenticated users -->
{% if not user.is_authenticated %}
{% include "components/landing/student_stories.html" %}
{% endif %}

{% if user.is_authenticated and streak and streak.current_streak > 0 %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const el = document.getElementById('streak-number');
    if (!el) return;
    const target = parseInt(el.dataset.streak, 10) || 0;
    let current = 0;
    const duration = 600;
    const start = performance.now();

    function animate(now) {
      const progress = Math.min((now - start) / duration, 1);
      current = Math.round(progress * target);
      el.textContent = current;
      if (progress < 1) requestAnimationFrame(animate);
    }

    requestAnimationFrame(animate);
  });
</script>
{% endif %}
{% endblock %}