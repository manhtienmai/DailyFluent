{# templates/home.html #}
{% extends "layouts/sidebar_layout.html" %}
{% load static %}

{% block title %}DailyFluent - Trang ch·ªß{% endblock %}

{% block extra_css %}
<style>
  /* ========================================
     Dashboard - Theme Aware Styles
     ======================================== */

  .df-dashboard {
    padding: 1.5rem 1rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Hero Section */
  .df-hero {
    display: grid;
    grid-template-columns: 200px 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 900px) {
    .df-hero {
      grid-template-columns: 1fr 1fr;
    }
    .df-hero-avatar {
      display: none;
    }
  }

  @media (max-width: 640px) {
    .df-hero {
      grid-template-columns: 1fr;
    }
  }

  /* Avatar Card */
  .df-hero-avatar {
    position: relative;
    border-radius: 1.5rem;
    overflow: hidden;
    height: 200px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .df-hero-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .df-hero-avatar-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5rem;
  }

  /* Stats Card */
  .df-vocab-stats {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 1.5rem;
    padding: 1rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    height: 200px;
  }

  .df-vocab-stat {
    text-align: center;
    padding: 0.5rem;
    background: var(--bg-surface);
    border-radius: 0.75rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .df-vocab-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.2;
  }

  .df-vocab-stat-value--primary {
    color: var(--action-primary);
  }

  .df-vocab-stat-value--secondary {
    color: var(--text-primary);
  }

  .df-vocab-stat-value--accent {
    color: var(--action-accent);
  }

  .df-vocab-stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
  }

  /* Streak Card */
  .df-streak-card {
    background: linear-gradient(135deg, #F97316, #FBBF24);
    border-radius: 1.5rem;
    padding: 1rem;
    color: #fff;
    position: relative;
    overflow: hidden;
    height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .df-streak-title {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.9;
    margin-bottom: 0.25rem;
  }

  .df-streak-count {
    display: flex;
    align-items: baseline;
    gap: 0.375rem;
    margin-bottom: 0.75rem;
  }

  .df-streak-number {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
  }

  .df-streak-unit {
    font-size: 0.875rem;
    opacity: 0.9;
  }

  /* Week Days */
  .df-streak-days {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
  }

  .df-streak-day {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6875rem;
    font-weight: 600;
    transition: all 0.2s;
  }

  .df-streak-day--inactive {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.7);
  }

  .df-streak-day--active {
    background: #fff;
    color: #F97316;
  }

  .df-streak-day--today {
    background: #fff;
    color: #F97316;
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.4);
  }

  /* Quick Access */
  .df-quick-access {
    margin-bottom: 2rem;
  }

  .df-quick-access-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-align: center;
    margin-bottom: 1rem;
  }

  .df-quick-access-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }

  @media (max-width: 768px) {
    .df-quick-access-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .df-quick-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 1rem;
    text-decoration: none;
    transition: all 0.2s;
  }

  .df-quick-card:hover {
    border-color: var(--action-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .df-quick-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  .df-quick-icon--blue { background: rgba(99, 102, 241, 0.15); }
  .df-quick-icon--yellow { background: rgba(245, 158, 11, 0.15); }
  .df-quick-icon--green { background: rgba(16, 185, 129, 0.15); }
  .df-quick-icon--red { background: rgba(239, 68, 68, 0.15); }

  .df-quick-text {
    flex: 1;
    min-width: 0;
  }

  .df-quick-label {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .df-quick-desc {
    font-size: 0.75rem;
    color: var(--text-tertiary);
  }

  .df-quick-arrow {
    color: var(--text-tertiary);
    transition: transform 0.2s;
  }

  .df-quick-card:hover .df-quick-arrow {
    transform: translateX(4px);
  }

  /* Section */
  .df-section {
    margin-bottom: 2rem;
  }

  .df-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .df-section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .df-section-link {
    font-size: 0.8125rem;
    color: var(--action-primary);
    text-decoration: none;
    font-weight: 500;
  }

  .df-section-link:hover {
    text-decoration: underline;
  }

  /* Course/Vocab Card */
  .df-item-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 1rem;
    text-decoration: none;
    transition: all 0.15s;
    margin-bottom: 0.75rem;
  }

  .df-item-card:hover {
    background: var(--bg-interactive);
    border-color: var(--action-primary);
  }

  .df-item-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .df-item-content {
    flex: 1;
    min-width: 0;
  }

  .df-item-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.125rem;
  }

  .df-item-meta {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  /* Two Column Grid */
  .df-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }

  @media (max-width: 768px) {
    .df-grid-2 {
      grid-template-columns: 1fr;
    }
  }

  .df-grid-section {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 1.25rem;
    padding: 1.25rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="df-dashboard">
  {% if user.is_authenticated %}

  <!-- Hero Section: Avatar + Vocab Stats + Streak -->
  <div class="df-hero">
    <!-- Avatar -->
    <div class="df-hero-avatar">
      {% if user.profile.avatar %}
        <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}">
      {% else %}
        <div class="df-hero-avatar-placeholder">üëã</div>
      {% endif %}
    </div>

    <!-- Vocabulary Stats -->
    <div class="df-vocab-stats">
      <div class="df-vocab-stat">
        <div class="df-vocab-stat-value df-vocab-stat-value--primary">{{ vocab_stats.mastered|default:0 }}</div>
        <div class="df-vocab-stat-label">ƒê√£ thu·ªôc</div>
      </div>
      <div class="df-vocab-stat">
        <div class="df-vocab-stat-value df-vocab-stat-value--secondary">{{ vocab_stats.learning|default:0 }}</div>
        <div class="df-vocab-stat-label">Ch∆∞a thu·ªôc</div>
      </div>
      <div class="df-vocab-stat">
        <div class="df-vocab-stat-value df-vocab-stat-value--primary">{{ vocab_stats.total|default:0 }}</div>
        <div class="df-vocab-stat-label">T·ªïng t·ª´</div>
      </div>
      <div class="df-vocab-stat">
        <div class="df-vocab-stat-value df-vocab-stat-value--accent">{{ vocab_stats.progress|default:"0%" }}</div>
        <div class="df-vocab-stat-label">Ti·∫øn ƒë·ªô</div>
      </div>
    </div>

    <!-- Streak Card -->
    <div class="df-streak-card">
      <div class="df-streak-title">üî• Chu·ªói ng√†y h·ªçc</div>
      <div class="df-streak-count">
        <span class="df-streak-number" id="streak-number" data-streak="{{ streak.current_streak|default:0 }}">{{ streak.current_streak|default:0 }}</span>
        <span class="df-streak-unit">ng√†y</span>
      </div>
      <div class="df-streak-days">
        {% for day in week_days %}
        <div class="df-streak-day {% if day.is_today %}df-streak-day--today{% elif day.studied %}df-streak-day--active{% else %}df-streak-day--inactive{% endif %}">
          {{ day.label }}
        </div>
        {% empty %}
        <div class="df-streak-day df-streak-day--inactive">T6</div>
        <div class="df-streak-day df-streak-day--inactive">T7</div>
        <div class="df-streak-day df-streak-day--inactive">CN</div>
        <div class="df-streak-day df-streak-day--inactive">T2</div>
        <div class="df-streak-day df-streak-day--inactive">T3</div>
        <div class="df-streak-day df-streak-day--today">T4</div>
        <div class="df-streak-day df-streak-day--inactive">T5</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Quick Access -->
  <div class="df-quick-access">
    <div class="df-quick-access-title">Truy c·∫≠p nhanh</div>
    <div class="df-quick-access-grid">
      <a href="{% url 'vocab:english_list' %}" class="df-quick-card">
        <div class="df-quick-icon df-quick-icon--blue">‚ûï</div>
        <div class="df-quick-text">
          <div class="df-quick-label">Th√™m t·ª´ m·ªõi</div>
          <div class="df-quick-desc">T·∫°o t·ª´ v·ª±ng c√° nh√¢n</div>
        </div>
        <svg class="df-quick-arrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </a>

      <a href="{% url 'vocab:games' %}" class="df-quick-card">
        <div class="df-quick-icon df-quick-icon--yellow">‚ö°</div>
        <div class="df-quick-text">
          <div class="df-quick-label">Luy·ªán t·∫≠p</div>
          <div class="df-quick-desc">Flashcard & Games</div>
        </div>
        <svg class="df-quick-arrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </a>

      <a href="{% url 'core:course_list' %}" class="df-quick-card">
        <div class="df-quick-icon df-quick-icon--green">üèõÔ∏è</div>
        <div class="df-quick-text">
          <div class="df-quick-label">L·ªô tr√¨nh h·ªçc</div>
          <div class="df-quick-desc">H·ªçc theo ch·ªß ƒë·ªÅ</div>
        </div>
        <svg class="df-quick-arrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </a>

      <a href="{% url 'core:profile' %}" class="df-quick-card">
        <div class="df-quick-icon df-quick-icon--red">üèÜ</div>
        <div class="df-quick-text">
          <div class="df-quick-label">X·∫øp h·∫°ng</div>
          <div class="df-quick-desc">Xem th√†nh t√≠ch</div>
        </div>
        <svg class="df-quick-arrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </a>
    </div>
  </div>

  <!-- Daily Goal + Heatmap -->
  <div class="df-grid-2 df-section">
    {% include "streak/_daily_goal.html" %}
    {% include "streak/_heatmap.html" %}
  </div>

  <!-- Courses + Exam Results -->
  <div class="df-grid-2 df-section">
    <!-- My Courses -->
    <div class="df-grid-section">
      <div class="df-section-header">
        <h2 class="df-section-title">üìö Kh√≥a h·ªçc c·ªßa t√¥i</h2>
        <a href="{% url 'core:course_list' %}" class="df-section-link">Xem t·∫•t c·∫£ ‚Üí</a>
      </div>
      {% if enrolled_courses %}
        {% for enrollment in enrolled_courses %}
        <a href="{% url 'core:course_detail' enrollment.course.slug %}" class="df-item-card">
          <div class="df-item-icon" style="background: linear-gradient(135deg, #6366F1, #8B5CF6); color: #fff;">
            {{ enrollment.course.title|slice:":2"|upper }}
          </div>
          <div class="df-item-content">
            <div class="df-item-title">{{ enrollment.course.title }}</div>
            <div class="df-item-meta">{% if enrollment.progress %}{{ enrollment.progress }}% ho√†n th√†nh{% else %}Ch∆∞a b·∫Øt ƒë·∫ßu{% endif %}</div>
          </div>
        </a>
        {% endfor %}
      {% else %}
        <p style="text-align: center; padding: 2rem; color: var(--text-tertiary);">
          B·∫°n ch∆∞a ƒëƒÉng k√Ω kh√≥a h·ªçc n√†o.<br>
          <a href="{% url 'core:course_list' %}" style="color: var(--action-primary);">Kh√°m ph√° kh√≥a h·ªçc ‚Üí</a>
        </p>
      {% endif %}
    </div>

    <!-- Exam Results -->
    <div class="df-grid-section">
      <div class="df-section-header">
        <h2 class="df-section-title">üìä K·∫øt qu·∫£ luy·ªán thi</h2>
        <a href="{% url 'core:profile' %}" class="df-section-link">Xem t·∫•t c·∫£ ‚Üí</a>
      </div>
      {% if recent_exam_results %}
        {% for result in recent_exam_results|slice:":3" %}
        <a href="{% url 'exam:exam_result' result.id %}" class="df-item-card">
          <div class="df-item-icon" style="{% if result.score >= 80 %}background: rgba(16, 185, 129, 0.15); color: #059669;{% elif result.score >= 60 %}background: rgba(245, 158, 11, 0.15); color: #D97706;{% else %}background: rgba(239, 68, 68, 0.15); color: #DC2626;{% endif %}">
            {{ result.score|floatformat:0 }}%
          </div>
          <div class="df-item-content">
            <div class="df-item-title">{{ result.template.title }}</div>
            <div class="df-item-meta">{{ result.submitted_at|date:"d/m/Y" }} ‚Ä¢ {{ result.correct_count }}/{{ result.total_questions }} c√¢u ƒë√∫ng</div>
          </div>
        </a>
        {% endfor %}
      {% else %}
        <p style="text-align: center; padding: 2rem; color: var(--text-tertiary);">
          B·∫°n ch∆∞a l√†m b√†i thi n√†o.<br>
          <a href="{% url 'exam:exam_list' %}" style="color: var(--action-primary);">L√†m b√†i thi ngay ‚Üí</a>
        </p>
      {% endif %}
    </div>
  </div>

  <!-- Latest Exams Section -->
  {% if latest_exams %}
  <div class="df-section">
    <div class="df-section-header">
      <h2 class="df-section-title">üìù ƒê·ªÅ thi m·ªõi nh·∫•t</h2>
      <a href="{% url 'exam:exam_list' %}" class="df-section-link">Xem t·∫•t c·∫£ ‚Üí</a>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
      {% for exam in latest_exams|slice:":8" %}
      <a href="{% url 'exam:exam_detail' exam.slug %}" class="df-item-card" style="flex-direction: column; text-align: center;">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÑ</div>
        <div class="df-item-title" style="font-size: 0.8125rem; line-height: 1.3;">{{ exam.title|truncatechars:40 }}</div>
        <div class="df-item-meta">{{ exam.total_questions }} c√¢u ‚Ä¢ {{ exam.attempt_count|default:0 }} l∆∞·ª£t</div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% else %}
  <!-- Non-authenticated user landing -->
  <div style="text-align: center; padding: 4rem 1rem;">
    <h1 style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem;">
      Ch√†o m·ª´ng ƒë·∫øn v·ªõi DailyFluent! üëã
    </h1>
    <p style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 2rem;">
      N·ªÅn t·∫£ng h·ªçc t·ª´ v·ª±ng v·ªõi ph∆∞∆°ng ph√°p SRS khoa h·ªçc
    </p>
    <div style="display: flex; justify-content: center; gap: 1rem;">
      <a href="{% url 'account_login' %}" style="padding: 0.75rem 1.5rem; background: var(--action-primary); color: #fff; border-radius: 0.75rem; text-decoration: none; font-weight: 600;">
        ƒêƒÉng nh·∫≠p
      </a>
      <a href="{% url 'account_signup' %}" style="padding: 0.75rem 1.5rem; background: var(--bg-interactive); color: var(--text-primary); border-radius: 0.75rem; text-decoration: none; font-weight: 600;">
        ƒêƒÉng k√Ω
      </a>
    </div>
  </div>
  {% endif %}
</div>

{% if user.is_authenticated and streak and streak.current_streak > 0 %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const el = document.getElementById('streak-number');
  if (!el) return;
  const target = parseInt(el.dataset.streak, 10) || 0;
  let current = 0;
  const duration = 600;
  const start = performance.now();

  function animate(now) {
    const progress = Math.min((now - start) / duration, 1);
    current = Math.round(progress * target);
    el.textContent = current;
    if (progress < 1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
});
</script>
{% endif %}

{% if not user.is_authenticated %}
{% include "components/landing/why_choose_us.html" %}
{% include "components/landing/student_stories.html" %}
{% endif %}
{% endblock %}