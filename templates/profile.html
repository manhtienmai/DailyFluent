{% extends "layouts/sidebar_layout.html" %}
{% load static %}

{% block title %}{{ profile_user.username }} | DailyFluent{% endblock %}

{% block extra_css %}
<style>
  /* ========================================
     Profile Page - Theme Aware
     ======================================== */
  .df-profile {
    max-width: 800px;
    margin: 0 auto;
    padding: 1.5rem 1rem;
  }

  /* Header Card */
  .df-profile-header {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 1.25rem;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .df-profile-banner {
    height: 100px;
    background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #EC4899 100%);
    position: relative;
  }

  .df-profile-content {
    display: flex;
    align-items: flex-start;
    gap: 1.25rem;
    padding: 1.25rem;
    margin-top: -40px;
  }

  .df-profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: var(--card-bg);
    border: 3px solid var(--card-bg);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    flex-shrink: 0;
  }

  .df-profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .df-profile-avatar-placeholder {
    width: 100%;
    height: 100%;
    background: var(--bg-interactive);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
  }

  .df-profile-info {
    flex: 1;
    padding-top: 2.5rem;
  }

  .df-profile-name {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .df-profile-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.8125rem;
    color: var(--text-secondary);
  }

  .df-profile-meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .df-profile-meta-item svg {
    width: 14px;
    height: 14px;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .df-profile-stats {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .df-profile-stat {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 0.875rem;
    padding: 1rem;
    text-align: center;
    box-shadow: var(--shadow-sm);
  }

  .df-profile-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary); /* Changed from Action Primary for better neutrality, or keep custom */
    line-height: 1;
    margin-bottom: 0.25rem;
  }

  .df-profile-stat-label {
    font-size: 0.6875rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    font-weight: 600;
  }

  /* Tabs */
  .df-profile-tabs {
    display: flex;
    gap: 0.25rem;
    margin-bottom: 1.25rem;
    background: var(--bg-interactive);
    padding: 0.25rem;
    border-radius: 0.75rem;
  }

  .df-profile-tab {
    flex: 1;
    padding: 0.625rem 1rem;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-secondary);
    background: transparent;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .df-profile-tab:hover {
    color: var(--text-primary);
    background: rgba(0,0,0,0.05);
  }
  
  [data-theme="dark"] .df-profile-tab:hover {
    background: rgba(255,255,255,0.05); /* Dark mode hover */
  }

  .df-profile-tab--active {
    background: var(--card-bg) !important;
    color: var(--text-primary) !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  /* Tab Content */
  .df-profile-panel {
    display: none;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .df-profile-panel--active {
    display: block;
  }

  /* Section */
  .df-profile-section {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-sm);
  }

  .df-profile-section-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Course Card */
  .df-profile-course {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.875rem;
    background: var(--bg-surface);
    border-radius: 0.75rem;
    margin-bottom: 0.5rem;
    text-decoration: none;
    transition: all 0.15s;
    border: 1px solid transparent;
  }

  .df-profile-course:hover {
    background: var(--bg-interactive);
    border-color: var(--card-border);
    transform: translateY(-1px);
  }

  .df-profile-course-icon {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: linear-gradient(135deg, #6366F1, #8B5CF6);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 700;
    flex-shrink: 0;
    box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
  }

  .df-profile-course-info {
    flex: 1;
    min-width: 0;
  }

  .df-profile-course-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.125rem;
  }

  .df-profile-course-meta {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  .df-profile-course-progress {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--action-primary);
  }

  /* Exam Result Card */
  .df-profile-result {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.875rem;
    background: var(--bg-surface);
    border-radius: 0.75rem;
    margin-bottom: 0.5rem;
    text-decoration: none;
    transition: all 0.15s;
    border: 1px solid transparent;
  }

  .df-profile-result:hover {
    background: var(--bg-interactive);
    border-color: var(--card-border);
    transform: translateY(-1px);
  }

  .df-profile-result-score {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 700;
    flex-shrink: 0;
  }

  .df-profile-result-score--high {
    background: rgba(16, 185, 129, 0.15);
    color: #059669;
  }
  [data-theme="dark"] .df-profile-result-score--high {
    background: rgba(16, 185, 129, 0.2);
    color: #34d399; /* Lighter green for dark mode */
  }

  .df-profile-result-score--mid {
    background: rgba(245, 158, 11, 0.15);
    color: #D97706;
  }
  [data-theme="dark"] .df-profile-result-score--mid {
    background: rgba(245, 158, 11, 0.2);
    color: #fbbf24; /* Lighter amber for dark mode */
  }

  .df-profile-result-score--low {
    background: rgba(239, 68, 68, 0.15);
    color: #DC2626;
  }
  [data-theme="dark"] .df-profile-result-score--low {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171; /* Lighter red for dark mode */
  }

  .df-profile-result-info {
    flex: 1;
    min-width: 0;
  }

  .df-profile-result-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.125rem;
  }

  .df-profile-result-meta {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  .df-profile-result-arrow {
    color: var(--text-tertiary);
  }

  /* Empty State */
  .df-profile-empty {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-tertiary);
  }

  .df-profile-empty-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
  }

  .df-profile-empty-text {
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .df-profile-empty-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: var(--action-primary);
    color: var(--action-primary-text);
    font-size: 0.8125rem;
    font-weight: 600;
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.15s;
  }

  .df-profile-empty-btn:hover {
    background: var(--action-primary-hover);
  }

  /* Badges Grid */
  .df-badges-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 1rem;
  }

  .df-badge-card {
    background: var(--bg-surface);
    border: 1px solid var(--card-border);
    border-radius: 1rem;
    padding: 1.25rem 1rem;
    text-align: center;
    transition: all 0.2s;
    position: relative;
  }

  .df-badge-card--earned {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
    border-color: rgba(99, 102, 241, 0.3);
  }

  .df-badge-card--earned:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
  }

  .df-badge-card--locked {
    opacity: 0.5;
    filter: grayscale(0.8);
  }

  .df-badge-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    display: block;
  }

  .df-badge-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .df-badge-desc {
    font-size: 0.75rem;
    color: var(--text-secondary);
    line-height: 1.3;
  }

  .df-badge-earned-date {
    font-size: 0.6875rem;
    color: var(--text-tertiary);
    margin-top: 0.5rem;
  }

  .df-badge-lock-icon {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 0.875rem;
    opacity: 0.5;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .df-profile-content {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .df-profile-info {
      padding-top: 0.5rem;
    }

    .df-profile-meta {
      justify-content: center;
    }

    .df-badges-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="df-profile">
  <!-- Header Card -->
  <div class="df-profile-header">
    <div class="df-profile-banner"></div>
    <div class="df-profile-content">
      <div class="df-profile-avatar">
        {% if profile_user.profile.avatar %}
        <img src="{{ profile_user.profile.avatar.url }}" alt="{{ profile_user.username }}">
        {% else %}
        <div class="df-profile-avatar-placeholder">üë§</div>
        {% endif %}
      </div>
      <div class="df-profile-info">
        <h1 class="df-profile-name">
          {% if profile_user.get_full_name %}
            {{ profile_user.get_full_name }}
            <span style="font-size: 0.875rem; color: var(--text-secondary); font-weight: normal; margin-left: 0.5rem;">@{{ profile_user.username }}</span>
          {% else %}
            {{ profile_user.username }}
          {% endif %}
        </h1>
        <div class="df-profile-meta">
          <span class="df-profile-meta-item">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            Tham gia {{ profile_user.date_joined|date:"m/Y" }}
          </span>
          {% if streak %}
          <span class="df-profile-meta-item">
            üî• {{ streak.current_streak }} ng√†y streak
          </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div class="df-profile-stats">
    <div class="df-profile-stat">
      <div class="df-profile-stat-value">{{ total_exams|default:0 }}</div>
      <div class="df-profile-stat-label">B√†i thi</div>
    </div>
    <div class="df-profile-stat">
      <div class="df-profile-stat-value">{{ total_courses|default:0 }}</div>
      <div class="df-profile-stat-label">Kh√≥a h·ªçc</div>
    </div>
    <div class="df-profile-stat">
      <div class="df-profile-stat-value">{{ total_vocab|default:0 }}</div>
      <div class="df-profile-stat-label">T·ª´ v·ª±ng</div>
    </div>
    <div class="df-profile-stat">
      <div class="df-profile-stat-value">{{ streak.longest_streak|default:0 }}</div>
      <div class="df-profile-stat-label">K·ª∑ l·ª•c streak</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="df-profile-tabs">
    <button type="button" class="df-profile-tab df-profile-tab--active" data-tab="badges">
      üèÜ Th√†nh t·ª±u
    </button>
    <button type="button" class="df-profile-tab" data-tab="courses">
      üìö Kh√≥a h·ªçc
    </button>
    <button type="button" class="df-profile-tab" data-tab="results">
      üìä K·∫øt qu·∫£ thi
    </button>
  </div>

  <!-- Panel: Badges -->
  <div id="panel-badges" class="df-profile-panel df-profile-panel--active">
    <div class="df-profile-section">
      <div class="df-profile-section-title">üèÜ Huy hi·ªáu th√†nh t·ª±u</div>
      
      <div class="df-badges-grid">
        {% for item in badges_with_status %}
        <div class="df-badge-card {% if item.earned %}df-badge-card--earned{% else %}df-badge-card--locked{% endif %}">
          {% if not item.earned %}
          <span class="df-badge-lock-icon">üîí</span>
          {% endif %}
          <span class="df-badge-icon">{{ item.badge.icon }}</span>
          <div class="df-badge-name">{{ item.badge.name }}</div>
          <div class="df-badge-desc">{{ item.badge.description }}</div>
          {% if item.earned and item.earned_at %}
          <div class="df-badge-earned-date">ƒê·∫°t ƒë∆∞·ª£c {{ item.earned_at|date:"d/m/Y" }}</div>
          {% endif %}
        </div>
        {% empty %}
        <div class="df-profile-empty" style="grid-column: 1 / -1;">
          <div class="df-profile-empty-icon">üèÜ</div>
          <p class="df-profile-empty-text">Ch∆∞a c√≥ huy hi·ªáu n√†o. H√£y ti·∫øp t·ª•c h·ªçc t·∫≠p!</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Panel: Courses -->
  <div id="panel-courses" class="df-profile-panel">
    <div class="df-profile-section">
      <div class="df-profile-section-title">Kh√≥a h·ªçc ƒë√£ ƒëƒÉng k√Ω</div>
      
      {% if enrolled_courses %}
        {% for enrollment in enrolled_courses %}
        <a href="{% url 'core:course_detail' enrollment.course.slug %}" class="df-profile-course">
          <div class="df-profile-course-icon">{{ enrollment.course.title|slice:":2"|upper }}</div>
          <div class="df-profile-course-info">
            <div class="df-profile-course-name">{{ enrollment.course.title }}</div>
            <div class="df-profile-course-meta">{{ enrollment.course.lessons.count }} b√†i h·ªçc</div>
          </div>
          <div class="df-profile-course-progress">{{ enrollment.progress|default:0 }}%</div>
        </a>
        {% endfor %}
      {% else %}
        <div class="df-profile-empty">
          <div class="df-profile-empty-icon">üìö</div>
          <p class="df-profile-empty-text">Ch∆∞a tham gia kh√≥a h·ªçc n√†o</p>
          <a href="{% url 'core:course_list' %}" class="df-profile-empty-btn">Kh√°m ph√° kh√≥a h·ªçc</a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Panel: Results -->
  <div id="panel-results" class="df-profile-panel">
    <div class="df-profile-section">
      <div class="df-profile-section-title">K·∫øt qu·∫£ luy·ªán thi g·∫ßn nh·∫•t</div>
      
      {% if recent_exam_results %}
        {% for result in recent_exam_results %}
        <a href="{% url 'exam:exam_result' result.id %}" class="df-profile-result">
          <div class="df-profile-result-score {% if result.score >= 80 %}df-profile-result-score--high{% elif result.score >= 60 %}df-profile-result-score--mid{% else %}df-profile-result-score--low{% endif %}">
            {{ result.score|floatformat:0 }}%
          </div>
          <div class="df-profile-result-info">
            <div class="df-profile-result-title">{{ result.template.title }}</div>
            <div class="df-profile-result-meta">{{ result.submitted_at|date:"d/m/Y" }} ‚Ä¢ {{ result.correct_count }}/{{ result.total_questions }} c√¢u ƒë√∫ng</div>
          </div>
          <svg class="df-profile-result-arrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </a>
        {% endfor %}
      {% else %}
        <div class="df-profile-empty">
          <div class="df-profile-empty-icon">üìù</div>
          <p class="df-profile-empty-text">Ch∆∞a c√≥ k·∫øt qu·∫£ luy·ªán thi n√†o</p>
          <a href="{% url 'exam:exam_list' %}" class="df-profile-empty-btn">L√†m b√†i thi ngay</a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  document.querySelectorAll('.df-profile-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const tabId = this.dataset.tab;
      
      document.querySelectorAll('.df-profile-tab').forEach(t => {
        t.classList.remove('df-profile-tab--active');
      });
      this.classList.add('df-profile-tab--active');
      
      document.querySelectorAll('.df-profile-panel').forEach(panel => {
        panel.classList.remove('df-profile-panel--active');
      });
      document.getElementById('panel-' + tabId)?.classList.add('df-profile-panel--active');
    });
  });
})();
</script>
{% endblock %}