{% extends "layouts/sidebar_layout.html" %}
{% load static %}

{% block title %}{{ profile_user.username }} | DailyFluent{% endblock %}

{% block extra_css %}
<style>
  .df-profile-page { max-width: 1100px; margin: 0 auto; }
  
  .df-profile-cover {
    height: 200px;
    background: {% if user_profile.cover_image %}url('{{ user_profile.cover_image.url }}') center/cover{% else %}linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #a18cd1 100%){% endif %};
    position: relative;
  }
  .df-profile-cover-overlay { position: absolute; bottom: 0; left: 0; right: 0; height: 60px; background: linear-gradient(to top, var(--bg-main), transparent); }
  .df-profile-cover-edit { position: absolute; top: 1rem; right: 1rem; padding: 0.5rem 1rem; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.875rem; }
  
  .df-profile-avatar-section { display: flex; justify-content: center; margin-top: -80px; position: relative; z-index: 10; margin-bottom: 1rem; }
  .df-profile-avatar-wrapper { position: relative; width: 170px; height: 170px; display: flex; align-items: center; justify-content: center; }
  .df-profile-avatar { width: 130px; height: 130px; border-radius: 50%; background: var(--bg-surface); border: 4px solid var(--bg-surface); box-shadow: 0 8px 24px rgba(0,0,0,0.15); overflow: hidden; position: relative; z-index: 2; }
  .df-profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .df-profile-avatar-placeholder { width: 100%; height: 100%; background: linear-gradient(135deg, #f97316, #ea580c); display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white; font-weight: 700; }
  .df-profile-avatar-edit { position: absolute; bottom: 15px; right: 15px; width: 36px; height: 36px; background: var(--action-primary); color: white; border: 3px solid var(--bg-surface); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }
  
  /* Equipped Frame Overlay */
  .df-avatar-frame { position: absolute; inset: 0; border-radius: 50%; z-index: 1; pointer-events: none; }
  .df-avatar-frame--gradient { border: 6px solid transparent; background-origin: border-box; background-clip: padding-box, border-box; }
  .df-avatar-frame--glow { animation: frame-glow 2s ease-in-out infinite; }
  .df-avatar-frame--pulse { animation: frame-pulse 1.5s ease-in-out infinite; }
  .df-avatar-frame--rainbow { animation: frame-rainbow 3s linear infinite; }
  .df-avatar-frame--spin { animation: frame-spin 8s linear infinite; }
  @keyframes frame-glow { 0%,100% { filter: drop-shadow(0 0 8px currentColor); } 50% { filter: drop-shadow(0 0 20px currentColor); } }
  @keyframes frame-pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.03); } }
  @keyframes frame-rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
  @keyframes frame-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .df-profile-name-section { text-align: center; padding: 0 1.5rem; margin-bottom: 1.5rem; }
  .df-profile-name { font-size: 1.75rem; font-weight: 800; color: var(--text-primary); display: inline-flex; align-items: center; gap: 0.5rem; }
  .df-profile-edit-btn { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-interactive); border: 1px solid var(--border-subtle); border-radius: 6px; cursor: pointer; }
  .df-profile-edit-btn:hover { background: var(--bg-surface); color: var(--text-primary); }
  
  .df-profile-main { display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; padding: 0 1.5rem 2rem; }
  @media (max-width: 900px) { .df-profile-main { grid-template-columns: 1fr; } .df-profile-sidebar { order: -1; } }
  
  .df-profile-card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 1rem; margin-bottom: 1.25rem; overflow: hidden; }
  .df-profile-card-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-subtle); background: var(--bg-muted); }
  .df-profile-card-title { font-size: 0.8125rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }
  .df-profile-card-body { padding: 1.25rem; }
  
  .df-profile-bio { font-size: 0.9375rem; color: var(--text-secondary); line-height: 1.6; }
  .df-profile-bio-placeholder { color: var(--text-tertiary); font-style: italic; }
  
  .df-profile-tabs { display: flex; border-bottom: 1px solid var(--border-subtle); background: var(--bg-surface); padding: 0 1.25rem; }
  .df-profile-tab { padding: 0.875rem 1rem; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); background: transparent; border: none; border-bottom: 2px solid transparent; cursor: pointer; margin-bottom: -1px; }
  .df-profile-tab:hover { color: var(--text-primary); }
  .df-profile-tab--active { color: var(--action-primary); border-bottom-color: var(--action-primary); }
  
  .df-profile-panel { display: none; } .df-profile-panel--active { display: block; }
  
  .df-profile-about-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; }
  .df-profile-about-subtitle { font-size: 0.9375rem; color: #10b981; font-family: monospace; margin-bottom: 1.25rem; }
  
  .df-social-links { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
  .df-social-link { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; font-size: 0.75rem; font-weight: 600; color: white; border-radius: 6px; text-decoration: none; }
  .df-social-link--facebook { background: #1877F2; } .df-social-link--tiktok { background: #000; } .df-social-link--gmail { background: #EA4335; } .df-social-link--linkedin { background: #0A66C2; } .df-social-link--github { background: #24292e; }
  
  .df-profile-info-list { list-style: none; padding: 0; margin: 0 0 1.5rem 0; }
  .df-profile-info-item { display: flex; align-items: flex-start; gap: 0.625rem; padding: 0.5rem 0; font-size: 0.9375rem; color: var(--text-primary); }
  
  .df-profile-section-title { font-size: 1.125rem; font-weight: 700; color: var(--text-primary); margin: 1.5rem 0 1rem; display: flex; align-items: center; gap: 0.5rem; }
  
  .df-skills-group { margin-bottom: 1rem; }
  .df-skills-label { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.375rem; }
  .df-skills-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .df-skill-tag { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.375rem 0.75rem; font-size: 0.75rem; font-weight: 600; color: white; border-radius: 6px; text-transform: uppercase; }
  .df-skill-tag--red { background: #EF4444; } .df-skill-tag--blue { background: #3B82F6; } .df-skill-tag--purple { background: #8B5CF6; } .df-skill-tag--green { background: #10B981; } .df-skill-tag--orange { background: #F97316; } .df-skill-tag--gray { background: #6B7280; }
  
  .df-certificates-list { list-style: disc; padding-left: 1.25rem; margin: 0.75rem 0; }
  .df-certificates-list li { font-size: 0.9375rem; color: var(--text-primary); padding: 0.375rem 0; }
  .df-certificate-score { color: var(--action-primary); font-weight: 700; }
  
  .df-hobbies-list { margin: 0.75rem 0; }
  .df-hobby-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0; font-size: 0.9375rem; color: var(--text-primary); }
  
  .df-profile-sidebar { display: flex; flex-direction: column; gap: 1.25rem; }
  .df-achievement-card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: 0.75rem; overflow: hidden; }
  .df-achievement-card-header { padding: 0.875rem 1rem; font-size: 0.9375rem; font-weight: 700; color: var(--text-primary); border-bottom: 1px solid var(--border-subtle); }
  .df-achievement-card-body { padding: 0.5rem; }
  .df-achievement-item { display: flex; align-items: center; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.25rem; }
  .df-achievement-item--orange { background: rgba(249,115,22,0.08); } .df-achievement-item--orange .df-achievement-value { color: #F97316; }
  .df-achievement-item--red { background: rgba(239,68,68,0.08); } .df-achievement-item--red .df-achievement-value { color: #EF4444; }
  .df-achievement-item--green { background: rgba(16,185,129,0.08); } .df-achievement-item--green .df-achievement-value { color: #10B981; }
  .df-achievement-value { font-size: 1rem; font-weight: 700; margin-right: 0.375rem; }
  .df-achievement-label { font-size: 0.875rem; color: var(--text-secondary); }
  
  .df-badges-preview { padding: 1rem; text-align: center; }
  .df-badge-mascot { width: 80px; height: 80px; margin: 0 auto 0.75rem; background: var(--bg-interactive); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; }
  .df-badges-empty-text { font-size: 0.875rem; color: var(--text-tertiary); }
  .df-badges-grid-mini { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; padding: 1rem; }
  .df-badge-mini { text-align: center; padding: 0.5rem; background: var(--bg-interactive); border-radius: 0.5rem; }
  .df-badge-mini-icon { font-size: 1.5rem; display: block; margin-bottom: 0.25rem; }
  .df-badge-mini-name { font-size: 0.6875rem; color: var(--text-secondary); }
  
  .df-stats-inline { display: flex; gap: 1.5rem; padding: 1rem 1.25rem; background: var(--bg-muted); border-radius: 0.75rem; }
  .df-stat-inline { text-align: center; flex: 1; }
  .df-stat-inline-value { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
  .df-stat-inline-label { font-size: 0.6875rem; color: var(--text-tertiary); text-transform: uppercase; }
  
  .df-course-mini { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; text-decoration: none; }
  .df-course-mini:hover { background: var(--bg-interactive); }
  .df-course-mini-icon { width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #6366F1, #8B5CF6); color: white; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; }
  .df-course-mini-info { flex: 1; min-width: 0; }
  .df-course-mini-name { font-size: 0.8125rem; font-weight: 600; color: var(--text-primary); }
  .df-course-mini-meta { font-size: 0.6875rem; color: var(--text-tertiary); }
  
  /* Modal */
  .df-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
  .df-modal--active { display: flex; }
  .df-modal-content { background: var(--bg-surface); border-radius: 1rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
  .df-modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
  .df-modal-title { font-size: 1.125rem; font-weight: 700; }
  .df-modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
  .df-modal-body { padding: 1.25rem; }
  .df-form-group { margin-bottom: 1rem; }
  .df-form-label { display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; }
  .df-form-input, .df-form-textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-default); border-radius: 0.5rem; font-size: 0.9375rem; background: var(--bg-surface); color: var(--text-primary); }
  .df-form-textarea { min-height: 100px; resize: vertical; }
  .df-modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 0.75rem; }
  .df-btn { padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; border: none; }
  .df-btn--primary { background: var(--action-primary); color: white; }
  .df-btn--secondary { background: var(--bg-interactive); color: var(--text-primary); }
  
  @media (max-width: 640px) {
    .df-profile-cover { height: 140px; }
    .df-profile-avatar-section { margin-top: -60px; }
    .df-profile-avatar { width: 120px; height: 120px; }
    .df-profile-main { padding: 0 1rem 2rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="df-profile-page">
  <!-- Cover -->
  <div class="df-profile-cover">
    <div class="df-profile-cover-overlay"></div>
    {% if is_own_profile %}
    <button class="df-profile-cover-edit" onclick="uploadCover()">üì∑ ƒê·ªïi ·∫£nh b√¨a</button>
    {% endif %}
  </div>
  
  <!-- Avatar -->
  <div class="df-profile-avatar-section">
    <div class="df-profile-avatar-wrapper">
      <!-- Equipped Frame Overlay -->
      {% if equipped_frame %}
      <div class="df-avatar-frame df-avatar-frame--gradient{% if equipped_frame.css_animation %} df-avatar-frame--{{ equipped_frame.css_animation }}{% endif %}"
           style="background-image: linear-gradient(var(--bg-surface), var(--bg-surface)), {{ equipped_frame.css_gradient }}; border-width: {{ equipped_frame.border_width }}px;">
      </div>
      {% endif %}
      
      <div class="df-profile-avatar">
        {% if user_profile.avatar %}
        <img src="{{ user_profile.avatar.url }}" alt="{{ profile_user.username }}">
        {% else %}
        <div class="df-profile-avatar-placeholder">{{ profile_user.username|slice:":1"|upper }}</div>
        {% endif %}
      </div>
      {% if is_own_profile %}
      <button class="df-profile-avatar-edit" onclick="uploadAvatar()">üì∑</button>
      {% endif %}
    </div>
  </div>
  
  <!-- Name -->
  <div class="df-profile-name-section">
    <h1 class="df-profile-name">
      {% if profile_user.get_full_name %}{{ profile_user.get_full_name }}{% else %}{{ profile_user.username }}{% endif %}
      {% if is_own_profile %}<button class="df-profile-edit-btn" onclick="openModal('bio-modal')">‚úèÔ∏è S·ª≠a</button>{% endif %}
    </h1>
  </div>
  
  <!-- Bio Card -->
  <div style="padding: 0 1.5rem; margin-bottom: 1.25rem;">
    <div class="df-profile-card">
      <div class="df-profile-card-header">
        <span class="df-profile-card-title">GI·ªöI THI·ªÜU</span>
        {% if is_own_profile %}<button class="df-profile-edit-btn" onclick="openModal('bio-modal')">‚úèÔ∏è</button>{% endif %}
      </div>
      <div class="df-profile-card-body">
        <p class="df-profile-bio {% if not user_profile.bio %}df-profile-bio-placeholder{% endif %}">
          {{ user_profile.bio|default:"Nh·∫•n ch·ªânh s·ª≠a ƒë·ªÉ th√™m gi·ªõi thi·ªáu..." }}
        </p>
      </div>
    </div>
  </div>
  
  <!-- Main + Sidebar -->
  <div class="df-profile-main">
    <div class="df-profile-content">
      <div class="df-profile-card">
        <div class="df-profile-tabs">
          <button class="df-profile-tab df-profile-tab--active" data-tab="about">Gi·ªõi thi·ªáu</button>
          <button class="df-profile-tab" data-tab="courses">Kh√≥a h·ªçc</button>
          <button class="df-profile-tab" data-tab="results">K·∫øt qu·∫£ thi</button>
        </div>
        
        <div class="df-profile-card-body">
          <!-- About Panel -->
          <div id="panel-about" class="df-profile-panel df-profile-panel--active">
            <div class="df-profile-about-title">{{ user_profile.display_title|default:"Hello Fellow < Love />! üëã" }}</div>
            <p class="df-profile-about-subtitle">{{ user_profile.subtitle|default:"Ch√†o m·ª´ng ƒë·∫øn trang c√° nh√¢n" }}</p>
            
            <!-- Social Links -->
            <div class="df-social-links">
              {% for key, url in user_profile.social_links.items %}
              <a href="{{ url }}" class="df-social-link df-social-link--{{ key }}" target="_blank">{{ key|upper }}</a>
              {% empty %}
              <a href="#" class="df-social-link df-social-link--facebook">FACEBOOK</a>
              <a href="#" class="df-social-link df-social-link--tiktok">TIKTOK</a>
              <a href="#" class="df-social-link df-social-link--gmail">GMAIL</a>
              <a href="#" class="df-social-link df-social-link--linkedin">LINKEDIN</a>
              {% endfor %}
            </div>
            
            <!-- Info Items -->
            <ul class="df-profile-info-list">
              {% for item in user_profile.info_items %}
              <li class="df-profile-info-item"><span>{{ item.icon }}</span><span>{{ item.text }}</span></li>
              {% empty %}
              <li class="df-profile-info-item"><span>üëã</span><span>Xin ch√†o, m√¨nh l√† {{ profile_user.username }}</span></li>
              <li class="df-profile-info-item"><span>üíº</span><span>M√¨nh l√† ng∆∞·ªùi h·ªçc...</span></li>
              {% endfor %}
            </ul>
            
            <!-- Skills -->
            <h3 class="df-profile-section-title"><span>&lt;/&gt;</span> K·ªπ nƒÉng {% if is_own_profile %}<button class="df-profile-edit-btn" onclick="openModal('skills-modal')">‚úèÔ∏è</button>{% endif %}</h3>
            
            {% if user_profile.skills.languages %}
            <div class="df-skills-group">
              <div class="df-skills-label">üìö Ng√¥n ng·ªØ:</div>
              <div class="df-skills-tags">
                {% for lang in user_profile.skills.languages %}
                <span class="df-skill-tag df-skill-tag--blue">{{ lang }}</span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            {% if user_profile.skills.tools %}
            <div class="df-skills-group">
              <div class="df-skills-label">üõ†Ô∏è C√¥ng c·ª•:</div>
              <div class="df-skills-tags">
                {% for tool in user_profile.skills.tools %}
                <span class="df-skill-tag df-skill-tag--green">{{ tool }}</span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <!-- Certificates -->
            <h3 class="df-profile-section-title">üìú Ch·ª©ng ch·ªâ {% if is_own_profile %}<button class="df-profile-edit-btn" onclick="openModal('certs-modal')">‚úèÔ∏è</button>{% endif %}</h3>
            <ul class="df-certificates-list">
              {% for cert in user_profile.certificates %}
              <li>{{ cert.name }} <span class="df-certificate-score">{{ cert.score }}</span></li>
              {% empty %}
              <li style="color: var(--text-tertiary);">Ch∆∞a c√≥ ch·ª©ng ch·ªâ n√†o</li>
              {% endfor %}
            </ul>
            
            <!-- Hobbies -->
            <h3 class="df-profile-section-title">üìã S·ªü th√≠ch {% if is_own_profile %}<button class="df-profile-edit-btn" onclick="openModal('hobbies-modal')">‚úèÔ∏è</button>{% endif %}</h3>
            <div class="df-hobbies-list">
              {% for hobby in user_profile.hobbies %}
              <div class="df-hobby-item"><span>{{ hobby.icon }}</span>{{ hobby.text }}</div>
              {% empty %}
              <div class="df-hobby-item" style="color: var(--text-tertiary);">Ch∆∞a c√≥ s·ªü th√≠ch n√†o</div>
              {% endfor %}
            </div>
          </div>
          
          <!-- Courses Panel -->
          <div id="panel-courses" class="df-profile-panel">
            {% for enrollment in enrolled_courses %}
            <a href="{% url 'core:course_detail' enrollment.course.slug %}" class="df-course-mini">
              <div class="df-course-mini-icon">{{ enrollment.course.title|slice:":2"|upper }}</div>
              <div class="df-course-mini-info">
                <div class="df-course-mini-name">{{ enrollment.course.title }}</div>
                <div class="df-course-mini-meta">{{ enrollment.course.lessons.count }} b√†i h·ªçc ‚Ä¢ {{ enrollment.progress|default:0 }}%</div>
              </div>
            </a>
            {% empty %}
            <div style="text-align: center; padding: 2rem; color: var(--text-tertiary);">
              <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üìö</div>
              <p>Ch∆∞a tham gia kh√≥a h·ªçc n√†o</p>
            </div>
            {% endfor %}
          </div>
          
          <!-- Results Panel -->
          <div id="panel-results" class="df-profile-panel">
            {% for result in recent_exam_results %}
            <a href="{% url 'exam:exam_result' result.id %}" class="df-course-mini">
              <div class="df-course-mini-icon" style="background: {% if result.score >= 80 %}#10B981{% elif result.score >= 60 %}#F59E0B{% else %}#EF4444{% endif %};">{{ result.score|floatformat:0 }}%</div>
              <div class="df-course-mini-info">
                <div class="df-course-mini-name">{{ result.template.title }}</div>
                <div class="df-course-mini-meta">{{ result.submitted_at|date:"d/m/Y" }} ‚Ä¢ {{ result.correct_count }}/{{ result.total_questions }} c√¢u ƒë√∫ng</div>
              </div>
            </a>
            {% empty %}
            <div style="text-align: center; padding: 2rem; color: var(--text-tertiary);">
              <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üìù</div>
              <p>Ch∆∞a c√≥ k·∫øt qu·∫£ thi n√†o</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="df-profile-sidebar">
      <div class="df-achievement-card">
        <div class="df-achievement-card-header">Th√†nh t√≠ch</div>
        <div class="df-achievement-card-body">
          <div class="df-achievement-item df-achievement-item--orange"><span class="df-achievement-value">{{ streak.total_study_minutes|default:0 }}m</span><span class="df-achievement-label">th·ªùi gian h·ªçc</span></div>
          <div class="df-achievement-item df-achievement-item--red"><span class="df-achievement-value">{{ streak.longest_streak|default:0 }}</span><span class="df-achievement-label">ng√†y li√™n ti·∫øp d√†i nh·∫•t</span></div>
          <div class="df-achievement-item df-achievement-item--green"><span class="df-achievement-value">{{ total_vocab|default:0 }}</span><span class="df-achievement-label">t·ª´ v·ª±ng ƒë√£ h·ªçc</span></div>
        </div>
      </div>
      
      <div class="df-achievement-card">
        <div class="df-achievement-card-header">Huy hi·ªáu</div>
        {% if badges_with_status %}
        <div class="df-badges-grid-mini">
          {% for item in badges_with_status|slice:":6" %}{% if item.earned %}
          <div class="df-badge-mini"><span class="df-badge-mini-icon">{{ item.badge.icon }}</span><div class="df-badge-mini-name">{{ item.badge.name }}</div></div>
          {% endif %}{% endfor %}
        </div>
        {% else %}
        <div class="df-badges-preview"><div class="df-badge-mascot">üê∏</div><p class="df-badges-empty-text">Ch∆∞a c√≥ th√†nh t√≠ch</p></div>
        {% endif %}
      </div>
      
      <div class="df-stats-inline">
        <div class="df-stat-inline"><div class="df-stat-inline-value">{{ total_exams|default:0 }}</div><div class="df-stat-inline-label">B√†i thi</div></div>
        <div class="df-stat-inline"><div class="df-stat-inline-value">{{ total_courses|default:0 }}</div><div class="df-stat-inline-label">Kh√≥a h·ªçc</div></div>
        <div class="df-stat-inline"><div class="df-stat-inline-value">{{ streak.current_streak|default:0 }}</div><div class="df-stat-inline-label">Chu·ªói ng√†y</div></div>
      </div>
    </div>
  </div>
</div>

<!-- Bio Modal -->
<div id="bio-modal" class="df-modal">
  <div class="df-modal-content">
    <div class="df-modal-header"><span class="df-modal-title">Ch·ªânh s·ª≠a th√¥ng tin</span><button class="df-modal-close" onclick="closeModal('bio-modal')">&times;</button></div>
    <div class="df-modal-body">
      <div class="df-form-group"><label class="df-form-label">Ti√™u ƒë·ªÅ</label><input type="text" class="df-form-input" id="edit-title" value="{{ user_profile.display_title }}"></div>
      <div class="df-form-group"><label class="df-form-label">Ph·ª• ƒë·ªÅ</label><input type="text" class="df-form-input" id="edit-subtitle" value="{{ user_profile.subtitle }}"></div>
      <div class="df-form-group"><label class="df-form-label">Bio</label><textarea class="df-form-textarea" id="edit-bio">{{ user_profile.bio }}</textarea></div>
    </div>
    <div class="df-modal-footer"><button class="df-btn df-btn--secondary" onclick="closeModal('bio-modal')">H·ªßy</button><button class="df-btn df-btn--primary" onclick="saveBio()">L∆∞u</button></div>
  </div>
</div>

<!-- Hidden file inputs -->
<input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="handleAvatarUpload(this)">
<input type="file" id="cover-input" accept="image/*" style="display:none" onchange="handleCoverUpload(this)">

<script>
const csrfToken = '{{ csrf_token }}';

function openModal(id) { document.getElementById(id).classList.add('df-modal--active'); }
function closeModal(id) { document.getElementById(id).classList.remove('df-modal--active'); }

document.querySelectorAll('.df-profile-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.df-profile-tab').forEach(t => t.classList.remove('df-profile-tab--active'));
    this.classList.add('df-profile-tab--active');
    document.querySelectorAll('.df-profile-panel').forEach(p => p.classList.remove('df-profile-panel--active'));
    document.getElementById('panel-' + this.dataset.tab)?.classList.add('df-profile-panel--active');
  });
});

async function saveBio() {
  const data = { display_title: document.getElementById('edit-title').value, subtitle: document.getElementById('edit-subtitle').value, bio: document.getElementById('edit-bio').value };
  const res = await fetch('{% url "core:profile_update" %}', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify(data) });
  if (res.ok) { closeModal('bio-modal'); location.reload(); } else { alert('L·ªói khi l∆∞u!'); }
}

function uploadAvatar() { document.getElementById('avatar-input').click(); }
function uploadCover() { document.getElementById('cover-input').click(); }

async function handleAvatarUpload(input) {
  if (!input.files[0]) return;
  const fd = new FormData(); fd.append('avatar', input.files[0]);
  const res = await fetch('{% url "core:profile_upload_avatar" %}', { method: 'POST', headers: { 'X-CSRFToken': csrfToken }, body: fd });
  if (res.ok) location.reload(); else alert('L·ªói khi upload!');
}

async function handleCoverUpload(input) {
  if (!input.files[0]) return;
  const fd = new FormData(); fd.append('cover', input.files[0]);
  const res = await fetch('{% url "core:profile_upload_cover" %}', { method: 'POST', headers: { 'X-CSRFToken': csrfToken }, body: fd });
  if (res.ok) location.reload(); else alert('L·ªói khi upload!');
}
</script>
{% endblock %}