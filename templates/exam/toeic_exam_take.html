{% extends "base.html" %}
{% load static %}
{% load exam_tags %}

{% block title %}{{ template_obj.title }} | DailyFluent{% endblock %}
{% block main_classes %}df-page-full{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/exam-take.css' %}?v=20260127">
<link rel="stylesheet" href="{% static 'css/exam-highlight.css' %}?v=20260113">
{% endblock %}

{% block content %}
<div class="df-toeic-exam-container"
  data-template-id="{{ template_obj.id }}"
  data-session-id="{{ session.id }}"
  data-template-full-audio="{% if template_obj.audio_file %}{{ template_obj.audio_file.url }}{% endif %}">
  {# ===== HEADER ===== #}
  <div class="df-toeic-header">
    <div class="df-toeic-header-top">
      <h1 class="df-toeic-title">{{ template_obj.title }}</h1>
      <button type="button" onclick="window.history.back()" class="df-toeic-exit-btn">
        Tho√°t
      </button>
    </div>
  </div>

  {# ===== MAIN LAYOUT: Content + Sidebar ===== #}
  <div class="df-toeic-main-layout">
    {# === LEFT: MAIN CONTENT === #}
    <div class="df-toeic-content">
      {# Part Navigation Buttons #}
      <div class="df-toeic-part-nav">
        {% for part_data in parts_list %}
        <button type="button" class="df-toeic-part-btn {% if forloop.first %}df-toeic-part-btn--active{% endif %}"
          data-part="{{ part_data.part }}">
          Part {{ part_data.part|slice:"1:" }}
        </button>
        {% endfor %}
      </div>

      {# Highlight Toggle #}
      <div class="df-toeic-controls">
        <label class="df-toeic-highlight-toggle">
          <input type="checkbox" id="highlight-toggle" checked>
          <span class="df-toeic-switch"></span>
          <span class="df-toeic-highlight-label">Highlight n·ªôi dung</span>
        </label>
      </div>

      {# Highlight Toolbar (shown when text is selected) #}
      <div id="highlight-toolbar" class="df-highlight-toolbar" style="display:none;">
        <button type="button" class="df-highlight-btn df-highlight-btn--remove" data-color="remove" title="X√≥a highlight">
          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        </button>
        <button type="button" class="df-highlight-btn" data-color="#93c5fd" title="Xanh d∆∞∆°ng" style="background:#93c5fd;"></button>
        <button type="button" class="df-highlight-btn" data-color="#fca5a5" title="ƒê·ªè nh·∫°t" style="background:#fca5a5;"></button>
        <button type="button" class="df-highlight-btn" data-color="#86efac" title="Xanh l√°" style="background:#86efac;"></button>
        <button type="button" class="df-highlight-btn" data-color="#fde047" title="V√†ng" style="background:#fde047;"></button>
        <button type="button" class="df-highlight-btn" data-color="#f87171" title="ƒê·ªè" style="background:#f87171;"></button>
        <button type="button" class="df-highlight-btn df-highlight-btn--underline" data-color="underline" title="G·∫°ch ch√¢n">
          <span style="text-decoration:underline;font-weight:600;">abc</span>
        </button>
      </div>

      {# Audio Player (for Listening Parts) #}
      <div id="audio-player-container" class="df-toeic-audio-player" style="display: none;">
        <audio id="toeic-audio" preload="auto"></audio>
        <div class="df-toeic-audio-controls">
          <button type="button" id="audio-play-btn" class="df-toeic-audio-btn">‚ñ∂</button>
          <div class="df-toeic-audio-progress">
            <div class="df-toeic-audio-progress-bar">
              <div id="audio-progress" class="df-toeic-audio-progress-fill"></div>
            </div>
            <span id="audio-time" class="df-toeic-audio-time">00:00</span>
          </div>
          <button type="button" class="df-toeic-audio-speaker">üîä</button>
          <input type="range" id="audio-volume" class="df-toeic-audio-volume" min="0" max="100" value="100">
          <button type="button" class="df-toeic-audio-settings">‚öôÔ∏è</button>
        </div>
      </div>

      {# Exam Form #}
      <form id="toeic-exam-form" method="post" class="df-toeic-exam-form">
        {% csrf_token %}

        {# Render t·ª´ng Part #}
        {% for part_data in parts_list %}
        <div class="df-toeic-part-section {% if forloop.first %}df-toeic-part-section--active{% endif %}"
          data-part="{{ part_data.part }}" id="part-{{ part_data.part }}">

          {# ===== Content by part ===== #}
          {% if part_data.part == "L1" %}
          {% for q in part_data.questions %}
          <div class="df-toeic-question-block" data-question-id="{{ q.id }}"
            data-audio-url="{% if q.audio %}{{ q.audio.url }}{% endif %}">
            {% if q.image %}
            <div class="df-toeic-part1-image">
              <img src="{{ q.image.url }}" alt="Part 1 Image">
            </div>
            {% endif %}

            <div class="df-toeic-question">
              <div class="df-toeic-question-header">
                <button type="button" class="df-toeic-question-number df-toeic-question-number--reviewable"
                  data-question-id="{{ q.id }}" title="ƒê√°nh d·∫•u c√¢u c·∫ßn xem l·∫°i">
                  {{ q.order }}
                </button>
              </div>

              <div class="df-toeic-question-options">
                {% for choice in q.mcq_choices %}
                <label class="df-toeic-option">
                  <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}">
                  <span class="df-toeic-option-label">{{ choice.key|number_to_letter }} {{ choice.text }}</span>
                </label>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}

          {% elif part_data.part == "L2" %}
          {% for q in part_data.questions %}
          <div class="df-toeic-question-block" data-question-id="{{ q.id }}"
            data-audio-url="{% if q.audio %}{{ q.audio.url }}{% endif %}">
            <div class="df-toeic-question-header">
              <button type="button" class="df-toeic-question-number df-toeic-question-number--reviewable"
                data-question-id="{{ q.id }}" title="ƒê√°nh d·∫•u c√¢u c·∫ßn xem l·∫°i">
                {{ q.order }}
              </button>
            </div>

            <div class="df-toeic-question-options">
              {% for choice in q.mcq_choices %}
                <label class="df-toeic-option">
                  <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}">
                  <span class="df-toeic-option-label">{{ choice.key|number_to_letter }} {{ choice.text }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}

          {% elif part_data.part == "L3" or part_data.part == "L4" %}
          {% for conv_key, conv_data in part_data.conversations.items %}
          {% if not forloop.first %}
          <hr class="df-toeic-passage-divider">{% endif %}

          <div class="df-toeic-conversation-block" data-conv-id="{{ conv_data.conversation.id }}"
            data-audio-url="{% if conv_data.conversation.audio %}{{ conv_data.conversation.audio.url }}{% endif %}">
            <div class="df-toeic-conv-grid {% if conv_data.conversation.image %}df-toeic-conv-grid--has-image{% endif %}">
              {% if conv_data.conversation.image %}
              <div class="df-toeic-conv-image">
                <img src="{{ conv_data.conversation.image.url }}" alt="Conversation Image">
              </div>
              {% endif %}

              <div class="df-toeic-conv-questions">
                {% for q in conv_data.questions %}
                <div class="df-toeic-question-block" data-question-id="{{ q.id }}">
                  <div class="df-toeic-question-header">
                    <button type="button" class="df-toeic-question-number df-toeic-question-number--reviewable"
                      data-question-id="{{ q.id }}" title="ƒê√°nh d·∫•u c√¢u c·∫ßn xem l·∫°i">
                      {{ q.order }}
                    </button>
                    {% if q.has_meaningful_text %}
                    <div class="df-toeic-question-text df-toeic-question-text--inline">{{ q.text }}</div>
                    {% endif %}
                  </div>

                  <div class="df-toeic-question-options">
                    {% for choice in q.mcq_choices %}
                    <label class="df-toeic-option">
                      <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}">
                      <span class="df-toeic-option-label" data-choice-key="{{ choice.key }}">{{ choice.text }}</span>
                    </label>
                    {% endfor %}
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}

          {% elif part_data.part == "R5" %}
          {% for q in part_data.questions %}
          <div class="df-toeic-question-block" data-question-id="{{ q.id }}">
            <div class="df-toeic-question-header">
              <button type="button" class="df-toeic-question-number df-toeic-question-number--reviewable"
                data-question-id="{{ q.id }}" title="ƒê√°nh d·∫•u c√¢u c·∫ßn xem l·∫°i">
                {{ q.order }}
              </button>
              {% if q.data|has_stem_segments %}
              {# Schema 2.1: Render stem_segments with blank markers #}
              <div class="df-toeic-stem-segments">{{ q.data|render_stem_segments }}</div>
              {% elif q.has_meaningful_text %}
              {# Schema 1.0: Plain text stem #}
              <div class="df-toeic-question-text df-toeic-question-text--inline">{{ q.text }}</div>
              {% endif %}
            </div>

            <div class="df-toeic-question-options">
              {% for choice in q.mcq_choices %}
              <label class="df-toeic-option">
                <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}">
                <span class="df-toeic-option-label">{{ choice.key|number_to_letter }}. {{ choice.text }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}

          {% else %}
          {# R6 / R7 #}
          {% for passage_key, passage_data in part_data.passages.items %}
          {% if not forloop.first %}
          <hr class="df-toeic-passage-divider">{% endif %}

          <div class="df-toeic-passage-block" data-passage-id="{{ passage_data.passage.id }}">
            {% if passage_data.questions %}
            <!-- {% with first_q=passage_data.questions|first last_q=passage_data.questions|last %}
            <div class="df-toeic-passage-header">
              <div class="df-toeic-passage-range">
                Questions {{ first_q.order }}{% if first_q.order != last_q.order %}-{{ last_q.order }}{% endif %}
              </div>
            </div>
            {% endwith %} -->
            {% endif %}

            <div class="df-toeic-passage-split">
              {% if passage_data.passage.content_json|has_documents %}
              <div class="df-toeic-passage-content">
                {% if passage_data.passage.title %}
                <!-- <div class="df-toeic-passage-inline-title">{{ passage_data.passage.title }}</div> -->
                {% endif %}
                {{ passage_data.passage.content_json|render_documents }}
              </div>
              {% elif passage_data.passage.content_json|has_content_json %}
              <div class="df-toeic-passage-content">
                {% if passage_data.passage.title %}
                <div class="df-toeic-passage-inline-title">{{ passage_data.passage.title }}</div>
                {% endif %}
                {{ passage_data.passage.content_json|render_content_json }}
              </div>
              {% elif passage_data.passage.data|has_content_segments %}
              {# Schema 2.1: Render passage with content_segments #}
              <div class="df-toeic-passage-content">
                {% if passage_data.passage.title %}
                <div class="df-toeic-passage-inline-title">{{ passage_data.passage.title }}</div>
                {% endif %}
                {{ passage_data.passage.data|render_passage_segments }}
              </div>
              {% elif passage_data.passage.images.all %}
              <div class="df-toeic-passage-content">
                {% if passage_data.passage.title %}
                <div class="df-toeic-passage-inline-title">{{ passage_data.passage.title }}</div>
                {% endif %}
                {% for pimg in passage_data.passage.images.all %}
                <div style="margin-bottom: 0.75rem;">
                  <img src="{{ pimg.image.url }}" alt="Passage Image {{ forloop.counter }}">
                </div>
                {% endfor %}
              </div>
              {% elif passage_data.passage.image %}
              <div class="df-toeic-passage-content">
                {% if passage_data.passage.title %}
                <div class="df-toeic-passage-inline-title">{{ passage_data.passage.title }}</div>
                {% endif %}
                <img src="{{ passage_data.passage.image.url }}" alt="Passage Image">
              </div>
              {% elif passage_data.passage.text %}
              {# Schema 1.0 fallback: show plain text #}
              <div class="df-toeic-passage-content">
                {% if passage_data.passage.title %}
                <div class="df-toeic-passage-inline-title">{{ passage_data.passage.title }}</div>
                {% endif %}
                {{ passage_data.passage.text|linebreaksbr }}
              </div>
              {% else %}
              <div class="df-toeic-passage-content">
                <div class="df-toeic-passage-placeholder">No content available</div>
              </div>
              {% endif %}

              <div class="df-toeic-passage-questions">
                {% for q in passage_data.questions %}
                <div class="df-toeic-question-block" data-question-id="{{ q.id }}">
                  <div class="df-toeic-question-header">
                    <button type="button" class="df-toeic-question-number df-toeic-question-number--reviewable"
                      data-question-id="{{ q.id }}" title="ƒê√°nh d·∫•u c√¢u c·∫ßn xem l·∫°i">
                      {{ q.order }}
                    </button>
                    {% if q.has_meaningful_text %}
                    <div class="df-toeic-question-text df-toeic-question-text--inline">{{ q.text }}</div>
                    {% endif %}
                  </div>

                  <div class="df-toeic-question-options">
                    {% for choice in q.mcq_choices %}
                    <label class="df-toeic-option">
                      <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}">
                      <span class="df-toeic-option-label" data-choice-key="{{ choice.key }}">{{ choice.text }}</span>
                    </label>
                    {% endfor %}
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endfor %}
          {% endif %}
        </div>
        {% endfor %}


        {# Navigation buttons gi·ªØa c√°c part #}
        <div class="df-toeic-part-navigation">
          <button type="button" id="toeic-prev-part" class="df-toeic-nav-part-btn df-toeic-nav-part-btn--prev" disabled>
            ‚Üê Part tr∆∞·ªõc
          </button>
          <button type="button" id="toeic-next-part" class="df-toeic-nav-part-btn df-toeic-nav-part-btn--next">
            Part sau ‚Üí
          </button>
        </div>

        {# Submit Button (hidden, submit via sidebar) #}
        <button type="submit" id="toeic-submit-btn" style="display: none;"></button>
      </form>
    </div>

    {# === RIGHT: SIDEBAR === #}
    <div class="df-toeic-sidebar">
      {# Timer #}
      <div class="df-toeic-timer">
        <div class="df-toeic-timer-label">Th·ªùi gian c√≤n l·∫°i:</div>
        <div id="toeic-timer" class="df-toeic-timer-value">{{ total_minutes }}:00</div>
      </div>

      {# Submit Button #}
      <button type="button" id="toeic-submit-sidebar" class="df-toeic-submit-btn">
        N·ªôp b√†i
      </button>

      {# Instructions #}
      <div class="df-toeic-instructions">
        <div class="df-toeic-instruction-item">
          Kh√¥i ph·ª•c/l∆∞u b√†i l√†m >
        </div>
      </div>

      {# Question Navigation Grid #}
      <div class="df-toeic-question-nav">
        {% for part_data in parts_list %}
        <div class="df-toeic-nav-part">
          <div class="df-toeic-nav-part-title">Part {{ part_data.part|slice:"1:" }}</div>
          <div class="df-toeic-nav-grid">
            {% for q in part_data.questions %}
            <button type="button"
              class="df-toeic-nav-qbtn {% if forloop.parentloop.first and forloop.first %}df-toeic-nav-qbtn--active{% endif %}"
              data-question-id="{{ q.id }}" data-part="{{ part_data.part }}">
              {{ q.order }}
            </button>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>

      {# Submit Button in Question Nav #}
      <button type="button" id="toeic-submit-nav" class="df-toeic-submit-btn">
        N·ªôp b√†i
      </button>
    </div>
  </div>
</div>

<script>
  // TOEIC Exam JavaScript
  (function () {
    const partsList = JSON.parse('{{ parts_list_json|escapejs }}');
    const sessionId = Number('{{ session.id }}');
    const templateId = Number('{{ template_obj.id }}');
    const containerEl = document.querySelector('.df-toeic-exam-container');
    const isRedoMode = '{{ is_redo_mode|yesno:"true,false" }}' === 'true';
    // In redo mode, don't use full test audio - use individual audio from questions/conversations
    const templateFullAudioUrl = isRedoMode ? '' : (containerEl ? (containerEl.getAttribute('data-template-full-audio') || '') : '');
    let currentPart = partsList[0]?.part || '';
    let timerInterval = null;
    let totalSeconds = Number('{{ total_minutes }}') * 60;

  // Part Navigation
  document.querySelectorAll('.df-toeic-part-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const part = this.dataset.part;
      switchPart(part);
    });
  });

  function switchPart(part) {
    currentPart = part;

    // Update buttons
    document.querySelectorAll('.df-toeic-part-btn').forEach(btn => {
      btn.classList.toggle('df-toeic-part-btn--active', btn.dataset.part === part);
    });

    // Update sections
    document.querySelectorAll('.df-toeic-part-section').forEach(section => {
      section.classList.toggle('df-toeic-part-section--active', section.dataset.part === part);
    });

    // Show/hide audio player for Listening parts
    const isListening = part.startsWith('L');
    document.getElementById('audio-player-container').style.display = isListening ? 'block' : 'none';

    // Load audio if needed
    if (isListening) {
      loadPartAudio(part);
    }

    // Scroll to top khi chuy·ªÉn part
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function loadPartAudio(part) {
    // Lu√¥n d√πng audio full c·ªßa b√†i test n·∫øu c√≥ c·∫•u h√¨nh ·ªü ExamTemplate.audio_file
    if (!templateFullAudioUrl) {
      console.warn('[TOEIC] Kh√¥ng c√≥ template_full_audio, b·ªè qua loadPartAudio cho', part);
      return;
    }

    if (audio.src === templateFullAudioUrl) {
      // ƒë√£ ƒë√∫ng ngu·ªìn, kh√¥ng c·∫ßn reload
      return;
    }

    console.log('[TOEIC] Loading full test audio for part', part, 'url:', templateFullAudioUrl);
    audio.pause();
    audio.currentTime = 0;
    audio.src = templateFullAudioUrl;
    audio.load();
  }

  // Track answered questions v√† tr·∫°ng th√°i review
  const answeredQuestions = new Set();
  const reviewQuestions = new Set();

  // C·∫≠p nh·∫≠t style cho n√∫t trong grid
  function updateNavButtons() {
    document.querySelectorAll('.df-toeic-nav-qbtn').forEach(btn => {
      const questionId = String(btn.dataset.questionId);
      const isAnswered = answeredQuestions.has(questionId);
      const isReview = reviewQuestions.has(questionId);

      btn.classList.toggle('df-toeic-nav-qbtn--answered', isAnswered);
      btn.classList.toggle('df-toeic-nav-qbtn--review', isReview);
    });
  }

  // C·∫≠p nh·∫≠t style cho √¥ s·ªë c√¢u h·ªèi (click ƒë·ªÉ ƒë√°nh d·∫•u review)
  function updateReviewButtons() {
    document.querySelectorAll('.df-toeic-question-number--reviewable').forEach(btn => {
      const questionId = String(btn.dataset.questionId);
      const isReview = reviewQuestions.has(questionId);
      btn.classList.toggle('df-toeic-question-number--review', isReview);
      btn.setAttribute('aria-pressed', isReview ? 'true' : 'false');
    });
  }

  // Clear localStorage khi b·∫Øt ƒë·∫ßu l√†m l·∫°i (n·∫øu l√† session m·ªõi)
  function clearSavedState() {
    try {
      // Ki·ªÉm tra xem c√≥ ph·∫£i l√† l·∫ßn ƒë·∫ßu load trang kh√¥ng (kh√¥ng c√≥ sessionStorage flag)
      const hasStarted = sessionStorage.getItem(`toeic_started_${sessionId}`);
      if (!hasStarted) {
        // L·∫ßn ƒë·∫ßu load: x√≥a t·∫•t c·∫£ localStorage c≈© cho template n√†y
        localStorage.removeItem(`toeic_answered_${templateId}`);
        localStorage.removeItem(`toeic_review_${templateId}`);
        // ƒê√°nh d·∫•u ƒë√£ b·∫Øt ƒë·∫ßu session m·ªõi
        sessionStorage.setItem(`toeic_started_${sessionId}`, 'true');
      }
    } catch (e) {
      console.error('Error clearing saved state:', e);
    }
  }

  // Load state t·ª´ localStorage
  function loadSavedState() {
    try {
      const savedAnswered = localStorage.getItem(`toeic_answered_${templateId}`);
      if (savedAnswered) {
        const parsed = JSON.parse(savedAnswered);
        parsed.forEach(id => answeredQuestions.add(String(id)));
      }
    } catch (e) { }

    try {
      const savedReview = localStorage.getItem(`toeic_review_${templateId}`);
      if (savedReview) {
        const parsed = JSON.parse(savedReview);
        parsed.forEach(id => reviewQuestions.add(String(id)));
      }
    } catch (e) { }

    updateNavButtons();
    updateReviewButtons();
  }

  // L∆∞u state
  function saveState() {
    try {
      localStorage.setItem(`toeic_answered_${templateId}`, JSON.stringify(Array.from(answeredQuestions)));
      localStorage.setItem(`toeic_review_${templateId}`, JSON.stringify(Array.from(reviewQuestions)));
    } catch (e) { }
  }

  // Khi ch·ªçn ƒë√°p √°n ‚Üí ƒë√°nh d·∫•u ƒë√£ tr·∫£ l·ªùi
  // S·ª≠ d·ª•ng event delegation ƒë·ªÉ handle c·∫£ click tr√™n label v√† change tr√™n radio
  document.addEventListener('change', function (e) {
    if (e.target.type === 'radio' && e.target.name.startsWith('q')) {
      const name = e.target.name;
      const questionId = String(name.replace('q', ''));
      answeredQuestions.add(questionId);
      saveState();
      updateNavButtons();
    }
  });

  // Handle click tr·ª±c ti·∫øp tr√™n label - immediately update UI for responsiveness
  document.querySelectorAll('.df-toeic-option').forEach(label => {
    label.addEventListener('click', function (e) {
      e.preventDefault();
      const radio = this.querySelector('input[type="radio"]');
      if (radio) {
        // Immediately update UI (don't wait for change event)
        const container = this.parentElement;
        if (container) {
          container.querySelectorAll('.df-toeic-option').forEach(opt => {
            opt.classList.remove('df-toeic-option--selected');
          });
        }
        this.classList.add('df-toeic-option--selected');

        // Then update the radio state
        radio.checked = true;
        radio.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  });

  // Click v√†o √¥ s·ªë c√¢u h·ªèi = toggle review
  document.querySelectorAll('.df-toeic-question-number--reviewable').forEach(btn => {
    btn.addEventListener('click', function () {
      const questionId = String(this.dataset.questionId);
      if (reviewQuestions.has(questionId)) {
        reviewQuestions.delete(questionId);
      } else {
        reviewQuestions.add(questionId);
      }
      saveState();
      updateNavButtons();
      updateReviewButtons();
    });
  });

  // Grid navigation: click = chuy·ªÉn c√¢u, Ctrl/Cmd+Click = toggle review
  document.querySelectorAll('.df-toeic-nav-qbtn').forEach(btn => {
    btn.addEventListener('click', function (e) {
      const questionId = String(this.dataset.questionId);
      const part = this.dataset.part;

      // Ctrl+Click ho·∫∑c Cmd+Click = toggle review
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        if (reviewQuestions.has(questionId)) {
          reviewQuestions.delete(questionId);
        } else {
          reviewQuestions.add(questionId);
        }
        saveState();
        updateNavButtons();
        updateReviewButtons();
        return;
      }

      // Click b√¨nh th∆∞·ªùng = chuy·ªÉn ƒë·∫øn c√¢u h·ªèi
      switchPart(part);
      const questionBlock = document.querySelector(`[data-question-id="${questionId}"]`);
      if (questionBlock) {
        questionBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      document.querySelectorAll('.df-toeic-nav-qbtn').forEach(b => {
        b.classList.remove('df-toeic-nav-qbtn--active');
      });
      this.classList.add('df-toeic-nav-qbtn--active');
    });

    // Right-click = toggle review
    btn.addEventListener('contextmenu', function (e) {
      e.preventDefault();
      const questionId = String(this.dataset.questionId);
      if (reviewQuestions.has(questionId)) {
        reviewQuestions.delete(questionId);
      } else {
        reviewQuestions.add(questionId);
      }
      saveState();
      updateNavButtons();
      updateReviewButtons();
    });
  });

  // Kh·ªüi t·∫°o state
  // Clear old state tr∆∞·ªõc khi load (n·∫øu l√† session m·ªõi)
  clearSavedState();
  loadSavedState();

  // Timer
  function updateTimer() {
    totalSeconds--;
    if (totalSeconds <= 0) {
      clearInterval(timerInterval);
      document.getElementById('toeic-exam-form').submit();
      return;
    }

    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    let timeString;
    if (hours > 0) {
      // Hi·ªÉn th·ªã HH:MM:SS n·∫øu c√≥ gi·ªù
      timeString = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
      // Hi·ªÉn th·ªã MM:SS (kh√¥ng pad s·ªë 0 ·ªü ƒë·∫ßu ph√∫t)
      timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    document.getElementById('toeic-timer').textContent = timeString;
  }

  // Only start timer if there's a time limit (not redo mode)
  if (totalSeconds > 0) {
    timerInterval = setInterval(updateTimer, 1000);
  } else {
    // No timer - display "Kh√¥ng gi·ªõi h·∫°n" or hide timer
    const timerEl = document.getElementById('toeic-timer');
    if (timerEl) timerEl.textContent = 'Kh√¥ng gi·ªõi h·∫°n';
  }

  // Submit
  document.getElementById('toeic-submit-sidebar').addEventListener('click', function () {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?')) {
      document.getElementById('toeic-exam-form').submit();
    }
  });

  // Submit button in question nav panel
  document.getElementById('toeic-submit-nav')?.addEventListener('click', function () {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?')) {
      document.getElementById('toeic-exam-form').submit();
    }
  });

  // Audio Player
  const audio = document.getElementById('toeic-audio');
  const playBtn = document.getElementById('audio-play-btn');

  if (playBtn) {
    playBtn.addEventListener('click', function () {
      if (audio.paused) {
        audio.play();
        this.textContent = '‚è∏';
      } else {
        audio.pause();
        this.textContent = '‚ñ∂';
      }
    });
  }

  // Initialize: Show first part
  if (partsList.length > 0) {
    switchPart(partsList[0].part);
    updatePartNavigation();
  }

  // Part navigation buttons
  function updatePartNavigation() {
    const currentIndex = partsList.findIndex(p => p.part === currentPart);
    const prevBtn = document.getElementById('toeic-prev-part');
    const nextBtn = document.getElementById('toeic-next-part');

    if (prevBtn) {
      prevBtn.disabled = currentIndex <= 0;
    }
    if (nextBtn) {
      nextBtn.disabled = currentIndex >= partsList.length - 1;
    }
  }

  document.getElementById('toeic-prev-part')?.addEventListener('click', function () {
    const currentIndex = partsList.findIndex(p => p.part === currentPart);
    if (currentIndex > 0) {
      switchPart(partsList[currentIndex - 1].part);
      updatePartNavigation();
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  document.getElementById('toeic-next-part')?.addEventListener('click', function () {
    const currentIndex = partsList.findIndex(p => p.part === currentPart);
    if (currentIndex < partsList.length - 1) {
      switchPart(partsList[currentIndex + 1].part);
      updatePartNavigation();
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  // Override switchPart ƒë·ªÉ update navigation
  const originalSwitchPart = switchPart;
  switchPart = function (part) {
    originalSwitchPart(part);
    updatePartNavigation();
  };

  // Convert choice keys from numbers to letters (1->A, 2->B, etc.)
  function convertChoiceKeys() {
    const mapping = { "1": "A", "2": "B", "3": "C", "4": "D" };
    document.querySelectorAll('.df-toeic-option-label[data-choice-key]').forEach(label => {
      const key = label.getAttribute('data-choice-key');
      const letter = mapping[key] || key;
      const text = label.textContent.trim();
      label.textContent = letter + '. ' + text;
      label.removeAttribute('data-choice-key');
    });
  }

  // Convert choice keys after page load
  convertChoiceKeys();

  // Highlight feature moved to static/js/exam-highlight.js

  }) ();
</script>
<script src="{% static 'js/exam-highlight.js' %}?v=20260113"></script>
{% endblock %}
