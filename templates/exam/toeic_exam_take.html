{% extends "base.html" %}
{% load static %}
{% load exam_tags %}

{% block title %}{{ template_obj.title }} | DailyFluent{% endblock %}
{% block main_classes %}df-page-full{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/exam-take.css' %}?v=20251227">
{% endblock %}

{% block content %}
<div class="df-toeic-exam-container">
  {# ===== HEADER ===== #}
  <div class="df-toeic-header">
    <div class="df-toeic-header-top">
      <h1 class="df-toeic-title">{{ template_obj.title }}</h1>
      <button type="button" onclick="window.history.back()" class="df-toeic-exit-btn">
        Tho√°t
      </button>
    </div>
  </div>

  {# ===== MAIN LAYOUT: Content + Sidebar ===== #}
  <div class="df-toeic-main-layout">
    {# === LEFT: MAIN CONTENT === #}
    <div class="df-toeic-content">
      {# Part Navigation Buttons #}
      <div class="df-toeic-part-nav">
        {% for part_data in parts_list %}
          <button type="button" 
                  class="df-toeic-part-btn {% if forloop.first %}df-toeic-part-btn--active{% endif %}"
                  data-part="{{ part_data.part }}">
            Part {{ part_data.part|slice:"1:" }}
          </button>
        {% endfor %}
      </div>

      {# Highlight Toggle #}
      <div class="df-toeic-controls">
        <label class="df-toeic-highlight-toggle">
          <input type="checkbox" id="highlight-toggle" checked>
          <span class="df-toeic-switch"></span>
          <span class="df-toeic-highlight-label">Highlight n·ªôi dung</span>
          <span class="df-toeic-info-icon">‚ÑπÔ∏è</span>
        </label>
      </div>

      {# Audio Player (for Listening Parts) #}
      <div id="audio-player-container" class="df-toeic-audio-player" style="display: none;">
        <audio id="toeic-audio" preload="auto"></audio>
        <div class="df-toeic-audio-controls">
          <button type="button" id="audio-play-btn" class="df-toeic-audio-btn">‚ñ∂</button>
          <div class="df-toeic-audio-progress">
            <div class="df-toeic-audio-progress-bar">
              <div id="audio-progress" class="df-toeic-audio-progress-fill"></div>
            </div>
            <span id="audio-time" class="df-toeic-audio-time">00:00</span>
          </div>
          <button type="button" class="df-toeic-audio-speaker">üîä</button>
          <input type="range" id="audio-volume" class="df-toeic-audio-volume" min="0" max="100" value="100">
          <button type="button" class="df-toeic-audio-settings">‚öôÔ∏è</button>
        </div>
      </div>

      {# Exam Form #}
      <form id="toeic-exam-form" method="post" class="df-toeic-exam-form">
        {% csrf_token %}

        {# Render t·ª´ng Part #}
        {% for part_data in parts_list %}
          <div class="df-toeic-part-section {% if forloop.first %}df-toeic-part-section--active{% endif %}" 
               data-part="{{ part_data.part }}"
               id="part-{{ part_data.part }}">
            
            {# Part Instruction #}
            <div class="df-toeic-part-instruction">
              {% if part_data.part == "L1" %}
                <div class="df-toeic-part-instruction-title">Part 1</div>
                <div class="df-toeic-part-instruction-text">
                  Look at the picture. You will hear four statements. Choose the statement that best describes what you see in the picture.
                </div>
              {% elif part_data.part == "L2" %}
                <div class="df-toeic-part-instruction-title">Part 2</div>
                <div class="df-toeic-part-instruction-text">
                  You will hear a question or statement followed by three responses. Choose the best response.
                </div>
              {% elif part_data.part == "L3" %}
                <div class="df-toeic-part-instruction-title">Part 3</div>
                <div class="df-toeic-part-instruction-text">
                  You will hear some conversations between two people. You will be asked to answer three questions about what the speakers say in each conversation.
                </div>
              {% elif part_data.part == "L4" %}
                <div class="df-toeic-part-instruction-title">Part 4</div>
                <div class="df-toeic-part-instruction-text">
                  You will hear some talks given by a single speaker. You will be asked to answer three questions about what the speaker says in each talk.
                </div>
              {% elif part_data.part == "R5" %}
                <div class="df-toeic-part-instruction-title">Part 5</div>
                <div class="df-toeic-part-instruction-text">
                  A word or phrase is missing in each of the following sentences. Four answer choices are given below each sentence. Select the best answer to complete the sentence.
                </div>
              {% elif part_data.part == "R6" %}
                <div class="df-toeic-part-instruction-title">Part 6</div>
                <div class="df-toeic-part-instruction-text">
                  Read the texts that follow. A word or phrase is missing in some of the sentences. Four answer choices are given below each of the sentences. Select the best answer to complete the text.
                </div>
              {% elif part_data.part == "R7" %}
                <div class="df-toeic-part-instruction-title">Part 7</div>
                <div class="df-toeic-part-instruction-text">
                  In this part you will read a selection of texts, such as magazine and newspaper articles, letters, and advertisements. Each text is followed by several questions. Select the best answer for each question.
                </div>
              {% endif %}
            </div>
            
            {# Part 1-5: MCQ b√¨nh th∆∞·ªùng #}
            {% if part_data.part in "L1,L2,L3,L4,R5" %}
              {# Part 1: C√≥ h√¨nh ·∫£nh #}
              {% if part_data.part == "L1" %}
                {% for q in part_data.questions %}
                  <div class="df-toeic-question-block" 
                       data-question-id="{{ q.id }}"
                       data-audio-url="{% if q.audio %}{{ q.audio.url }}{% endif %}">
                    {% if q.image %}
                      <div class="df-toeic-part1-image">
                        <img src="{{ q.image.url }}" alt="Part 1 Image">
                      </div>
                    {% endif %}
                    <div class="df-toeic-question">
                      <div class="df-toeic-question-header">
                        <div class="df-toeic-question-number">{{ q.order }}</div>
                        <button type="button"
                                class="df-toeic-review-toggle"
                                data-question-id="{{ q.id }}"
                                aria-label="ƒê√°nh d·∫•u review cho c√¢u {{ q.order }}">
                          ‚òÖ
                        </button>
                      </div>
                      <div class="df-toeic-question-options">
                        {% for choice in q.mcq_choices %}
                          <label class="df-toeic-option">
                            <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}" 
                                   {% if forloop.first %}checked{% endif %}>
                            <span class="df-toeic-option-label">{{ choice.key|number_to_letter }} {{ choice.text }}</span>
                          </label>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% elif part_data.part == "L2" %}
                {# Part 2: MCQ kh√¥ng c√≥ h√¨nh, d√πng ch·ªØ c√°i A B C D #}
                {% for q in part_data.questions %}
                  <div class="df-toeic-question-block" 
                       data-question-id="{{ q.id }}"
                       data-audio-url="{% if q.audio %}{{ q.audio.url }}{% endif %}">
                    {% if q.image %}
                      <div class="df-toeic-part1-image">
                        <img src="{{ q.image.url }}" alt="Part 2 Image">
                      </div>
                    {% endif %}
                    <div class="df-toeic-question-header">
                      <div class="df-toeic-question-number">{{ q.order }}</div>
                      <button type="button"
                              class="df-toeic-review-toggle"
                              data-question-id="{{ q.id }}"
                              aria-label="ƒê√°nh d·∫•u review cho c√¢u {{ q.order }}">
                        ‚òÖ
                      </button>
                    </div>
                    <div class="df-toeic-question-options">
                      {% for choice in q.mcq_choices %}
                        <label class="df-toeic-option">
                          <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}"
                                 {% if forloop.first %}checked{% endif %}>
                          <span class="df-toeic-option-label">{{ choice.key|number_to_letter }} {{ choice.text }}</span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                {# Part 3-5: MCQ kh√¥ng c√≥ h√¨nh #}
                {% if part_data.part == "L3" or part_data.part == "L4" %}
                  {# Part 3, 4: Group theo conversation #}
                  {% for conv_key, conv_data in part_data.conversations.items %}
                    {% if not forloop.first %}
                      <hr class="df-toeic-passage-divider">
                    {% endif %}
                    <div class="df-toeic-conversation-block" 
                         data-conv-id="{{ conv_data.conversation.id }}"
                         data-audio-url="{% if conv_data.conversation.audio %}{{ conv_data.conversation.audio.url }}{% endif %}">
                      {# Hi·ªÉn th·ªã ·∫£nh conversation #}
                      {% if conv_data.conversation.image %}
                        <div class="df-toeic-conv-image">
                          <img src="{{ conv_data.conversation.image.url }}" alt="Conversation Image" 
                               onerror="console.error('Failed to load conversation image. URL:', this.src); this.style.display='none';"
                               style="max-width: 100%; height: auto; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        </div>
                      {% endif %}
                      {% for q in conv_data.questions %}
                        <div class="df-toeic-question-block" data-question-id="{{ q.id }}">
                          <div class="df-toeic-question-header">
                            <div class="df-toeic-question-number">{{ q.order }}</div>
                            {% if q.has_meaningful_text %}
                              <div class="df-toeic-question-text df-toeic-question-text--inline">
                                {{ q.text }}
                              </div>
                            {% endif %}
                            <button type="button"
                                    class="df-toeic-review-toggle"
                                    data-question-id="{{ q.id }}"
                                    aria-label="ƒê√°nh d·∫•u review cho c√¢u {{ q.order }}">
                              ‚òÖ
                            </button>
                          </div>
                          <div class="df-toeic-question-options">
                            {% for choice in q.mcq_choices %}
                              <label class="df-toeic-option">
                                <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}"
                                       {% if forloop.first %}checked{% endif %}>
                                <span class="df-toeic-option-label" data-choice-key="{{ choice.key }}">{{ choice.text }}</span>
                              </label>
                            {% endfor %}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endfor %}
                {% else %}
                  {# Part 5: MCQ ƒë∆°n gi·∫£n #}
                  {% for q in part_data.questions %}
                    <div class="df-toeic-question-block" 
                         data-question-id="{{ q.id }}"
                         data-audio-url="{% if q.audio %}{{ q.audio.url }}{% endif %}">
                      <div class="df-toeic-question-header">
                        <div class="df-toeic-question-number">{{ q.order }}</div>
                        {% if q.has_meaningful_text %}
                          <div class="df-toeic-question-text df-toeic-question-text--inline">
                            {{ q.text }}
                          </div>
                        {% endif %}
                        <button type="button"
                                class="df-toeic-review-toggle"
                                data-question-id="{{ q.id }}"
                                aria-label="ƒê√°nh d·∫•u review cho c√¢u {{ q.order }}">
                          ‚òÖ
                        </button>
                      </div>
                      <div class="df-toeic-question-options">
                        {% for choice in q.mcq_choices %}
                          <label class="df-toeic-option">
                            <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}"
                                   {% if forloop.first %}checked{% endif %}>
                            <span class="df-toeic-option-label">{{ choice.key }}. {{ choice.text }}</span>
                          </label>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              {% endif %}
            {% else %}
              {# Part 6-7: Split screen (·∫£nh passage + questions) #}
              {% for passage_key, passage_data in part_data.passages.items %}
                {% if not forloop.first %}
                  <hr class="df-toeic-passage-divider">
                {% endif %}
                <div class="df-toeic-passage-block" data-passage-id="{{ passage_data.passage.id }}">
                  {# Passage header text: "Questions 196-200 refer to the following e-mail, review, and notice." #}
                  {% if passage_data.questions %}
                    {% with first_q=passage_data.questions|first last_q=passage_data.questions|last %}
                      <div class="df-toeic-passage-header">
                        Questions {{ first_q.order }}{% if first_q.order != last_q.order %}-{{ last_q.order }}{% endif %} refer to the following {% if passage_data.passage.title %}{{ passage_data.passage.title|lower }}{% else %}passage{% endif %}.
                      </div>
                    {% endwith %}
                  {% endif %}
                  
                  <div class="df-toeic-passage-split">
                    {# Left: Passage Image (sticky) #}
                    <div class="df-toeic-passage-image">
                      {% if passage_data.passage.image %}
                        <img src="{{ passage_data.passage.image.url }}" alt="Passage Image">
                      {% else %}
                        <div class="df-toeic-passage-placeholder">No image available</div>
                      {% endif %}
                    </div>
                    {# Right: Questions #}
                    <div class="df-toeic-passage-questions">
                      {% for q in passage_data.questions %}
                        <div class="df-toeic-question-block" data-question-id="{{ q.id }}">
                          <div class="df-toeic-question-header">
                            <div class="df-toeic-question-number">{{ q.order }}</div>
                            {% if q.has_meaningful_text %}
                              <div class="df-toeic-question-text df-toeic-question-text--inline">
                                {{ q.text }}
                              </div>
                            {% endif %}
                            <button type="button"
                                    class="df-toeic-review-toggle"
                                    data-question-id="{{ q.id }}"
                                    aria-label="ƒê√°nh d·∫•u review cho c√¢u {{ q.order }}">
                              ‚òÖ
                            </button>
                          </div>
                          <div class="df-toeic-question-options">
                            {% for choice in q.mcq_choices %}
                              <label class="df-toeic-option">
                                <input type="radio" name="q{{ q.id }}" value="{{ choice.key }}"
                                       {% if forloop.first %}checked{% endif %}>
                                <span class="df-toeic-option-label" data-choice-key="{{ choice.key }}">{{ choice.text }}</span>
                              </label>
                            {% endfor %}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          </div>
        {% endfor %}

        {# Navigation buttons gi·ªØa c√°c part #}
        <div class="df-toeic-part-navigation mt-6 pt-6 border-t border-slate-200">
          <div class="flex items-center justify-between">
            <button type="button" 
                    id="toeic-prev-part"
                    class="df-toeic-nav-part-btn df-toeic-nav-part-btn--prev"
                    disabled>
              ‚Äπ Part tr∆∞·ªõc
            </button>
            <button type="button" 
                    id="toeic-next-part"
                    class="df-toeic-nav-part-btn df-toeic-nav-part-btn--next">
              Part sau ‚Ä∫
            </button>
          </div>
        </div>

        {# Submit Button (hidden, submit via sidebar) #}
        <button type="submit" id="toeic-submit-btn" style="display: none;"></button>
      </form>
    </div>

    {# === RIGHT: SIDEBAR === #}
    <div class="df-toeic-sidebar">
      {# Timer #}
      <div class="df-toeic-timer">
        <div class="df-toeic-timer-label">Th·ªùi gian c√≤n l·∫°i:</div>
        <div id="toeic-timer" class="df-toeic-timer-value">{{ total_minutes }}:00</div>
      </div>

      {# Submit Button #}
      <button type="button" id="toeic-submit-sidebar" class="df-toeic-submit-btn">
        N·ªòP B√ÄI
      </button>

      {# Instructions #}
      <div class="df-toeic-instructions">
        <div class="df-toeic-instruction-item">
          Kh√¥i ph·ª•c/l∆∞u b√†i l√†m >
        </div>
        <div class="df-toeic-instruction-note">
          Ch√∫ √Ω: Click v√†o s·ªë c√¢u ƒë·ªÉ chuy·ªÉn nhanh. D√πng n√∫t ‚òÖ c·∫°nh s·ªë c√¢u ho·∫∑c Ctrl+Click / Right-click ƒë·ªÉ ƒë√°nh d·∫•u review.
        </div>
      </div>

      {# Question Navigation Grid #}
      <div class="df-toeic-question-nav">
        {% for part_data in parts_list %}
          <div class="df-toeic-nav-part">
            <div class="df-toeic-nav-part-title">Part {{ part_data.part|slice:"1:" }}</div>
            <div class="df-toeic-nav-grid">
              {% for q in part_data.questions %}
                <button type="button" 
                        class="df-toeic-nav-qbtn {% if forloop.parentloop.first and forloop.first %}df-toeic-nav-qbtn--active{% endif %}"
                        data-question-id="{{ q.id }}"
                        data-part="{{ part_data.part }}">
                  {{ q.order }}
                </button>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
// TOEIC Exam JavaScript
(function() {
  const partsList = {{ parts_list_json|safe }};
  const sessionId = {{ session.id }};
  const templateId = {{ template_obj.id }};
  let currentPart = partsList[0]?.part || '';
  let timerInterval = null;
  let totalSeconds = {{ total_minutes }} * 60;

  // Part Navigation
  document.querySelectorAll('.df-toeic-part-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const part = this.dataset.part;
      switchPart(part);
    });
  });

  function switchPart(part) {
    currentPart = part;
    
    // Update buttons
    document.querySelectorAll('.df-toeic-part-btn').forEach(btn => {
      btn.classList.toggle('df-toeic-part-btn--active', btn.dataset.part === part);
    });
    
    // Update sections
    document.querySelectorAll('.df-toeic-part-section').forEach(section => {
      section.classList.toggle('df-toeic-part-section--active', section.dataset.part === part);
    });
    
    // Show/hide audio player for Listening parts
    const isListening = part.startsWith('L');
    document.getElementById('audio-player-container').style.display = isListening ? 'block' : 'none';
    
    // Load audio if needed
    if (isListening) {
      loadPartAudio(part);
    }
    
    // Scroll to top khi chuy·ªÉn part
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function loadPartAudio(part) {
    const partData = partsList.find(p => p.part === part);
    if (!partData || !partData.audio_urls || partData.audio_urls.length === 0) {
      return;
    }
    
    // Load first audio (for Part 1, 2) or conversation audio (for Part 3, 4)
    const firstAudio = partData.audio_urls[0];
    if (firstAudio && firstAudio.url) {
      audio.src = firstAudio.url;
      audio.load();
    }
  }

  // Track answered questions v√† tr·∫°ng th√°i review
  const answeredQuestions = new Set();
  const reviewQuestions = new Set();
  
  // C·∫≠p nh·∫≠t style cho n√∫t trong grid
  function updateNavButtons() {
    document.querySelectorAll('.df-toeic-nav-qbtn').forEach(btn => {
      const questionId = String(btn.dataset.questionId);
      const isAnswered = answeredQuestions.has(questionId);
      const isReview = reviewQuestions.has(questionId);
      
      btn.classList.toggle('df-toeic-nav-qbtn--answered', isAnswered);
      btn.classList.toggle('df-toeic-nav-qbtn--review', isReview);
    });
  }
  
  // C·∫≠p nh·∫≠t style cho n√∫t review c·∫°nh s·ªë c√¢u h·ªèi
  function updateReviewButtons() {
    document.querySelectorAll('.df-toeic-review-toggle').forEach(btn => {
      const questionId = String(btn.dataset.questionId);
      const isReview = reviewQuestions.has(questionId);
      btn.classList.toggle('df-toeic-review-toggle--active', isReview);
    });
  }
  
  // Clear localStorage khi b·∫Øt ƒë·∫ßu l√†m l·∫°i (n·∫øu l√† session m·ªõi)
  function clearSavedState() {
    try {
      // Ki·ªÉm tra xem c√≥ ph·∫£i l√† l·∫ßn ƒë·∫ßu load trang kh√¥ng (kh√¥ng c√≥ sessionStorage flag)
      const hasStarted = sessionStorage.getItem(`toeic_started_${sessionId}`);
      if (!hasStarted) {
        // L·∫ßn ƒë·∫ßu load: x√≥a t·∫•t c·∫£ localStorage c≈© cho template n√†y
        localStorage.removeItem(`toeic_answered_${templateId}`);
        localStorage.removeItem(`toeic_review_${templateId}`);
        // ƒê√°nh d·∫•u ƒë√£ b·∫Øt ƒë·∫ßu session m·ªõi
        sessionStorage.setItem(`toeic_started_${sessionId}`, 'true');
      }
    } catch (e) {
      console.error('Error clearing saved state:', e);
    }
  }

  // Load state t·ª´ localStorage
  function loadSavedState() {
    try {
      const savedAnswered = localStorage.getItem(`toeic_answered_${templateId}`);
      if (savedAnswered) {
        const parsed = JSON.parse(savedAnswered);
        parsed.forEach(id => answeredQuestions.add(String(id)));
      }
    } catch (e) {}
    
    try {
      const savedReview = localStorage.getItem(`toeic_review_${templateId}`);
      if (savedReview) {
        const parsed = JSON.parse(savedReview);
        parsed.forEach(id => reviewQuestions.add(String(id)));
      }
    } catch (e) {}
    
    updateNavButtons();
    updateReviewButtons();
  }
  
  // L∆∞u state
  function saveState() {
    try {
      localStorage.setItem(`toeic_answered_${templateId}`, JSON.stringify(Array.from(answeredQuestions)));
      localStorage.setItem(`toeic_review_${templateId}`, JSON.stringify(Array.from(reviewQuestions)));
    } catch (e) {}
  }
  
  // Khi ch·ªçn ƒë√°p √°n ‚Üí ƒë√°nh d·∫•u ƒë√£ tr·∫£ l·ªùi
  // S·ª≠ d·ª•ng event delegation ƒë·ªÉ handle c·∫£ click tr√™n label v√† change tr√™n radio
  document.addEventListener('change', function(e) {
    if (e.target.type === 'radio' && e.target.name.startsWith('q')) {
      const name = e.target.name;
      const questionId = String(name.replace('q', ''));
      answeredQuestions.add(questionId);

      // C·∫≠p nh·∫≠t UI option ƒë∆∞·ª£c ch·ªçn (xanh nh·∫π)
      const label = e.target.closest('.df-toeic-option');
      if (label) {
        const container = label.parentElement;
        if (container) {
          container.querySelectorAll('.df-toeic-option').forEach(opt => {
            opt.classList.remove('df-toeic-option--selected');
          });
        }
        label.classList.add('df-toeic-option--selected');
      }

      saveState();
      updateNavButtons();
    }
  });
  
  // C≈©ng handle click tr·ª±c ti·∫øp tr√™n label ƒë·ªÉ ƒë·∫£m b·∫£o radio ƒë∆∞·ª£c checked
  document.querySelectorAll('.df-toeic-option').forEach(label => {
    label.addEventListener('click', function(e) {
      const radio = this.querySelector('input[type="radio"]');
      if (radio && !radio.checked) {
        radio.checked = true;
        radio.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  });
  
  // N√∫t review c·∫°nh s·ªë c√¢u h·ªèi
  document.querySelectorAll('.df-toeic-review-toggle').forEach(btn => {
    btn.addEventListener('click', function() {
      const questionId = String(this.dataset.questionId);
      if (reviewQuestions.has(questionId)) {
        reviewQuestions.delete(questionId);
      } else {
        reviewQuestions.add(questionId);
      }
      saveState();
      updateNavButtons();
      updateReviewButtons();
    });
  });
  
  // Grid navigation: click = chuy·ªÉn c√¢u, Ctrl/Cmd+Click = toggle review
  document.querySelectorAll('.df-toeic-nav-qbtn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      const questionId = String(this.dataset.questionId);
      const part = this.dataset.part;
      
      // Ctrl+Click ho·∫∑c Cmd+Click = toggle review
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        if (reviewQuestions.has(questionId)) {
          reviewQuestions.delete(questionId);
        } else {
          reviewQuestions.add(questionId);
        }
        saveState();
        updateNavButtons();
        updateReviewButtons();
        return;
      }
      
      // Click b√¨nh th∆∞·ªùng = chuy·ªÉn ƒë·∫øn c√¢u h·ªèi
      switchPart(part);
      const questionBlock = document.querySelector(`[data-question-id="${questionId}"]`);
      if (questionBlock) {
        questionBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      document.querySelectorAll('.df-toeic-nav-qbtn').forEach(b => {
        b.classList.remove('df-toeic-nav-qbtn--active');
      });
      this.classList.add('df-toeic-nav-qbtn--active');
    });
    
    // Right-click = toggle review
    btn.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      const questionId = String(this.dataset.questionId);
      if (reviewQuestions.has(questionId)) {
        reviewQuestions.delete(questionId);
      } else {
        reviewQuestions.add(questionId);
      }
      saveState();
      updateNavButtons();
      updateReviewButtons();
    });
  });
  
  // Kh·ªüi t·∫°o state
  // Clear old state tr∆∞·ªõc khi load (n·∫øu l√† session m·ªõi)
  clearSavedState();
  loadSavedState();

  // Timer
  function updateTimer() {
    totalSeconds--;
    if (totalSeconds <= 0) {
      clearInterval(timerInterval);
      document.getElementById('toeic-exam-form').submit();
      return;
    }
    
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    let timeString;
    if (hours > 0) {
      // Hi·ªÉn th·ªã HH:MM:SS n·∫øu c√≥ gi·ªù
      timeString = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
      // Hi·ªÉn th·ªã MM:SS (kh√¥ng pad s·ªë 0 ·ªü ƒë·∫ßu ph√∫t)
      timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    document.getElementById('toeic-timer').textContent = timeString;
  }

  timerInterval = setInterval(updateTimer, 1000);

  // Submit
  document.getElementById('toeic-submit-sidebar').addEventListener('click', function() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?')) {
      document.getElementById('toeic-exam-form').submit();
    }
  });

  // Audio Player
  const audio = document.getElementById('toeic-audio');
  const playBtn = document.getElementById('audio-play-btn');
  
  if (playBtn) {
    playBtn.addEventListener('click', function() {
      if (audio.paused) {
        audio.play();
        this.textContent = '‚è∏';
      } else {
        audio.pause();
        this.textContent = '‚ñ∂';
      }
    });
  }

  // Initialize: Show first part
  if (partsList.length > 0) {
    switchPart(partsList[0].part);
    updatePartNavigation();
  }
  
  // Part navigation buttons
  function updatePartNavigation() {
    const currentIndex = partsList.findIndex(p => p.part === currentPart);
    const prevBtn = document.getElementById('toeic-prev-part');
    const nextBtn = document.getElementById('toeic-next-part');
    
    if (prevBtn) {
      prevBtn.disabled = currentIndex <= 0;
    }
    if (nextBtn) {
      nextBtn.disabled = currentIndex >= partsList.length - 1;
    }
  }
  
  document.getElementById('toeic-prev-part')?.addEventListener('click', function() {
    const currentIndex = partsList.findIndex(p => p.part === currentPart);
    if (currentIndex > 0) {
      switchPart(partsList[currentIndex - 1].part);
      updatePartNavigation();
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });
  
  document.getElementById('toeic-next-part')?.addEventListener('click', function() {
    const currentIndex = partsList.findIndex(p => p.part === currentPart);
    if (currentIndex < partsList.length - 1) {
      switchPart(partsList[currentIndex + 1].part);
      updatePartNavigation();
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });
  
  // Override switchPart ƒë·ªÉ update navigation
  const originalSwitchPart = switchPart;
  switchPart = function(part) {
    originalSwitchPart(part);
    updatePartNavigation();
  };
  
  // Convert choice keys from numbers to letters (1->A, 2->B, etc.)
  function convertChoiceKeys() {
    const mapping = { "1": "A", "2": "B", "3": "C", "4": "D" };
    document.querySelectorAll('.df-toeic-option-label[data-choice-key]').forEach(label => {
      const key = label.getAttribute('data-choice-key');
      const letter = mapping[key] || key;
      const text = label.textContent.trim();
      label.textContent = letter + '. ' + text;
      label.removeAttribute('data-choice-key');
    });
  }
  
  // Convert choice keys after page load
  convertChoiceKeys();
})();
</script>
{% endblock %}

<style>
.df-toeic-header {
  background: #fff;
  border-bottom: 1px solid #e2e8f0;
  padding: 1rem 1.5rem;
}

.df-toeic-header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.df-toeic-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
}

.df-toeic-exit-btn {
  padding: 0.5rem 1rem;
  background: #fff;
  border: 1px solid #cbd5e1;
  border-radius: 0.5rem;
  color: #475569;
  cursor: pointer;
  font-size: 0.875rem;
}

.df-toeic-exit-btn:hover {
  background: #f1f5f9;
}

.df-toeic-main-layout {
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 1.5rem;
  padding: 1.5rem;
  max-width: 1600px;
  margin: 0 auto;
}

.df-toeic-content {
  background: #fff;
  border-radius: 0.5rem;
  padding: 1.5rem;
}

.df-toeic-part-nav {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.df-toeic-part-btn {
  padding: 0.5rem 1rem;
  background: #f1f5f9;
  border: 1px solid #cbd5e1;
  border-radius: 9999px;
  color: #475569;
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 500;
  transition: all 0.2s;
}

.df-toeic-part-btn:hover {
  background: #e2e8f0;
}

.df-toeic-part-btn--active {
  background: #3b82f6;
  border-color: #3b82f6;
  color: #fff;
}

.df-toeic-controls {
  margin-bottom: 1rem;
}

.df-toeic-highlight-toggle {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}

.df-toeic-switch {
  position: relative;
  width: 44px;
  height: 24px;
  background: #cbd5e1;
  border-radius: 12px;
  transition: background 0.2s;
}

.df-toeic-switch::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  background: #fff;
  border-radius: 50%;
  top: 3px;
  left: 3px;
  transition: left 0.2s;
}

.df-toeic-highlight-toggle input:checked + .df-toeic-switch {
  background: #3b82f6;
}

.df-toeic-highlight-toggle input:checked + .df-toeic-switch::after {
  left: 23px;
}

.df-toeic-highlight-label {
  font-size: 0.875rem;
  color: #475569;
}

.df-toeic-info-icon {
  font-size: 0.875rem;
  color: #94a3b8;
}

.df-toeic-audio-player {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 0.5rem;
}

.df-toeic-audio-controls {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.df-toeic-audio-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #3b82f6;
  color: #fff;
  border: none;
  cursor: pointer;
  font-size: 0.875rem;
}

.df-toeic-audio-progress {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.df-toeic-audio-progress-bar {
  flex: 1;
  height: 4px;
  background: #e2e8f0;
  border-radius: 2px;
  overflow: hidden;
}

.df-toeic-audio-progress-fill {
  height: 100%;
  background: #3b82f6;
  width: 0%;
  transition: width 0.1s;
}

.df-toeic-audio-time {
  font-size: 0.75rem;
  color: #64748b;
  min-width: 45px;
}

.df-toeic-audio-volume {
  width: 80px;
}

.df-toeic-part-section {
  display: none;
}

.df-toeic-part-section--active {
  display: block;
}

.df-toeic-part-instruction {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-left: 4px solid #3b82f6;
  border-radius: 0.5rem;
  padding: 1rem 1.25rem;
  margin-bottom: 2rem;
}

.df-toeic-part-instruction-title {
  font-size: 1rem;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 0.5rem;
}

.df-toeic-part-instruction-text {
  font-size: 0.875rem;
  color: #475569;
  line-height: 1.6;
}

.df-toeic-question-block {
  margin-bottom: 0.75rem; /* Gi·∫£m t·ª´ 1rem xu·ªëng 0.75rem */
}

.df-toeic-part1-image {
  margin-bottom: 1.5rem;
}

.df-toeic-part1-image img {
  width: 100%;
  max-width: 600px;
  height: auto;
  border-radius: 0.5rem;
}

.df-toeic-question-header {
  display: flex;
  align-items: flex-start;
  gap: 0.375rem; /* Gi·∫£m t·ª´ 0.5rem xu·ªëng 0.375rem */
  margin-bottom: 0.25rem; /* Gi·∫£m t·ª´ 0.5rem xu·ªëng 0.25rem */
}

.df-toeic-question-number {
  font-size: 0.9375rem; /* Gi·∫£m t·ª´ 1rem xu·ªëng 0.9375rem */
  font-weight: 600;
  color: #1e293b;
}

.df-toeic-review-toggle {
  border: none;
  background: transparent;
  color: #cbd5e1;
  font-size: 0.9rem;
  cursor: pointer;
  padding: 0 0.25rem;
  line-height: 1;
  transition: color 0.2s ease, transform 0.1s ease;
}

.df-toeic-review-toggle:hover {
  color: #f59e0b;
  transform: scale(1.1);
}

.df-toeic-review-toggle--active {
  color: #f59e0b;
}

.df-toeic-question-text {
  font-size: 0.875rem; /* Gi·∫£m t·ª´ 0.9375rem xu·ªëng 0.875rem */
  color: #475569;
  margin-bottom: 0.5rem; /* Gi·∫£m t·ª´ 1rem xu·ªëng 0.5rem */
  line-height: 1.4;
}

.df-toeic-question-text--inline {
  flex: 1 1 auto;
  margin-bottom: 0;
}

.df-toeic-question-options {
  display: flex;
  flex-direction: column;
  gap: 0.5rem; /* Gi·∫£m t·ª´ 0.75rem xu·ªëng 0.5rem */
}

.df-toeic-option {
  display: flex;
  align-items: center;
  gap: 0.375rem; /* Gi·∫£m t·ª´ 0.5rem xu·ªëng 0.375rem */
  padding: 0.375rem 0.5rem; /* Gi·∫£m t·ª´ 0.5rem 0.75rem xu·ªëng 0.375rem 0.5rem */
  border: 1px solid #e2e8f0;
  border-radius: 0.375rem; /* Gi·∫£m t·ª´ 0.5rem xu·ªëng 0.375rem */
  cursor: pointer;
  transition: all 0.2s;
}

.df-toeic-option:hover:not(.df-toeic-option--selected) {
  background: #f1f5f9;
  border-color: #cbd5e1;
}

.df-toeic-option input[type="radio"] {
  margin: 0;
  opacity: 0;
  width: 0;
  height: 0;
  pointer-events: none;
}

.df-toeic-option-label {
  font-size: 0.875rem; /* Gi·∫£m t·ª´ 0.9375rem xu·ªëng 0.875rem */
  color: #1e293b;
  line-height: 1.4; /* TƒÉng line-height ƒë·ªÉ d·ªÖ ƒë·ªçc h∆°n */
}

/* Option ƒë√£ ƒë∆∞·ª£c ch·ªçn (theo t·ª´ng c√¢u) */
.df-toeic-option--selected {
  background: #dbeafe; /* blue-100 - xanh nh·∫π */
  border-color: #93c5fd; /* blue-300 */
}

/* Horizontal divider gi·ªØa c√°c passage/conversation */
.df-toeic-passage-divider {
  border: 0;
  border-top: 2px solid #e2e8f0;
  margin: 1.5rem 0;
}

/* Part navigation buttons */
.df-toeic-part-navigation {
  padding-top: 1.5rem;
  margin-top: 1.5rem;
}

.df-toeic-nav-part-btn {
  padding: 0.625rem 1.25rem;
  border: 1px solid #cbd5e1;
  border-radius: 0.5rem;
  background: #fff;
  color: #475569;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.df-toeic-nav-part-btn:hover:not(:disabled) {
  background: #f1f5f9;
  border-color: #94a3b8;
}

.df-toeic-nav-part-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.df-toeic-nav-part-btn--next {
  background: #3b82f6;
  color: #fff;
  border-color: #3b82f6;
}

.df-toeic-nav-part-btn--next:hover:not(:disabled) {
  background: #2563eb;
  border-color: #2563eb;
}

/* Part 6-7: Split Screen */
.df-toeic-passage-header {
  font-size: 0.9375rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #e2e8f0;
}

.df-toeic-passage-split {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-bottom: 2rem;
  align-items: start; /* ƒê·∫£m b·∫£o c√°c items align ·ªü top */
}

.df-toeic-passage-image {
  position: static; /* V·ªã tr√≠ tƒ©nh - scroll c√πng v·ªõi n·ªôi dung, kh√¥ng c·ªë ƒë·ªãnh */
  height: fit-content;
  align-self: start;
}

.df-toeic-passage-image img {
  width: 100%;
  height: auto;
  border-radius: 0.5rem;
}

.df-toeic-passage-placeholder {
  padding: 3rem;
  background: #f1f5f9;
  border-radius: 0.5rem;
  text-align: center;
  color: #94a3b8;
}

.df-toeic-passage-questions {
  display: flex;
  flex-direction: column;
  gap: 1rem; /* Gi·∫£m t·ª´ 1.5rem xu·ªëng 1rem */
}

.df-toeic-passage-block {
  position: relative;
}

/* Sidebar */
.df-toeic-sidebar {
  background: #fff;
  border-radius: 0.5rem;
  padding: 1.5rem;
  position: sticky;
  top: 80px;
  height: fit-content;
  /* B·ªè max-height v√† overflow-y ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£ c√¢u h·ªèi */
}

.df-toeic-timer {
  margin-bottom: 1.5rem;
  text-align: center;
}

.df-toeic-timer-label {
  font-size: 0.875rem;
  color: #64748b;
  margin-bottom: 0.5rem;
}

.df-toeic-timer-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1e293b;
}

.df-toeic-submit-btn {
  width: 100%;
  padding: 0.75rem;
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 0.5rem;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 1.5rem;
  transition: background 0.2s;
}

.df-toeic-submit-btn:hover {
  background: #2563eb;
}

.df-toeic-instructions {
  margin-bottom: 1.5rem;
  font-size: 0.875rem;
  color: #64748b;
}

.df-toeic-instruction-note {
  margin-top: 0.5rem;
  font-size: 0.8125rem;
  color: #94a3b8;
}

.df-toeic-question-nav {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.df-toeic-nav-part-title {
  font-size: 0.875rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 0.75rem;
}

.df-toeic-nav-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 0.5rem;
}

.df-toeic-nav-qbtn {
  width: 32px;
  height: 32px;
  border: 1px solid #cbd5e1;
  background: #fff;
  border-radius: 0.25rem;
  color: #475569;
  font-size: 0.8125rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.df-toeic-nav-qbtn:hover {
  background: #f1f5f9;
  border-color: #94a3b8;
}

.df-toeic-nav-qbtn--active {
  background: #3b82f6;
  border-color: #3b82f6;
  color: #fff;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
}

/* Answered state - Green background */
.df-toeic-nav-qbtn--answered {
  background: #10b981 !important; /* emerald-500 */
  color: #fff !important;
  border-color: #10b981 !important;
}

.df-toeic-nav-qbtn--answered:hover {
  background: #059669 !important; /* emerald-600 */
  border-color: #059669 !important;
}

/* Review state - ch·ªâ hi·ªÉn th·ªã ng√¥i sao, kh√¥ng ƒë·ªïi m√†u vi·ªÅn/n·ªÅn */
.df-toeic-nav-qbtn--review {
  position: relative;
}

.df-toeic-nav-qbtn--review::after {
  content: "‚òÖ";
  position: absolute;
  top: -6px;
  right: -6px;
  font-size: 10px;
  color: #f59e0b;
  background: #fff;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  font-weight: bold;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.df-toeic-nav-qbtn--active.df-toeic-nav-qbtn--answered {
  background: #10b981 !important;
  border-color: #10b981 !important;
  box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
}


/* Tablet and below */
@media (max-width: 1024px) {
  .df-toeic-main-layout {
    grid-template-columns: 1fr;
    gap: 1rem;
    padding: 1rem;
  }
  
  .df-toeic-sidebar {
    position: relative;
    top: 0;
    max-height: none;
  }
  
  .df-toeic-passage-split {
    grid-template-columns: 1fr;
  }
}

/* Mobile */
@media (max-width: 768px) {
  .df-toeic-header {
    padding: 0.75rem 1rem;
  }
  
  .df-toeic-header-top {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }
  
  .df-toeic-title {
    font-size: 1.25rem;
  }
  
  .df-toeic-exit-btn {
    align-self: flex-end;
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
  }
  
  .df-toeic-main-layout {
    padding: 0.75rem;
    gap: 0.75rem;
  }
  
  .df-toeic-content {
    padding: 1rem;
  }
  
  .df-toeic-sidebar {
    padding: 1rem;
  }
  
  .df-toeic-part-nav {
    gap: 0.375rem;
    margin-bottom: 1rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
  }
  
  .df-toeic-part-nav::-webkit-scrollbar {
    height: 4px;
  }
  
  .df-toeic-part-nav::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
  }
  
  .df-toeic-part-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    white-space: nowrap;
    flex-shrink: 0;
  }
  
  .df-toeic-part-instruction {
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
  }
  
  .df-toeic-part-instruction-title {
    font-size: 0.9375rem;
  }
  
  .df-toeic-part-instruction-text {
    font-size: 0.8125rem;
  }
  
  .df-toeic-question-block {
    margin-bottom: 1rem;
  }
  
  .df-toeic-question-header {
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .df-toeic-question-number {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
  }
  
  .df-toeic-question-options {
    gap: 0.5rem;
  }
  
  .df-toeic-option {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
  }
  
  .df-toeic-option-label {
    font-size: 0.875rem;
  }
  
  .df-toeic-audio-player {
    padding: 0.75rem;
  }
  
  .df-toeic-audio-controls {
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .df-toeic-audio-btn {
    width: 32px;
    height: 32px;
    font-size: 0.75rem;
  }
  
  .df-toeic-audio-time {
    font-size: 0.75rem;
  }
  
  .df-toeic-timer {
    margin-bottom: 1rem;
  }
  
  .df-toeic-timer-label {
    font-size: 0.8125rem;
  }
  
  .df-toeic-timer-value {
    font-size: 1.25rem;
  }
  
  .df-toeic-submit-btn {
    padding: 0.625rem;
    font-size: 0.9375rem;
  }
  
  .df-toeic-question-nav {
    grid-template-columns: repeat(auto-fill, minmax(2.5rem, 1fr));
    gap: 0.375rem;
  }
  
  .df-toeic-question-nav-item {
    padding: 0.375rem;
    font-size: 0.75rem;
  }
  
  .df-toeic-part-navigation {
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .df-toeic-part-navigation button {
    width: 100%;
    padding: 0.625rem;
  }
  
  .df-toeic-passage-split {
    gap: 1rem;
  }
  
  .df-toeic-passage-header {
    font-size: 0.875rem;
  }
  
  .df-toeic-part1-image img {
    max-width: 100%;
  }
  
  .df-toeic-conv-image img {
    max-width: 100%;
  }
}

/* Small mobile */
@media (max-width: 480px) {
  .df-toeic-header {
    padding: 0.5rem 0.75rem;
  }
  
  .df-toeic-title {
    font-size: 1.125rem;
  }
  
  .df-toeic-main-layout {
    padding: 0.5rem;
  }
  
  .df-toeic-content {
    padding: 0.75rem;
  }
  
  .df-toeic-sidebar {
    padding: 0.75rem;
  }
  
  .df-toeic-part-nav {
    gap: 0.25rem;
  }
  
  .df-toeic-part-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }
  
  .df-toeic-timer-value {
    font-size: 1.125rem;
  }
  
  .df-toeic-question-nav {
    grid-template-columns: repeat(auto-fill, minmax(2rem, 1fr));
    gap: 0.25rem;
  }
  
  .df-toeic-question-nav-item {
    padding: 0.25rem;
    font-size: 0.6875rem;
  }
}
