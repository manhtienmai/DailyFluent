{% extends "base.html" %}
{% load static %}
{% block title %}Kết quả {{ template_obj.title }} | DailyFluent{% endblock %}
{% block main_classes %}df-page-container-lg{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/exam-result.css' %}?v=20260107">
<style>
  /* Modern Exam Result Styles */
  body {
    scrollbar-gutter: stable both-edges;
  }

  .df-result-container {
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: 0.75rem;
  }

  /* Alert Banner */
  .df-result-alert {
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    border: 1px solid #a7f3d0;
    border-radius: 0.75rem;
    padding: 0.6rem 0.75rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: flex-start;
    gap: 0.6rem;
  }

  .df-result-alert-icon {
    color: #059669;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .df-result-alert-text {
    font-size: 0.875rem;
    color: #065f46;
    line-height: 1.5;
  }

  .df-result-alert-link {
    color: #047857;
    font-weight: 600;
    text-decoration: underline;
  }

  /* Header */
  .df-result-header {
    margin-bottom: 0.75rem;
  }

  .df-result-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.5rem;
  }

  .df-result-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .df-result-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    font-weight: 600;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }

  .df-result-btn--primary {
    background: #3b82f6;
    color: #fff;
  }

  .df-result-btn--primary:hover {
    background: #2563eb;
  }

  .df-result-btn--secondary {
    background: #fff;
    color: #475569;
    border: 1px solid #cbd5e1;
  }

  .df-result-btn--secondary:hover {
    background: #f8fafc;
    border-color: #94a3b8;
  }

  /* Summary Grid */
  .df-result-summary {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  @media (min-width: 768px) {
    .df-result-summary {
      grid-template-columns: 280px 1fr;
    }
  }

  /* Left Stats Card */
  .df-result-left-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .df-result-stat-row {
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .df-result-stat-icon {
    width: 24px;
    height: 24px;
    color: #64748b;
    flex-shrink: 0;
  }

  .df-result-stat-content {
    flex: 1;
  }

  .df-result-stat-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 0.125rem;
  }

  .df-result-stat-value {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
  }

  /* Right Stats Cards Grid */
  .df-result-right-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.6rem;
  }

  @media (min-width: 1024px) {
    .df-result-right-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .df-result-stat-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 0.85rem;
    text-align: center;
  }

  .df-result-stat-card-icon {
    width: 32px;
    height: 32px;
    margin: 0 auto 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .df-result-stat-card-icon--correct {
    color: #10b981;
  }

  .df-result-stat-card-icon--wrong {
    color: #ef4444;
  }

  .df-result-stat-card-icon--skipped {
    color: #94a3b8;
  }

  .df-result-stat-card-icon--score {
    color: #6366f1;
  }

  .df-result-stat-card-label {
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 0.375rem;
  }

  .df-result-stat-card-value {
    font-size: 1.5rem;
    font-weight: 700;
  }

  .df-result-stat-card-value--correct {
    color: #10b981;
  }

  .df-result-stat-card-value--wrong {
    color: #ef4444;
  }

  .df-result-stat-card-value--skipped {
    color: #64748b;
  }

  .df-result-stat-card-value--score {
    color: #1e293b;
  }

  .df-result-stat-card-unit {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.125rem;
  }

  /* Section Scores */
  .df-result-section-scores {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .df-result-section-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 1.25rem;
    text-align: center;
  }

  .df-result-section-title {
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 0.5rem;
  }

  .df-result-section-score {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
  }

  .df-result-section-detail {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.25rem;
  }

  /* Analysis Section */
  .df-result-analysis {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .df-result-analysis-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e2e8f0;
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
  }

  /* Part Tabs */
  .df-result-tabs {
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid #e2e8f0;
    padding: 0 0.5rem;
  }

  .df-result-tab {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #64748b;
    border: none;
    background: transparent;
    cursor: pointer;
    white-space: nowrap;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.2s;
  }

  .df-result-tab:hover {
    color: #3b82f6;
  }

  .df-result-tab--active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
    font-weight: 600;
  }

  /* Analysis Table */
  .df-result-table {
    width: 100%;
    border-collapse: collapse;
  }

  .df-result-table th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #64748b;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
  }

  .df-result-table td {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    color: #1e293b;
    border-bottom: 1px solid #f1f5f9;
  }

  .df-result-table tr:last-child td {
    border-bottom: none;
  }

  .df-result-table .text-center {
    text-align: center;
  }

  .df-result-table .total-row {
    background: #f8fafc;
    font-weight: 600;
  }

  /* Question Number Buttons in Table */
  .df-result-qnum-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .df-result-qnum {
    width: 28px;
    height: 28px;
    border-radius: 0.375rem;
    border: 1px solid #e2e8f0;
    background: #fff;
    font-size: 0.75rem;
    font-weight: 500;
    color: #64748b;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .df-result-qnum:hover {
    border-color: #94a3b8;
  }

  .df-result-qnum--correct {
    background: #dcfce7;
    border-color: #86efac;
    color: #166534;
  }

  .df-result-qnum--wrong {
    background: #fee2e2;
    border-color: #fca5a5;
    color: #991b1b;
  }

  .df-result-qnum--skipped {
    background: #f1f5f9;
    border-color: #cbd5e1;
    color: #64748b;
  }

  /* Answer Section */
  .df-result-answers {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .df-result-answers-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .df-result-answers-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
  }

  .df-result-warning {
    font-size: 0.75rem;
    color: #dc2626;
    font-style: italic;
  }

  .df-result-tips {
    background: #fefce8;
    border: 1px solid #fef08a;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .df-result-tips-icon {
    color: #ca8a04;
    flex-shrink: 0;
  }

  .df-result-tips-text {
    font-size: 0.8125rem;
    color: #854d0e;
    line-height: 1.5;
  }

  /* Question List */
  .df-result-qlist {
    margin-top: 1.5rem;
  }

  .df-result-qlist-part {
    margin-bottom: 1.5rem;
  }

  .df-result-qlist-part-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.75rem;
  }

  .df-result-qlist-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.4rem 1rem;
  }

  @media (max-width: 640px) {
    .df-result-qlist-grid {
      grid-template-columns: 1fr;
    }
  }

  .df-result-qlist-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.15rem 0;
  }

  .df-result-qlist-num {
    font-size: 0.875rem;
    font-weight: 600;
    color: #3b82f6;
    min-width: 24px;
  }

  .df-result-qlist-answer {
    font-size: 0.875rem;
    color: #475569;
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .df-result-qlist-status {
    display: flex;
    align-items: center;
  }

  .df-result-qlist-status--correct {
    color: #10b981;
  }

  .df-result-qlist-status--wrong {
    color: #ef4444;
  }

  .df-result-qlist-status--skipped {
    color: #94a3b8;
  }

  .df-result-qlist-detail {
    font-size: 0.8125rem;
    color: #64748b;
    cursor: pointer;
    margin-left: 0;
  }

  .df-result-qlist-detail:hover {
    color: #3b82f6;
    text-decoration: underline;
  }

  /* Modal */
  .df-result-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s;
  }

  .df-result-modal.active {
    opacity: 1;
    visibility: visible;
  }

  .df-result-modal-content {
    background: #fff;
    border-radius: 1rem;
    max-width: 720px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    transform: translateY(20px);
    transition: transform 0.3s;
  }

  .df-result-modal.active .df-result-modal-content {
    transform: translateY(0);
  }

  .df-result-modal-header {
    position: sticky;
    top: 0;
    background: #fff;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 10;
  }

  .df-result-modal-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1e293b;
  }

  .df-result-modal-subtitle {
    font-size: 0.8125rem;
    color: #64748b;
    margin-top: 0.125rem;
  }

  .df-result-modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #94a3b8;
    cursor: pointer;
    border-radius: 0.375rem;
    transition: all 0.15s;
    background: transparent;
    border: none;
  }

  .df-result-modal-close:hover {
    background: #f1f5f9;
    color: #475569;
  }

  .df-result-modal-body {
    padding: 1.25rem;
  }

  /* Modal Content Styles */
  .df-result-modal-tag {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #eff6ff;
    color: #2563eb;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 9999px;
    margin-bottom: 1rem;
  }

  .df-result-modal-audio {
    background: #f8fafc;
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin-bottom: 1rem;
  }

  .df-result-modal-audio audio {
    width: 100%;
    height: 36px;
  }

  .df-result-modal-image {
    margin-bottom: 1rem;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 1px solid #e2e8f0;
  }

  .df-result-modal-image img {
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: contain;
    display: block;
  }

  .df-result-modal-question {
    font-size: 0.9375rem;
    font-weight: 500;
    color: #1e293b;
    margin-bottom: 1rem;
    line-height: 1.5;
  }

  .df-result-modal-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .df-result-modal-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: #1e293b;
  }

  .df-result-modal-option--correct {
    background: #dcfce7;
    border-color: #86efac;
  }

  .df-result-modal-option--wrong {
    background: #fee2e2;
    border-color: #fca5a5;
  }

  .df-result-modal-option-radio {
    width: 16px;
    height: 16px;
    border: 2px solid #cbd5e1;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .df-result-modal-option--selected .df-result-modal-option-radio {
    border-color: #3b82f6;
    background: #3b82f6;
    box-shadow: inset 0 0 0 3px #fff;
  }

  .df-result-modal-answer {
    padding: 0.75rem 1rem;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: #1e40af;
    font-weight: 500;
    margin-bottom: 1rem;
  }

  .df-result-modal-explanation-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.75rem 0;
    background: transparent;
    border: none;
    font-size: 0.875rem;
    font-weight: 500;
    color: #3b82f6;
    cursor: pointer;
    border-top: 1px solid #e2e8f0;
  }

  .df-result-modal-explanation-content {
    padding: 1rem;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: #475569;
    line-height: 1.6;
    white-space: pre-line;
    display: none;
  }

  .df-result-modal-explanation-content.show {
    display: block;
  }
</style>
{% endblock %}

{% block content %}
<!-- Hidden form for CSRF token -->
<form id="csrf-form" style="display: none;">{% csrf_token %}</form>

<div class="df-result-container">
  <!-- Alert Banner -->
  <div class="df-result-alert">
    <svg class="df-result-alert-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <p class="df-result-alert-text">
      <strong>Chú ý:</strong> Bạn có thể tạo flashcards từ highlights (bao gồm các highlights các bạn đã tạo trước đây)
      trong trang chi tiết kết quả bài thi. <a href="#" class="df-result-alert-link">Xem hướng dẫn.</a>
    </p>
  </div>

  <!-- Header -->
  <div class="df-result-header">
    <h1 class="df-result-title">Kết quả thi: {{ template_obj.title }}</h1>
    <div class="df-result-actions">
      <button type="button" id="btn-view-answers" class="df-result-btn df-result-btn--primary">
        Xem đáp án
      </button>
      <a href="{% url 'exam:exam_detail' template_obj.slug %}" class="df-result-btn df-result-btn--secondary">
        Quay về trang đề thi
      </a>
    </div>
  </div>

  <!-- Summary -->
  <div class="df-result-summary">
    <!-- Left Card -->
    <div class="df-result-left-card">
      <div class="df-result-stat-row">
        <svg class="df-result-stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div class="df-result-stat-content">
          <div class="df-result-stat-label">Kết quả làm bài</div>
          <div class="df-result-stat-value">{{ session.correct_count }}/{{ session.total_questions }}</div>
        </div>
      </div>
      <div class="df-result-stat-row">
        <svg class="df-result-stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        <div class="df-result-stat-content">
          <div class="df-result-stat-label">Độ chính xác (#đúng/#tổng)</div>
          <div class="df-result-stat-value">{{ session.score_percent }}%</div>
        </div>
      </div>
      {% if time_taken %}
      <div class="df-result-stat-row">
        <svg class="df-result-stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div class="df-result-stat-content">
          <div class="df-result-stat-label">Thời gian hoàn thành</div>
          <div class="df-result-stat-value">{{ time_taken }}</div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Right Cards Grid -->
    <div class="df-result-right-grid">
      <!-- Correct -->
      <div class="df-result-stat-card">
        <div class="df-result-stat-card-icon df-result-stat-card-icon--correct">
          <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="df-result-stat-card-label">Trả lời đúng</div>
        <div class="df-result-stat-card-value df-result-stat-card-value--correct">{{ session.correct_count }}</div>
        <div class="df-result-stat-card-unit">câu hỏi</div>
      </div>

      <!-- Wrong -->
      <div class="df-result-stat-card">
        <div class="df-result-stat-card-icon df-result-stat-card-icon--wrong">
          <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="df-result-stat-card-label">Trả lời sai</div>
        <div class="df-result-stat-card-value df-result-stat-card-value--wrong">{{ wrong_count }}</div>
        <div class="df-result-stat-card-unit">câu hỏi</div>
      </div>

      <!-- Skipped -->
      <div class="df-result-stat-card">
        <div class="df-result-stat-card-icon df-result-stat-card-icon--skipped">
          <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
          </svg>
        </div>
        <div class="df-result-stat-card-label">Bỏ qua</div>
        <div class="df-result-stat-card-value df-result-stat-card-value--skipped">{{ skipped_count }}</div>
        <div class="df-result-stat-card-unit">câu hỏi</div>
      </div>

      <!-- Score -->
      <div class="df-result-stat-card">
        <div class="df-result-stat-card-icon df-result-stat-card-icon--score">
          <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />
          </svg>
        </div>
        <div class="df-result-stat-card-label">Điểm</div>
        <div class="df-result-stat-card-value df-result-stat-card-value--score">
          {% if template_obj.level == "TOEIC" and toeic_stats %}
          {{ toeic_stats.total_score }}
          {% else %}
          {{ session.score_percent }}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- TOEIC Section Scores -->
  {% if template_obj.level == "TOEIC" and toeic_stats %}
  <div class="df-result-section-scores">
    <div class="df-result-section-card">
      <div class="df-result-section-title">Listening</div>
      <div class="df-result-section-score">{{ toeic_stats.listening.score }}/495</div>
      <div class="df-result-section-detail">Trả lời đúng: {{ toeic_stats.listening.correct }}/{{
        toeic_stats.listening.total }}</div>
    </div>
    <div class="df-result-section-card">
      <div class="df-result-section-title">Reading</div>
      <div class="df-result-section-score">{{ toeic_stats.reading.score }}/495</div>
      <div class="df-result-section-detail">Trả lời đúng: {{ toeic_stats.reading.correct }}/{{ toeic_stats.reading.total
        }}</div>
    </div>
  </div>
  {% endif %}

  <!-- Detailed Analysis -->
  <div class="df-result-analysis">
    <div class="df-result-analysis-header">Phân tích chi tiết</div>

    <!-- Tabs -->
    <div class="df-result-tabs">
      {% if template_obj.level == "TOEIC" %}
      <button type="button" class="df-result-tab df-result-tab--active" data-part="L1">Part 1</button>
      <button type="button" class="df-result-tab" data-part="L2">Part 2</button>
      <button type="button" class="df-result-tab" data-part="L3">Part 3</button>
      <button type="button" class="df-result-tab" data-part="L4">Part 4</button>
      <button type="button" class="df-result-tab" data-part="R5">Part 5</button>
      <button type="button" class="df-result-tab" data-part="R6">Part 6</button>
      <button type="button" class="df-result-tab" data-part="R7">Part 7</button>
      <button type="button" class="df-result-tab" data-part="overall">Tổng quát</button>
      {% else %}
      <button type="button" class="df-result-tab df-result-tab--active" data-part="overall">Tổng quát</button>
      {% endif %}
    </div>

    <!-- Table Content -->
    <div id="analysis-table-content" style="padding: 1rem;">
      <div style="text-align: center; padding: 2rem; color: #64748b;">Đang tải dữ liệu...</div>
    </div>
  </div>

  <!-- Answer Section -->
  <div class="df-result-answers">
    <div class="df-result-answers-header">
      <span class="df-result-answers-title">Đáp án</span>
      <button type="button" id="btn-view-detail" class="df-result-btn df-result-btn--secondary">
        Xem chi tiết đáp án
      </button>
      <button type="button" id="btn-redo-wrong" class="df-result-btn df-result-btn--secondary">
        Làm lại các câu sai
      </button>
      <span class="df-result-warning">Chú ý: Khi làm lại các câu sai, điểm trung bình của bạn sẽ KHÔNG BỊ ẢNH
        HƯỞNG.</span>
    </div>

    <div class="df-result-tips">
      <svg class="df-result-tips-icon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
      </svg>
      <p class="df-result-tips-text">
        <strong>Tips:</strong> Khi xem chi tiết đáp án, bạn có thể tạo và lưu highlight từ vựng, keywords và tạo note để
        học và tra cứu khi có nhu cầu ôn lại đề thi này trong tương lai.
      </p>
    </div>

    <!-- Question List (shown by default) -->
    <div id="question-list" class="df-result-qlist">
      <!-- Will be rendered by JavaScript -->
    </div>
  </div>
</div>

<!-- Question Detail Modal -->
<div id="question-modal" class="df-result-modal">
  <div class="df-result-modal-content">
    <div class="df-result-modal-header">
      <div>
        <div class="df-result-modal-title">Đáp án chi tiết #<span id="modal-qnum"></span></div>
        <div class="df-result-modal-subtitle">{{ template_obj.title }}</div>
      </div>
      <button type="button" id="modal-close-btn" class="df-result-modal-close">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="df-result-modal-body" id="modal-body">
      <!-- Will be rendered by JavaScript -->
    </div>
  </div>
</div>

<script>
  (function () {
    const answersData = {{ answers_json| safe }};
    const toeicStats = {{ toeic_stats_json| safe }};
    const templateLevel = "{{ template_obj.level }}";
    const sessionId = {{ session.id }};

    let currentTab = templateLevel === "TOEIC" ? "L1" : "overall";
  let showAnswers = false;

  // Sub-type labels
  const subTypeLabels = {
    "people": "Tranh tả người",
    "objects": "Tranh tả vật",
    "conversation": "Hội thoại",
    "short_talk": "Bài nói ngắn",
    "text_completion": "Điền từ vào đoạn văn",
    "reading_comprehension": "Đọc hiểu",
    "general": "Chung"
  };

  // Convert number (1,2,3,4) to letter (A,B,C,D)
  function numberToLetter(num) {
    const mapping = { '1': 'A', '2': 'B', '3': 'C', '4': 'D' };
    return mapping[String(num)] || num;
  }

  // Tab switching
  document.querySelectorAll('.df-result-tab').forEach(btn => {
    btn.addEventListener('click', function () {
      currentTab = this.dataset.part;

      document.querySelectorAll('.df-result-tab').forEach(b => {
        b.classList.remove('df-result-tab--active');
      });
      this.classList.add('df-result-tab--active');

      renderAnalysisTable();
    });
  });

  // Render analysis table
  function renderAnalysisTable() {
    const container = document.getElementById('analysis-table-content');
    if (!container) return;

    if (templateLevel === "TOEIC" && toeicStats && toeicStats.stats_by_part) {
      const part = currentTab === "overall" ? null : currentTab;

      const partGroups = {};

      Object.keys(toeicStats.stats_by_part).forEach(key => {
        const stats = toeicStats.stats_by_part[key];
        if (part && stats.part !== part) return;

        const groupKey = stats.part || "other";
        if (!partGroups[groupKey]) {
          partGroups[groupKey] = [];
        }
        partGroups[groupKey].push(stats);
      });

      let html = `
        <table class="df-result-table">
          <thead>
            <tr>
              <th style="width: 25%;">Phân loại câu hỏi</th>
              <th class="text-center" style="width: 12%;">Số câu đúng</th>
              <th class="text-center" style="width: 12%;">Số câu sai</th>
              <th class="text-center" style="width: 12%;">Số câu bỏ qua</th>
              <th class="text-center" style="width: 12%;">Độ chính xác</th>
              <th style="width: 27%;">Danh sách câu hỏi</th>
            </tr>
          </thead>
          <tbody>
      `;

      Object.keys(partGroups).sort().forEach(partKey => {
        partGroups[partKey].forEach(stats => {
          const partNum = stats.part ? stats.part.replace('L', '').replace('R', '') : '';
          const subTypeLabel = subTypeLabels[stats.sub_type] || stats.sub_type;
          const classification = stats.part ? `[Part ${partNum}] ${subTypeLabel}` : subTypeLabel;
          const accuracy = stats.total > 0 ? ((stats.correct / stats.total) * 100).toFixed(2) : '0.00';

          html += `
            <tr>
              <td>${classification}</td>
              <td class="text-center">${stats.correct || 0}</td>
              <td class="text-center">${stats.wrong || 0}</td>
              <td class="text-center">${stats.skipped || 0}</td>
              <td class="text-center">${accuracy}%</td>
              <td>
                <div class="df-result-qnum-grid">
                  ${(stats.questions || []).map(q => {
            let statusClass = 'df-result-qnum--skipped';
            if (q.is_correct) statusClass = 'df-result-qnum--correct';
            else if (q.selected) statusClass = 'df-result-qnum--wrong';
            return `<button type="button" class="df-result-qnum ${statusClass}" data-qid="${q.id}">${q.order}</button>`;
          }).join('')}
                </div>
              </td>
            </tr>
          `;
        });
      });

      // Total row
      if (part && Object.keys(partGroups).length > 0) {
        const partTotal = Object.values(partGroups).flat().reduce((acc, stats) => {
          acc.correct += stats.correct || 0;
          acc.wrong += stats.wrong || 0;
          acc.skipped += stats.skipped || 0;
          acc.total += stats.total || 0;
          return acc;
        }, { correct: 0, wrong: 0, skipped: 0, total: 0 });

        const totalAccuracy = partTotal.total > 0 ? ((partTotal.correct / partTotal.total) * 100).toFixed(2) : '0.00';
        html += `
          <tr class="total-row">
            <td>Total</td>
            <td class="text-center">${partTotal.correct}</td>
            <td class="text-center">${partTotal.wrong}</td>
            <td class="text-center">${partTotal.skipped}</td>
            <td class="text-center">${totalAccuracy}%</td>
            <td></td>
          </tr>
        `;
      }

      html += '</tbody></table>';
      container.innerHTML = html;

      // Attach click handlers
      container.querySelectorAll('.df-result-qnum').forEach(btn => {
        btn.addEventListener('click', () => showQuestionDetail(parseInt(btn.dataset.qid)));
      });
    } else {
      container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #64748b;">Chưa có dữ liệu phân tích.</p>';
    }
  }

  // View answers buttons
  document.getElementById('btn-view-answers')?.addEventListener('click', toggleAnswers);
  document.getElementById('btn-view-detail')?.addEventListener('click', toggleAnswers);

  function toggleAnswers() {
    showAnswers = !showAnswers;
    const section = document.getElementById('question-list');
    if (section) {
      section.style.display = showAnswers ? 'block' : 'none';
      if (showAnswers) renderQuestionList();
    }
    const btn = document.getElementById('btn-view-answers');
    if (btn) btn.textContent = showAnswers ? 'Ẩn đáp án' : 'Xem đáp án';
  }

  // Render question list
  function renderQuestionList() {
    const container = document.getElementById('question-list');
    if (!container) return;

    const byPart = {};
    answersData.forEach(ans => {
      const part = ans.question?.toeic_part || 'Other';
      if (!byPart[part]) byPart[part] = [];
      byPart[part].push(ans);
    });

    let html = '';
    Object.keys(byPart).sort().forEach(part => {
      const partNum = part.replace('L', '').replace('R', '');
      html += `<div class="df-result-qlist-part">`;
      html += `<div class="df-result-qlist-part-title">Part ${partNum}</div>`;
      html += `<div class="df-result-qlist-grid">`;

      byPart[part].forEach(ans => {
        const q = ans.question;
        const selected = ans.raw_answer?.selected_key || '';
        const correct = q?.correct_answer || '';
        const isCorrect = ans.is_correct;
        const isSkipped = !selected;

        let statusIcon = '';
        let statusClass = '';
        if (isSkipped) {
          statusIcon = '—';
          statusClass = 'df-result-qlist-status--skipped';
        } else if (isCorrect) {
          statusIcon = '✓';
          statusClass = 'df-result-qlist-status--correct';
        } else {
          statusIcon = '✗';
          statusClass = 'df-result-qlist-status--wrong';
        }

        const displayAnswer = isSkipped ? 'chưa trả lời' : numberToLetter(selected);

        html += `
          <div class="df-result-qlist-item">
            <span class="df-result-qlist-num">${q?.order || ''}</span>
            <span class="df-result-qlist-answer">
              ${numberToLetter(correct)}: ${displayAnswer}
              <span class="df-result-qlist-status ${statusClass}">${statusIcon}</span>
              <span class="df-result-qlist-detail" data-qid="${q?.id}">[Chi tiết]</span>
            </span>
          </div>
        `;
      });

      html += '</div></div>';
    });

    container.innerHTML = html;

    // Attach click handlers
    container.querySelectorAll('.df-result-qlist-detail').forEach(btn => {
      btn.addEventListener('click', () => showQuestionDetail(parseInt(btn.dataset.qid)));
    });
  }

  // Modal
  const modal = document.getElementById('question-modal');
  const modalBody = document.getElementById('modal-body');
  const modalQnum = document.getElementById('modal-qnum');
  const modalCloseBtn = document.getElementById('modal-close-btn');

  function openModal() {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    // Stop any playing audio in the modal
    const audio = modalBody?.querySelector('audio');
    if (audio) {
      audio.pause();
      audio.currentTime = 0;
    }
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }

  modalCloseBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('active')) closeModal();
  });

  // Show question detail
  async function showQuestionDetail(questionId) {
    if (!modal || !modalBody) return;

    modalBody.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">Đang tải...</div>';
    openModal();

    try {
      const response = await fetch(`/exam/session/${sessionId}/result/question/${questionId}/`);
      if (!response.ok) throw new Error('Failed to fetch');
      const data = await response.json();

      const q = data.question;
      const answer = data.answer;

      if (modalQnum) modalQnum.textContent = q.order || q.id;

      let html = '';

      // Tag
      if (q.toeic_part) {
        const partNum = q.toeic_part.replace('L', '').replace('R', '');
        const subTypeLabel = subTypeLabels[q.sub_type] || q.sub_type;
        html += `<div class="df-result-modal-tag">#[Part ${partNum}] ${subTypeLabel}</div>`;
      }

      // Audio
      if (q.audio || data.conversation?.audio) {
        const audioUrl = q.audio || data.conversation?.audio;
        html += `<div class="df-result-modal-audio"><audio controls><source src="${audioUrl}" type="audio/mpeg"></audio></div>`;
      }

      // Image
      if (q.image || data.passage?.image || data.conversation?.image) {
        const imageUrl = q.image || data.passage?.image || data.conversation?.image;
        html += `<div class="df-result-modal-image"><img src="${imageUrl}" alt="Question image"></div>`;
      }

      // Question text
      if (q.text) {
        html += `<div class="df-result-modal-question">${q.order || ''} ${escapeHtml(q.text)}</div>`;
      }

      // Options
      if (q.mcq_choices?.length > 0) {
        html += '<div class="df-result-modal-options">';
        q.mcq_choices.forEach(opt => {
          const isCorrect = opt.key === q.correct_answer;
          const isSelected = opt.key === answer.selected_key;
          let optClass = '';
          if (isCorrect) optClass = 'df-result-modal-option--correct';
          else if (isSelected) optClass = 'df-result-modal-option--wrong';

          html += `
            <div class="df-result-modal-option ${optClass} ${isSelected ? 'df-result-modal-option--selected' : ''}">
              <span class="df-result-modal-option-radio"></span>
              <span>${numberToLetter(opt.key)}.</span>
              <span>${escapeHtml(opt.text)}</span>
            </div>
          `;
        });
        html += '</div>';
      }

      // Correct answer
      html += `<div class="df-result-modal-answer">Đáp án đúng: ${numberToLetter(q.correct_answer) || 'N/A'}</div>`;

      // Explanation
      html += `
        <button type="button" class="df-result-modal-explanation-btn" id="explanation-toggle">
          <span>Giải thích chi tiết đáp án</span>
          <span id="explanation-arrow">▼</span>
        </button>
        <div class="df-result-modal-explanation-content" id="explanation-content">
          ${q.explanation_vi ? escapeHtml(q.explanation_vi) : 'Chưa có lời giải cho câu hỏi này.'}
        </div>
      `;

      modalBody.innerHTML = html;

      // Toggle explanation
      document.getElementById('explanation-toggle')?.addEventListener('click', () => {
        const content = document.getElementById('explanation-content');
        const arrow = document.getElementById('explanation-arrow');
        if (content && arrow) {
          content.classList.toggle('show');
          arrow.textContent = content.classList.contains('show') ? '▲' : '▼';
        }
      });

    } catch (error) {
      console.error('Error:', error);
      modalBody.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Lỗi khi tải dữ liệu.</div>';
    }
  }

  // Make showQuestionDetail global
  window.showQuestionDetail = showQuestionDetail;

  // Helper
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Initial render
  renderAnalysisTable();
  renderQuestionList();

  // Redo wrong questions button handler
  document.getElementById('btn-redo-wrong')?.addEventListener('click', function () {
    // Get wrong question IDs
    const wrongQuestionIds = answersData
      .filter(ans => !ans.is_correct && ans.raw_answer?.selected_key)
      .map(ans => ans.question?.id)
      .filter(id => id);

    if (wrongQuestionIds.length === 0) {
      alert('Không có câu sai để làm lại!');
      return;
    }

    if (confirm(`Bạn muốn làm lại ${wrongQuestionIds.length} câu sai? (Không tính thời gian)`)) {
      // Submit form to create new attempt with wrong questions
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/exam/session/${sessionId}/redo-wrong/`;

      // Add CSRF token
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
      form.appendChild(csrfInput);

      // Add question IDs
      wrongQuestionIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'question_ids';
        input.value = id;
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
    }
  });
}) ();
</script>
{% endblock %}