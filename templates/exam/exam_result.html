{% extends "layouts/sidebar_layout.html" %}
{% load static %}
{% block title %}Kết quả {{ template_obj.title }} | DailyFluent{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/exam-result.css' %}?v=20260107">
<style>
  /* Modern Exam Result Styles - Themed */
  body {
    scrollbar-gutter: stable both-edges;
  }

  .df-result-container {
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: 1.5rem;
    color: var(--text-primary);
  }

  /* Alert Banner */
  .df-result-alert {
    background: var(--status-success-subtle);
    border: 1px solid var(--status-success-border);
    border-radius: var(--df-radius-md);
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .df-result-alert-icon {
    color: var(--status-success-text);
    flex-shrink: 0;
    margin-top: 2px;
  }

  .df-result-alert-text {
    font-size: 0.875rem;
    color: var(--status-success-text);
    line-height: 1.5;
  }

  .df-result-alert-link {
    color: var(--status-success-text);
    font-weight: 600;
    text-decoration: underline;
  }

  /* Header */
  .df-result-header {
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  @media (min-width: 768px) {
    .df-result-header {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
    }
  }

  .df-result-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }

  /* ========================================
     Modern Hero Section with Circular Score
     ======================================== */
  .df-result-hero {
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
    border-radius: 1.25rem;
    padding: 2rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2rem;
    flex-wrap: wrap;
    position: relative;
    overflow: hidden;
  }

  .df-result-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 60%;
    height: 200%;
    background: radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, transparent 70%);
    pointer-events: none;
  }

  .df-result-hero-info {
    flex: 1;
    min-width: 280px;
    position: relative;
    z-index: 1;
  }

  .df-result-hero-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 9999px;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 0.75rem;
  }

  .df-result-hero-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: #fff;
    margin: 0 0 0.5rem 0;
    line-height: 1.2;
  }

  /* ========================================
     Compact Hero Section - 3 Columns
     ======================================== */
  .df-result-hero-compact {
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
    border-radius: 1rem;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1rem;
    display: grid;
    grid-template-columns: 1fr auto auto;
    align-items: center;
    gap: 1.5rem;
    position: relative;
    overflow: hidden;
  }
  
  .df-result-hero-compact::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 40%;
    height: 200%;
    background: radial-gradient(circle, rgba(139, 92, 246, 0.25) 0%, transparent 70%);
    pointer-events: none;
  }
  
  .df-result-hero-left {
    position: relative;
    z-index: 1;
    min-width: 0;
  }
  
  .df-result-hero-meta-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
  }
  
  .df-result-hero-meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.8125rem;
    color: rgba(255, 255, 255, 0.7);
  }
  
  .df-result-hero-meta-item svg {
    opacity: 0.7;
  }
  
  .df-result-hero-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .df-result-hero-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.875rem;
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.15s ease;
    cursor: pointer;
    border: none;
  }
  
  .df-result-hero-btn--primary {
    background: linear-gradient(135deg, #10B981, #34D399);
    color: #fff;
  }
  
  .df-result-hero-btn--primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }
  
  .df-result-hero-btn--ghost {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .df-result-hero-btn--ghost:hover {
    background: rgba(255, 255, 255, 0.15);
  }
  
  /* Center Score Display /990 */
  .df-result-hero-score {
    position: relative;
    z-index: 1;
    text-align: center;
    padding: 0 1rem;
  }
  
  .df-result-score-big {
    font-size: 3rem;
    font-weight: 900;
    color: #fff;
    line-height: 1;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  
  .df-result-score-max {
    font-size: 1.25rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.5);
    margin-top: 0.125rem;
  }
  
  .df-result-grade {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    margin-top: 0.5rem;
  }
  
  .df-result-grade--success {
    background: linear-gradient(135deg, #10B981, #34D399);
    color: #fff;
  }
  
  .df-result-grade--warning {
    background: linear-gradient(135deg, #F59E0B, #FBBF24);
    color: #fff;
  }
  
  .df-result-grade--danger {
    background: linear-gradient(135deg, #EF4444, #F87171);
    color: #fff;
  }
  
  /* Circular % Ring */
  .df-result-hero-ring {
    position: relative;
    z-index: 1;
  }
  
  .df-result-ring-wrap {
    position: relative;
    width: 80px;
    height: 80px;
  }
  
  .df-result-ring-wrap svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }
  
  .df-result-ring-bg {
    fill: none;
    stroke: rgba(255, 255, 255, 0.1);
    stroke-width: 6;
  }
  
  .df-result-ring-fill {
    fill: none;
    stroke: url(#scoreGradient);
    stroke-width: 6;
    stroke-linecap: round;
    transition: stroke-dashoffset 1s ease-out;
  }
  
  .df-result-ring-value {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .df-result-ring-pct {
    font-size: 1.125rem;
    font-weight: 800;
    color: #fff;
  }
  
  /* Compact Stats Row */
  .df-result-stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  
  .df-result-stat-mini {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .df-result-stat-mini svg {
    flex-shrink: 0;
  }
  
  .df-result-stat-mini--correct svg { color: #10B981; }
  .df-result-stat-mini--wrong svg { color: #EF4444; }
  .df-result-stat-mini--skip svg { color: #6B7280; }
  .df-result-stat-mini--score svg { color: #8B5CF6; }
  
  .df-result-stat-mini-data {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }
  
  .df-result-stat-mini-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.2;
  }
  
  .df-result-stat-mini-label {
    font-size: 0.6875rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .df-result-hero-compact {
      grid-template-columns: 1fr;
      text-align: center;
      gap: 1rem;
      padding: 1.25rem 1rem;
    }
    
    .df-result-hero-meta-row {
      justify-content: center;
    }
    
    .df-result-hero-actions {
      justify-content: center;
    }
    
    .df-result-hero-score {
      order: -1;
      padding: 0;
    }
    
    .df-result-score-big {
      font-size: 2.5rem;
    }
    
    .df-result-hero-ring {
      display: none;
    }
    
    .df-result-stats-row {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .df-result-hero-compact {
      padding: 1rem;
    }
    
    .df-result-hero-title {
      font-size: 1.25rem;
    }
    
    .df-result-score-big {
      font-size: 2rem;
    }
  }

  .df-result-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .df-result-btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: var(--df-radius-md);
    cursor: pointer;
    transition: var(--df-transition-fast);
    border: none;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .df-result-btn--primary {
    background: var(--btn-primary-bg);
    color: var(--btn-primary-text);
    box-shadow: var(--shadow-sm);
  }

  .df-result-btn--primary:hover {
    background: var(--btn-primary-bg-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .df-result-btn--secondary {
    background: var(--bg-surface);
    color: var(--text-secondary);
    border: 1px solid var(--border-default);
  }

  .df-result-btn--secondary:hover {
    background: var(--bg-surface-raised);
    border-color: var(--border-strong);
    color: var(--text-primary);
  }

  /* Summary Grid */
  .df-result-summary {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  @media (min-width: 1024px) {
    .df-result-summary {
      grid-template-columns: 320px 1fr;
    }
  }

  /* Left Stats Card */
  .df-result-left-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--df-radius-lg);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    box-shadow: var(--shadow-sm);
  }

  .df-result-stat-row {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .df-result-stat-icon {
    width: 24px;
    height: 24px;
    color: var(--text-tertiary);
    flex-shrink: 0;
  }

  .df-result-stat-content {
    flex: 1;
  }

  .df-result-stat-label {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
  }

  .df-result-stat-value {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  /* Right Stats Cards Grid */
  .df-result-right-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  @media (min-width: 768px) {
    .df-result-right-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .df-result-stat-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--df-radius-lg);
    padding: 1.25rem;
    text-align: center;
    box-shadow: var(--shadow-sm);
    transition: var(--df-transition-fast);
  }
  
  .df-result-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--border-interactive);
  }

  .df-result-stat-card-icon {
    width: 40px;
    height: 40px;
    margin: 0 auto 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--bg-app-subtle);
  }

  .df-result-stat-card-icon--correct {
    color: var(--status-success);
    background: var(--status-success-subtle);
  }

  .df-result-stat-card-icon--wrong {
    color: var(--status-error);
    background: var(--status-error-subtle);
  }

  .df-result-stat-card-icon--skipped {
    color: var(--text-tertiary);
    background: var(--bg-app-subtle);
  }

  .df-result-stat-card-icon--score {
    color: var(--action-primary);
    background: var(--action-primary-subtle);
  }

  .df-result-stat-card-label {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
  }

  .df-result-stat-card-value {
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.2;
  }

  .df-result-stat-card-value--correct { color: var(--status-success); }
  .df-result-stat-card-value--wrong { color: var(--status-error); }
  .df-result-stat-card-value--skipped { color: var(--text-secondary); }
  .df-result-stat-card-value--score { color: var(--text-primary); }

  .df-result-stat-card-unit {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-top: 0.25rem;
  }

  /* Section Scores */
  .df-result-section-scores {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .df-result-section-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--df-radius-lg);
    padding: 1.5rem;
    text-align: center;
    box-shadow: var(--shadow-sm);
  }

  .df-result-section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .df-result-section-score {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .df-result-section-detail {
    font-size: 0.875rem;
    color: var(--text-tertiary);
    margin-top: 0.5rem;
  }

  /* ========================================
     TOEIC Visual Score Display (Reference Design)
     ======================================== */
  .df-toeic-score-display {
    background: #fef8f0;
    border: 1px solid #f59e0b;
    border-radius: var(--df-radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
  }

  @media (prefers-color-scheme: dark) {
    .df-toeic-score-display {
      background: #1c1917;
      border-color: #d97706;
    }
  }

  .df-toeic-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 768px) {
    .df-toeic-columns {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
  }

  .df-toeic-column {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .df-toeic-section-header {
    display: inline-block;
    background: #f59e0b;
    color: #1c1917;
    font-size: 0.9375rem;
    font-weight: 700;
    padding: 0.5rem 1.25rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    width: fit-content;
    margin: 0 auto 0.5rem;
    text-align: center;
  }

  /* Part Row */
  .df-toeic-part-row {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    position: relative;
  }

  .df-toeic-part-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
  }

  .df-toeic-part-bar-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
  }

  .df-toeic-part-bar {
    flex: 1;
    height: 20px;
    background: linear-gradient(to right, #1c1917 0%, #52525b 100%);
    border-radius: 2px;
    position: relative;
    overflow: visible;
  }

  .df-toeic-part-fill {
    height: 100%;
    background: linear-gradient(to right, #f59e0b, #fbbf24);
    border-radius: 2px 0 0 2px;
    position: relative;
  }

  .df-toeic-part-score-bubble {
    position: absolute;
    top: -12px;
    right: -2px;
    transform: translateX(50%);
    width: 36px;
    height: 36px;
    background: #fff;
    border: 2px solid #1c1917;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    color: #1c1917;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .df-toeic-part-total {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-secondary);
    min-width: 32px;
    text-align: right;
  }

  @media (prefers-color-scheme: dark) {
    .df-toeic-part-score-bubble {
      background: #fef3c7;
    }
  }

  /* Section Score Card */
  .df-toeic-section-score-card {
    background: #fff;
    border: 2px solid #e5e7eb;
    border-radius: var(--df-radius-md);
    padding: 1.25rem;
    text-align: center;
  }

  @media (prefers-color-scheme: dark) {
    .df-toeic-section-score-card {
      background: #1f2937;
      border-color: #374151;
    }
  }

  .df-toeic-section-score-header {
    display: inline-block;
    background: #f59e0b;
    color: #1c1917;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.375rem 1rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }

  .df-toeic-section-score-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
  }

  .df-toeic-section-score-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    position: relative;
    display: inline-block;
    width: 60px;
    height: 60px;
    border: 2px solid #1c1917;
    border-radius: 50%;
    line-height: 56px;
    background: #fff;
    margin-bottom: 0.75rem;
  }

  @media (prefers-color-scheme: dark) {
    .df-toeic-section-score-value {
      background: #fef3c7;
      color: #1c1917;
    }
  }

  .df-toeic-section-score-slider {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .df-toeic-section-slider-min,
  .df-toeic-section-slider-max {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    min-width: 28px;
  }

  .df-toeic-section-slider-track {
    flex: 1;
    height: 16px;
    background: linear-gradient(to right, #1c1917 0%, #52525b 100%);
    border-radius: 2px;
    position: relative;
  }

  .df-toeic-section-slider-fill {
    height: 100%;
    background: linear-gradient(to right, #f59e0b, #fbbf24);
    border-radius: 2px 0 0 2px;
  }

  /* Total Score */
  .df-toeic-total-score {
    text-align: center;
    padding-top: 1.5rem;
    border-top: 2px solid #f59e0b;
  }

  .df-toeic-total-header {
    display: inline-block;
    background: #f59e0b;
    color: #1c1917;
    font-size: 0.9375rem;
    font-weight: 700;
    padding: 0.625rem 1.5rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }

  .df-toeic-total-value {
    font-size: 4rem;
    font-weight: 800;
    color: var(--text-primary);
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 140px;
    height: 140px;
    border: 3px solid #1c1917;
    border-radius: 50%;
    background: #fff;
  }

  @media (prefers-color-scheme: dark) {
    .df-toeic-total-value {
      background: #fef3c7;
      color: #1c1917;
    }
  }

  @media (max-width: 640px) {
    .df-toeic-total-value {
      font-size: 3rem;
      width: 110px;
      height: 110px;
    }
  }

  /* Analysis Section */
  .df-result-analysis {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--df-radius-lg);
    margin-bottom: 2rem;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  .df-result-analysis-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-default);
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    background: var(--bg-surface-raised);
  }

  /* Part Tabs */
  .df-result-tabs {
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--border-default);
    padding: 0 1rem;
    background: var(--bg-surface);
    gap: 0.5rem;
  }

  .df-result-tab {
    padding: 1rem 1rem;
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--text-secondary);
    border: none;
    background: transparent;
    cursor: pointer;
    white-space: nowrap;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: var(--df-transition-fast);
  }

  .df-result-tab:hover {
    color: var(--action-primary);
    background: var(--bg-interactive-hover);
  }

  .df-result-tab--active {
    color: var(--action-primary);
    border-bottom-color: var(--action-primary);
    font-weight: 600;
  }

  /* Analysis Table */
  .df-result-table {
    width: 100%;
    border-collapse: collapse;
  }

  .df-result-table th {
    text-align: left;
    padding: 1rem 1.5rem;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-secondary);
    background: var(--bg-app-subtle);
    border-bottom: 1px solid var(--border-default);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .df-result-table td {
    padding: 1rem 1.5rem;
    font-size: 0.9375rem;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-subtle);
  }

  .df-result-table tr:hover td {
    background: var(--bg-app-subtle);
  }

  .df-result-table tr:last-child td {
    border-bottom: none;
  }

  .df-result-table .text-center {
    text-align: center;
  }

  .df-result-table .total-row {
    background: var(--bg-surface-raised);
    font-weight: 700;
  }
  
  .df-result-table .total-row td {
    color: var(--text-primary);
    border-top: 2px solid var(--border-default);
  }

  /* Question Number Buttons in Table */
  .df-result-qnum-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .df-result-qnum {
    width: 32px;
    height: 32px;
    border-radius: 0.375rem;
    border: 1px solid var(--border-default);
    background: var(--bg-surface);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .df-result-qnum:hover {
    border-color: var(--border-strong);
    transform: scale(1.05);
  }

  .df-result-qnum--correct {
    background: var(--status-success-subtle);
    border-color: var(--status-success-border);
    color: var(--status-success-text);
  }

  .df-result-qnum--wrong {
    background: var(--status-error-subtle);
    border-color: var(--status-error-border);
    color: var(--status-error-text);
  }

  .df-result-qnum--skipped {
    background: var(--bg-app-subtle);
    border-color: var(--border-default);
    color: var(--text-tertiary);
  }

  /* Answer Section */
  .df-result-answers {
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--df-radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
  }

  .df-result-answers-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-subtle);
  }

  .df-result-answers-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-right: auto;
  }

  .df-result-warning {
    font-size: 0.8125rem;
    color: var(--status-warning-text);
    font-style: italic;
    background: var(--status-warning-subtle);
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
  }

  .df-result-tips {
    background: var(--status-warning-subtle);
    border: 1px solid var(--status-warning-border);
    border-radius: var(--df-radius-md);
    padding: 1rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .df-result-tips-icon {
    color: var(--status-warning-text);
    flex-shrink: 0;
  }

  .df-result-tips-text {
    font-size: 0.875rem;
    color: var(--status-warning-text);
    line-height: 1.6;
  }
  
  .df-result-tips-text strong {
    color: var(--status-warning);
  }

  /* Question List */
  .df-result-qlist {
    margin-top: 1.5rem;
  }

  .df-result-qlist-part {
    margin-bottom: 2rem;
  }

  .df-result-qlist-part-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1rem;
    padding-left: 0.75rem;
    border-left: 3px solid var(--action-secondary);
  }

  .df-result-qlist-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 0.5rem 1.5rem;
  }

  @media (min-width: 640px) {
    .df-result-qlist-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .df-result-qlist-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: var(--df-radius-sm);
    transition: background 0.15s;
    background: var(--bg-surface);
    border: 1px solid transparent;
  }
  
  .df-result-qlist-item:hover {
    background: var(--bg-app-subtle);
    border-color: var(--border-default);
  }

  .df-result-qlist-num {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--action-primary);
    min-width: 28px;
  }

  .df-result-qlist-answer {
    font-size: 0.875rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-grow: 1;
  }

  .df-result-qlist-status {
    display: flex;
    align-items: center;
    font-size: 1rem;
  }
  
  .df-result-qlist-status--correct { color: var(--status-success); }
  .df-result-qlist-status--wrong { color: var(--status-error); }
  .df-result-qlist-status--skipped { color: var(--text-tertiary); }

  .df-result-qlist-detail {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    cursor: pointer;
    margin-left: auto;
    font-weight: 500;
  }

  .df-result-qlist-detail:hover {
    color: var(--action-primary);
    text-decoration: underline;
  }

  /* Modal */
  .df-result-modal {
    position: fixed;
    inset: 0;
    background: var(--overlay-backdrop);
    backdrop-filter: blur(4px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s;
  }

  .df-result-modal.active {
    opacity: 1;
    visibility: visible;
  }

  .df-result-modal-content {
    background: var(--bg-surface);
    border-radius: var(--df-radius-xl);
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-xl);
    transform: translateY(20px);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    color: var(--text-primary);
    border: 1px solid var(--border-subtle);
  }

  .df-result-modal.active .df-result-modal-content {
    transform: translateY(0);
  }

  .df-result-modal-header {
    background: var(--bg-surface);
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-default);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    border-radius: var(--df-radius-xl) var(--df-radius-xl) 0 0;
  }

  .df-result-modal-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
  }

  .df-result-modal-subtitle {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
  }

  .df-result-modal-close {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-tertiary);
    cursor: pointer;
    border-radius: var(--df-radius-md);
    transition: all 0.15s;
    background: transparent;
    border: none;
  }

  .df-result-modal-close:hover {
    background: var(--bg-interactive-hover);
    color: var(--text-primary);
  }

  .df-result-modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex: 1;
  }

  /* Modal Content Styles */
  .df-result-modal-tag {
    display: inline-block;
    padding: 0.35rem 0.875rem;
    background: var(--action-primary-subtle);
    color: var(--action-primary);
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 9999px;
    margin-bottom: 1.25rem;
  }

  .df-result-modal-audio {
    background: var(--bg-app-subtle);
    border-radius: var(--df-radius-lg);
    padding: 1rem;
    margin-bottom: 1.5rem;
    border: 1px solid var(--border-subtle);
  }

  .df-result-modal-audio audio {
    width: 100%;
    height: 40px;
  }

  .df-result-modal-image {
    margin-bottom: 1.5rem;
    border-radius: var(--df-radius-lg);
    overflow: hidden;
    border: 1px solid var(--border-default);
    background: var(--bg-app-subtle);
  }

  .df-result-modal-image img {
    width: 100%;
    height: auto;
    max-height: 450px;
    object-fit: contain;
    display: block;
    margin: 0 auto;
  }

  .df-result-modal-question {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  .df-result-modal-options {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .df-result-modal-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-default);
    border-radius: var(--df-radius-md);
    font-size: 0.9375rem;
    color: var(--text-primary);
    background: var(--bg-surface);
    transition: all 0.15s;
  }

  .df-result-modal-option--correct {
    background: var(--status-success-subtle);
    border-color: var(--status-success-border);
  }

  .df-result-modal-option--wrong {
    background: var(--status-error-subtle);
    border-color: var(--status-error-border);
  }

  .df-result-modal-option-radio {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-strong);
    border-radius: 50%;
    flex-shrink: 0;
    position: relative;
  }

  .df-result-modal-option--selected .df-result-modal-option-radio {
    border-color: var(--action-primary);
    background: var(--action-primary);
    box-shadow: inset 0 0 0 3px var(--bg-surface);
  }
  
  .df-result-modal-option--correct .df-result-modal-option-radio {
    border-color: var(--status-success);
    background: var(--status-success);
  }
  
  .df-result-modal-option--wrong .df-result-modal-option-radio {
    border-color: var(--status-error);
    background: var(--status-error);
  }

  .df-result-modal-answer {
    padding: 1rem 1.25rem;
    background: var(--action-primary-subtle);
    border: 1px solid var(--action-primary-subtle-hover);
    border-radius: var(--df-radius-md);
    font-size: 0.9375rem;
    color: var(--action-primary);
    font-weight: 600;
    margin-bottom: 1.5rem;
  }

  .df-result-modal-explanation-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 1rem 0;
    background: transparent;
    border: none;
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--action-primary);
    cursor: pointer;
    border-top: 1px solid var(--border-default);
  }
  
  .df-result-modal-explanation-btn:hover {
    color: var(--action-primary-hover);
  }

  .df-result-modal-explanation-content {
    padding: 1.25rem;
    background: var(--bg-app-subtle);
    border: 1px solid var(--border-subtle);
    border-radius: var(--df-radius-md);
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.7;
    white-space: pre-line;
    display: none;
  }

  .df-result-modal-explanation-content.show {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  /* Transcript & Translation Styles */
  .df-result-modal-actions {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .df-result-modal-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: var(--df-radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
  }

  .df-result-modal-action-btn:hover {
    background: var(--bg-app-subtle);
    color: var(--text-primary);
    border-color: var(--border-strong);
  }

  .df-result-modal-action-btn.active {
    background: var(--action-primary-subtle);
    color: var(--action-primary);
    border-color: var(--action-primary);
  }

  .df-result-modal-content-section {
    margin-bottom: 1.5rem;
    padding: 1.25rem;
    background: var(--bg-app);
    border-radius: var(--df-radius-md);
    border: 1px solid var(--border-default);
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.7;
    display: none;
  }

  .df-result-modal-content-section.show {
    display: block;
    animation: fadeIn 0.3s ease;
  }
  
  .df-result-modal-content-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-tertiary);
    font-weight: 700;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-subtle);
  }

  .df-transcript-line {
    margin-bottom: 0.5rem;
  }
  
  .df-transcript-speaker {
    font-weight: 700;
    color: var(--text-primary);
    margin-right: 0.375rem;
  }
  
  .df-translation-text {
    color: var(--text-tertiary);
    font-style: italic;
    margin-top: 0.25rem;
    display: block;
    padding-left: 0.5rem;
    border-left: 2px solid var(--border-subtle);
  }

  .df-option-translation {
    display: block;
    font-size: 0.8125rem;
    color: var(--text-tertiary);
    margin-top: 0.25rem;
    font-style: italic;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock %}

{% block content %}
<!-- Hidden form for CSRF token -->
<form id="csrf-form" style="display: none;">{% csrf_token %}</form>

<div class="df-result-container">
  <!-- Alert Banner -->
  <div class="df-result-alert">
    <svg class="df-result-alert-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <p class="df-result-alert-text">
      <strong>Chú ý:</strong> Bạn có thể tạo flashcards từ highlights (bao gồm các highlights các bạn đã tạo trước đây)
      trong trang chi tiết kết quả bài thi. <a href="#" class="df-result-alert-link">Xem hướng dẫn.</a>
    </p>
  </div>

  <!-- Compact Modern Hero Section -->
  <div class="df-result-hero-compact">
    <!-- Left: Title & Meta -->
    <div class="df-result-hero-left">
      <span class="df-result-hero-badge">{{ template_obj.level }}</span>
      <h1 class="df-result-hero-title">{{ template_obj.title }}</h1>
      <div class="df-result-hero-meta-row">
        <span class="df-result-hero-meta-item">
          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          {% if time_taken %}{{ time_taken }}{% else %}--:--{% endif %}
        </span>
        <span class="df-result-hero-meta-item">
          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          {{ session.total_questions }} câu
        </span>
      </div>
      
      <!-- Inline Action Buttons -->
      <div class="df-result-hero-actions">
        <button type="button" id="btn-view-answers" class="df-result-hero-btn df-result-hero-btn--primary">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
          </svg>
          Xem đáp án
        </button>
        <a href="{% url 'exam:exam_detail' template_obj.slug %}" class="df-result-hero-btn df-result-hero-btn--ghost">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Thi lại
        </a>
        <a href="{% url 'exam:exam_list' %}" class="df-result-hero-btn df-result-hero-btn--ghost">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Quay lại
        </a>
      </div>
    </div>
    
    <!-- Center: Score Display /990 -->
    <div class="df-result-hero-score">
      {% if template_obj.level == "TOEIC" and toeic_stats %}
      <div class="df-result-score-big">{{ toeic_stats.total_score }}</div>
      <div class="df-result-score-max">/990</div>
      {% else %}
      <div class="df-result-score-big">{{ session.correct_count }}</div>
      <div class="df-result-score-max">/{{ session.total_questions }}</div>
      {% endif %}
      {% if session.score_percent >= 80 %}
      <span class="df-result-grade df-result-grade--success">Xuất sắc!</span>
      {% elif session.score_percent >= 50 %}
      <span class="df-result-grade df-result-grade--warning">Khá tốt</span>
      {% else %}
      <span class="df-result-grade df-result-grade--danger">Cần cố gắng</span>
      {% endif %}
    </div>
    
    <!-- Right: Circular % Ring -->
    <div class="df-result-hero-ring">
      <!-- SVG Gradient Definition -->
      <svg width="0" height="0" style="position: absolute;">
        <defs>
          <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#10B981" />
            <stop offset="50%" style="stop-color:#34D399" />
            <stop offset="100%" style="stop-color:#6EE7B7" />
          </linearGradient>
        </defs>
      </svg>
      
      <div class="df-result-ring-wrap">
        <svg viewBox="0 0 100 100">
          <circle class="df-result-ring-bg" cx="50" cy="50" r="42" />
          <circle class="df-result-ring-fill" cx="50" cy="50" r="42"
            stroke-dasharray="264"
            stroke-dashoffset="264"
            id="score-ring-fill" />
        </svg>
        <div class="df-result-ring-value">
          <span class="df-result-ring-pct" id="hero-score">{{ session.score_percent }}%</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Compact Stats Row -->
  <div class="df-result-stats-row">
    <div class="df-result-stat-mini df-result-stat-mini--correct">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
      </svg>
      <div class="df-result-stat-mini-data">
        <span class="df-result-stat-mini-value">{{ session.correct_count }}</span>
        <span class="df-result-stat-mini-label">Đúng</span>
      </div>
    </div>
    <div class="df-result-stat-mini df-result-stat-mini--wrong">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
      </svg>
      <div class="df-result-stat-mini-data">
        <span class="df-result-stat-mini-value">{{ wrong_count }}</span>
        <span class="df-result-stat-mini-label">Sai</span>
      </div>
    </div>
    <div class="df-result-stat-mini df-result-stat-mini--skip">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20 12H4"/>
      </svg>
      <div class="df-result-stat-mini-data">
        <span class="df-result-stat-mini-value">{{ skipped_count }}</span>
        <span class="df-result-stat-mini-label">Bỏ qua</span>
      </div>
    </div>
    <div class="df-result-stat-mini df-result-stat-mini--score">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5"/>
      </svg>
      <div class="df-result-stat-mini-data">
        <span class="df-result-stat-mini-value">{{ session.score_percent }}%</span>
        <span class="df-result-stat-mini-label">Tỷ lệ</span>
      </div>
    </div>
  </div>

  <!-- TOEIC Visual Score Display -->
  {% if template_obj.level == "TOEIC" and toeic_stats %}
  <div class="df-toeic-score-display">
    <div class="df-toeic-columns">
      <!-- LISTENING Column -->
      <div class="df-toeic-column">
        <div class="df-toeic-section-header">LISTENING</div>
        
        <!-- Part 1 -->
        <div class="df-toeic-part-row">
          <span class="df-toeic-part-label">Part 1</span>
          <div class="df-toeic-part-bar-container">
            <div class="df-toeic-part-bar">
              <div class="df-toeic-part-fill" id="part-l1-fill" style="width: 0%;">
                <span class="df-toeic-part-score-bubble" id="part-l1-score">0</span>
              </div>
            </div>
            <span class="df-toeic-part-total" id="part-l1-total">6</span>
          </div>
        </div>
        
        <!-- Part 2 -->
        <div class="df-toeic-part-row">
          <span class="df-toeic-part-label">Part 2</span>
          <div class="df-toeic-part-bar-container">
            <div class="df-toeic-part-bar">
              <div class="df-toeic-part-fill" id="part-l2-fill" style="width: 0%;">
                <span class="df-toeic-part-score-bubble" id="part-l2-score">0</span>
              </div>
            </div>
            <span class="df-toeic-part-total" id="part-l2-total">25</span>
          </div>
        </div>
        
        <!-- Part 3 -->
        <div class="df-toeic-part-row">
          <span class="df-toeic-part-label">Part 3</span>
          <div class="df-toeic-part-bar-container">
            <div class="df-toeic-part-bar">
              <div class="df-toeic-part-fill" id="part-l3-fill" style="width: 0%;">
                <span class="df-toeic-part-score-bubble" id="part-l3-score">0</span>
              </div>
            </div>
            <span class="df-toeic-part-total" id="part-l3-total">39</span>
          </div>
        </div>
        
        <!-- Part 4 -->
        <div class="df-toeic-part-row">
          <span class="df-toeic-part-label">Part 4</span>
          <div class="df-toeic-part-bar-container">
            <div class="df-toeic-part-bar">
              <div class="df-toeic-part-fill" id="part-l4-fill" style="width: 0%;">
                <span class="df-toeic-part-score-bubble" id="part-l4-score">0</span>
              </div>
            </div>
            <span class="df-toeic-part-total" id="part-l4-total">30</span>
          </div>
        </div>
        
        <!-- Listening Section Score -->
        <div class="df-toeic-section-score-card">
          <div class="df-toeic-section-score-header">LISTENING</div>
          <div class="df-toeic-section-score-label">Điểm của bạn</div>
          <div class="df-toeic-section-score-value" id="listening-score">{{ toeic_stats.listening.score }}</div>
          <div class="df-toeic-section-score-slider">
            <span class="df-toeic-section-slider-min">5</span>
            <div class="df-toeic-section-slider-track">
              <div class="df-toeic-section-slider-fill" id="listening-slider-fill" style="width: 0%;"></div>
            </div>
            <span class="df-toeic-section-slider-max">495</span>
          </div>
        </div>
      </div>
      
      <!-- READING Column -->
      <div class="df-toeic-column">
        <div class="df-toeic-section-header">READING</div>
        
        <!-- Part 5 -->
        <div class="df-toeic-part-row">
          <span class="df-toeic-part-label">Part 5</span>
          <div class="df-toeic-part-bar-container">
            <div class="df-toeic-part-bar">
              <div class="df-toeic-part-fill" id="part-r5-fill" style="width: 0%;">
                <span class="df-toeic-part-score-bubble" id="part-r5-score">0</span>
              </div>
            </div>
            <span class="df-toeic-part-total" id="part-r5-total">30</span>
          </div>
        </div>
        
        <!-- Part 6 -->
        <div class="df-toeic-part-row">
          <span class="df-toeic-part-label">Part 6</span>
          <div class="df-toeic-part-bar-container">
            <div class="df-toeic-part-bar">
              <div class="df-toeic-part-fill" id="part-r6-fill" style="width: 0%;">
                <span class="df-toeic-part-score-bubble" id="part-r6-score">0</span>
              </div>
            </div>
            <span class="df-toeic-part-total" id="part-r6-total">16</span>
          </div>
        </div>
        
        <!-- Part 7 -->
        <div class="df-toeic-part-row">
          <span class="df-toeic-part-label">Part 7</span>
          <div class="df-toeic-part-bar-container">
            <div class="df-toeic-part-bar">
              <div class="df-toeic-part-fill" id="part-r7-fill" style="width: 0%;">
                <span class="df-toeic-part-score-bubble" id="part-r7-score">0</span>
              </div>
            </div>
            <span class="df-toeic-part-total" id="part-r7-total">54</span>
          </div>
        </div>
        
        <!-- Reading Section Score -->
        <div class="df-toeic-section-score-card" style="margin-top: auto;">
          <div class="df-toeic-section-score-header">READING</div>
          <div class="df-toeic-section-score-label">Điểm của bạn</div>
          <div class="df-toeic-section-score-value" id="reading-score">{{ toeic_stats.reading.score }}</div>
          <div class="df-toeic-section-score-slider">
            <span class="df-toeic-section-slider-min">5</span>
            <div class="df-toeic-section-slider-track">
              <div class="df-toeic-section-slider-fill" id="reading-slider-fill" style="width: 0%;"></div>
            </div>
            <span class="df-toeic-section-slider-max">495</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Total Score -->
    <div class="df-toeic-total-score">
      <div class="df-toeic-total-header">TỔNG ĐIỂM</div>
      <div class="df-toeic-total-value" id="total-score">{{ toeic_stats.total_score }}</div>
    </div>
  </div>
  {% endif %}

  <!-- Detailed Analysis -->
  <div class="df-result-analysis">
    <div class="df-result-analysis-header">Phân tích chi tiết</div>

    <!-- Tabs -->
    <div class="df-result-tabs">
      {% if template_obj.level == "TOEIC" %}
      <button type="button" class="df-result-tab df-result-tab--active" data-part="L1">Part 1</button>
      <button type="button" class="df-result-tab" data-part="L2">Part 2</button>
      <button type="button" class="df-result-tab" data-part="L3">Part 3</button>
      <button type="button" class="df-result-tab" data-part="L4">Part 4</button>
      <button type="button" class="df-result-tab" data-part="R5">Part 5</button>
      <button type="button" class="df-result-tab" data-part="R6">Part 6</button>
      <button type="button" class="df-result-tab" data-part="R7">Part 7</button>
      <button type="button" class="df-result-tab" data-part="overall">Tổng quát</button>
      {% else %}
      <button type="button" class="df-result-tab df-result-tab--active" data-part="overall">Tổng quát</button>
      {% endif %}
    </div>

    <!-- Table Content -->
    <div id="analysis-table-content" style="padding: 1rem;">
      <div style="text-align: center; padding: 2rem; color: #64748b;">Đang tải dữ liệu...</div>
    </div>
  </div>

  <!-- Answer Section -->
  <div class="df-result-answers">
    <div class="df-result-answers-header">
      <span class="df-result-answers-title">Đáp án</span>
      <button type="button" id="btn-view-detail" class="df-result-btn df-result-btn--secondary">
        Xem chi tiết đáp án
      </button>
      <button type="button" id="btn-redo-wrong" class="df-result-btn df-result-btn--secondary">
        Làm lại các câu sai
      </button>
      <span class="df-result-warning">Chú ý: Khi làm lại các câu sai, điểm trung bình của bạn sẽ KHÔNG BỊ ẢNH
        HƯỞNG.</span>
    </div>

    <div class="df-result-tips">
      <svg class="df-result-tips-icon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
      </svg>
      <p class="df-result-tips-text">
        <strong>Mẹo:</strong> Khi xem chi tiết đáp án, bạn có thể tạo và lưu highlight từ vựng, keywords và tạo note để
        học và tra cứu khi có nhu cầu ôn lại đề thi này trong tương lai.
      </p>
    </div>

    <!-- Question List (shown by default) -->
    <div id="question-list" class="df-result-qlist">
      <!-- Will be rendered by JavaScript -->
    </div>
  </div>
</div>

<!-- Question Detail Modal -->
<div id="question-modal" class="df-result-modal">
  <div class="df-result-modal-content">
    <div class="df-result-modal-header">
      <div>
        <div class="df-result-modal-title">Đáp án chi tiết #<span id="modal-qnum"></span></div>
      </div>
      <button type="button" id="modal-close-btn" class="df-result-modal-close">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="df-result-modal-body" id="modal-body">
      <!-- Will be rendered by JavaScript -->
    </div>
  </div>
</div>

<script>
  (function () {
    const answersData = {{ answers_json| safe }};
    const toeicStats = {{ toeic_stats_json| safe }};
    const templateLevel = "{{ template_obj.level }}";
    const sessionId = {{ session.id }};

    let currentTab = templateLevel === "TOEIC" ? "L1" : "overall";
  let showAnswers = false;

  // Animate the circular score ring on page load
  function animateScoreRing() {
    const ring = document.getElementById('score-ring-fill');
    if (!ring) return;
    
    let scorePercent = {{ session.score_percent }};
    {% if template_obj.level == "TOEIC" and toeic_stats %}
    scorePercent = ({{ toeic_stats.total_score }} / 990) * 100;
    {% endif %}
    
    const circumference = 2 * Math.PI * 60; // r=60
    const offset = circumference - (scorePercent / 100) * circumference;
    
    // Trigger animation after a small delay
    setTimeout(() => {
      ring.style.strokeDashoffset = offset;
    }, 100);
  }
  
  // Run animation on page load
  animateScoreRing();

  // Sub-type labels
  const subTypeLabels = {
    "people": "Tranh tả người",
    "objects": "Tranh tả vật",
    "conversation": "Hội thoại",
    "short_talk": "Bài nói ngắn",
    "text_completion": "Điền từ vào đoạn văn",
    "reading_comprehension": "Đọc hiểu",
    "general": "Chung"
  };

  // Convert number (1,2,3,4) to letter (A,B,C,D)
  function numberToLetter(num) {
    const mapping = { '1': 'A', '2': 'B', '3': 'C', '4': 'D' };
    return mapping[String(num)] || num;
  }

  // Tab switching
  document.querySelectorAll('.df-result-tab').forEach(btn => {
    btn.addEventListener('click', function () {
      currentTab = this.dataset.part;

      document.querySelectorAll('.df-result-tab').forEach(b => {
        b.classList.remove('df-result-tab--active');
      });
      this.classList.add('df-result-tab--active');

      renderAnalysisTable();
    });
  });

  // Render analysis table
  function renderAnalysisTable() {
    const container = document.getElementById('analysis-table-content');
    if (!container) return;

    if (templateLevel === "TOEIC" && toeicStats && toeicStats.stats_by_part) {
      const part = currentTab === "overall" ? null : currentTab;

      const partGroups = {};

      Object.keys(toeicStats.stats_by_part).forEach(key => {
        const stats = toeicStats.stats_by_part[key];
        if (part && stats.part !== part) return;

        const groupKey = stats.part || "other";
        if (!partGroups[groupKey]) {
          partGroups[groupKey] = [];
        }
        partGroups[groupKey].push(stats);
      });

      let html = `
        <table class="df-result-table">
          <thead>
            <tr>
              <th style="width: 25%;">Phân loại câu hỏi</th>
              <th class="text-center" style="width: 12%;">Số câu đúng</th>
              <th class="text-center" style="width: 12%;">Số câu sai</th>
              <th class="text-center" style="width: 12%;">Số câu bỏ qua</th>
              <th class="text-center" style="width: 12%;">Độ chính xác</th>
              <th style="width: 27%;">Danh sách câu hỏi</th>
            </tr>
          </thead>
          <tbody>
      `;

      Object.keys(partGroups).sort().forEach(partKey => {
        partGroups[partKey].forEach(stats => {
          const partNum = stats.part ? stats.part.replace('L', '').replace('R', '') : '';
          const subTypeLabel = subTypeLabels[stats.sub_type] || stats.sub_type;
          const classification = stats.part ? `[Part ${partNum}] ${subTypeLabel}` : subTypeLabel;
          const accuracy = stats.total > 0 ? ((stats.correct / stats.total) * 100).toFixed(2) : '0.00';

          html += `
            <tr>
              <td>${classification}</td>
              <td class="text-center">${stats.correct || 0}</td>
              <td class="text-center">${stats.wrong || 0}</td>
              <td class="text-center">${stats.skipped || 0}</td>
              <td class="text-center">${accuracy}%</td>
              <td>
                <div class="df-result-qnum-grid">
                  ${(stats.questions || []).map(q => {
            let statusClass = 'df-result-qnum--skipped';
            if (q.is_correct) statusClass = 'df-result-qnum--correct';
            else if (q.selected) statusClass = 'df-result-qnum--wrong';
            return `<button type="button" class="df-result-qnum ${statusClass}" data-qid="${q.id}">${q.order}</button>`;
          }).join('')}
                </div>
              </td>
            </tr>
          `;
        });
      });

      // Total row
      if (part && Object.keys(partGroups).length > 0) {
        const partTotal = Object.values(partGroups).flat().reduce((acc, stats) => {
          acc.correct += stats.correct || 0;
          acc.wrong += stats.wrong || 0;
          acc.skipped += stats.skipped || 0;
          acc.total += stats.total || 0;
          return acc;
        }, { correct: 0, wrong: 0, skipped: 0, total: 0 });

        const totalAccuracy = partTotal.total > 0 ? ((partTotal.correct / partTotal.total) * 100).toFixed(2) : '0.00';
        html += `
          <tr class="total-row">
            <td>Tổng</td>
            <td class="text-center">${partTotal.correct}</td>
            <td class="text-center">${partTotal.wrong}</td>
            <td class="text-center">${partTotal.skipped}</td>
            <td class="text-center">${totalAccuracy}%</td>
            <td></td>
          </tr>
        `;
      }

      html += '</tbody></table>';
      container.innerHTML = html;

      // Attach click handlers
      container.querySelectorAll('.df-result-qnum').forEach(btn => {
        btn.addEventListener('click', () => showQuestionDetail(parseInt(btn.dataset.qid)));
      });
    } else {
      container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #64748b;">Chưa có dữ liệu phân tích.</p>';
    }
  }

  // View answers buttons
  document.getElementById('btn-view-answers')?.addEventListener('click', toggleAnswers);
  document.getElementById('btn-view-detail')?.addEventListener('click', toggleAnswers);

  function toggleAnswers() {
    showAnswers = !showAnswers;
    const section = document.getElementById('question-list');
    if (section) {
      section.style.display = showAnswers ? 'block' : 'none';
      if (showAnswers) renderQuestionList();
    }
    const btn = document.getElementById('btn-view-answers');
    if (btn) btn.textContent = showAnswers ? 'Ẩn đáp án' : 'Xem đáp án';
  }

  // Render question list
  function renderQuestionList() {
    const container = document.getElementById('question-list');
    if (!container) return;

    const byPart = {};
    answersData.forEach(ans => {
      const part = ans.question?.toeic_part || 'Other';
      if (!byPart[part]) byPart[part] = [];
      byPart[part].push(ans);
    });

    let html = '';
    Object.keys(byPart).sort().forEach(part => {
      const partNum = part.replace('L', '').replace('R', '');
      html += `<div class="df-result-qlist-part">`;
      html += `<div class="df-result-qlist-part-title">Part ${partNum}</div>`;
      html += `<div class="df-result-qlist-grid">`;

      byPart[part].forEach(ans => {
        const q = ans.question;
        const selected = ans.raw_answer?.selected_key || '';
        const correct = q?.correct_answer || '';
        const isCorrect = ans.is_correct;
        const isSkipped = !selected;

        let statusIcon = '';
        let statusClass = '';
        if (isSkipped) {
          statusIcon = '—';
          statusClass = 'df-result-qlist-status--skipped';
        } else if (isCorrect) {
          statusIcon = '✓';
          statusClass = 'df-result-qlist-status--correct';
        } else {
          statusIcon = '✗';
          statusClass = 'df-result-qlist-status--wrong';
        }

        const displayAnswer = isSkipped ? 'chưa trả lời' : numberToLetter(selected);

        html += `
          <div class="df-result-qlist-item">
            <span class="df-result-qlist-num">${q?.order || ''}</span>
            <span class="df-result-qlist-answer">
              ${numberToLetter(correct)}: ${displayAnswer}
              <span class="df-result-qlist-status ${statusClass}">${statusIcon}</span>
              <span class="df-result-qlist-detail" data-qid="${q?.id}">[Chi tiết]</span>
            </span>
          </div>
        `;
      });

      html += '</div></div>';
    });

    container.innerHTML = html;

    // Attach click handlers
    container.querySelectorAll('.df-result-qlist-detail').forEach(btn => {
      btn.addEventListener('click', () => showQuestionDetail(parseInt(btn.dataset.qid)));
    });
  }

  // Modal
  const modal = document.getElementById('question-modal');
  const modalBody = document.getElementById('modal-body');
  const modalQnum = document.getElementById('modal-qnum');
  const modalCloseBtn = document.getElementById('modal-close-btn');

  function openModal() {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    // Stop any playing audio in the modal
    const audio = modalBody?.querySelector('audio');
    if (audio) {
      audio.pause();
      audio.currentTime = 0;
    }
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }

  modalCloseBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('active')) closeModal();
  });

  // Show question detail
  async function showQuestionDetail(questionId) {
    if (!modal || !modalBody) return;

    modalBody.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">Đang tải...</div>';
    openModal();

    try {
      const response = await fetch(`/exam/session/${sessionId}/result/question/${questionId}/`);
      if (!response.ok) throw new Error('Failed to fetch');
      const data = await response.json();

      const q = data.question;
      const answer = data.answer;

      if (modalQnum) modalQnum.textContent = q.order || q.id;

      let html = '';

      // Audio
      if (q.audio || data.conversation?.audio) {
        const audioUrl = q.audio || data.conversation?.audio;
        html += `<div class="df-result-modal-audio"><audio controls><source src="${audioUrl}" type="audio/mpeg"></audio></div>`;
      }

      // Actions (Transcript & Translation Buttons)
      const hasTranscript = q.audio_transcript || data.conversation?.transcript || data.conversation?.transcript_data;
      const hasTranslation = q.text_vi || q.audio_transcript_vi || data.conversation?.transcript_vi;

      if (hasTranscript || hasTranslation) {
        html += '<div class="df-result-modal-actions">';
        
        if (hasTranscript) {
          html += `
            <button type="button" class="df-result-modal-action-btn" id="btn-toggle-transcript">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Hiện Transcript
            </button>
          `;
        }
        
        if (hasTranslation) {
          html += `
            <button type="button" class="df-result-modal-action-btn" id="btn-toggle-translation">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
              </svg>
              Hiện Dịch nghĩa
            </button>
          `;
        }
        
        html += '</div>';
      }

      // Helper to check if a line is an instruction or clean it
      function cleanTranscriptLine(text) {
        if (!text) return null;
        let cleaned = text.trim();
        
        // Patterns to SKIP the line entirely
        const skipPatterns = [
          /^Look at the picture/i,
          /^Questions? \d+.*refer/i,
          /^Refer to the/i,
          /^Go on to the next page/i,
          /^Directions:/i
        ];
        if (skipPatterns.some(regex => regex.test(cleaned))) return null;

        // Pattern to REMOVE prefix (e.g., "Number 29.", "Number one.") but keep rest of line
        // Matches "Number" followed by digits or words, ending with optional dot and space
        const prefixRegex = /^Number\s+(?:\d+|[a-zA-Z]+(?:[\s-][a-zA-Z]+)*)[.]?\s*/i;
        cleaned = cleaned.replace(prefixRegex, '');

        return cleaned;
      }

      // Transcript Section
      if (hasTranscript) {
        html += `<div id="section-transcript" class="df-result-modal-content-section">`;
        html += `<div class="df-result-modal-content-title">TRANSCRIPT</div>`;
        
        let headerHtml = "";

        if (data.conversation?.transcript_data?.lines) {
           // Structured conversation transcript
           data.conversation.transcript_data.lines.forEach(line => {
             const cleanedText = cleanTranscriptLine(line.text);
             if (!cleanedText) return; // Skip instruction lines

             headerHtml += `
              <div class="df-transcript-line">
                ${line.speaker ? `<span class="df-transcript-speaker">${line.speaker}:</span>` : ''}
                <span class="df-transcript-text">${cleanedText}</span>
                <span class="df-translation-text" style="display:none;">${line.text_vi || ''}</span>
              </div>
             `;
           });
        } else {
           // Fallback textual transcript
           let content = q.audio_transcript || data.conversation?.transcript || "";
           
           // Filter and clean lines
           const lines = content.split('\n');
           const filteredLines = lines
              .map(line => cleanTranscriptLine(line))
              .filter(line => line !== null && line.length > 0);
           content = filteredLines.join('\n');

           headerHtml += `<div>${escapeHtml(content).replace(/\n/g, '<br>')}</div>`;
           
           const transVi = q.audio_transcript_vi || data.conversation?.transcript_vi;
           if (transVi) {
             headerHtml += `<div class="df-translation-text" style="display:none; margin-top: 0.5rem; border-top: 1px dashed #cbd5e1; padding-top: 0.5rem;">${escapeHtml(transVi).replace(/\n/g, '<br>')}</div>`;
           }
        }
        
        html += headerHtml;

        // For questions 1-31, append options to transcript
        const qOrder = parseInt(q.order);
        if (qOrder >= 1 && qOrder <= 31 && q.mcq_choices?.length > 0) {
           let optionsHtml = '<div style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px dashed #e2e8f0;">';
           q.mcq_choices.forEach(opt => {
               optionsHtml += `<div style="margin-bottom: 0.25rem;"><strong>${numberToLetter(opt.key)}.</strong> ${escapeHtml(opt.text)}</div>`;
           });
           optionsHtml += '</div>';
           html += optionsHtml;
        }

        html += `</div>`;
      }
      
      // Image
      if (q.image || data.passage?.image || data.conversation?.image) {
        const imageUrl = q.image || data.passage?.image || data.conversation?.image;
        html += `<div class="df-result-modal-image"><img src="${imageUrl}" alt="Question image"></div>`;
      }

      // Question text and Options
      html += `<div class="df-result-modal-question">`;
      if (q.text) {
         html += `<div>${q.order || ''} ${escapeHtml(q.text)}</div>`;
         if (q.text_vi) {
             html += `<div class="df-translation-text" style="display:none;">${escapeHtml(q.text_vi)}</div>`;
         }
      }
      html += `</div>`;

      // Options
      if (q.mcq_choices?.length > 0) {
        html += '<div class="df-result-modal-options">';
        q.mcq_choices.forEach((opt, idx) => {
          const isCorrect = opt.key === q.correct_answer;
          const isSelected = opt.key === answer.selected_key;
          let optClass = '';
          if (isCorrect) optClass = 'df-result-modal-option--correct';
          else if (isSelected) optClass = 'df-result-modal-option--wrong';
          
          // Get option translation if available from transcript_data
          let optVi = "";
          if (q.transcript_data?.options && q.transcript_data.options[idx]) {
             optVi = q.transcript_data.options[idx].text_vi || "";
          }

          html += `
            <div class="df-result-modal-option ${optClass} ${isSelected ? 'df-result-modal-option--selected' : ''}">
              <span class="df-result-modal-option-radio"></span>
              <div style="flex-grow: 1;">
                 <div>${numberToLetter(opt.key)}. ${escapeHtml(opt.text)}</div>
                 ${optVi ? `<div class="df-option-translation" style="display:none;">${optVi}</div>` : ''}
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      // Correct answer
      html += `<div class="df-result-modal-answer">Đáp án đúng: ${numberToLetter(q.correct_answer) || 'N/A'}</div>`;

      // Explanation
      html += `
        <button type="button" class="df-result-modal-explanation-btn" id="explanation-toggle">
          <span>Giải thích chi tiết đáp án</span>
          <span id="explanation-arrow">▼</span>
        </button>
        <div class="df-result-modal-explanation-content" id="explanation-content">
          ${q.explanation_vi ? escapeHtml(q.explanation_vi) : 'Chưa có lời giải cho câu hỏi này.'}
        </div>
      `;

      modalBody.innerHTML = html;

      // Event Handlers for Toggles
      
      // Toggle Transcript
      const btnTranscript = document.getElementById('btn-toggle-transcript');
      const sectionTranscript = document.getElementById('section-transcript');
      if (btnTranscript && sectionTranscript) {
          btnTranscript.addEventListener('click', () => {
              sectionTranscript.classList.toggle('show');
              btnTranscript.classList.toggle('active');
          });
      }
      
      // Toggle Translation
      const btnTranslation = document.getElementById('btn-toggle-translation');
      // All translation items
      const transItems = modalBody.querySelectorAll('.df-translation-text, .df-option-translation');
      
      if (btnTranslation) {
          btnTranslation.addEventListener('click', () => {
             const isShowing = btnTranslation.classList.contains('active');
             btnTranslation.classList.toggle('active');
             
             transItems.forEach(item => {
                 item.style.display = isShowing ? 'none' : 'block';
             });
          });
      }

      // Toggle explanation
      document.getElementById('explanation-toggle')?.addEventListener('click', () => {
        const content = document.getElementById('explanation-content');
        const arrow = document.getElementById('explanation-arrow');
        if (content && arrow) {
          content.classList.toggle('show');
          arrow.textContent = content.classList.contains('show') ? '▲' : '▼';
        }
      });

    } catch (error) {
      console.error('Error:', error);
      modalBody.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Lỗi khi tải dữ liệu.</div>';
    }
  }

  // Make showQuestionDetail global
  window.showQuestionDetail = showQuestionDetail;

  // Helper
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Initial render
  renderAnalysisTable();
  renderQuestionList();

  // ============================================
  // TOEIC Visual Score Animation
  // ============================================
  function animateToeicScores() {
    // Part scores from analysisData
    const partDefaults = {
      'L1': { total: 6, correct: 0 },
      'L2': { total: 25, correct: 0 },
      'L3': { total: 39, correct: 0 },
      'L4': { total: 30, correct: 0 },
      'R5': { total: 30, correct: 0 },
      'R6': { total: 16, correct: 0 },
      'R7': { total: 54, correct: 0 }
    };

    // Update part defaults with actual data
    Object.keys(analysisData).forEach(partKey => {
      if (partDefaults[partKey]) {
        const part = analysisData[partKey];
        partDefaults[partKey].correct = part.correct || 0;
        partDefaults[partKey].total = part.total || partDefaults[partKey].total;
      }
    });

    // Animate each part bar
    const partMapping = {
      'L1': 'l1', 'L2': 'l2', 'L3': 'l3', 'L4': 'l4',
      'R5': 'r5', 'R6': 'r6', 'R7': 'r7'
    };

    Object.keys(partMapping).forEach(partKey => {
      const id = partMapping[partKey];
      const data = partDefaults[partKey];
      const pct = data.total > 0 ? (data.correct / data.total) * 100 : 0;

      const fillEl = document.getElementById(`part-${id}-fill`);
      const scoreEl = document.getElementById(`part-${id}-score`);
      const totalEl = document.getElementById(`part-${id}-total`);

      if (fillEl) {
        setTimeout(() => {
          fillEl.style.transition = 'width 0.8s ease-out';
          fillEl.style.width = `${pct}%`;
        }, 100);
      }
      if (scoreEl) scoreEl.textContent = data.correct;
      if (totalEl) totalEl.textContent = data.total;
    });

    // Section scores
    const listeningScore = parseInt(document.getElementById('listening-score')?.textContent) || 5;
    const readingScore = parseInt(document.getElementById('reading-score')?.textContent) || 5;

    const listenFill = document.getElementById('listening-slider-fill');
    const readFill = document.getElementById('reading-slider-fill');

    if (listenFill) {
      const pct = ((listeningScore - 5) / 490) * 100;
      setTimeout(() => {
        listenFill.style.transition = 'width 0.8s ease-out';
        listenFill.style.width = `${pct}%`;
      }, 300);
    }

    if (readFill) {
      const pct = ((readingScore - 5) / 490) * 100;
      setTimeout(() => {
        readFill.style.transition = 'width 0.8s ease-out';
        readFill.style.width = `${pct}%`;
      }, 300);
    }
  }

  // Run animation on load
  if (document.querySelector('.df-toeic-score-display')) {
    setTimeout(animateToeicScores, 200);
  }

  // Redo wrong questions button handler
  document.getElementById('btn-redo-wrong')?.addEventListener('click', function () {
    // Get wrong question IDs
    const wrongQuestionIds = answersData
      .filter(ans => !ans.is_correct && ans.raw_answer?.selected_key)
      .map(ans => ans.question?.id)
      .filter(id => id);

    if (wrongQuestionIds.length === 0) {
      alert('Không có câu sai để làm lại!');
      return;
    }

    if (confirm(`Bạn muốn làm lại ${wrongQuestionIds.length} câu sai? (Không tính thời gian)`)) {
      // Submit form to create new attempt with wrong questions
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/exam/session/${sessionId}/redo-wrong/`;

      // Add CSRF token
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
      form.appendChild(csrfInput);

      // Add question IDs
      wrongQuestionIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'question_ids';
        input.value = id;
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
    }
  });
}) ();
</script>
{% endblock %}
