{% extends "base.html" %}
{% load static %}

{% block title %}Placement Test - DailyFluent{% endblock %}

{% block extra_css %}
<style>
    .option-btn {
        transition: all 0.2s ease;
    }
    .option-btn:hover {
        transform: translateX(4px);
    }
    .option-btn.selected {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border-color: transparent;
    }
    .option-btn.correct {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-color: transparent;
    }
    .option-btn.incorrect {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-color: transparent;
    }
    .progress-fill {
        transition: width 0.5s ease;
    }
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
        50% { box-shadow: 0 0 0 8px rgba(99, 102, 241, 0); }
    }
    .audio-btn:hover {
        animation: pulse-glow 1.5s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-6" 
     x-data="placementTest({{ test.id }}, {{ test.questions_answered }}, {{ min_questions }}, {{ max_questions }})"
     x-init="startTest()">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <span class="text-sm text-gray-500 dark:text-gray-400">
                Câu <span class="font-bold text-gray-900 dark:text-white" x-text="questionsAnswered + 1"></span>/<span x-text="maxQuestions"></span>+
            </span>
            <span class="px-3 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 text-sm rounded-full font-medium" x-text="currentSkillLabel"></span>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-sm text-gray-500" x-show="estimatedScore > 0">
                ~<span class="font-bold text-indigo-600" x-text="estimatedScore"></span> điểm
            </span>
            <button @click="finishEarly()" 
                    x-show="canFinish"
                    class="text-sm text-gray-500 hover:text-gray-700 underline">
                Kết thúc sớm
            </button>
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden mb-8">
        <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-600 progress-fill rounded-full"
             :style="`width: ${(questionsAnswered / minQuestions) * 100}%`"></div>
    </div>
    
    <!-- Loading State -->
    <div x-show="loading" class="text-center py-20">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
        <p class="mt-4 text-gray-500">Đang tải câu hỏi...</p>
    </div>
    
    <!-- Question Card -->
    <div x-show="!loading && currentQuestion" x-cloak class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8">
        <!-- Context (if any) -->
        <div x-show="currentQuestion.context_text" class="mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
            <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap" x-text="currentQuestion.context_text"></p>
        </div>
        
        <!-- Audio (for listening) -->
        <div x-show="currentQuestion.question_audio || currentQuestion.context_audio" class="mb-6">
            <button @click="playAudio()" 
                    class="audio-btn flex items-center gap-3 px-6 py-3 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded-xl hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M9 12h.01M12 12h.01M15 12h.01"/>
                </svg>
                <span>Phát audio</span>
            </button>
            <audio x-ref="audioPlayer" :src="currentQuestion.context_audio || currentQuestion.question_audio"></audio>
        </div>
        
        <!-- Image (for Part 1) -->
        <div x-show="currentQuestion.question_image" class="mb-6">
            <img :src="currentQuestion.question_image" alt="Question image" 
                 class="max-w-full rounded-xl shadow-md mx-auto">
        </div>
        
        <!-- Question Text -->
        <h2 class="text-xl md:text-2xl font-semibold text-gray-900 dark:text-white mb-6" 
            x-text="currentQuestion.question_text"></h2>
        
        <!-- Options -->
        <div class="space-y-3">
            <template x-for="(text, key) in currentQuestion.options" :key="key">
                <button @click="selectAnswer(key)"
                        :disabled="showFeedback"
                        :class="{
                            'selected': selectedAnswer === key && !showFeedback,
                            'correct': showFeedback && key === correctAnswer,
                            'incorrect': showFeedback && selectedAnswer === key && key !== correctAnswer
                        }"
                        class="option-btn w-full text-left p-4 border-2 border-gray-200 dark:border-gray-600 rounded-xl hover:border-indigo-400 dark:hover:border-indigo-500 flex items-center gap-4">
                    <span class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center font-bold text-gray-600 dark:text-gray-300" 
                          :class="{'bg-white/20 text-white': selectedAnswer === key || (showFeedback && key === correctAnswer)}"
                          x-text="key"></span>
                    <span class="flex-1" x-text="text"></span>
                </button>
            </template>
        </div>
        
        <!-- Submit Button -->
        <div class="mt-8 flex justify-end">
            <button @click="submitAnswer()"
                    :disabled="!selectedAnswer || submitting"
                    x-show="!showFeedback"
                    class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                <span x-show="!submitting">Xác nhận</span>
                <span x-show="submitting" class="flex items-center gap-2">
                    <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Đang xử lý...
                </span>
            </button>
            
            <button @click="nextQuestion()"
                    x-show="showFeedback"
                    class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                Câu tiếp theo
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Completed State -->
    <div x-show="completed" x-cloak class="text-center py-12">
        <div class="inline-block p-6 bg-green-100 dark:bg-green-900/30 rounded-full mb-6">
            <svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Hoàn thành!</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">Đang chuyển đến kết quả...</p>
    </div>
</div>

<script>
function placementTest(testId, answered, minQ, maxQ) {
    return {
        testId: testId,
        questionsAnswered: answered,
        minQuestions: minQ,
        maxQuestions: maxQ,
        
        loading: true,
        currentQuestion: null,
        currentSkillLabel: '',
        selectedAnswer: null,
        showFeedback: false,
        correctAnswer: null,
        submitting: false,
        completed: false,
        
        estimatedScore: 0,
        canFinish: false,
        
        startTime: null,
        
        async startTest() {
            this.loading = true;
            try {
                const response = await fetch('{% url "placement:api_start_test" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                const data = await response.json();
                
                if (data.question) {
                    this.testId = data.test_id;
                    this.currentQuestion = data.question;
                    this.currentSkillLabel = data.question.skill_label;
                    this.questionsAnswered = data.progress.answered;
                    this.startTime = Date.now();
                } else if (data.error) {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Error starting test:', error);
            }
            this.loading = false;
        },
        
        selectAnswer(key) {
            if (!this.showFeedback) {
                this.selectedAnswer = key;
            }
        },
        
        playAudio() {
            this.$refs.audioPlayer.play();
        },
        
        async submitAnswer() {
            if (!this.selectedAnswer || this.submitting) return;
            
            this.submitting = true;
            const timeSpent = Math.round((Date.now() - this.startTime) / 1000);
            
            try {
                const response = await fetch(`/placement/api/test/${this.testId}/answer/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        question_id: this.currentQuestion.id,
                        answer: this.selectedAnswer,
                        time_spent: timeSpent
                    })
                });
                
                const data = await response.json();
                
                if (data.completed) {
                    this.completed = true;
                    setTimeout(() => {
                        window.location.href = `/placement/test/${this.testId}/result/`;
                    }, 1500);
                } else {
                    this.showFeedback = true;
                    this.correctAnswer = data.correct_answer;
                    this.estimatedScore = data.progress.estimated_score;
                    this.canFinish = data.progress.can_finish;
                    this.questionsAnswered = data.progress.answered;
                    
                    // Store next question
                    this._nextQuestion = data.question;
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
            }
            
            this.submitting = false;
        },
        
        nextQuestion() {
            this.currentQuestion = this._nextQuestion;
            this.currentSkillLabel = this._nextQuestion.skill_label;
            this.selectedAnswer = null;
            this.showFeedback = false;
            this.correctAnswer = null;
            this.startTime = Date.now();
        },
        
        async finishEarly() {
            if (!confirm('Bạn có chắc muốn kết thúc bài test sớm?')) return;
            
            try {
                const response = await fetch(`/placement/api/test/${this.testId}/finish_early/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                if (data.result) {
                    window.location.href = `/placement/test/${this.testId}/result/`;
                }
            } catch (error) {
                console.error('Error finishing test:', error);
            }
        }
    };
}
</script>
{% endblock %}
