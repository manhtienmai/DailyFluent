{% extends "base.html" %}

{% block title %}Luy·ªán flashcard | DailyFluent{% endblock %}

{% block main_classes %}max-w-3xl mx-auto px-4 py-6{% endblock %}

{% block content %}
<div class="mb-6">
  <div class="flex items-center justify-between mb-2">
    <h1 class="text-2xl font-bold text-slate-900">Luy·ªán flashcard</h1>
    <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full">
      <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
      </svg>
      <span class="text-sm font-semibold text-slate-700">
        <span id="cards-remaining">{{ states|length }}</span> th·∫ª
      </span>
    </div>
  </div>
</div>

{% if states %}
  <form id="csrf-form" class="hidden">
    {% csrf_token %}
  </form>

  <div id="flashcard-container"
       data-cards='[{% for s in states %}
         {
           "state_id": {{ s.id }},
           "vocab_id": {{ s.vocab.id }},
           "jp_kana": "{{ s.vocab.jp_kana|escapejs }}",
           "jp_kanji": "{{ s.vocab.jp_kanji|default_if_none:''|escapejs }}",
           "sino_vi": "{{ s.vocab.sino_vi|default_if_none:''|escapejs }}",
           "vi_meaning": "{{ s.vocab.vi_meaning|escapejs }}",
           "example_jp": "{{ s.vocab.example_jp|default_if_none:''|escapejs }}",
           "example_vi": "{{ s.vocab.example_vi|default_if_none:''|escapejs }}"
         }{% if not forloop.last %},{% endif %}
       {% endfor %}]'>

    <!-- Progress Bar -->
    <div class="mb-5 bg-slate-100 rounded-full h-2 overflow-hidden">
      <div id="progress-bar" class="h-full bg-gradient-to-r from-emerald-500 to-emerald-600 transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>

    <!-- Flashcard -->
    <div class="perspective-1000" id="card-wrapper">
      <div class="relative bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden transition-all duration-300 hover:shadow-2xl" id="card">
        
        <!-- Front Side -->
        <div class="p-8 min-h-[320px] flex flex-col justify-center" id="card-front">
          <div class="text-center">
            <!-- Main Word (Kanji) - Made larger -->
            <div class="relative inline-block">
              <p class="text-8xl font-bold text-slate-900" id="card-main-word"></p>
              <div class="absolute -bottom-2 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-emerald-500 to-transparent opacity-20"></div>
            </div>
          </div>

          <!-- Flip Button -->
          <div class="mt-12 flex justify-center">
            <button id="toggle-button" type="button"
                    class="group relative inline-flex items-center gap-2 px-6 py-2.5 rounded-full bg-gradient-to-r from-slate-900 to-slate-800 text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 active:scale-95">
              <svg class="w-5 h-5 transition-transform group-hover:rotate-180 duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              <span>L·∫≠t th·∫ª</span>
            </button>
          </div>
        </div>

        <!-- Back Side (Hidden Initially) -->
        <div id="card-back" class="hidden p-8 min-h-[320px]">
          <div class="space-y-4">
            <!-- Main Word & Reading (Compact) -->
            <div class="text-center pb-3 border-b-2 border-slate-100">
              <p class="text-3xl font-bold text-slate-900 mb-0.5" id="card-main-word-back"></p>
              <p class="text-sm text-slate-600" id="card-reading-back"></p>
            </div>

            <!-- Sino Vietnamese -->
            <div id="card-sino-block" class="hidden">
              <div class="inline-flex items-center gap-2 px-2.5 py-0.5 bg-orange-50 rounded-full mb-1">
                <span class="text-xs font-bold text-orange-600 uppercase tracking-wide">√Çm H√°n Vi·ªát</span>
              </div>
              <p class="text-sm font-medium text-slate-700" id="card-sino-vi"></p>
            </div>

            <!-- Vietnamese Meaning -->
            <div>
              <div class="inline-flex items-center gap-2 px-2.5 py-0.5 bg-emerald-50 rounded-full mb-1">
                <span class="text-xs font-bold text-emerald-600 uppercase tracking-wide">Nghƒ©a</span>
              </div>
              <p class="text-xl font-semibold text-slate-900" id="card-vi-meaning"></p>
            </div>

            <!-- Example Sentences - Made larger -->
            <div id="card-example" class="hidden bg-slate-50 rounded-xl p-4 space-y-3">
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-slate-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
                </svg>
                <div class="flex-1 space-y-1.5">
                  <p class="text-base font-medium text-slate-800 leading-relaxed" id="card-example-jp"></p>
                  <p class="text-base text-slate-600 leading-relaxed" id="card-example-vi"></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Grade Buttons - Made smaller -->
          <div id="grade-buttons" class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-2">
            <button data-rating="again" type="button"
                    class="group flex flex-col items-center gap-1 px-2 py-2 rounded-lg bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200 hover:border-red-300 transition-all hover:shadow-md active:scale-95">
              <span class="text-lg">üòµ</span>
              <span class="text-xs font-bold text-red-700">Qu√™n</span>
            </button>
            <button data-rating="hard" type="button"
                    class="group flex flex-col items-center gap-1 px-2 py-2 rounded-lg bg-gradient-to-br from-amber-50 to-amber-100 border-2 border-amber-200 hover:border-amber-300 transition-all hover:shadow-md active:scale-95">
              <span class="text-lg">üò£</span>
              <span class="text-xs font-bold text-amber-700">Kh√≥</span>
            </button>
            <button data-rating="good" type="button"
                    class="group flex flex-col items-center gap-1 px-2 py-2 rounded-lg bg-gradient-to-br from-emerald-50 to-emerald-100 border-2 border-emerald-200 hover:border-emerald-300 transition-all hover:shadow-md active:scale-95">
              <span class="text-lg">üôÇ</span>
              <span class="text-xs font-bold text-emerald-700">T·ªët</span>
            </button>
            <button data-rating="easy" type="button"
                    class="group flex flex-col items-center gap-1 px-2 py-2 rounded-lg bg-gradient-to-br from-sky-50 to-sky-100 border-2 border-sky-200 hover:border-sky-300 transition-all hover:shadow-md active:scale-95">
              <span class="text-lg">üòå</span>
              <span class="text-xs font-bold text-sky-700">D·ªÖ</span>
            </button>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- Completion Message -->
  <div id="no-more-cards" class="hidden text-center py-12">
    <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-emerald-100 to-emerald-200 rounded-full mb-4">
      <span class="text-4xl">üéâ</span>
    </div>
    <h2 class="text-2xl font-bold text-slate-900 mb-2">Xu·∫•t s·∫Øc!</h2>
    <p class="text-slate-600 max-w-md mx-auto">
      B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ flashcard h√¥m nay. H√£y quay l·∫°i khi ƒë·∫øn gi·ªù √¥n t·∫≠p ti·∫øp theo.
    </p>
  </div>

{% else %}
  <div class="text-center py-16">
    <div class="inline-flex items-center justify-center w-20 h-20 bg-slate-100 rounded-full mb-4">
      <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
      </svg>
    </div>
    <h2 class="text-xl font-semibold text-slate-900 mb-2">Ch∆∞a c√≥ th·∫ª n√†o</h2>
    <p class="text-slate-600 max-w-md mx-auto">
      Hi·ªán ch∆∞a c√≥ th·∫ª n√†o ƒë·∫øn h·∫°n ƒë·ªÉ √¥n. H√£y th√™m t·ª´ v·ª±ng m·ªõi ho·∫∑c quay l·∫°i sau.
    </p>
  </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const container = document.getElementById('flashcard-container');
  if (!container) return;

  const cards = JSON.parse(container.dataset.cards);
  let index = 0;

  const cardMain = document.getElementById('card-main-word');
  const cardMainBack = document.getElementById('card-main-word-back');
  const cardReadingBack = document.getElementById('card-reading-back');
  const cardVi = document.getElementById('card-vi-meaning');
  const cardSinoBlock = document.getElementById('card-sino-block');
  const cardSinoVi = document.getElementById('card-sino-vi');
  const cardExJp = document.getElementById('card-example-jp');
  const cardExVi = document.getElementById('card-example-vi');
  const cardExampleBox = document.getElementById('card-example');
  const cardFront = document.getElementById('card-front');
  const cardBack = document.getElementById('card-back');
  const toggleBtn = document.getElementById('toggle-button');
  const remainingSpan = document.getElementById('cards-remaining');
  const progressBar = document.getElementById('progress-bar');
  const noMore = document.getElementById('no-more-cards');
  const cardWrapper = document.getElementById('card-wrapper');

  const csrfInput = document.querySelector('#csrf-form [name=csrfmiddlewaretoken]');
  const csrfToken = csrfInput ? csrfInput.value : '';

  function updateProgress() {
    const progress = (index / cards.length) * 100;
    progressBar.style.width = progress + '%';
  }

  function renderCard() {
    if (index >= cards.length) {
      cardWrapper.classList.add('hidden');
      noMore.classList.remove('hidden');
      remainingSpan.textContent = "0";
      progressBar.style.width = '100%';
      return;
    }

    const c = cards[index];
    const mainWord = c.jp_kanji || c.jp_kana;
    
    // Front side - ch·ªâ hi·ªÉn th·ªã kanji ho·∫∑c kana
    cardMain.textContent = mainWord || "";

    // Back side
    cardMainBack.textContent = mainWord || "";
    cardReadingBack.textContent = c.jp_kanji ? c.jp_kana : "";
    cardVi.textContent = c.vi_meaning;

    // Sino Vietnamese
    if (c.sino_vi) {
      cardSinoVi.textContent = c.sino_vi;
      cardSinoBlock.classList.remove('hidden');
    } else {
      cardSinoBlock.classList.add('hidden');
    }

    // Example sentences
    if (c.example_jp || c.example_vi) {
      cardExJp.textContent = c.example_jp || "";
      cardExVi.textContent = c.example_vi || "";
      cardExampleBox.classList.remove('hidden');
    } else {
      cardExampleBox.classList.add('hidden');
    }

    // Reset to front
    cardFront.classList.remove('hidden');
    cardBack.classList.add('hidden');
    
    remainingSpan.textContent = (cards.length - index).toString();
    updateProgress();
  }

  // Flip card button
  toggleBtn.addEventListener('click', function () {
    cardFront.classList.add('hidden');
    cardBack.classList.remove('hidden');
  });

  // Click ƒë·ªÉ ch·∫•m ƒëi·ªÉm
  cardBack.addEventListener('click', function (e) {
    const btn = e.target.closest('button[data-rating]');
    if (!btn) return;

    const ratingKey = btn.dataset.rating;
    const currentCard = cards[index];

    // Visual feedback
    btn.classList.add('scale-95', 'opacity-50');
    
    fetch("/vocab/flashcard/grade/", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrfToken,
      },
      body: new URLSearchParams({
        state_id: currentCard.state_id,
        rating: ratingKey,
      }),
    }).finally(() => {
      setTimeout(() => {
        index += 1;
        renderCard();
      }, 150);
    });
  });

  // Keyboard shortcuts: 1 2 3 4
  document.addEventListener('keydown', function (e) {
    if (index >= cards.length) return;

    // N·∫øu ƒëang ·ªü m·∫∑t tr∆∞·ªõc, b·∫•m Space ho·∫∑c Enter ƒë·ªÉ l·∫≠t
    if (!cardFront.classList.contains('hidden') &&
        (e.key === ' ' || e.key === 'Enter')) {
      e.preventDefault();
      toggleBtn.click();
      return;
    }

    // Ch·ªâ x·ª≠ l√Ω ph√≠m s·ªë khi ƒëang ·ªü m·∫∑t sau
    if (cardBack.classList.contains('hidden')) return;

    let ratingKey = null;

    if (e.key === '1') ratingKey = 'again';
    else if (e.key === '2') ratingKey = 'hard';
    else if (e.key === '3') ratingKey = 'good';
    else if (e.key === '4') ratingKey = 'easy';

    if (!ratingKey) return;

    e.preventDefault();

    const btn = cardBack.querySelector(`button[data-rating="${ratingKey}"]`);
    if (btn) {
      btn.click();
    }
  });

  renderCard();
});
</script>

<style>
.perspective-1000 {
  perspective: 1000px;
}

#card {
  transform-style: preserve-3d;
  transition: transform 0.3s ease;
}

#card:hover {
  transform: translateY(-2px);
}
</style>

{% endblock %}