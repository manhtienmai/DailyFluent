{% extends "layouts/sidebar_layout.html" %}
{% load static %}

{% block title %}Study Set: {{ vocab_set.title }} | DailyFluent{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/toeic.css' %}?v=20260129">
<style>
    /* Custom Override for Study Set Header to match Course style but generic */
    .df-study-set-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: white;
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="df-toeic-container" x-data="setStudy()" x-init="init()">
  <!-- Header -->
  <div class="df-toeic-learn-header">
    <a href="{% url 'vocab:set_detail' vocab_set.pk %}" class="df-toeic-back-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </a>
    <div class="df-toeic-learn-header-info">
      <span class="df-study-set-badge">
        Study Mode
      </span>
      <span class="df-toeic-learn-set-label">{{ vocab_set.title }}</span>
    </div>
    <div class="df-toeic-learn-counter" x-text="(currentIndex + 1) + '/' + items.length"></div>
  </div>

  <!-- Progress Dots -->
  <div class="df-toeic-learn-dots">
    <template x-for="(item, i) in items" :key="i">
      <div class="df-toeic-learn-dot"
           :class="{
             'df-toeic-learn-dot--current': i === currentIndex && !showSummary,
             'df-toeic-learn-dot--known': results[i] === 'known',
             'df-toeic-learn-dot--unknown': results[i] === 'unknown',
           }"></div>
    </template>
  </div>

  <!-- Empty State -->
  <template x-if="items.length === 0">
    <div class="text-center py-12">
       <p class="text-secondary mb-4">No words to study.</p>
       <a href="{% url 'vocab:set_detail' vocab_set.pk %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-hover">
         Go Back
       </a>
    </div>
  </template>

  <!-- Flashcard -->
  <div class="df-toeic-learn-card-area" x-show="!showSummary && items.length > 0">
    <div class="df-toeic-learn-card" :class="{'df-toeic-learn-card--flipped': isFlipped}" @click="flip()">
      <!-- Front: Language-specific -->
      <div class="df-toeic-learn-card-front">
        <!-- Japanese Front -->
        <template x-if="isJapanese">
          <div class="text-center">
            <!-- Kanji only (no reading), large for easy viewing -->
            <div class="df-set-study-kanji-front text-primary leading-tight" x-text="currentItem?.word"></div>
            <!-- H√°n Vi·ªát (Badge) -->
            <template x-if="currentItem?.extra_data?.han_viet">
              <div class="mt-3 inline-block px-3 py-1 rounded-lg bg-amber-100 text-amber-700 text-sm font-bold border border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-700" 
                   x-text="currentItem.extra_data.han_viet"></div>
            </template>
            <!-- Audio Button -->
            <button type="button" class="df-toeic-learn-audio-btn mt-4"
                    @click.stop="playAudio()" x-show="currentItem?.audio_url">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                <path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/>
              </svg>
            </button>
            <div class="df-toeic-learn-flip-hint">Ch·∫°m ƒë·ªÉ l·∫≠t</div>
          </div>
        </template>
        <!-- English/Default Front -->
        <template x-if="!isJapanese">
          <div class="text-center">
            <div class="df-toeic-learn-word" x-text="currentItem?.word"></div>
            <div class="df-toeic-learn-ipa" x-text="currentItem?.ipa"></div>
            <button type="button" class="df-toeic-learn-audio-btn"
                    @click.stop="playAudio()" x-show="currentItem?.audio_url">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                <path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/>
              </svg>
            </button>
            <div class="df-toeic-learn-flip-hint">Ch·∫°m ƒë·ªÉ l·∫≠t</div>
          </div>
        </template>
      </div>

      <!-- Back: Language-specific -->
      <div class="df-toeic-learn-card-back">
        <!-- Japanese Back -->
        <template x-if="isJapanese">
          <div class="w-full">
            <!-- Kanji + Reading -->
            <div class="flex items-baseline gap-2 flex-wrap">
              <span class="text-2xl font-bold text-primary" x-text="currentItem?.word"></span>
              <template x-if="currentItem?.extra_data?.reading">
                <span class="text-base text-secondary" x-text="'(' + currentItem.extra_data.reading + ')'"></span>
              </template>
            </div>
            <!-- Part of Speech -->
            <div class="df-toeic-learn-back-pos" x-text="currentItem?.part_of_speech"></div>
            <!-- Meaning -->
            <div class="df-toeic-learn-meaning" x-text="currentItem?.meaning"></div>
            <!-- Example -->
            <template x-if="currentItem?.example">
              <div class="df-toeic-learn-example">
                <div class="df-toeic-learn-example-text" x-text="currentItem?.example"></div>
                <div class="df-toeic-learn-example-trans" x-text="currentItem?.example_trans"></div>
              </div>
            </template>
          </div>
        </template>
        <!-- English/Default Back -->
        <template x-if="!isJapanese">
          <div class="w-full">
            <div class="df-toeic-learn-back-word" x-text="currentItem?.word"></div>
            <div class="df-toeic-learn-back-pos" x-text="currentItem?.part_of_speech"></div>
            <div class="df-toeic-learn-meaning" x-text="currentItem?.meaning"></div>
            <template x-if="currentItem?.example">
              <div class="df-toeic-learn-example">
                <div class="df-toeic-learn-example-text" x-text="currentItem?.example"></div>
                <div class="df-toeic-learn-example-trans" x-text="currentItem?.example_trans"></div>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>

    <!-- Action Buttons (shown after flip) -->
    <div class="df-toeic-learn-actions" x-show="isFlipped" x-transition>
      <button type="button" class="df-toeic-learn-btn df-toeic-learn-btn--unknown"
              @click="markWord('again')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Ch∆∞a thu·ªôc
      </button>
      <button type="button" class="df-toeic-learn-btn df-toeic-learn-btn--known"
              @click="markWord('good')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        ƒê√£ bi·∫øt
      </button>
    </div>
  </div>

  <!-- Summary Screen -->
  <div class="df-toeic-learn-summary" x-show="showSummary" x-transition>
    <div class="df-toeic-learn-summary-icon">üéâ</div>
    <h2 class="df-toeic-learn-summary-title">Ho√†n th√†nh!</h2>
    <p class="text-secondary mb-6">B·∫°n ƒë√£ √¥n t·∫≠p h·∫øt danh s√°ch t·ª´ n√†y.</p>

    <div class="df-toeic-learn-summary-stats">
      <div class="df-toeic-learn-summary-stat df-toeic-learn-summary-stat--known">
        <span class="df-toeic-learn-summary-stat-value" x-text="knownCount"></span>
        <span class="df-toeic-learn-summary-stat-label">ƒê√£ bi·∫øt</span>
      </div>
      <div class="df-toeic-learn-summary-stat df-toeic-learn-summary-stat--unknown">
        <span class="df-toeic-learn-summary-stat-value" x-text="unknownCount"></span>
        <span class="df-toeic-learn-summary-stat-label">C·∫ßn h·ªçc l·∫°i</span>
      </div>
    </div>

    <div class="df-toeic-learn-summary-actions">
      <a href="{% url 'vocab:set_detail' vocab_set.pk %}" class="df-toeic-btn df-toeic-btn--primary">
        Quay v·ªÅ danh s√°ch
      </a>
      <button @click="location.reload()" class="df-toeic-btn df-toeic-btn--secondary">
        H·ªçc l·∫°i
      </button>
    </div>
  </div>

  <!-- Hidden data -->
  <script id="items-data" type="application/json">{{ items_json|safe }}</script>
  <form id="csrf-form" class="hidden">{% csrf_token %}</form>
</div>

<script>
function setStudy() {
  return {
    items: [],
    currentIndex: 0,
    isFlipped: false,
    results: {},
    showSummary: false,
    audioEl: null,
    setLanguage: '{{ vocab_set.language|default:"en" }}',

    get currentItem() {
      return this.items[this.currentIndex] || null;
    },
    get isJapanese() {
      return this.setLanguage === 'jp';
    },
    get knownCount() {
      return Object.values(this.results).filter(r => r === 'known').length;
    },
    get unknownCount() {
      return Object.values(this.results).filter(r => r === 'unknown').length;
    },

    init() {
      const raw = document.getElementById('items-data');
      if (raw) {
          this.items = JSON.parse(raw.textContent);
      }
      this.audioEl = new Audio();
    },

    flip() {
      this.isFlipped = !this.isFlipped;
    },

    playAudio() {
      if (this.currentItem && this.currentItem.audio_url) {
        this.audioEl.src = this.currentItem.audio_url;
        this.audioEl.play().catch(() => {});
      }
    },

    async gradeCard(vocabId, rating) {
       // Call FSRS API
       const csrf = document.querySelector('#csrf-form [name=csrfmiddlewaretoken]').value;
       
       try {
        await fetch("{% url 'vocab:flashcard_grade_english' %}", {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
             'X-CSRFToken': csrf,
           },
           body: JSON.stringify({
             vocab_id: vocabId,
             rating: rating,
           }),
         });
         // We don't necessarily need to wait for response or handle intervals here for simple study mode
       } catch (err) {
         console.error("Grading failed", err);
       }
    },

    async markWord(rating) {
      // rating: 'good' (known) or 'again' (unknown)
      const visualResult = rating === 'good' ? 'known' : 'unknown';
      this.results[this.currentIndex] = visualResult;
      
      // Async grade in background
      if (this.currentItem) {
          this.gradeCard(this.currentItem.id, rating); // id here is vocab id from view
      }

      if (this.currentIndex < this.items.length - 1) {
        this.currentIndex++;
        this.isFlipped = false;
      } else {
        this.showSummary = true;
      }
    },
  };
}
</script>
{% endblock %}
