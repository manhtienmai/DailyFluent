{% extends "layouts/sidebar_layout.html" %}
{% load static %}

{% block title %}{{ vocab_set.title }} | DailyFluent{% endblock %}

{% block extra_css %}
<style>
  /* Japanese Word Card Styles */
  .jp-word-card {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1.25rem;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: 1rem;
    transition: all 0.2s ease;
  }
  .jp-word-card:hover {
    border-color: var(--border-strong);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
  }
  .jp-word-kanji {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1.2;
    color: var(--text-primary);
    font-family: "Noto Sans JP", "Hiragino Kaku Gothic Pro", "Meiryo", sans-serif;
  }
  .jp-word-reading {
    font-size: 1rem;
    color: var(--text-secondary);
    font-family: "Noto Sans JP", sans-serif;
  }
  .jp-word-hanviet {
    display: inline-block;
    padding: 0.25rem 0.625rem;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    font-size: 0.75rem;
    font-weight: 700;
    border-radius: 0.5rem;
    border: 1px solid #fcd34d;
  }
  .dark .jp-word-hanviet {
    background: linear-gradient(135deg, rgba(217, 119, 6, 0.2) 0%, rgba(245, 158, 11, 0.15) 100%);
    color: #fbbf24;
    border-color: rgba(251, 191, 36, 0.3);
  }
  .jp-word-meaning {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.5;
  }
  .jp-word-pos {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    background: var(--bg-interactive);
    color: var(--text-secondary);
    font-size: 0.6875rem;
    font-weight: 500;
    border-radius: 0.375rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  .jp-word-example {
    padding: 0.875rem 1rem;
    background: var(--bg-interactive);
    border-radius: 0.75rem;
    border-left: 3px solid var(--action-primary, #0D9488);
  }
  .jp-word-example-text {
    font-size: 0.9375rem;
    color: var(--text-primary);
    line-height: 1.6;
  }
  .jp-word-example-trans {
    font-size: 0.8125rem;
    color: var(--text-tertiary);
    margin-top: 0.375rem;
    font-style: italic;
  }
  .audio-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border: 1px solid rgba(59, 130, 246, 0.2);
    transition: all 0.15s ease;
    cursor: pointer;
  }
  .audio-btn:hover {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.4);
    transform: scale(1.1);
  }
  .dark .audio-btn {
    background: rgba(59, 130, 246, 0.15);
    border-color: rgba(59, 130, 246, 0.3);
  }
  /* English Word Card */
  .en-word-card {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1rem 1.25rem;
    background: var(--bg-surface);
    border: 1px solid var(--border-default);
    border-radius: 0.875rem;
    transition: all 0.2s ease;
  }
  .en-word-card:hover {
    border-color: var(--border-strong);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }
  .en-word-text {
    font-size: 1.375rem;
    font-weight: 700;
    color: var(--text-primary);
  }
  .en-word-ipa {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-family: monospace;
  }
  
  /* Selection Checkbox */
  .card-checkbox {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 0.25rem;
      border: 2px solid var(--border-strong);
      cursor: pointer;
      accent-color: var(--action-primary, #0D9488);
      z-index: 10;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto" x-data="setManager()">
  
  {# --- BACK LINK --- #}
  <div class="mb-6">
    <a href="{% url 'vocab:set_list' %}" class="inline-flex items-center text-sm font-medium text-secondary hover:text-primary transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Sets
    </a>
  </div>

  {# --- HEADER SECTION --- #}
  <div class="bg-surface border border-default rounded-2xl p-6 mb-6 shadow-sm">
    <div class="flex flex-col lg:flex-row justify-between items-start gap-6">
      <div class="flex-1">
        {# Badges #}
        <div class="flex flex-wrap items-center gap-2 mb-3">
          {% if vocab_set.language == 'jp' %}
            <span class="px-2.5 py-1 rounded-lg text-xs font-bold text-white shadow-sm"
                  style="background: linear-gradient(135deg, #dc2626 0%, #f97316 100%);">
              ðŸ‡¯ðŸ‡µ Japanese
            </span>
          {% else %}
            <span class="px-2.5 py-1 rounded-lg text-xs font-bold text-white shadow-sm"
                  style="background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);">
              ðŸ‡¬ðŸ‡§ English
            </span>
          {% endif %}
          
          {% if vocab_set.toeic_level %}
            <span class="px-2.5 py-0.5 rounded-md text-xs font-bold text-white shadow-sm"
                  style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);">
              TOEIC {{ vocab_set.toeic_level }}
            </span>
          {% endif %}
          
          <span class="px-2.5 py-0.5 rounded-full text-xs font-medium 
            {% if vocab_set.is_public %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300{% else %}bg-app-subtle text-secondary border border-default{% endif %}">
            {{ vocab_set.is_public|yesno:"Public,Private" }}
          </span>
        </div>

        <h1 class="text-2xl lg:text-3xl font-bold text-primary mb-2 leading-tight">{{ vocab_set.title }}</h1>
        <p class="text-secondary text-base max-w-2xl leading-relaxed">{{ vocab_set.description|default:"No description available." }}</p>
        
        <div class="flex items-center gap-4 mt-4 text-sm text-tertiary">
          <span class="flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            {{ vocab_set.owner.username|default:"System" }}
          </span>
          <span class="flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            <strong class="text-primary">{{ vocab_set.items.count }}</strong> words
          </span>
        </div>
      </div>

      {# Actions #}
      <div class="flex flex-wrap gap-3 w-full lg:w-auto">
        <a href="{% url 'vocab:set_study' vocab_set.pk %}" 
           class="flex-1 lg:flex-none inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-primary to-emerald-500 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all hover:scale-105 active:scale-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M5 3l14 9-14 9V3z" />
          </svg>
          Study Now
        </a>

        {% if request.user == vocab_set.owner %}
          <div class="flex gap-2">
			  {# Bulk Edit/Delete Toggle #}
              <button @click="toggleEditMode()" 
                 :class="editMode ? 'bg-amber-100 text-amber-700 border-amber-300' : 'bg-surface border-default text-secondary hover:text-primary hover:border-strong hover:bg-app-subtle'"
                 class="inline-flex items-center justify-center gap-2 px-4 py-2.5 border rounded-xl font-medium transition-all shadow-sm">
                 <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  <span x-text="editMode ? 'Done' : 'Manage'"></span>
              </button>

              <a href="{% url 'vocab:set_import' vocab_set.pk %}" 
              class="inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700 transition-colors shadow-sm"
              title="Import from JSON">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
              </svg>
              </a>

              <a href="{% url 'vocab:set_delete' vocab_set.pk %}" 
              class="inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-surface border border-red-200 text-red-600 rounded-xl font-medium hover:bg-red-50 hover:border-red-300 dark:border-red-900/50 dark:hover:bg-red-900/20 transition-all shadow-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  {# --- BULK ACTIONS BAR --- #}
  <div x-show="editMode" x-transition class="mb-4 flex items-center justify-between bg-surface border border-dashed border-primary rounded-xl p-4 shadow-sm" style="display: none;">
      <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-primary">Selected: <span class="font-bold" x-text="selectedItems.length"></span></span>
          <button @click="deleteSelected()" 
                  x-show="selectedItems.length > 0"
                  class="text-xs bg-red-100 text-red-700 px-3 py-1.5 rounded-lg border border-red-200 font-bold hover:bg-red-200 transition-colors">
              Delete Selected
          </button>
      </div>
      <div class="text-sm text-tertiary">Select words to remove</div>
  </div>

  {# --- SEARCH & ADD WORD (Owner Only) --- #}
  {% if request.user == vocab_set.owner %}
  <div x-show="!editMode" class="mb-6 relative z-20">
    <div class="bg-surface border border-default rounded-xl p-1.5 shadow-sm max-w-xl">
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-tertiary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
          </svg>
        </div>
        <input type="text" id="word-search" 
               class="block w-full pl-10 pr-4 py-2.5 bg-surface text-primary placeholder-tertiary border-none rounded-lg focus:ring-2 focus:ring-primary focus:bg-app-subtle transition-colors"
               placeholder="Search to add words...">
        
        {# Results Dropdown #}
        <div id="search-results" class="absolute top-full left-0 right-0 mt-2 bg-surface rounded-xl border border-default shadow-xl overflow-hidden hidden max-h-60 overflow-y-auto">
            <!-- Populated via JS -->
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {# --- VOCABULARY GRID --- #}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="vocab-grid">
    {% for item in items %}
      {% if vocab_set.language == 'jp' %}
      {# Japanese Word Card #}
      <div class="jp-word-card" id="item-card-{{ item.id }}">
        {# Checkbox for Edit Mode #}
        <input type="checkbox" value="{{ item.id }}" x-model="selectedItems" x-show="editMode" 
               class="card-checkbox" style="display: none;">

        <div class="flex justify-between items-start">
          <div>
            <div class="jp-word-kanji">{{ item.definition.entry.vocab.word }}</div>
            {% if item.definition.entry.vocab.extra_data.reading %}
              <div class="jp-word-reading mt-1">{{ item.definition.entry.vocab.extra_data.reading }}</div>
            {% endif %}
          </div>
          <div class="flex items-center gap-2">
            {% if item.definition.entry.audio_us or item.definition.entry.audio_uk %}
              <button onclick="playAudio(this)" data-src="{{ item.definition.entry.audio_us|default:item.definition.entry.audio_uk }}" 
                      class="audio-btn" title="Play audio">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
              </button>
            {% endif %}
          </div>
        </div>

        {% if item.definition.entry.vocab.extra_data.han_viet %}
          <div>
            <span class="jp-word-hanviet">{{ item.definition.entry.vocab.extra_data.han_viet }}</span>
          </div>
        {% endif %}
        
        <div class="flex items-center gap-2 flex-wrap">
          <span class="jp-word-pos">{{ item.definition.entry.part_of_speech }}</span>
          <span class="jp-word-meaning">{{ item.definition.meaning }}</span>
        </div>
        
        {% if item.definition.example_sentence %}
        <div class="jp-word-example">
          <div class="jp-word-example-text">{{ item.definition.example_sentence }}</div>
          <div class="jp-word-example-trans">{{ item.definition.example_trans }}</div>
        </div>
        {% endif %}
      </div>

      {% else %}
      {# English Word Card #}
      <div class="en-word-card" id="item-card-{{ item.id }}">
         {# Checkbox for Edit Mode #}
         <input type="checkbox" value="{{ item.id }}" x-model="selectedItems" x-show="editMode" 
                class="card-checkbox" style="display: none;">

        <div class="flex justify-between items-start">
          <div>
            <div class="en-word-text">{{ item.definition.entry.vocab.word }}</div>
            <div class="en-word-ipa">{{ item.definition.entry.ipa }}</div>
          </div>
          <div class="flex items-center gap-2">
            {% if item.definition.entry.audio_us or item.definition.entry.audio_uk %}
              <button onclick="playAudio(this)" data-src="{{ item.definition.entry.audio_us|default:item.definition.entry.audio_uk }}" 
                      class="audio-btn" title="Play audio">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
              </button>
            {% endif %}
          </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
          <span class="jp-word-pos">{{ item.definition.entry.part_of_speech }}</span>
          <span class="text-primary font-medium">{{ item.definition.meaning }}</span>
        </div>
        
        {% if item.definition.example_sentence %}
        <div class="jp-word-example mt-2">
          <div class="jp-word-example-text">{{ item.definition.example_sentence }}</div>
          <div class="jp-word-example-trans">{{ item.definition.example_trans }}</div>
        </div>
        {% endif %}
      </div>
      {% endif %}
    {% empty %}
      <div class="col-span-full bg-surface border border-default rounded-xl p-12 text-center">
        <svg class="w-16 h-16 text-tertiary mb-4 mx-auto opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
        <p class="text-secondary text-lg font-medium">This set doesn't have any words yet.</p>
        {% if request.user == vocab_set.owner %}
        <p class="text-sm text-tertiary mt-2">Use the search box above to add some words!</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

{# Hidden Audio Player #}
<audio id="global-audio-player" class="hidden"></audio>

{% if request.user == vocab_set.owner %}
<script>
  function setManager() {
      return {
          editMode: false,
          selectedItems: [],
          
          toggleEditMode() {
              this.editMode = !this.editMode;
              if (!this.editMode) {
                  this.selectedItems = [];
              }
          },
          
          async deleteSelected() {
              if (this.selectedItems.length === 0) return;
              if (!confirm(`Are you sure you want to delete ${this.selectedItems.length} items?`)) return;
              
              const csrf = '{{ csrf_token }}';
              const setId = {{ vocab_set.id }};
              
              // Process sequentially or Promise.all
              const deletePromises = this.selectedItems.map(itemId => {
                   return fetch(`{% url 'vocab:api_remove_item' vocab_set.id %}`, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/x-www-form-urlencoded',
                          'X-CSRFToken': csrf
                      },
                      body: `item_id=${itemId}`
                  }).then(res => res.json());
              });
              
              try {
                  const results = await Promise.all(deletePromises);
                  // Check results if needed
                  window.location.reload();
              } catch (e) {
                  console.error("Delete failed", e);
                  alert("Failed to delete some items.");
              }
          }
      }
  }

  // Simple Audio Player
  function playAudio(btn) {
    const src = btn.getAttribute('data-src');
    const player = document.getElementById('global-audio-player');
    if(src && player) {
        player.src = src;
        player.play().catch(e => console.error(e));
    }
  }

  // Search Logic
  const searchInput = document.getElementById('word-search');
  const resultsDiv = document.getElementById('search-results');
  const setId = {{ vocab_set.id }};
  let debounceTimer;

  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        const query = e.target.value.trim();
        
        if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
        }

        debounceTimer = setTimeout(() => {
        fetch(`{% url 'vocab:api_search' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
            resultsDiv.innerHTML = '';
            if (data.length > 0) {
                data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'px-4 py-3 hover:bg-app-subtle cursor-pointer transition-colors border-b border-default last:border-0 flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <span class="font-bold text-primary">${item.text}</span>
                        <span class="text-xs text-tertiary ml-2 italic">${item.meaning || ''}</span>
                    </div>
                    <span class="text-xs text-secondary bg-app px-2 py-0.5 rounded border border-default">Add</span>
                `;
                div.onclick = () => addItem(item.id);
                resultsDiv.appendChild(div);
                });
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.innerHTML = '<div class="px-4 py-3 text-tertiary italic text-center text-sm">No words found</div>';
                resultsDiv.classList.remove('hidden');
            }
            })
            .catch(err => console.error(err));
        }, 300);
    });

    // Close search on outside click
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
        resultsDiv.classList.add('hidden');
        }
    });
  }

  function addItem(definitionId) {
    fetch(`{% url 'vocab:api_add_item' vocab_set.id %}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: `definition_id=${definitionId}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error);
      }
    });
  }
</script>
{% else %}
<script>
    function playAudio(btn) {
    const src = btn.getAttribute('data-src');
    const player = document.getElementById('global-audio-player');
    if(src && player) {
        player.src = src;
        player.play().catch(e => console.error(e));
    }
  }
</script>
{% endif %}
{% endblock %}
