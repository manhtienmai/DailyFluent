{% extends "layouts/sidebar_layout.html" %}
{% load static %}

{% block title %}N·ªëi t·ª´ v·ªõi nghƒ©a | DailyFluent{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vocab-games.css' %}?v=20260210">
{% endblock %}

{% block content %}
<div class="df-game-container">
  <!-- Header -->
  <div class="df-game-header">
    <div>
      <h1 class="df-game-title">N·ªëi t·ª´ v·ªõi nghƒ©a</h1>
      <p class="df-game-subtitle">Ch·ªçn c√°c c·∫∑p t·ª´ - nghƒ©a ƒë√∫ng</p>
    </div>
    <div class="df-game-stats">
      <div class="df-game-stat" id="lives-stat" style="background: var(--status-error-subtle); border-color: var(--status-error-border);">
        <span class="df-game-stat-value" id="lives-count" style="color: var(--status-error-text);">5</span>
        <span class="df-game-stat-label" style="color: var(--status-error-text);">M·∫°ng</span>
      </div>
      <div class="df-game-stat df-game-stat--correct">
        <span class="df-game-stat-value" id="matched-count">0</span>
        <span class="df-game-stat-label">C·∫∑p</span>
      </div>
    </div>
  </div>

  {% if tiles %}
  <script id="tiles-data" type="application/json">{{ tiles_json|safe }}</script>

  <div id="game-container">
    <!-- Timer -->
    <div id="timer-display" class="df-game-timer">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      <span id="timer-text">0:00</span>
    </div>

    <!-- Progress -->
    <div class="df-game-progress">
      <div class="df-game-progress-bar">
        <div id="progress-fill" class="df-game-progress-fill" style="width: 0%"></div>
      </div>
      <span id="progress-text" class="df-game-progress-text">0 / {{ total_pairs }}</span>
    </div>

    <!-- Matching Grid -->
    <div class="df-game-card" style="padding: 1.25rem;">
      <div id="match-grid" class="df-game-match-grid"></div>
    </div>
  </div>

  <!-- Complete Screen -->
  <div id="complete-screen" class="df-game-complete hidden">
    <div class="df-game-complete-icon">
      <span id="complete-emoji"></span>
    </div>
    <h2 class="df-game-complete-title" id="complete-title"></h2>
    <p class="df-game-complete-subtitle" id="complete-subtitle"></p>

    <div class="df-game-complete-stats">
      <div class="df-game-complete-stat">
        <div id="final-pairs" class="df-game-complete-stat-value">0</div>
        <div class="df-game-complete-stat-label">C·∫∑p ƒë√£ n·ªëi</div>
      </div>
      <div class="df-game-complete-stat">
        <div id="final-time" class="df-game-complete-stat-value">0:00</div>
        <div class="df-game-complete-stat-label">Th·ªùi gian</div>
      </div>
      <div class="df-game-complete-stat">
        <div id="final-lives" class="df-game-complete-stat-value">0</div>
        <div class="df-game-complete-stat-label">M·∫°ng c√≤n</div>
      </div>
    </div>

    <div class="df-game-complete-actions">
      <button type="button" id="btn-play-again" class="df-game-complete-btn df-game-complete-btn--primary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"/></svg>
        Ch∆°i l·∫°i
      </button>
      <a href="{% url 'vocab:games' %}" class="df-game-complete-btn df-game-complete-btn--secondary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        Tr√≤ ch∆°i kh√°c
      </a>
    </div>
  </div>

  <!-- Game Over Screen -->
  <div id="gameover-screen" class="df-game-complete hidden">
    <div class="df-game-complete-icon" style="background: var(--status-error-subtle); border-color: var(--status-error-border);">
      <span>üíî</span>
    </div>
    <h2 class="df-game-complete-title" style="color: var(--status-error-text);">H·∫øt m·∫°ng!</h2>
    <p class="df-game-complete-subtitle">B·∫°n ƒë√£ h·∫øt l∆∞·ª£t ch∆°i. Mua th√™m m·∫°ng ho·∫∑c ch∆°i l·∫°i!</p>

    <div style="margin: 1.5rem 0;">
      <button type="button" id="btn-buy-life" class="df-game-complete-btn df-game-complete-btn--primary" style="background: linear-gradient(135deg, #F59E0B, #D97706); box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
        Mua 1 m·∫°ng (10 coin)
      </button>
      <div id="buy-life-info" style="font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.5rem;"></div>
    </div>

    <div class="df-game-complete-actions">
      <button type="button" id="btn-restart" class="df-game-complete-btn df-game-complete-btn--primary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"/></svg>
        Ch∆°i l·∫°i t·ª´ ƒë·∫ßu
      </button>
      <a href="{% url 'vocab:games' %}" class="df-game-complete-btn df-game-complete-btn--secondary">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        Tho√°t
      </a>
    </div>
  </div>

  {% else %}
  <div class="df-game-empty">
    <div class="df-game-empty-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
    </div>
    <h2 class="df-game-empty-title">Ch∆∞a c√≥ t·ª´ v·ª±ng</h2>
    <p class="df-game-empty-text">H√£y th√™m t·ª´ v·ª±ng v√†o h·ªá th·ªëng ƒë·ªÉ b·∫Øt ƒë·∫ßu ch∆°i.</p>
  </div>
  {% endif %}
</div>

{% if tiles %}
<script>
(function() {
  const tilesData = JSON.parse(document.getElementById('tiles-data').textContent || '[]');
  const totalPairs = {{ total_pairs }};
  const BUY_LIFE_URL = "{% url 'vocab:api_buy_game_life' %}";
  const CSRF_TOKEN = "{{ csrf_token }}";

  const MAX_LIVES = 5;

  let tiles = [...tilesData];
  let selected = null;
  let matchedPairs = new Set();
  let locked = false;
  let lives = MAX_LIVES;
  let timerSeconds = 0;
  let timerInterval = null;

  const grid = document.getElementById('match-grid');
  const progressFill = document.getElementById('progress-fill');
  const progressText = document.getElementById('progress-text');
  const matchedEl = document.getElementById('matched-count');
  const livesEl = document.getElementById('lives-count');
  const timerText = document.getElementById('timer-text');
  const timerDisplay = document.getElementById('timer-display');
  const gameContainer = document.getElementById('game-container');
  const completeScreen = document.getElementById('complete-screen');
  const gameoverScreen = document.getElementById('gameover-screen');
  const buyLifeBtn = document.getElementById('btn-buy-life');
  const buyLifeInfo = document.getElementById('buy-life-info');

  function formatTime(s) {
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return m + ':' + (sec < 10 ? '0' : '') + sec;
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      timerSeconds++;
      timerText.textContent = formatTime(timerSeconds);
      if (timerSeconds >= 60) timerDisplay.classList.add('warning');
    }, 1000);
  }

  function stopTimer() {
    clearInterval(timerInterval);
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function bumpEl(el) {
    el.classList.add('bump');
    setTimeout(() => el.classList.remove('bump'), 200);
  }

  function render() {
    grid.innerHTML = '';
    livesEl.textContent = lives;

    tiles.forEach((tile, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'df-game-match-tile';
      btn.className += tile.type === 'word' ? ' df-game-match-tile--word' : ' df-game-match-tile--meaning';
      btn.textContent = tile.text;
      btn.dataset.index = i;

      if (matchedPairs.has(tile.pair_id)) {
        btn.classList.add('df-game-match-tile--matched');
        btn.disabled = true;
      }

      if (selected && selected.index === i) {
        btn.classList.add('df-game-match-tile--selected');
      }

      btn.addEventListener('click', () => handleClick(i, tile));
      grid.appendChild(btn);
    });

    const pct = (matchedPairs.size / totalPairs) * 100;
    progressFill.style.width = pct + '%';
    progressText.textContent = matchedPairs.size + ' / ' + totalPairs;
    matchedEl.textContent = matchedPairs.size;
  }

  function handleClick(index, tile) {
    if (locked || matchedPairs.has(tile.pair_id)) return;

    if (!selected) {
      selected = { index, ...tile };
      render();
      return;
    }

    if (selected.index === index) {
      selected = null;
      render();
      return;
    }

    const isMatch = selected.pair_id === tile.pair_id && selected.type !== tile.type;

    if (isMatch) {
      matchedPairs.add(tile.pair_id);
      bumpEl(matchedEl);
      selected = null;
      render();

      if (matchedPairs.size >= totalPairs) {
        stopTimer();
        setTimeout(showComplete, 500);
      }
    } else {
      lives--;
      livesEl.textContent = lives;

      locked = true;
      const btns = grid.querySelectorAll('button');
      if (btns[selected.index]) btns[selected.index].classList.add('df-game-match-tile--wrong');
      if (btns[index]) btns[index].classList.add('df-game-match-tile--wrong');

      setTimeout(() => {
        selected = null;
        locked = false;

        if (lives <= 0) {
          stopTimer();
          showGameOver();
        } else {
          render();
        }
      }, 600);
    }
  }

  function showComplete() {
    gameContainer.classList.add('hidden');
    gameoverScreen.classList.add('hidden');
    completeScreen.classList.remove('hidden');

    document.getElementById('final-pairs').textContent = matchedPairs.size;
    document.getElementById('final-time').textContent = formatTime(timerSeconds);
    document.getElementById('final-lives').textContent = lives;

    if (lives >= 4) {
      document.getElementById('complete-emoji').textContent = 'üéâ';
      document.getElementById('complete-title').textContent = 'Xu·∫•t s·∫Øc!';
      document.getElementById('complete-subtitle').textContent = 'Ho√†n th√†nh trong ' + formatTime(timerSeconds) + ' v·ªõi ' + lives + ' m·∫°ng!';
    } else if (lives >= 2) {
      document.getElementById('complete-emoji').textContent = 'üëç';
      document.getElementById('complete-title').textContent = 'T·ªët l·∫Øm!';
      document.getElementById('complete-subtitle').textContent = 'B·∫°n ƒë√£ gh√©p ƒë√∫ng t·∫•t c·∫£ c√°c c·∫∑p t·ª´!';
    } else {
      document.getElementById('complete-emoji').textContent = 'üòÖ';
      document.getElementById('complete-title').textContent = 'S√°t n√∫t!';
      document.getElementById('complete-subtitle').textContent = 'Su√Ωt h·∫øt m·∫°ng! Th·ª≠ l·∫°i ƒë·ªÉ l√†m t·ªët h∆°n nh√©';
    }

    showConfetti();
  }

  function showGameOver() {
    gameContainer.classList.add('hidden');
    completeScreen.classList.add('hidden');
    gameoverScreen.classList.remove('hidden');
    buyLifeBtn.disabled = false;
    buyLifeInfo.textContent = '';
  }

  function resetGame() {
    tiles = shuffleArray([...tilesData]);
    selected = null;
    matchedPairs = new Set();
    locked = false;
    lives = MAX_LIVES;
    timerSeconds = 0;
    timerText.textContent = '0:00';
    timerDisplay.classList.remove('warning');
    stopTimer();

    gameContainer.classList.remove('hidden');
    completeScreen.classList.add('hidden');
    gameoverScreen.classList.add('hidden');
    render();
    startTimer();
  }

  async function buyLife() {
    buyLifeBtn.disabled = true;
    buyLifeInfo.textContent = 'ƒêang x·ª≠ l√Ω...';

    try {
      const res = await fetch(BUY_LIFE_URL, {
        method: 'POST',
        headers: {
          'X-CSRFToken': CSRF_TOKEN,
          'Content-Type': 'application/json'
        }
      });

      const data = await res.json();

      if (data.success) {
        lives = 1;
        buyLifeInfo.textContent = data.message + ' S·ªë d∆∞: ' + data.new_balance + ' coin';

        setTimeout(() => {
          gameoverScreen.classList.add('hidden');
          gameContainer.classList.remove('hidden');
          render();
        }, 1000);
      } else {
        buyLifeInfo.textContent = data.message;
        buyLifeBtn.disabled = false;
      }
    } catch (err) {
      buyLifeInfo.textContent = 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
      buyLifeBtn.disabled = false;
    }
  }

  function showConfetti() {
    const container = document.createElement('div');
    container.className = 'df-confetti';
    document.body.appendChild(container);
    const colors = ['#F59E0B', '#10B981', '#3B82F6', '#EC4899', '#8B5CF6', '#F97316'];
    for (let i = 0; i < 40; i++) {
      const piece = document.createElement('div');
      piece.className = 'df-confetti-piece';
      piece.style.left = Math.random() * 100 + '%';
      piece.style.background = colors[Math.floor(Math.random() * colors.length)];
      piece.style.animationDelay = Math.random() * 0.8 + 's';
      piece.style.animationDuration = (2 + Math.random() * 1.5) + 's';
      container.appendChild(piece);
    }
    setTimeout(() => container.remove(), 4000);
  }

  document.getElementById('btn-play-again').addEventListener('click', resetGame);
  document.getElementById('btn-restart').addEventListener('click', resetGame);
  buyLifeBtn.addEventListener('click', buyLife);

  render();
  startTimer();
})();
</script>
{% endif %}
{% endblock %}
