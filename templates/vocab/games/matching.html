{% extends "layouts/sidebar_layout.html" %}
{% load static %}

{% block title %}Ná»‘i tá»« vá»›i nghÄ©a | DailyFluent{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vocab-games.css' %}?v=20260115">
{% endblock %}

{% block content %}
<div class="df-game-container">
  <!-- Header -->
  <div class="df-game-header">
    <div>
      <h1 class="df-game-title">â‡„ Ná»‘i tá»« vá»›i nghÄ©a</h1>
      <p class="df-game-subtitle">Chá»n cÃ¡c cáº·p tá»« - nghÄ©a Ä‘Ãºng</p>
    </div>
    <div class="df-game-stats">
      <div class="df-game-stat">
        <span class="df-game-stat-value" id="matched-count">0</span>
        <span class="df-game-stat-label">ÄÃ£ ghÃ©p</span>
      </div>
      <div class="df-game-stat">
        <span class="df-game-stat-value">{{ total_pairs }}</span>
        <span class="df-game-stat-label">Tá»•ng</span>
      </div>
    </div>
  </div>

  {% if tiles %}
  <script id="tiles-data" type="application/json">{{ tiles_json|safe }}</script>

  <div id="game-container">
    <!-- Progress -->
    <div class="df-game-progress">
      <div class="df-game-progress-bar">
        <div id="progress-fill" class="df-game-progress-fill" style="width: 0%"></div>
      </div>
      <span id="progress-text" class="df-game-progress-text">0 / {{ total_pairs }}</span>
    </div>

    <!-- Matching Grid -->
    <div class="df-game-card">
      <div id="match-grid" class="df-game-match-grid"></div>
    </div>

    <!-- Reset Button -->
    <div style="text-align: center; margin-top: 1rem;">
      <button type="button" id="btn-reset" class="df-game-nav-btn df-game-nav-btn--secondary">
        ChÆ¡i láº¡i
      </button>
    </div>
  </div>

  <!-- Complete Screen -->
  <div id="complete-screen" class="df-game-complete hidden">
    <div class="df-game-complete-icon">ğŸ‰</div>
    <h2 class="df-game-complete-title">HoÃ n thÃ nh!</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Báº¡n Ä‘Ã£ ghÃ©p Ä‘Ãºng táº¥t cáº£ cÃ¡c cáº·p tá»«!</p>
    <div style="display: flex; justify-content: center; gap: 1rem;">
      <button type="button" id="btn-play-again" class="df-game-nav-btn df-game-nav-btn--secondary">ChÆ¡i láº¡i</button>
      <a href="{% url 'vocab:games' %}" class="df-game-complete-btn">Xem cÃ¡c trÃ² khÃ¡c</a>
    </div>
  </div>

  {% else %}
  <div class="df-game-empty">
    <div class="df-game-empty-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
    </div>
    <h2 class="df-game-empty-title">ChÆ°a cÃ³ tá»« vá»±ng</h2>
    <p class="df-game-empty-text">HÃ£y thÃªm tá»« vá»±ng vÃ o há»‡ thá»‘ng Ä‘á»ƒ báº¯t Ä‘áº§u chÆ¡i.</p>
  </div>
  {% endif %}
</div>

{% if tiles %}
<script>
(function() {
  const tilesData = JSON.parse(document.getElementById('tiles-data').textContent || '[]');
  const totalPairs = {{ total_pairs }};
  
  let tiles = [...tilesData];
  let selected = null;
  let matchedPairs = new Set();
  let locked = false;
  
  const grid = document.getElementById('match-grid');
  const progressFill = document.getElementById('progress-fill');
  const progressText = document.getElementById('progress-text');
  const matchedEl = document.getElementById('matched-count');
  const gameContainer = document.getElementById('game-container');
  const completeScreen = document.getElementById('complete-screen');
  
  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  
  function render() {
    grid.innerHTML = '';
    
    tiles.forEach((tile, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'df-game-match-tile';
      btn.className += tile.type === 'word' ? ' df-game-match-tile--word' : ' df-game-match-tile--meaning';
      btn.textContent = tile.text;
      btn.dataset.index = i;
      btn.dataset.pairId = tile.pair_id;
      btn.dataset.type = tile.type;
      
      if (matchedPairs.has(tile.pair_id)) {
        btn.classList.add('df-game-match-tile--matched');
        btn.disabled = true;
      }
      
      if (selected && selected.index === i) {
        btn.classList.add('df-game-match-tile--selected');
      }
      
      btn.addEventListener('click', () => handleClick(i, tile));
      grid.appendChild(btn);
    });
    
    // Update progress
    const pct = (matchedPairs.size / totalPairs) * 100;
    progressFill.style.width = pct + '%';
    progressText.textContent = `${matchedPairs.size} / ${totalPairs}`;
    matchedEl.textContent = matchedPairs.size;
  }
  
  function handleClick(index, tile) {
    if (locked) return;
    if (matchedPairs.has(tile.pair_id)) return;
    
    if (!selected) {
      selected = { index, ...tile };
      render();
      return;
    }
    
    if (selected.index === index) {
      selected = null;
      render();
      return;
    }
    
    // Check match
    const isMatch = selected.pair_id === tile.pair_id && selected.type !== tile.type;
    
    if (isMatch) {
      matchedPairs.add(tile.pair_id);
      selected = null;
      render();
      
      // Check complete
      if (matchedPairs.size >= totalPairs) {
        setTimeout(showComplete, 500);
      }
    } else {
      // Wrong match - flash and reset
      locked = true;
      const btns = grid.querySelectorAll('button');
      btns[selected.index].classList.add('df-game-option--wrong');
      btns[index].classList.add('df-game-option--wrong');
      
      setTimeout(() => {
        selected = null;
        locked = false;
        render();
      }, 600);
    }
  }
  
  function showComplete() {
    gameContainer.classList.add('hidden');
    completeScreen.classList.remove('hidden');
  }
  
  function resetGame() {
    tiles = shuffleArray([...tilesData]);
    selected = null;
    matchedPairs = new Set();
    locked = false;
    gameContainer.classList.remove('hidden');
    completeScreen.classList.add('hidden');
    render();
  }
  
  document.getElementById('btn-reset').addEventListener('click', resetGame);
  document.getElementById('btn-play-again').addEventListener('click', resetGame);
  
  render();
})();
</script>
{% endif %}
{% endblock %}
