{% extends "layouts/sidebar_layout.html" %}
{% load static %}

{% block title %}Ná»‘i tá»« vá»›i nghÄ©a | DailyFluent{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vocab-games.css' %}?v=20260130">
<style>
  /* Lives/Hearts UI */
  .df-game-lives {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 9999px;
    border: 1px solid rgba(239, 68, 68, 0.2);
  }
  
  .df-game-lives-icon {
    font-size: 1.25rem;
  }
  
  .df-game-lives-count {
    font-weight: 700;
    color: var(--text-primary);
    font-size: 0.875rem;
  }
  
  .df-game-lives-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }
  
  /* Game Over Screen */
  .df-game-over {
    text-align: center;
    padding: 3rem 1.5rem;
  }
  
  .df-game-over-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }
  
  .df-game-over-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #EF4444;
    margin-bottom: 0.5rem;
  }
  
  .df-game-over-text {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }
  
  .df-game-buy-life-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #F59E0B, #D97706);
    color: #fff;
    border: none;
    border-radius: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    margin-bottom: 1rem;
  }
  
  .df-game-buy-life-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
  }
  
  .df-game-buy-life-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  
  .df-game-buy-life-info {
    font-size: 0.8125rem;
    color: var(--text-secondary);
  }
  
  .df-game-actions-row {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    margin-top: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="df-game-container">
  <!-- Header -->
  <div class="df-game-header">
    <div>
      <h1 class="df-game-title">â‡„ Ná»‘i tá»« vá»›i nghÄ©a</h1>
      <p class="df-game-subtitle">Chá»n cÃ¡c cáº·p tá»« - nghÄ©a Ä‘Ãºng</p>
    </div>
    <div class="df-game-stats">
      <!-- Lives -->
      <div class="df-game-lives">
        <span class="df-game-lives-icon">â¤ï¸</span>
        <span class="df-game-lives-count" id="lives-count">5</span>
        <span class="df-game-lives-label">máº¡ng</span>
      </div>
      <div class="df-game-stat">
        <span class="df-game-stat-value" id="matched-count">0</span>
        <span class="df-game-stat-label">ÄÃ£ ghÃ©p</span>
      </div>
      <div class="df-game-stat">
        <span class="df-game-stat-value">{{ total_pairs }}</span>
        <span class="df-game-stat-label">Tá»•ng</span>
      </div>
    </div>
  </div>

  {% if tiles %}
  <script id="tiles-data" type="application/json">{{ tiles_json|safe }}</script>

  <div id="game-container">
    <!-- Progress -->
    <div class="df-game-progress">
      <div class="df-game-progress-bar">
        <div id="progress-fill" class="df-game-progress-fill" style="width: 0%"></div>
      </div>
      <span id="progress-text" class="df-game-progress-text">0 / {{ total_pairs }}</span>
    </div>

    <!-- Matching Grid -->
    <div class="df-game-card">
      <div id="match-grid" class="df-game-match-grid"></div>
    </div>

    <!-- Reset Button -->
    <div style="text-align: center; margin-top: 1rem;">
      <button type="button" id="btn-reset" class="df-game-nav-btn df-game-nav-btn--secondary">
        ChÆ¡i láº¡i
      </button>
    </div>
  </div>

  <!-- Complete Screen -->
  <div id="complete-screen" class="df-game-complete hidden">
    <div class="df-game-complete-icon">ğŸ‰</div>
    <h2 class="df-game-complete-title">HoÃ n thÃ nh!</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Báº¡n Ä‘Ã£ ghÃ©p Ä‘Ãºng táº¥t cáº£ cÃ¡c cáº·p tá»«!</p>
    <div style="display: flex; justify-content: center; gap: 1rem;">
      <button type="button" id="btn-play-again" class="df-game-nav-btn df-game-nav-btn--secondary">ChÆ¡i láº¡i</button>
      <a href="{% url 'vocab:my_words' %}" class="df-game-complete-btn">Quay láº¡i</a>
    </div>
  </div>

  <!-- Game Over Screen -->
  <div id="gameover-screen" class="df-game-over hidden">
    <div class="df-game-over-icon">ğŸ’”</div>
    <h2 class="df-game-over-title">Háº¿t máº¡ng!</h2>
    <p class="df-game-over-text">Báº¡n Ä‘Ã£ háº¿t lÆ°á»£t chÆ¡i. Mua thÃªm máº¡ng Ä‘á»ƒ tiáº¿p tá»¥c!</p>
    
    <button type="button" id="btn-buy-life" class="df-game-buy-life-btn">
      <span>ğŸ’°</span>
      <span>Mua 1 máº¡ng (10 coin)</span>
    </button>
    <div class="df-game-buy-life-info" id="buy-life-info"></div>
    
    <div class="df-game-actions-row">
      <button type="button" id="btn-restart" class="df-game-nav-btn df-game-nav-btn--secondary">ChÆ¡i láº¡i tá»« Ä‘áº§u</button>
      <a href="{% url 'vocab:my_words' %}" class="df-game-nav-btn df-game-nav-btn--primary">ThoÃ¡t</a>
    </div>
  </div>

  {% else %}
  <div class="df-game-empty">
    <div class="df-game-empty-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
    </div>
    <h2 class="df-game-empty-title">ChÆ°a cÃ³ tá»« vá»±ng</h2>
    <p class="df-game-empty-text">HÃ£y thÃªm tá»« vá»±ng vÃ o há»‡ thá»‘ng Ä‘á»ƒ báº¯t Ä‘áº§u chÆ¡i.</p>
  </div>
  {% endif %}
</div>

{% if tiles %}
<script>
(function() {
  const tilesData = JSON.parse(document.getElementById('tiles-data').textContent || '[]');
  const totalPairs = {{ total_pairs }};
  const BUY_LIFE_URL = "{% url 'vocab:api_buy_game_life' %}";
  const CSRF_TOKEN = "{{ csrf_token }}";
  
  const MAX_LIVES = 5;
  
  let tiles = [...tilesData];
  let selected = null;
  let matchedPairs = new Set();
  let locked = false;
  let lives = MAX_LIVES;
  
  const grid = document.getElementById('match-grid');
  const progressFill = document.getElementById('progress-fill');
  const progressText = document.getElementById('progress-text');
  const matchedEl = document.getElementById('matched-count');
  const livesEl = document.getElementById('lives-count');
  const gameContainer = document.getElementById('game-container');
  const completeScreen = document.getElementById('complete-screen');
  const gameoverScreen = document.getElementById('gameover-screen');
  const buyLifeBtn = document.getElementById('btn-buy-life');
  const buyLifeInfo = document.getElementById('buy-life-info');
  
  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  
  function updateLivesUI() {
    livesEl.textContent = lives;
  }
  
  function render() {
    grid.innerHTML = '';
    updateLivesUI();
    
    tiles.forEach((tile, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'df-game-match-tile';
      btn.className += tile.type === 'word' ? ' df-game-match-tile--word' : ' df-game-match-tile--meaning';
      btn.textContent = tile.text;
      btn.dataset.index = i;
      btn.dataset.pairId = tile.pair_id;
      btn.dataset.type = tile.type;
      
      if (matchedPairs.has(tile.pair_id)) {
        btn.classList.add('df-game-match-tile--matched');
        btn.disabled = true;
      }
      
      if (selected && selected.index === i) {
        btn.classList.add('df-game-match-tile--selected');
      }
      
      btn.addEventListener('click', () => handleClick(i, tile));
      grid.appendChild(btn);
    });
    
    // Update progress
    const pct = (matchedPairs.size / totalPairs) * 100;
    progressFill.style.width = pct + '%';
    progressText.textContent = `${matchedPairs.size} / ${totalPairs}`;
    matchedEl.textContent = matchedPairs.size;
  }
  
  function handleClick(index, tile) {
    if (locked) return;
    if (matchedPairs.has(tile.pair_id)) return;
    
    if (!selected) {
      selected = { index, ...tile };
      render();
      return;
    }
    
    if (selected.index === index) {
      selected = null;
      render();
      return;
    }
    
    // Check match
    const isMatch = selected.pair_id === tile.pair_id && selected.type !== tile.type;
    
    if (isMatch) {
      matchedPairs.add(tile.pair_id);
      selected = null;
      render();
      
      // Check complete
      if (matchedPairs.size >= totalPairs) {
        setTimeout(showComplete, 500);
      }
    } else {
      // Wrong match - lose a life
      lives--;
      updateLivesUI();
      
      locked = true;
      const btns = grid.querySelectorAll('button');
      btns[selected.index].classList.add('df-game-option--wrong');
      btns[index].classList.add('df-game-option--wrong');
      
      setTimeout(() => {
        selected = null;
        locked = false;
        
        if (lives <= 0) {
          showGameOver();
        } else {
          render();
        }
      }, 600);
    }
  }
  
  function showComplete() {
    gameContainer.classList.add('hidden');
    completeScreen.classList.remove('hidden');
    gameoverScreen.classList.add('hidden');
  }
  
  function showGameOver() {
    gameContainer.classList.add('hidden');
    completeScreen.classList.add('hidden');
    gameoverScreen.classList.remove('hidden');
    buyLifeInfo.textContent = '';
  }
  
  function hideGameOver() {
    gameoverScreen.classList.add('hidden');
    gameContainer.classList.remove('hidden');
  }
  
  function resetGame() {
    tiles = shuffleArray([...tilesData]);
    selected = null;
    matchedPairs = new Set();
    locked = false;
    lives = MAX_LIVES;
    gameContainer.classList.remove('hidden');
    completeScreen.classList.add('hidden');
    gameoverScreen.classList.add('hidden');
    render();
  }
  
  async function buyLife() {
    buyLifeBtn.disabled = true;
    buyLifeInfo.textContent = 'Äang xá»­ lÃ½...';
    
    try {
      const res = await fetch(BUY_LIFE_URL, {
        method: 'POST',
        headers: {
          'X-CSRFToken': CSRF_TOKEN,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await res.json();
      
      if (data.success) {
        lives = 1; // Give 1 life
        buyLifeInfo.textContent = `âœ“ ${data.message} Sá»‘ dÆ°: ${data.new_balance} coin`;
        
        // Resume game after short delay
        setTimeout(() => {
          hideGameOver();
          render();
        }, 1000);
      } else {
        buyLifeInfo.textContent = `âœ— ${data.message}`;
        buyLifeBtn.disabled = false;
      }
    } catch (err) {
      buyLifeInfo.textContent = 'âœ— Lá»—i káº¿t ná»‘i. Vui lÃ²ng thá»­ láº¡i.';
      buyLifeBtn.disabled = false;
    }
  }
  
  document.getElementById('btn-reset').addEventListener('click', resetGame);
  document.getElementById('btn-play-again').addEventListener('click', resetGame);
  document.getElementById('btn-restart').addEventListener('click', resetGame);
  buyLifeBtn.addEventListener('click', buyLife);
  
  render();
})();
</script>
{% endif %}
{% endblock %}
