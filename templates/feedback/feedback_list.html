{% extends "layouts/sidebar_layout.html" %}
{% load static %}

{% block title %}Góc Cải Tiến - DailyFluent{% endblock %}

{% block main_classes %}df-page-container-lg{% endblock %}

{% block content %}
<div class="df-feedback-page">
    <!-- Header Section -->
    <div class="df-feedback-header">
        <div class="df-feedback-header-content">
            <div class="df-feedback-title-section">
                <h1 class="df-feedback-title">
                    <svg class="df-feedback-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path
                            d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
                    </svg>
                    Góc Cải Tiến
                </h1>
                <p class="df-feedback-subtitle">Đề xuất tính năng mới, báo lỗi và bình chọn cho ý tưởng hay</p>
            </div>
            {% if user.is_authenticated %}
            <a href="{% url 'feedback:create' %}" class="df-feedback-create-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Tạo đề xuất mới
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Filters Section -->
    <div class="df-feedback-filters">
        <!-- Status Tabs -->
        <div class="df-feedback-tabs">
            <a href="?status=all&sort={{ sort_by }}&type={{ type_filter }}"
                class="df-feedback-tab {% if status_filter == 'all' %}active{% endif %}">
                Tất cả
            </a>
            <a href="?status=in_progress&sort={{ sort_by }}&type={{ type_filter }}"
                class="df-feedback-tab {% if status_filter == 'in_progress' %}active{% endif %}">
                Đang thực hiện
            </a>
            <a href="?status=done&sort={{ sort_by }}&type={{ type_filter }}"
                class="df-feedback-tab {% if status_filter == 'done' %}active{% endif %}">
                Đã hoàn thành
            </a>
        </div>

        <!-- Sort & Type Filters -->
        <div class="df-feedback-filter-group">
            <div class="df-feedback-filter">
                <label>Sắp xếp:</label>
                <select id="sortSelect" class="df-feedback-select" onchange="updateFilters()">
                    <option value="popular" {% if sort_by == 'popular' %}selected{% endif %}>Phổ biến nhất</option>
                    <option value="latest" {% if sort_by == 'latest' %}selected{% endif %}>Mới nhất</option>
                </select>
            </div>
            <div class="df-feedback-filter">
                <label>Loại:</label>
                <select id="typeSelect" class="df-feedback-select" onchange="updateFilters()">
                    <option value="all" {% if type_filter == 'all' %}selected{% endif %}>Tất cả</option>
                    <option value="feature" {% if type_filter == 'feature' %}selected{% endif %}>Tính năng</option>
                    <option value="bug" {% if type_filter == 'bug' %}selected{% endif %}>Báo lỗi</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Feedback List -->
    <div class="df-feedback-list">
        {% for feedback in page_obj %}
        <a href="{% url 'feedback:detail' pk=feedback.pk %}" class="df-feedback-card">
            <!-- Vote Box -->
            <div class="df-vote-box {% if feedback.id in user_voted_ids %}voted{% endif %}" data-id="{{ feedback.id }}"
                onclick="event.preventDefault(); toggleVote({{ feedback.id }}, this);">
                <span class="df-vote-count">{{ feedback.vote_count }}</span>
                <svg class="df-vote-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="18 15 12 9 6 15" />
                </svg>
                <span class="df-vote-label">vote</span>
            </div>

            <!-- Card Content -->
            <div class="df-feedback-card-content">
                <div class="df-feedback-card-header">
                    <h2 class="df-feedback-card-title">{{ feedback.title }}</h2>
                    <div class="df-feedback-badges">
                        <span class="df-type-badge df-type-{{ feedback.type }}">
                            {% if feedback.type == 'feature' %}Tính năng{% else %}Báo lỗi{% endif %}
                        </span>
                        <span class="df-status-badge df-status-{{ feedback.status }}">
                            {{ feedback.get_status_display }}
                        </span>
                    </div>
                </div>
                <p class="df-feedback-card-desc">{{ feedback.description|truncatewords:30 }}</p>
                <div class="df-feedback-card-meta">
                    <span class="df-feedback-author">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                        {{ feedback.user.email|truncatechars:25 }}
                    </span>
                    <span class="df-feedback-date">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>
                        {{ feedback.created_at|date:"d/m/Y" }}
                    </span>
                    <span class="df-feedback-comments">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                        </svg>
                        {{ feedback.comments.count }} bình luận
                    </span>
                </div>
            </div>
        </a>
        {% empty %}
        <div class="df-feedback-empty">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path
                    d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
            </svg>
            <h3>Chưa có đề xuất nào</h3>
            <p>Hãy là người đầu tiên đề xuất tính năng mới hoặc báo lỗi!</p>
            {% if user.is_authenticated %}
            <a href="{% url 'feedback:create' %}" class="df-feedback-create-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Tạo đề xuất đầu tiên
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="df-feedback-pagination">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&status={{ status_filter }}&sort={{ sort_by }}&type={{ type_filter }}"
            class="df-pagination-btn">
            ← Trang trước
        </a>
        {% endif %}

        <span class="df-pagination-info">
            Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&status={{ status_filter }}&sort={{ sort_by }}&type={{ type_filter }}"
            class="df-pagination-btn">
            Trang sau →
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    function updateFilters() {
        const sort = document.getElementById('sortSelect').value;
        const type = document.getElementById('typeSelect').value;
        const status = '{{ status_filter }}';
        window.location.href = `?status=${status}&sort=${sort}&type=${type}`;
    }

    function toggleVote(feedbackId, element) {
        {% if not user.is_authenticated %}
        window.location.href = "{% url 'account_login' %}?next={{ request.path }}";
        return;
        {% endif %}

        const csrfToken = '{{ csrf_token }}';

        fetch(`/feedback/${feedbackId}/vote/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const voteCount = element.querySelector('.df-vote-count');
                    voteCount.textContent = data.total_votes;

                    if (data.voted) {
                        element.classList.add('voted');
                    } else {
                        element.classList.remove('voted');
                    }
                } else if (data.login_required) {
                    window.location.href = "{% url 'account_login' %}?next={{ request.path }}";
                }
            })
            .catch(error => {
                console.error('Vote error:', error);
            });
    }
</script>
{% endblock %}