{% extends "base.html" %}
{% load static %}

{% block title %}M·ª•c ti√™u h√†ng ng√†y - DailyFluent{% endblock %}

{% block main_classes %}df-page-container-md{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between gap-3">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-400">M·ª•c ti√™u h√†ng ng√†y</p>
      <h1 class="text-2xl sm:text-3xl font-bold text-slate-900">
        Danh s√°ch m·ª•c ti√™u c·ªßa b·∫°n üìù
      </h1>
    </div>
    <a href="{% url 'home' %}" class="text-sm text-slate-600 hover:text-slate-900">
      ‚Üê V·ªÅ Dashboard
    </a>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white border border-slate-200 rounded-2xl p-4">
      <div class="text-2xl font-bold text-slate-900">{{ total_count }}</div>
      <div class="text-sm text-slate-500 mt-1">T·ªïng m·ª•c ti√™u</div>
    </div>
    <div class="bg-white border border-slate-200 rounded-2xl p-4">
      <div class="text-2xl font-bold text-blue-600">{{ active_count }}</div>
      <div class="text-sm text-slate-500 mt-1">ƒêang th·ª±c hi·ªán</div>
    </div>
    <div class="bg-white border border-slate-200 rounded-2xl p-4">
      <div class="text-2xl font-bold text-green-600">{{ completed_count }}</div>
      <div class="text-sm text-slate-500 mt-1">ƒê√£ ho√†n th√†nh</div>
    </div>
  </div>

  <!-- Add todo form -->
  <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5 sm:p-6">
    <h2 class="text-lg font-bold text-slate-900 mb-4">Th√™m m·ª•c ti√™u m·ªõi</h2>
    <form id="todo-form" class="space-y-3">
      <div>
        <input
          type="text"
          id="todo-title"
          placeholder="Ti√™u ƒë·ªÅ m·ª•c ti√™u..."
          class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
          maxlength="200"
          required
        />
      </div>
      <div>
        <textarea
          id="todo-description"
          placeholder="M√¥ t·∫£ chi ti·∫øt (t√πy ch·ªçn)..."
          rows="3"
          class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm resize-none"
          maxlength="500"
        ></textarea>
      </div>
      <div class="flex gap-3">
        <select
          id="todo-period-type"
          class="px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white"
        >
          <option value="day">Ng√†y</option>
          <option value="week">Tu·∫ßn</option>
          <option value="month">Th√°ng</option>
          <option value="year">NƒÉm</option>
        </select>
        <select
          id="todo-priority"
          class="px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white"
        >
          <option value="low">M·ª©c ƒë·ªô ∆∞u ti√™n: Th·∫•p</option>
          <option value="medium" selected>M·ª©c ƒë·ªô ∆∞u ti√™n: Trung b√¨nh</option>
          <option value="high">M·ª©c ƒë·ªô ∆∞u ti√™n: Cao</option>
        </select>
        <input
          type="date"
          id="todo-due-date"
          class="px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm bg-white"
        />
      </div>
      <button
        type="submit"
        class="w-full px-5 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold text-sm transition-colors"
      >
        Th√™m m·ª•c ti√™u
      </button>
    </form>
  </section>

  <!-- Active todos -->
  {% if active_todos %}
  <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5 sm:p-6">
    <h2 class="text-lg font-bold text-slate-900 mb-4">ƒêang th·ª±c hi·ªán ({{ active_count }})</h2>
    <div id="active-todos" class="space-y-2">
      {% for todo in active_todos %}
      <div class="df-todo-item flex items-start gap-3 p-4 rounded-xl border border-slate-200 hover:bg-slate-50 transition-colors" data-todo-id="{{ todo.id }}">
        <button
          type="button"
          class="df-todo-checkbox flex-shrink-0 w-6 h-6 rounded-lg border-2 border-slate-300 flex items-center justify-center transition-all hover:scale-110 mt-0.5"
          data-todo-id="{{ todo.id }}"
          title="ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh"
        >
        </button>
        <div class="flex-1 min-w-0">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1">
              <h3 class="text-sm font-semibold {% if todo.completed %}line-through text-slate-400{% else %}text-slate-900{% endif %}">{{ todo.title }}</h3>
              {% if todo.description %}
              <p class="text-xs text-slate-600 mt-1 {% if todo.completed %}line-through{% endif %}">{{ todo.description }}</p>
              {% endif %}
              <div class="flex items-center gap-3 mt-2 text-xs text-slate-500">
                {% if todo.period_type == 'day' %}
                <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded">Ng√†y</span>
                {% elif todo.period_type == 'week' %}
                <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded">Tu·∫ßn</span>
                {% elif todo.period_type == 'month' %}
                <span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded">Th√°ng</span>
                {% else %}
                <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded">NƒÉm</span>
                {% endif %}
                {% if todo.priority == 'high' %}
                <span class="px-2 py-0.5 bg-red-100 text-red-700 rounded">Cao</span>
                {% elif todo.priority == 'medium' %}
                <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded">Trung b√¨nh</span>
                {% else %}
                <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded">Th·∫•p</span>
                {% endif %}
                {% if todo.due_date %}
                <span>H·∫°n: {{ todo.due_date|date:"d/m/Y" }}</span>
                {% if todo.is_overdue %}
                <span class="text-red-600 font-semibold">(Qu√° h·∫°n)</span>
                {% endif %}
                {% endif %}
              </div>
            </div>
            <button
              type="button"
              class="df-todo-delete flex-shrink-0 w-8 h-8 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 flex items-center justify-center transition-colors"
              data-todo-id="{{ todo.id }}"
              title="X√≥a"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- Completed todos -->
  {% if completed_todos %}
  <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5 sm:p-6">
    <h2 class="text-lg font-bold text-slate-900 mb-4">ƒê√£ ho√†n th√†nh ({{ completed_count }})</h2>
    <div id="completed-todos" class="space-y-2">
      {% for todo in completed_todos %}
      <div class="df-todo-item flex items-start gap-3 p-4 rounded-xl border border-slate-200 bg-slate-50 opacity-75" data-todo-id="{{ todo.id }}">
        <button
          type="button"
          class="df-todo-checkbox flex-shrink-0 w-6 h-6 rounded-lg border-2 bg-blue-600 border-blue-600 flex items-center justify-center transition-all hover:scale-110 mt-0.5"
          data-todo-id="{{ todo.id }}"
          title="ƒê√°nh d·∫•u ch∆∞a ho√†n th√†nh"
        >
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
          </svg>
        </button>
        <div class="flex-1 min-w-0">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1">
              <h3 class="text-sm font-semibold text-slate-400 line-through">{{ todo.title }}</h3>
              {% if todo.description %}
              <p class="text-xs text-slate-500 mt-1 line-through">{{ todo.description }}</p>
              {% endif %}
            </div>
            <button
              type="button"
              class="df-todo-delete flex-shrink-0 w-8 h-8 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 flex items-center justify-center transition-colors"
              data-todo-id="{{ todo.id }}"
              title="X√≥a"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% if not active_todos and not completed_todos %}
  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-12 text-center">
    <div class="text-4xl mb-4">üìù</div>
    <h3 class="text-lg font-semibold text-slate-900 mb-2">Ch∆∞a c√≥ m·ª•c ti√™u n√†o</h3>
    <p class="text-sm text-slate-500">H√£y th√™m m·ª•c ti√™u ƒë·∫ßu ti√™n c·ªßa b·∫°n ·ªü tr√™n!</p>
  </div>
  {% endif %}
</div>

<script>
(function() {
  const todoForm = document.getElementById('todo-form');
  const todoTitle = document.getElementById('todo-title');
  const todoDescription = document.getElementById('todo-description');
  const todoPriority = document.getElementById('todo-priority');
  const todoDueDate = document.getElementById('todo-due-date');
  
  // Create todo
  todoForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const title = todoTitle.value.trim();
    if (!title) return;
    
    try {
      const response = await fetch('{% url "todos:todo_create" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          title: title,
          description: todoDescription.value.trim(),
          priority: todoPriority.value,
          due_date: todoDueDate.value || null
        })
      });
      
      const data = await response.json();
      if (data.success) {
        todoTitle.value = '';
        todoDescription.value = '';
        todoDueDate.value = '';
        todoPriority.value = 'medium';
        location.reload();
      } else {
        alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫°o m·ª•c ti√™u'));
      }
    } catch (error) {
      console.error('Error:', error);
      alert('C√≥ l·ªói x·∫£y ra khi t·∫°o m·ª•c ti√™u');
    }
  });
  
  // Toggle completed
  document.querySelectorAll('.df-todo-checkbox').forEach(btn => {
    btn.addEventListener('click', async function() {
      const todoId = this.dataset.todoId;
      try {
        const response = await fetch(`/todos/${todoId}/toggle/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        });
        
        const data = await response.json();
        if (data.success) {
          location.reload();
        }
      } catch (error) {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra');
      }
    });
  });
  
  // Delete todo
  document.querySelectorAll('.df-todo-delete').forEach(btn => {
    btn.addEventListener('click', async function() {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c ti√™u n√†y?')) return;
      
      const todoId = this.dataset.todoId;
      try {
        const response = await fetch(`/todos/${todoId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        });
        
        const data = await response.json();
        if (data.success) {
          location.reload();
        }
      } catch (error) {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra');
      }
    });
  });
})();
</script>
{% endblock %}

